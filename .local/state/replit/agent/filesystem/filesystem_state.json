{"file_contents":{"client/src/components/ui/select.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-9 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronUp className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronDown className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1\",\n          position === \"popper\" &&\n            \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"py-1.5 pl-8 pr-2 text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n}\n","size_bytes":5741},"design_guidelines.md":{"content":"# Design Guidelines: Cartoon Story Video Generation Tool\n\n## Design Approach\n\n**Selected Approach:** Hybrid - Design System Foundation with Creative Flourish\n\nDrawing inspiration from creative AI tools (Runway, Midjourney) and streamlined form wizards (Typeform, Linear), balanced with Material Design principles for structural consistency. The interface should feel professional yet playful, reflecting the creative nature of cartoon storytelling while maintaining utility-focused clarity.\n\n**Core Principles:**\n- Progressive disclosure through clear multi-step workflow\n- Playful professionalism - creative without being childish\n- Information hierarchy that guides users naturally through the process\n- Generous whitespace to reduce cognitive load during complex inputs\n\n---\n\n## Typography\n\n**Font Families:**\n- Primary: Inter (via Google Fonts) - Clean, readable for UI and forms\n- Accent: Quicksand (via Google Fonts) - Playful, rounded for headings and creative elements\n\n**Hierarchy:**\n- Hero/Page Titles: text-5xl/6xl, font-bold, Quicksand\n- Section Headings: text-3xl/4xl, font-semibold, Quicksand\n- Step Titles: text-2xl, font-semibold, Inter\n- Body Text: text-base, font-normal, Inter\n- Labels: text-sm, font-medium, Inter\n- Scene Cards Title: text-lg, font-semibold, Inter\n- Scene Metadata: text-xs, font-medium, Inter\n\n---\n\n## Layout System\n\n**Spacing Scale:** Tailwind units of 2, 4, 6, 8, 12, 16, 20, 24\n\n**Container Structure:**\n- Max width: max-w-7xl for main content\n- Form containers: max-w-3xl centered\n- Scene grid container: max-w-6xl\n- Padding: px-4 md:px-6 lg:px-8\n\n**Grid Systems:**\n- Scene cards: grid grid-cols-1 md:grid-cols-2 gap-6\n- Character input fields: grid grid-cols-1 md:grid-cols-2 gap-4\n- Progress steps: flex horizontal layout with connectors\n\n---\n\n## Component Library\n\n### Navigation\n- Fixed header with logo left, minimal navigation right\n- Transparent overlay on hero, solid background on scroll\n- Height: h-16 md:h-20\n\n### Hero Section\n- Full-width, height: min-h-[500px] md:min-h-[600px]\n- Large hero image showing vibrant cartoon/animation workspace scene\n- Centered content with semi-transparent overlay card\n- CTA button: \"Start Creating Stories\" with blurred background backdrop\n- Supporting text describing the 3-step process below main headline\n\n### Multi-Step Progress Indicator\n- Horizontal stepper component\n- Active step: larger, emphasized\n- Completed steps: checkmark icon\n- Upcoming steps: outlined, muted\n- Connector lines between steps\n- Labels: \"1. Story & Characters\" → \"2. Generate Scenes\" → \"3. Review & Export\"\n- Position: sticky top-20, background with subtle border-b\n\n### Form Components\n\n**Input Fields:**\n- Height: h-12 for text inputs\n- Border: border-2, rounded-lg\n- Focus state with ring effect\n- Label above input with required indicator\n- Helper text below: text-sm, muted\n\n**Text Area (Script Input):**\n- Min height: min-h-[300px]\n- Rounded-lg border\n- Character counter in bottom-right corner\n- Placeholder with example script snippet\n\n**Character Details Cards:**\n- Bordered cards with rounded-xl\n- Grid layout for multiple characters\n- Each card contains: Name input + Description textarea\n- Add/Remove character buttons\n- Visual separator between characters\n\n**Submit Button:**\n- Large, prominent: h-14 px-12\n- Rounded-full with shadow\n- Disabled state when fields incomplete\n- Loading spinner when processing\n\n### Scene Generation Display\n\n**Scene Cards:**\n- Bordered cards with rounded-xl\n- Padding: p-6\n- Header: Scene number badge + Title\n- Content sections clearly separated:\n  - Visuals description\n  - Dialogue/Action\n  - Music notes\n  - Sound effects\n  - Transition details\n- Each section with small icon prefix (use Heroicons)\n- Subtle background variation for each section type\n\n**Scene Grid:**\n- Masonry-style or standard grid\n- Gap: gap-6\n- Smooth fade-in animation on load\n- Numbered badges prominent in top-left\n\n### Loading States\n- Skeleton screens for scene generation\n- Animated pulse effect\n- Progress percentage display\n- Status messages: \"Analyzing script...\", \"Generating scenes...\", \"Almost done...\"\n\n### Empty States\n- Illustration or icon\n- Helpful message and next action\n- Centered in container\n\n---\n\n## Page Structure\n\n### Landing/Home Page\n1. **Hero Section**: Large image, value proposition, primary CTA\n2. **How It Works**: 3-column feature grid showing the process steps with icons\n3. **Example Output**: Sample scene cards showcasing output quality\n4. **Features Grid**: 4-column grid of key features (AI-powered, Disney Pixar style, detailed scenes, export ready)\n5. **CTA Section**: Final conversion section with secondary background\n6. **Footer**: Links, social, contact info in 3-column layout\n\n### Tool Interface Page\n1. **Progress Indicator**: Sticky at top\n2. **Step Container**: Centered, max-w-3xl\n3. **Step 1 - Input Form**: \n   - Script textarea (large)\n   - Character cards section (dynamic, can add multiple)\n   - Navigation: Next button (bottom-right)\n4. **Step 2 - Processing**:\n   - Loading animation\n   - Status updates\n   - Cancel button option\n5. **Step 3 - Results**:\n   - Scene cards grid\n   - Export/Download options\n   - Edit/Regenerate actions\n   - Start new project button\n\n---\n\n## Interactions & Animations\n\n**Micro-interactions (Minimal):**\n- Button hover: slight scale and shadow increase\n- Card hover: subtle lift with shadow\n- Form focus: border pulse effect\n- Scene card entrance: staggered fade-in (100ms delay between cards)\n\n**Loading Animations:**\n- Spinner for primary loading\n- Skeleton screens for content loading\n- Progress bar for generation process\n\n**Transitions:**\n- Step changes: smooth content fade\n- Card animations: transform with ease-in-out\n- Duration: 200-300ms for most interactions\n\n---\n\n## Images\n\n**Hero Image:**\n- Large, full-width background image\n- Scene: Bright, colorful animation studio workspace or cartoon characters in creative process\n- Style: Modern, vibrant, professional\n- Treatment: Subtle gradient overlay for text readability\n- Position: Background, cover\n\n**How It Works Section:**\n- Icon-based visuals (Heroicons) rather than images\n- Simple, clear iconography for each step\n\n**Example Output Section:**\n- 2-3 sample scene illustrations showing cartoon/animation style\n- Arranged in card format with descriptions\n\n**Feature Grid:**\n- Icon-based (Heroicons), no images needed\n\n---\n\n## Accessibility & Responsiveness\n\n- Form inputs with proper labels and ARIA attributes\n- Progress indicator announces current step to screen readers\n- Keyboard navigation throughout multi-step form\n- Focus indicators visible on all interactive elements\n- Responsive breakpoints: sm (640px), md (768px), lg (1024px), xl (1280px)\n- Mobile: Single column, stacked layout, touch-friendly button sizes (min-h-12)\n- Scene cards: Single column on mobile, 2 columns on tablet, 2-3 columns on desktop","size_bytes":6862},"client/src/components/ui/card.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"shadcn-card rounded-xl border bg-card border-card-border text-card-foreground shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n));\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n));\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"text-2xl font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n));\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\nexport {\n  Card,\n  CardHeader,\n  CardFooter,\n  CardTitle,\n  CardDescription,\n  CardContent,\n}\n","size_bytes":1904},"client/src/components/ui/table.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Table = React.forwardRef<\n  HTMLTableElement,\n  React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props}\n    />\n  </div>\n))\nTable.displayName = \"Table\"\n\nconst TableHeader = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName = \"TableHeader\"\n\nconst TableBody = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props}\n  />\n))\nTableBody.displayName = \"TableBody\"\n\nconst TableFooter = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\n      \"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableFooter.displayName = \"TableFooter\"\n\nconst TableRow = React.forwardRef<\n  HTMLTableRowElement,\n  React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nTableRow.displayName = \"TableRow\"\n\nconst TableHead = React.forwardRef<\n  HTMLTableCellElement,\n  React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableHead.displayName = \"TableHead\"\n\nconst TableCell = React.forwardRef<\n  HTMLTableCellElement,\n  React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\"p-4 align-middle [&:has([role=checkbox])]:pr-0\", className)}\n    {...props}\n  />\n))\nTableCell.displayName = \"TableCell\"\n\nconst TableCaption = React.forwardRef<\n  HTMLTableCaptionElement,\n  React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nTableCaption.displayName = \"TableCaption\"\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n}\n","size_bytes":2765},"server/videoMergerFFmpeg.ts":{"content":"// Video merger utility using local FFmpeg\n// Downloads videos from URLs, merges them sequentially, and uploads to Cloudinary\n\nimport { exec } from 'child_process';\nimport { promisify } from 'util';\nimport { writeFile, mkdir, rm, readFile } from 'fs/promises';\nimport { existsSync } from 'fs';\nimport path from 'path';\nimport { randomUUID } from 'crypto';\nimport { ObjectStorageService } from './objectStorage';\n\nconst execAsync = promisify(exec);\nconst objectStorageService = new ObjectStorageService();\n\n// Cloudinary configuration (unsigned upload)\nconst CLOUDINARY_CLOUD_NAME = 'dy40igzli';\nconst CLOUDINARY_UPLOAD_PRESET = 'demo123';\nconst CLOUDINARY_UPLOAD_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/video/upload`;\n\nexport async function mergeVideosWithFFmpeg(videoUrls: string[]): Promise<string> {\n  if (videoUrls.length === 0) {\n    throw new Error('No video URLs provided for merging');\n  }\n\n  if (videoUrls.length > 19) {\n    throw new Error('Cannot merge more than 19 videos at once');\n  }\n\n  // Create unique temp directory for this merge operation\n  const uniqueId = randomUUID();\n  const tempDir = path.join('/tmp', `video-merge-${uniqueId}`);\n  const listFile = path.join(tempDir, 'filelist.txt');\n  const outputFile = path.join(tempDir, 'merged-output.mp4');\n\n  try {\n    // Create temp directory if it doesn't exist\n    if (!existsSync(tempDir)) {\n      await mkdir(tempDir, { recursive: true });\n    }\n\n    console.log(`[FFmpeg Merger] Starting merge of ${videoUrls.length} videos in ${tempDir}`);\n\n    // Step 1: Download all videos to temp directory\n    const downloadedFiles: string[] = [];\n    for (let i = 0; i < videoUrls.length; i++) {\n      const filename = path.join(tempDir, `video-${i + 1}.mp4`);\n      console.log(`[FFmpeg Merger] Downloading video ${i + 1}/${videoUrls.length}...`);\n      \n      const response = await fetch(videoUrls[i]);\n      if (!response.ok) {\n        throw new Error(`Failed to download video ${i + 1}: ${response.statusText}`);\n      }\n      \n      const buffer = await response.arrayBuffer();\n      await writeFile(filename, Buffer.from(buffer));\n      downloadedFiles.push(filename);\n      console.log(`[FFmpeg Merger] Downloaded video ${i + 1} (${buffer.byteLength} bytes)`);\n    }\n\n    // Step 2: Create file list for FFmpeg concat\n    const fileListContent = downloadedFiles\n      .map(file => `file '${file}'`)\n      .join('\\n');\n    await writeFile(listFile, fileListContent);\n    console.log(`[FFmpeg Merger] Created file list with ${downloadedFiles.length} videos`);\n\n    // Step 3: Merge videos using FFmpeg concat demuxer\n    console.log(`[FFmpeg Merger] Running FFmpeg to merge videos...`);\n    const ffmpegCommand = `ffmpeg -f concat -safe 0 -i \"${listFile}\" -c copy \"${outputFile}\"`;\n    \n    try {\n      const { stdout, stderr } = await execAsync(ffmpegCommand, { maxBuffer: 1024 * 1024 * 10 });\n      console.log(`[FFmpeg Merger] FFmpeg completed successfully`);\n      if (stderr) {\n        console.log(`[FFmpeg Merger] FFmpeg stderr:`, stderr.substring(0, 500));\n      }\n    } catch (ffmpegError: any) {\n      console.error(`[FFmpeg Merger] FFmpeg error:`, ffmpegError.stderr || ffmpegError.message);\n      throw new Error(`FFmpeg failed: ${ffmpegError.message}`);\n    }\n\n    // Step 4: Upload merged video to Cloudinary using unsigned upload\n    console.log(`[FFmpeg Merger] Uploading merged video to Cloudinary...`);\n    \n    const videoBuffer = await readFile(outputFile);\n    const videoBlob = new Blob([videoBuffer], { type: 'video/mp4' });\n    \n    const formData = new FormData();\n    formData.append('file', videoBlob, `merged-${uniqueId}.mp4`);\n    formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);\n    \n    console.log(`[FFmpeg Merger] FormData created with upload_preset: ${CLOUDINARY_UPLOAD_PRESET}`);\n    \n    const uploadResponse = await fetch(CLOUDINARY_UPLOAD_URL, {\n      method: 'POST',\n      body: formData,\n    });\n\n    if (!uploadResponse.ok) {\n      const errorText = await uploadResponse.text();\n      throw new Error(`Cloudinary upload failed: ${uploadResponse.statusText} - ${errorText}`);\n    }\n\n    const uploadResult = await uploadResponse.json();\n    const cloudinaryUrl = uploadResult.secure_url;\n    console.log(`[FFmpeg Merger] Upload complete! URL: ${cloudinaryUrl}`);\n\n    // Step 5: Clean up temp directory\n    try {\n      await rm(tempDir, { recursive: true, force: true });\n      console.log(`[FFmpeg Merger] Cleanup successful`);\n    } catch (cleanupError) {\n      console.error(`[FFmpeg Merger] Cleanup failed:`, cleanupError);\n    }\n\n    return cloudinaryUrl;\n  } catch (error) {\n    console.error(`[FFmpeg Merger] Error during merge process:`, error);\n    \n    // Clean up on error - remove entire temp directory\n    try {\n      if (existsSync(tempDir)) {\n        await rm(tempDir, { recursive: true, force: true });\n        console.log(`[FFmpeg Merger] Error cleanup successful`);\n      }\n    } catch (cleanupError) {\n      console.error(`[FFmpeg Merger] Error cleanup failed:`, cleanupError);\n    }\n    \n    throw new Error(`Failed to merge videos with FFmpeg: ${error instanceof Error ? error.message : 'Unknown error'}`);\n  }\n}\n\nexport async function mergeVideosWithFFmpegTemporary(\n  videoUrls: string[], \n  expiryHours: number = 24\n): Promise<{ videoPath: string; expiresAt: string }> {\n  if (videoUrls.length === 0) {\n    throw new Error('No video URLs provided for merging');\n  }\n\n  if (videoUrls.length > 19) {\n    throw new Error('Cannot merge more than 19 videos at once');\n  }\n\n  const uniqueId = randomUUID();\n  const tempDir = path.join('/tmp', `video-merge-${uniqueId}`);\n  const listFile = path.join(tempDir, 'filelist.txt');\n  const outputFile = path.join(tempDir, 'merged-output.mp4');\n\n  try {\n    if (!existsSync(tempDir)) {\n      await mkdir(tempDir, { recursive: true });\n    }\n\n    console.log(`[FFmpeg Temporary] Starting merge of ${videoUrls.length} videos in ${tempDir}`);\n\n    const downloadedFiles: string[] = [];\n    for (let i = 0; i < videoUrls.length; i++) {\n      const filename = path.join(tempDir, `video-${i + 1}.mp4`);\n      console.log(`[FFmpeg Temporary] Downloading video ${i + 1}/${videoUrls.length}...`);\n      \n      const response = await fetch(videoUrls[i]);\n      if (!response.ok) {\n        throw new Error(`Failed to download video ${i + 1}: ${response.statusText}`);\n      }\n      \n      const buffer = await response.arrayBuffer();\n      await writeFile(filename, Buffer.from(buffer));\n      downloadedFiles.push(filename);\n      console.log(`[FFmpeg Temporary] Downloaded video ${i + 1} (${buffer.byteLength} bytes)`);\n    }\n\n    const fileListContent = downloadedFiles\n      .map(file => `file '${file}'`)\n      .join('\\n');\n    await writeFile(listFile, fileListContent);\n    console.log(`[FFmpeg Temporary] Created file list with ${downloadedFiles.length} videos`);\n\n    console.log(`[FFmpeg Temporary] Running FFmpeg to merge videos...`);\n    const ffmpegCommand = `ffmpeg -f concat -safe 0 -i \"${listFile}\" -c copy \"${outputFile}\"`;\n    \n    try {\n      const { stdout, stderr } = await execAsync(ffmpegCommand, { maxBuffer: 1024 * 1024 * 10 });\n      console.log(`[FFmpeg Temporary] FFmpeg completed successfully`);\n      if (stderr) {\n        console.log(`[FFmpeg Temporary] FFmpeg stderr:`, stderr.substring(0, 500));\n      }\n    } catch (ffmpegError: any) {\n      console.error(`[FFmpeg Temporary] FFmpeg error:`, ffmpegError.stderr || ffmpegError.message);\n      throw new Error(`FFmpeg failed: ${ffmpegError.message}`);\n    }\n\n    console.log(`[FFmpeg Temporary] Uploading to temporary storage (expires in ${expiryHours} hours)...`);\n    const videoPath = await objectStorageService.uploadTemporaryVideo(outputFile, expiryHours);\n\n    const expiryDate = new Date();\n    expiryDate.setHours(expiryDate.getHours() + expiryHours);\n\n    console.log(`[FFmpeg Temporary] Upload complete! Path: ${videoPath}`);\n    console.log(`[FFmpeg Temporary] Expires at: ${expiryDate.toISOString()}`);\n\n    try {\n      await rm(tempDir, { recursive: true, force: true });\n      console.log(`[FFmpeg Temporary] Cleanup successful`);\n    } catch (cleanupError) {\n      console.error(`[FFmpeg Temporary] Cleanup failed:`, cleanupError);\n    }\n\n    return {\n      videoPath,\n      expiresAt: expiryDate.toISOString()\n    };\n  } catch (error) {\n    console.error(`[FFmpeg Temporary] Error during merge process:`, error);\n    \n    try {\n      if (existsSync(tempDir)) {\n        await rm(tempDir, { recursive: true, force: true });\n        console.log(`[FFmpeg Temporary] Error cleanup successful`);\n      }\n    } catch (cleanupError) {\n      console.error(`[FFmpeg Temporary] Error cleanup failed:`, cleanupError);\n    }\n    \n    throw new Error(`Failed to merge videos with FFmpeg: ${error instanceof Error ? error.message : 'Unknown error'}`);\n  }\n}\n","size_bytes":8834},"client/src/components/examples/ProgressStepper.tsx":{"content":"import ProgressStepper from \"../ProgressStepper\";\n\nexport default function ProgressStepperExample() {\n  const steps = [\n    { id: 1, title: \"Story & Characters\", description: \"Input details\" },\n    { id: 2, title: \"Generate Scenes\", description: \"AI processing\" },\n    { id: 3, title: \"Review & Export\", description: \"View results\" },\n  ];\n\n  return (\n    <div className=\"space-y-8\">\n      <div>\n        <p className=\"text-sm text-muted-foreground mb-4\">Step 1 (Current)</p>\n        <ProgressStepper currentStep={1} steps={steps} />\n      </div>\n      <div>\n        <p className=\"text-sm text-muted-foreground mb-4\">Step 2 (Current)</p>\n        <ProgressStepper currentStep={2} steps={steps} />\n      </div>\n      <div>\n        <p className=\"text-sm text-muted-foreground mb-4\">Step 3 (Current)</p>\n        <ProgressStepper currentStep={3} steps={steps} />\n      </div>\n    </div>\n  );\n}\n","size_bytes":888},"client/src/components/ui/toaster.tsx":{"content":"import { useToast } from \"@/hooks/use-toast\"\nimport {\n  Toast,\n  ToastClose,\n  ToastDescription,\n  ToastProvider,\n  ToastTitle,\n  ToastViewport,\n} from \"@/components/ui/toast\"\n\nexport function Toaster() {\n  const { toasts } = useToast()\n\n  return (\n    <ToastProvider>\n      {toasts.map(function ({ id, title, description, action, ...props }) {\n        return (\n          <Toast key={id} {...props}>\n            <div className=\"grid gap-1\">\n              {title && <ToastTitle>{title}</ToastTitle>}\n              {description && (\n                <ToastDescription>{description}</ToastDescription>\n              )}\n            </div>\n            {action}\n            <ToastClose />\n          </Toast>\n        )\n      })}\n      <ToastViewport />\n    </ToastProvider>\n  )\n}\n","size_bytes":772},"client/src/components/ui/badge.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  // Whitespace-nowrap: Badges should never wrap.\n  \"whitespace-nowrap inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\" +\n  \" hover-elevate \" ,\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground shadow-xs\",\n        secondary: \"border-transparent bg-secondary text-secondary-foreground\",\n        destructive:\n          \"border-transparent bg-destructive text-destructive-foreground shadow-xs\",\n\n        outline: \" border [border-color:var(--badge-outline)] shadow-xs\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  },\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  );\n}\n\nexport { Badge, badgeVariants }\n","size_bytes":1202},"client/src/components/ui/sheet.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SheetPrimitive from \"@radix-ui/react-dialog\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Sheet = SheetPrimitive.Root\n\nconst SheetTrigger = SheetPrimitive.Trigger\n\nconst SheetClose = SheetPrimitive.Close\n\nconst SheetPortal = SheetPrimitive.Portal\n\nconst SheetOverlay = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nSheetOverlay.displayName = SheetPrimitive.Overlay.displayName\n\nconst sheetVariants = cva(\n  \"fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500\",\n  {\n    variants: {\n      side: {\n        top: \"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top\",\n        bottom:\n          \"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n        left: \"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm\",\n        right:\n          \"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm\",\n      },\n    },\n    defaultVariants: {\n      side: \"right\",\n    },\n  }\n)\n\ninterface SheetContentProps\n  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,\n    VariantProps<typeof sheetVariants> {}\n\nconst SheetContent = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Content>,\n  SheetContentProps\n>(({ side = \"right\", className, children, ...props }, ref) => (\n  <SheetPortal>\n    <SheetOverlay />\n    <SheetPrimitive.Content\n      ref={ref}\n      className={cn(sheetVariants({ side }), className)}\n      {...props}\n    >\n      {children}\n      <SheetPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </SheetPrimitive.Close>\n    </SheetPrimitive.Content>\n  </SheetPortal>\n))\nSheetContent.displayName = SheetPrimitive.Content.displayName\n\nconst SheetHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetHeader.displayName = \"SheetHeader\"\n\nconst SheetFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetFooter.displayName = \"SheetFooter\"\n\nconst SheetTitle = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold text-foreground\", className)}\n    {...props}\n  />\n))\nSheetTitle.displayName = SheetPrimitive.Title.displayName\n\nconst SheetDescription = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nSheetDescription.displayName = SheetPrimitive.Description.displayName\n\nexport {\n  Sheet,\n  SheetPortal,\n  SheetOverlay,\n  SheetTrigger,\n  SheetClose,\n  SheetContent,\n  SheetHeader,\n  SheetFooter,\n  SheetTitle,\n  SheetDescription,\n}\n","size_bytes":4281},"tailwind.config.ts":{"content":"import type { Config } from \"tailwindcss\";\n\nexport default {\n  darkMode: [\"class\"],\n  content: [\"./client/index.html\", \"./client/src/**/*.{js,jsx,ts,tsx}\"],\n  theme: {\n    extend: {\n      borderRadius: {\n        lg: \".5625rem\", /* 9px */\n        md: \".375rem\", /* 6px */\n        sm: \".1875rem\", /* 3px */\n      },\n      colors: {\n        // Flat / base colors (regular buttons)\n        background: \"hsl(var(--background) / <alpha-value>)\",\n        foreground: \"hsl(var(--foreground) / <alpha-value>)\",\n        border: \"hsl(var(--border) / <alpha-value>)\",\n        input: \"hsl(var(--input) / <alpha-value>)\",\n        card: {\n          DEFAULT: \"hsl(var(--card) / <alpha-value>)\",\n          foreground: \"hsl(var(--card-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--card-border) / <alpha-value>)\",\n        },\n        popover: {\n          DEFAULT: \"hsl(var(--popover) / <alpha-value>)\",\n          foreground: \"hsl(var(--popover-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--popover-border) / <alpha-value>)\",\n        },\n        primary: {\n          DEFAULT: \"hsl(var(--primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--primary-foreground) / <alpha-value>)\",\n          border: \"var(--primary-border)\",\n        },\n        secondary: {\n          DEFAULT: \"hsl(var(--secondary) / <alpha-value>)\",\n          foreground: \"hsl(var(--secondary-foreground) / <alpha-value>)\",\n          border: \"var(--secondary-border)\",\n        },\n        muted: {\n          DEFAULT: \"hsl(var(--muted) / <alpha-value>)\",\n          foreground: \"hsl(var(--muted-foreground) / <alpha-value>)\",\n          border: \"var(--muted-border)\",\n        },\n        accent: {\n          DEFAULT: \"hsl(var(--accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--accent-foreground) / <alpha-value>)\",\n          border: \"var(--accent-border)\",\n        },\n        destructive: {\n          DEFAULT: \"hsl(var(--destructive) / <alpha-value>)\",\n          foreground: \"hsl(var(--destructive-foreground) / <alpha-value>)\",\n          border: \"var(--destructive-border)\",\n        },\n        ring: \"hsl(var(--ring) / <alpha-value>)\",\n        chart: {\n          \"1\": \"hsl(var(--chart-1) / <alpha-value>)\",\n          \"2\": \"hsl(var(--chart-2) / <alpha-value>)\",\n          \"3\": \"hsl(var(--chart-3) / <alpha-value>)\",\n          \"4\": \"hsl(var(--chart-4) / <alpha-value>)\",\n          \"5\": \"hsl(var(--chart-5) / <alpha-value>)\",\n        },\n        sidebar: {\n          ring: \"hsl(var(--sidebar-ring) / <alpha-value>)\",\n          DEFAULT: \"hsl(var(--sidebar) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--sidebar-border) / <alpha-value>)\",\n        },\n        \"sidebar-primary\": {\n          DEFAULT: \"hsl(var(--sidebar-primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-primary-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-primary-border)\",\n        },\n        \"sidebar-accent\": {\n          DEFAULT: \"hsl(var(--sidebar-accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-accent-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-accent-border)\"\n        },\n        status: {\n          online: \"rgb(34 197 94)\",\n          away: \"rgb(245 158 11)\",\n          busy: \"rgb(239 68 68)\",\n          offline: \"rgb(156 163 175)\",\n        },\n      },\n      fontFamily: {\n        sans: [\"var(--font-sans)\"],\n        serif: [\"var(--font-serif)\"],\n        mono: [\"var(--font-mono)\"],\n        display: [\"var(--font-display)\"],\n      },\n      keyframes: {\n        \"accordion-down\": {\n          from: { height: \"0\" },\n          to: { height: \"var(--radix-accordion-content-height)\" },\n        },\n        \"accordion-up\": {\n          from: { height: \"var(--radix-accordion-content-height)\" },\n          to: { height: \"0\" },\n        },\n      },\n      animation: {\n        \"accordion-down\": \"accordion-down 0.2s ease-out\",\n        \"accordion-up\": \"accordion-up 0.2s ease-out\",\n      },\n    },\n  },\n  plugins: [require(\"tailwindcss-animate\"), require(\"@tailwindcss/typography\")],\n} satisfies Config;\n","size_bytes":4092},"client/src/components/examples/CharacterInput.tsx":{"content":"import CharacterInput from \"../CharacterInput\";\nimport { useState } from \"react\";\n\nexport default function CharacterInputExample() {\n  const [character, setCharacter] = useState({\n    id: \"1\",\n    name: \"Max the Motivator\",\n    description: \"A majestic golden-maned lion with incredible energy\",\n  });\n\n  return (\n    <div className=\"max-w-2xl p-4\">\n      <CharacterInput\n        character={character}\n        onUpdate={setCharacter}\n        onRemove={() => console.log(\"Remove character\")}\n        canRemove={true}\n      />\n    </div>\n  );\n}\n","size_bytes":543},"client/src/components/ui/resizable.tsx":{"content":"\"use client\"\n\nimport { GripVertical } from \"lucide-react\"\nimport * as ResizablePrimitive from \"react-resizable-panels\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ResizablePanelGroup = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (\n  <ResizablePrimitive.PanelGroup\n    className={cn(\n      \"flex h-full w-full data-[panel-group-direction=vertical]:flex-col\",\n      className\n    )}\n    {...props}\n  />\n)\n\nconst ResizablePanel = ResizablePrimitive.Panel\n\nconst ResizableHandle = ({\n  withHandle,\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {\n  withHandle?: boolean\n}) => (\n  <ResizablePrimitive.PanelResizeHandle\n    className={cn(\n      \"relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90\",\n      className\n    )}\n    {...props}\n  >\n    {withHandle && (\n      <div className=\"z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border\">\n        <GripVertical className=\"h-2.5 w-2.5\" />\n      </div>\n    )}\n  </ResizablePrimitive.PanelResizeHandle>\n)\n\nexport { ResizablePanelGroup, ResizablePanel, ResizableHandle }\n","size_bytes":1723},"client/src/components/ui/command.tsx":{"content":"import * as React from \"react\"\nimport { type DialogProps } from \"@radix-ui/react-dialog\"\nimport { Command as CommandPrimitive } from \"cmdk\"\nimport { Search } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\"\n\nconst Command = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nCommand.displayName = CommandPrimitive.displayName\n\nconst CommandDialog = ({ children, ...props }: DialogProps) => {\n  return (\n    <Dialog {...props}>\n      <DialogContent className=\"overflow-hidden p-0 shadow-lg\">\n        <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n          {children}\n        </Command>\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nconst CommandInput = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Input>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\n>(({ className, ...props }, ref) => (\n  <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\n    <CommandPrimitive.Input\n      ref={ref}\n      className={cn(\n        \"flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.List\n    ref={ref}\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n    {...props}\n  />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Empty>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\n>((props, ref) => (\n  <CommandPrimitive.Empty\n    ref={ref}\n    className=\"py-6 text-center text-sm\"\n    {...props}\n  />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Group>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Group\n    ref={ref}\n    className={cn(\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nCommandShortcut.displayName = \"CommandShortcut\"\n\nexport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n}\n","size_bytes":4885},"client/src/components/SceneCard.tsx":{"content":"import { Card } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Camera, MessageSquare, Music, Volume2, ArrowRight } from \"lucide-react\";\nimport type { Scene } from \"@shared/schema\";\n\ninterface SceneCardProps {\n  scene: Scene;\n}\n\nexport default function SceneCard({ scene }: SceneCardProps) {\n  const parseDescription = (description: string) => {\n    const sections = {\n      visuals: \"\",\n      dialogue_action: \"\",\n      music: \"\",\n      sound_effects: \"\",\n      transition: \"\"\n    };\n\n    const lines = description.split('\\n');\n    lines.forEach(line => {\n      if (line.startsWith('visuals:')) {\n        sections.visuals = line.replace('visuals:', '').trim();\n      } else if (line.startsWith('dialogue_action:')) {\n        sections.dialogue_action = line.replace('dialogue_action:', '').trim();\n      } else if (line.startsWith('music:')) {\n        sections.music = line.replace('music:', '').trim();\n      } else if (line.startsWith('sound_effects:')) {\n        sections.sound_effects = line.replace('sound_effects:', '').trim();\n      } else if (line.startsWith('transition:')) {\n        sections.transition = line.replace('transition:', '').trim();\n      }\n    });\n\n    return sections;\n  };\n\n  const sections = parseDescription(scene.description);\n\n  return (\n    <Card className=\"p-6 hover-elevate transition-all\" data-testid={`card-scene-${scene.scene}`}>\n      <div className=\"flex items-start justify-between gap-4 mb-4\">\n        <div className=\"flex-1\">\n          <div className=\"flex items-center gap-2 mb-2\">\n            <Badge variant=\"default\" className=\"text-xs\">\n              Scene {scene.scene}\n            </Badge>\n          </div>\n          <h3 className=\"text-lg font-semibold\" data-testid={`text-scene-title-${scene.scene}`}>\n            {scene.title}\n          </h3>\n        </div>\n      </div>\n\n      <div className=\"space-y-4\">\n        {sections.visuals && (\n          <div className=\"space-y-2\">\n            <div className=\"flex items-center gap-2 text-sm font-medium text-muted-foreground\">\n              <Camera className=\"w-4 h-4 text-primary\" />\n              <span>Visuals</span>\n            </div>\n            <p className=\"text-sm leading-relaxed pl-6\">\n              {sections.visuals}\n            </p>\n          </div>\n        )}\n\n        {sections.dialogue_action && sections.dialogue_action !== \"N/A\" && (\n          <div className=\"space-y-2\">\n            <div className=\"flex items-center gap-2 text-sm font-medium text-muted-foreground\">\n              <MessageSquare className=\"w-4 h-4 text-primary\" />\n              <span>Dialogue & Action</span>\n            </div>\n            <p className=\"text-sm leading-relaxed pl-6\">\n              {sections.dialogue_action}\n            </p>\n          </div>\n        )}\n\n        {sections.music && (\n          <div className=\"space-y-2\">\n            <div className=\"flex items-center gap-2 text-sm font-medium text-muted-foreground\">\n              <Music className=\"w-4 h-4 text-primary\" />\n              <span>Music</span>\n            </div>\n            <p className=\"text-sm leading-relaxed pl-6\">\n              {sections.music}\n            </p>\n          </div>\n        )}\n\n        {sections.sound_effects && (\n          <div className=\"space-y-2\">\n            <div className=\"flex items-center gap-2 text-sm font-medium text-muted-foreground\">\n              <Volume2 className=\"w-4 h-4 text-primary\" />\n              <span>Sound Effects</span>\n            </div>\n            <p className=\"text-sm leading-relaxed pl-6\">\n              {sections.sound_effects}\n            </p>\n          </div>\n        )}\n\n        {sections.transition && (\n          <div className=\"space-y-2\">\n            <div className=\"flex items-center gap-2 text-sm font-medium text-muted-foreground\">\n              <ArrowRight className=\"w-4 h-4 text-primary\" />\n              <span>Transition</span>\n            </div>\n            <p className=\"text-sm leading-relaxed pl-6\">\n              {sections.transition}\n            </p>\n          </div>\n        )}\n      </div>\n    </Card>\n  );\n}\n","size_bytes":4084},"client/src/components/ui/menubar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as MenubarPrimitive from \"@radix-ui/react-menubar\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction MenubarMenu({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {\n  return <MenubarPrimitive.Menu {...props} />\n}\n\nfunction MenubarGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Group>) {\n  return <MenubarPrimitive.Group {...props} />\n}\n\nfunction MenubarPortal({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {\n  return <MenubarPrimitive.Portal {...props} />\n}\n\nfunction MenubarRadioGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {\n  return <MenubarPrimitive.RadioGroup {...props} />\n}\n\nfunction MenubarSub({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {\n  return <MenubarPrimitive.Sub data-slot=\"menubar-sub\" {...props} />\n}\n\nconst Menubar = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"flex h-10 items-center space-x-1 rounded-md border bg-background p-1\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubar.displayName = MenubarPrimitive.Root.displayName\n\nconst MenubarTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName\n\nconst MenubarSubTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <MenubarPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </MenubarPrimitive.SubTrigger>\n))\nMenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName\n\nconst MenubarSubContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName\n\nconst MenubarContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>\n>(\n  (\n    { className, align = \"start\", alignOffset = -4, sideOffset = 8, ...props },\n    ref\n  ) => (\n    <MenubarPrimitive.Portal>\n      <MenubarPrimitive.Content\n        ref={ref}\n        align={align}\n        alignOffset={alignOffset}\n        sideOffset={sideOffset}\n        className={cn(\n          \"z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n          className\n        )}\n        {...props}\n      />\n    </MenubarPrimitive.Portal>\n  )\n)\nMenubarContent.displayName = MenubarPrimitive.Content.displayName\n\nconst MenubarItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarItem.displayName = MenubarPrimitive.Item.displayName\n\nconst MenubarCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <MenubarPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.CheckboxItem>\n))\nMenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName\n\nconst MenubarRadioItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <MenubarPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.RadioItem>\n))\nMenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName\n\nconst MenubarLabel = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarLabel.displayName = MenubarPrimitive.Label.displayName\n\nconst MenubarSeparator = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nMenubarSeparator.displayName = MenubarPrimitive.Separator.displayName\n\nconst MenubarShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nMenubarShortcut.displayname = \"MenubarShortcut\"\n\nexport {\n  Menubar,\n  MenubarMenu,\n  MenubarTrigger,\n  MenubarContent,\n  MenubarItem,\n  MenubarSeparator,\n  MenubarLabel,\n  MenubarCheckboxItem,\n  MenubarRadioGroup,\n  MenubarRadioItem,\n  MenubarPortal,\n  MenubarSubContent,\n  MenubarSubTrigger,\n  MenubarGroup,\n  MenubarSub,\n  MenubarShortcut,\n}\n","size_bytes":8605},"client/src/pages/ProjectDetail.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { useRoute, Link } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Loader2, Home, ArrowLeft, Download } from \"lucide-react\";\nimport type { Project, Character, Scene } from \"@shared/schema\";\nimport SceneCard from \"@/components/SceneCard\";\n\nexport default function ProjectDetail() {\n  const [, params] = useRoute(\"/projects/:id\");\n  const projectId = params?.id;\n\n  const { data, isLoading, error } = useQuery<{ project: Project }>({\n    queryKey: [`/api/projects/${projectId}`],\n    enabled: !!projectId,\n  });\n\n  const parseJSON = <T,>(jsonString: string, fallback: T): T => {\n    try {\n      return JSON.parse(jsonString);\n    } catch {\n      return fallback;\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-br from-[#1a2332] via-[#1e2838] to-[#242d3f] flex items-center justify-center\">\n        <Loader2 className=\"w-8 h-8 animate-spin text-purple-400\" />\n      </div>\n    );\n  }\n\n  if (error || !data?.project) {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-br from-[#1a2332] via-[#1e2838] to-[#242d3f] flex items-center justify-center\">\n        <Card className=\"p-8 text-center bg-[#1e2838] border-white/10\">\n          <p className=\"text-red-400 mb-4\">Project not found</p>\n          <Link href=\"/projects\">\n            <Button className=\"bg-purple-600 hover:bg-purple-700\">Back to Projects</Button>\n          </Link>\n        </Card>\n      </div>\n    );\n  }\n\n  const project = data.project;\n  const characters = parseJSON<Character[]>(project.characters, []);\n  const scenes = parseJSON<Scene[]>(project.scenes, []);\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-[#1a2332] via-[#1e2838] to-[#242d3f] dark:from-[#141a25] dark:via-[#181e2a] dark:to-[#1c2230]\">\n      <header className=\"border-b border-white/10 bg-[#1c2534]/80 dark:bg-[#161c28]/80 backdrop-blur-md sticky top-0 z-50\">\n        <div className=\"max-w-7xl mx-auto px-3 sm:px-4 py-2 sm:py-3 flex justify-between items-center\">\n          <h1 className=\"text-sm sm:text-base md:text-lg font-semibold text-white truncate\">{project.title}</h1>\n          <div className=\"flex gap-2\">\n            <Link href=\"/projects\">\n              <Button variant=\"outline\" size=\"sm\" className=\"border-white/20 text-white hover:bg-white/10\" data-testid=\"link-back\">\n                <ArrowLeft className=\"w-4 h-4 sm:mr-1\" />\n                <span className=\"hidden sm:inline\">Back</span>\n              </Button>\n            </Link>\n            <Link href=\"/\">\n              <Button variant=\"outline\" size=\"sm\" className=\"border-white/20 text-white hover:bg-white/10\" data-testid=\"link-home\">\n                <Home className=\"w-4 h-4 sm:mr-1\" />\n                <span className=\"hidden sm:inline\">Home</span>\n              </Button>\n            </Link>\n          </div>\n        </div>\n      </header>\n\n      <div className=\"max-w-6xl mx-auto px-3 sm:px-4 py-4 sm:py-8\">\n        <div className=\"space-y-6\">\n          <Card className=\"bg-[#1e2838] dark:bg-[#181e2a] border border-white/10\">\n            <CardHeader>\n              <CardTitle className=\"text-white\">Story Script</CardTitle>\n              <CardDescription className=\"text-gray-300\">The original story script for this project</CardDescription>\n            </CardHeader>\n            <CardContent>\n              <p className=\"text-sm sm:text-base whitespace-pre-wrap text-gray-200\">{project.script}</p>\n            </CardContent>\n          </Card>\n\n          <Card className=\"bg-[#1e2838] dark:bg-[#181e2a] border border-white/10\">\n            <CardHeader>\n              <CardTitle className=\"text-white\">Characters ({characters.length})</CardTitle>\n              <CardDescription className=\"text-gray-300\">Characters in this story</CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-3\">\n              {characters.map((char, idx) => (\n                <div key={idx} className=\"border-l-4 border-purple-500 pl-4\">\n                  <h4 className=\"font-semibold text-white\">{char.name}</h4>\n                  <p className=\"text-sm text-gray-300\">{char.description}</p>\n                </div>\n              ))}\n            </CardContent>\n          </Card>\n\n          {project.mergedVideoUrl && (\n            <Card className=\"bg-[#1e2838] dark:bg-[#181e2a] border border-white/10\">\n              <CardHeader>\n                <CardTitle className=\"text-white\">Merged Video</CardTitle>\n                <CardDescription className=\"text-gray-300\">The complete story video combining all scenes</CardDescription>\n              </CardHeader>\n              <CardContent>\n                <div className=\"w-full\">\n                  <video \n                    key={project.mergedVideoUrl}\n                    controls \n                    className=\"w-full rounded-lg shadow-lg\"\n                    data-testid=\"video-merged\"\n                  >\n                    <source src={project.mergedVideoUrl} type=\"video/mp4\" />\n                    Your browser does not support the video tag.\n                  </video>\n                  <div className=\"mt-4 flex flex-col sm:flex-row gap-2\">\n                    <Button\n                      onClick={() => {\n                        const link = document.createElement('a');\n                        link.href = project.mergedVideoUrl!;\n                        link.download = `${project.title}-merged.mp4`;\n                        link.click();\n                      }}\n                      data-testid=\"button-download-merged\"\n                      className=\"w-full sm:w-auto bg-purple-600 hover:bg-purple-700\"\n                    >\n                      <Download className=\"w-4 h-4 mr-2\" />\n                      Download Merged Video\n                    </Button>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          )}\n\n          <div>\n            <h2 className=\"text-2xl font-bold mb-4 text-white\">Generated Scenes ({scenes.length})</h2>\n            <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6\">\n              {scenes.map((scene) => (\n                <SceneCard key={scene.scene} scene={scene} />\n              ))}\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","size_bytes":6414},"client/src/components/ui/toast.tsx":{"content":"import * as React from \"react\"\nimport * as ToastPrimitives from \"@radix-ui/react-toast\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ToastProvider = ToastPrimitives.Provider\n\nconst ToastViewport = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Viewport>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Viewport\n    ref={ref}\n    className={cn(\n      \"fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]\",\n      className\n    )}\n    {...props}\n  />\n))\nToastViewport.displayName = ToastPrimitives.Viewport.displayName\n\nconst toastVariants = cva(\n  \"group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full\",\n  {\n    variants: {\n      variant: {\n        default: \"border bg-background text-foreground\",\n        destructive:\n          \"destructive group border-destructive bg-destructive text-destructive-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Toast = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &\n    VariantProps<typeof toastVariants>\n>(({ className, variant, ...props }, ref) => {\n  return (\n    <ToastPrimitives.Root\n      ref={ref}\n      className={cn(toastVariants({ variant }), className)}\n      {...props}\n    />\n  )\n})\nToast.displayName = ToastPrimitives.Root.displayName\n\nconst ToastAction = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Action>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Action\n    ref={ref}\n    className={cn(\n      \"inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive\",\n      className\n    )}\n    {...props}\n  />\n))\nToastAction.displayName = ToastPrimitives.Action.displayName\n\nconst ToastClose = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Close>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Close\n    ref={ref}\n    className={cn(\n      \"absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600\",\n      className\n    )}\n    toast-close=\"\"\n    {...props}\n  >\n    <X className=\"h-4 w-4\" />\n  </ToastPrimitives.Close>\n))\nToastClose.displayName = ToastPrimitives.Close.displayName\n\nconst ToastTitle = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Title>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Title\n    ref={ref}\n    className={cn(\"text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nToastTitle.displayName = ToastPrimitives.Title.displayName\n\nconst ToastDescription = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Description>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Description\n    ref={ref}\n    className={cn(\"text-sm opacity-90\", className)}\n    {...props}\n  />\n))\nToastDescription.displayName = ToastPrimitives.Description.displayName\n\ntype ToastProps = React.ComponentPropsWithoutRef<typeof Toast>\n\ntype ToastActionElement = React.ReactElement<typeof ToastAction>\n\nexport {\n  type ToastProps,\n  type ToastActionElement,\n  ToastProvider,\n  ToastViewport,\n  Toast,\n  ToastTitle,\n  ToastDescription,\n  ToastClose,\n  ToastAction,\n}\n","size_bytes":4845},"client/src/components/ui/input.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Input = React.forwardRef<HTMLInputElement, React.ComponentProps<\"input\">>(\n  ({ className, type, ...props }, ref) => {\n    // h-9 to match icon buttons and default buttons.\n    return (\n      <input\n        type={type}\n        className={cn(\n          \"flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nInput.displayName = \"Input\"\n\nexport { Input }\n","size_bytes":844},"client/src/components/ui/collapsible.tsx":{"content":"\"use client\"\n\nimport * as CollapsiblePrimitive from \"@radix-ui/react-collapsible\"\n\nconst Collapsible = CollapsiblePrimitive.Root\n\nconst CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger\n\nconst CollapsibleContent = CollapsiblePrimitive.CollapsibleContent\n\nexport { Collapsible, CollapsibleTrigger, CollapsibleContent }\n","size_bytes":329},"server/googleDrive.ts":{"content":"// Google Drive video upload utility\n// Uploads large merged videos to Google Drive\n\nimport { google } from 'googleapis';\nimport { createReadStream } from 'fs';\nimport { readFile } from 'fs/promises';\n\ninterface UploadResult {\n  id: string;\n  webViewLink: string;\n  webContentLink: string;\n}\n\n/**\n * Upload a video file to Google Drive\n * @param filePath Local path to the video file\n * @param fileName Name for the file in Google Drive\n * @returns Object containing file ID and shareable link\n */\nexport async function uploadVideoToGoogleDrive(\n  filePath: string,\n  fileName: string = 'merged-video.mp4'\n): Promise<UploadResult> {\n  try {\n    console.log('[Google Drive] Starting upload from local file:', filePath);\n    \n    // Parse Google Drive credentials from environment\n    const credentials = process.env.GOOGLE_DRIVE_CREDENTIALS;\n    if (!credentials) {\n      throw new Error('GOOGLE_DRIVE_CREDENTIALS environment variable is not set');\n    }\n\n    let credentialsJson;\n    try {\n      credentialsJson = JSON.parse(credentials);\n    } catch (error) {\n      throw new Error(`Failed to parse Google Drive credentials: ${error instanceof Error ? error.message : 'Unknown error'}`);\n    }\n\n    // Create auth client\n    const auth = new google.auth.GoogleAuth({\n      credentials: credentialsJson,\n      scopes: ['https://www.googleapis.com/auth/drive.file'],\n    });\n\n    const drive = google.drive({ version: 'v3', auth });\n\n    // Get file stats\n    const fileBuffer = await readFile(filePath);\n    console.log('[Google Drive] File size:', fileBuffer.byteLength, 'bytes');\n\n    // Create file metadata\n    const fileMetadata = {\n      name: fileName,\n      mimeType: 'video/mp4',\n    };\n\n    // Upload the file\n    console.log('[Google Drive] Uploading to Google Drive...');\n    const response = await drive.files.create({\n      requestBody: fileMetadata,\n      media: {\n        mimeType: 'video/mp4',\n        body: createReadStream(filePath),\n      },\n      fields: 'id, webViewLink, webContentLink',\n    });\n\n    const fileId = response.data.id;\n    if (!fileId) {\n      throw new Error('Failed to get file ID from Google Drive');\n    }\n\n    console.log('[Google Drive] Upload successful! File ID:', fileId);\n\n    // Make the file publicly accessible\n    await drive.permissions.create({\n      fileId,\n      requestBody: {\n        role: 'reader',\n        type: 'anyone',\n      },\n    });\n\n    console.log('[Google Drive] File set to public access');\n\n    // Get the direct download link\n    const file = await drive.files.get({\n      fileId,\n      fields: 'webViewLink, webContentLink',\n    });\n\n    return {\n      id: fileId,\n      webViewLink: file.data.webViewLink || '',\n      webContentLink: file.data.webContentLink || '',\n    };\n  } catch (error) {\n    console.error('[Google Drive] Upload error:', error);\n    throw new Error(\n      `Failed to upload video to Google Drive: ${error instanceof Error ? error.message : 'Unknown error'}`\n    );\n  }\n}\n\n/**\n * Get a direct download link for a Google Drive file\n * @param fileId Google Drive file ID\n * @returns Direct download URL\n */\nexport function getDirectDownloadLink(fileId: string): string {\n  return `https://drive.google.com/uc?export=download&id=${fileId}`;\n}\n","size_bytes":3235},"client/src/components/ui/label.tsx":{"content":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n    VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(labelVariants(), className)}\n    {...props}\n  />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","size_bytes":710},"client/src/components/ui/popover.tsx":{"content":"import * as React from \"react\"\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Popover = PopoverPrimitive.Root\n\nconst PopoverTrigger = PopoverPrimitive.Trigger\n\nconst PopoverContent = React.forwardRef<\n  React.ElementRef<typeof PopoverPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <PopoverPrimitive.Portal>\n    <PopoverPrimitive.Content\n      ref={ref}\n      align={align}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </PopoverPrimitive.Portal>\n))\nPopoverContent.displayName = PopoverPrimitive.Content.displayName\n\nexport { Popover, PopoverTrigger, PopoverContent }\n","size_bytes":1280},"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","size_bytes":80},"client/src/components/VideoGenerationProgress.tsx":{"content":"import { Card } from \"@/components/ui/card\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { CheckCircle2, Loader2, Video, AlertCircle } from \"lucide-react\";\n\ninterface VideoProgress {\n  sceneNumber: number;\n  sceneTitle: string;\n  status: 'pending' | 'starting' | 'generating' | 'completed' | 'failed';\n  videoUrl?: string;\n  error?: string;\n  message?: string;\n  timestamp?: string;\n}\n\ninterface VideoGenerationProgressProps {\n  progress: VideoProgress[];\n  currentScene: number;\n  totalScenes: number;\n}\n\nexport default function VideoGenerationProgress({ \n  progress, \n  currentScene, \n  totalScenes \n}: VideoGenerationProgressProps) {\n  const percentage = (currentScene / totalScenes) * 100;\n\n  return (\n    <div className=\"max-w-4xl mx-auto px-4 py-8\">\n      <div className=\"text-center mb-8\">\n        <h2 className=\"text-3xl font-bold mb-2\">Generating Videos</h2>\n        <p className=\"text-muted-foreground\">\n          Processing scene {currentScene} of {totalScenes}\n        </p>\n      </div>\n\n      <Card className=\"p-6 mb-6\">\n        <div className=\"space-y-2\">\n          <div className=\"flex justify-between text-sm\">\n            <span className=\"font-medium\">Overall Progress</span>\n            <span className=\"text-muted-foreground\">\n              {Math.round(percentage)}%\n            </span>\n          </div>\n          <Progress value={percentage} className=\"h-3\" />\n        </div>\n      </Card>\n\n      <div className=\"space-y-4\">\n        {progress.map((item) => (\n          <Card \n            key={item.sceneNumber} \n            className=\"p-4\"\n            data-testid={`video-progress-${item.sceneNumber}`}\n          >\n            <div className=\"flex items-center gap-4\">\n              <div className=\"flex-shrink-0\">\n                {item.status === 'completed' && (\n                  <CheckCircle2 className=\"w-6 h-6 text-green-500\" />\n                )}\n                {(item.status === 'generating' || item.status === 'starting') && (\n                  <Loader2 className=\"w-6 h-6 text-primary animate-spin\" />\n                )}\n                {item.status === 'pending' && (\n                  <Video className=\"w-6 h-6 text-muted-foreground\" />\n                )}\n                {item.status === 'failed' && (\n                  <AlertCircle className=\"w-6 h-6 text-destructive\" />\n                )}\n              </div>\n\n              <div className=\"flex-1\">\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"flex-1\">\n                    <h3 className=\"font-semibold\">\n                      Scene {item.sceneNumber}: {item.sceneTitle}\n                    </h3>\n                    <p className=\"text-sm text-muted-foreground\">\n                      {item.message || (\n                        <>\n                          {item.status === 'starting' && 'Preparing video...'}\n                          {item.status === 'generating' && 'Generating video...'}\n                          {item.status === 'completed' && 'Video ready'}\n                          {item.status === 'pending' && 'Waiting...'}\n                          {item.status === 'failed' && `Failed: ${item.error}`}\n                        </>\n                      )}\n                    </p>\n                    {item.timestamp && (\n                      <p className=\"text-xs text-muted-foreground/60 mt-1\">\n                        {new Date(item.timestamp).toLocaleTimeString()}\n                      </p>\n                    )}\n                  </div>\n                </div>\n              </div>\n            </div>\n          </Card>\n        ))}\n      </div>\n    </div>\n  );\n}\n","size_bytes":3641},"vite.config.ts":{"content":"import { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\nimport path from \"path\";\nimport runtimeErrorOverlay from \"@replit/vite-plugin-runtime-error-modal\";\n\nexport default defineConfig({\n  plugins: [\n    react(),\n    runtimeErrorOverlay(),\n    ...(process.env.NODE_ENV !== \"production\" &&\n    process.env.REPL_ID !== undefined\n      ? [\n          await import(\"@replit/vite-plugin-cartographer\").then((m) =>\n            m.cartographer(),\n          ),\n          await import(\"@replit/vite-plugin-dev-banner\").then((m) =>\n            m.devBanner(),\n          ),\n        ]\n      : []),\n  ],\n  resolve: {\n    alias: {\n      \"@\": path.resolve(import.meta.dirname, \"client\", \"src\"),\n      \"@shared\": path.resolve(import.meta.dirname, \"shared\"),\n      \"@assets\": path.resolve(import.meta.dirname, \"attached_assets\"),\n    },\n  },\n  root: path.resolve(import.meta.dirname, \"client\"),\n  build: {\n    outDir: path.resolve(import.meta.dirname, \"dist/public\"),\n    emptyOutDir: true,\n  },\n  server: {\n    fs: {\n      strict: true,\n      deny: [\"**/.*\"],\n    },\n  },\n});\n","size_bytes":1080},"client/src/components/ui/button.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\" +\n  \" hover-elevate active-elevate-2\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"bg-primary text-primary-foreground border border-primary-border\",\n        destructive:\n          \"bg-destructive text-destructive-foreground border border-destructive-border\",\n        outline:\n          // Shows the background color of whatever card / sidebar / accent background it is inside of.\n          // Inherits the current text color.\n          \" border [border-color:var(--button-outline)]  shadow-xs active:shadow-none \",\n        secondary: \"border bg-secondary text-secondary-foreground border border-secondary-border \",\n        // Add a transparent border so that when someone toggles a border on later, it doesn't shift layout/size.\n        ghost: \"border border-transparent\",\n      },\n      // Heights are set as \"min\" heights, because sometimes Ai will place large amount of content\n      // inside buttons. With a min-height they will look appropriate with small amounts of content,\n      // but will expand to fit large amounts of content.\n      size: {\n        default: \"min-h-9 px-4 py-2\",\n        sm: \"min-h-8 rounded-md px-3 text-xs\",\n        lg: \"min-h-10 rounded-md px-8\",\n        icon: \"h-9 w-9\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  },\n)\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\"\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    )\n  },\n)\nButton.displayName = \"Button\"\n\nexport { Button, buttonVariants }\n","size_bytes":2359},"client/src/components/ui/navigation-menu.tsx":{"content":"import * as React from \"react\"\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\"\nimport { cva } from \"class-variance-authority\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst NavigationMenu = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <NavigationMenuViewport />\n  </NavigationMenuPrimitive.Root>\n))\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\n\nconst NavigationMenuList = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.List\n    ref={ref}\n    className={cn(\n      \"group flex flex-1 list-none items-center justify-center space-x-1\",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\n\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\n\nconst navigationMenuTriggerStyle = cva(\n  \"group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[state=open]:text-accent-foreground data-[state=open]:bg-accent/50 data-[state=open]:hover:bg-accent data-[state=open]:focus:bg-accent\"\n)\n\nconst NavigationMenuTrigger = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Trigger\n    ref={ref}\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\n    {...props}\n  >\n    {children}{\" \"}\n    <ChevronDown\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180\"\n      aria-hidden=\"true\"\n    />\n  </NavigationMenuPrimitive.Trigger>\n))\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\n\nconst NavigationMenuContent = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto \",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\n\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\n\nconst NavigationMenuViewport = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\n>(({ className, ...props }, ref) => (\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\n    <NavigationMenuPrimitive.Viewport\n      className={cn(\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  </div>\n))\nNavigationMenuViewport.displayName =\n  NavigationMenuPrimitive.Viewport.displayName\n\nconst NavigationMenuIndicator = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Indicator\n    ref={ref}\n    className={cn(\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\n      className\n    )}\n    {...props}\n  >\n    <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\n  </NavigationMenuPrimitive.Indicator>\n))\nNavigationMenuIndicator.displayName =\n  NavigationMenuPrimitive.Indicator.displayName\n\nexport {\n  navigationMenuTriggerStyle,\n  NavigationMenu,\n  NavigationMenuList,\n  NavigationMenuItem,\n  NavigationMenuContent,\n  NavigationMenuTrigger,\n  NavigationMenuLink,\n  NavigationMenuIndicator,\n  NavigationMenuViewport,\n}\n","size_bytes":5128},"server/gemini.ts":{"content":"// Blueprint: javascript_gemini\nimport { GoogleGenAI } from \"@google/genai\";\nimport type { Scene, StoryInput } from \"@shared/schema\";\n\nconst ai = new GoogleGenAI({ apiKey: process.env.GEMINI_API_KEY || \"\" });\n\nconst MIN_ACCEPTABLE_SCENES = 5;\nconst MAX_RETRY_ATTEMPTS = 3;\n\nasync function attemptSceneGeneration(storyInput: StoryInput): Promise<Scene[]> {\n  try {\n    // Build character descriptions\n    const characterDescriptions = storyInput.characters\n      .map(char => `${char.name}: ${char.description}`)\n      .join('\\n');\n\n    const systemPrompt = `You are a Cartoon Scene Director AI optimized for generating short, cinematic 8-second animated scenes for Veo 3 or similar video-generation tools.\n\nYour job is to read a long cartoon script and output a list of scenes. Each scene should be brief, action-focused.\n\n---\n\n### OUTPUT REQUIREMENTS:\n\n1. Output a JSON array of scenes\n2. **Each scene should last about 8 seconds** and include:\n   - scene: scene number (integer)\n   - title: brief scene title\n   - description: containing following elements separated by newlines:\n     - visuals: camera and setting description\n     - dialogue_action: 1–2 lines of short dialogue or main action\n     - music: a brief background music suggestion (tone, mood, instruments)\n     - sound_effects: list of 1–3 matching SFX\n     - transition: how the clip moves to the next (fade, cut, zoom, etc.)\n\n3. **Scene style:** colorful, cinematic, and cartoonish — inspired by Pixar or DreamWorks 3D animation.\n\n4. **Scene splitting:** If the script is long, make more scenes instead of longer ones. Each scene should describe a single emotional beat or visual moment. Create as many scenes as needed (up to 70 if the script is long enough).\n\n---\n\nCharacters:\n${characterDescriptions}\n\nStory Script:\n${storyInput.script}\n\nGenerate as many detailed scenes as you can from the above script.`;\n\n    const response = await ai.models.generateContent({\n      model: \"gemini-2.5-flash\",\n      config: {\n        systemInstruction: systemPrompt,\n        responseMimeType: \"application/json\",\n        responseSchema: {\n          type: \"array\",\n          items: {\n            type: \"object\",\n            properties: {\n              scene: { type: \"number\" },\n              title: { type: \"string\" },\n              description: { type: \"string\" },\n            },\n            required: [\"scene\", \"title\", \"description\"],\n          },\n        },\n      },\n      contents: \"Generate the scenes now.\",\n    });\n\n    const rawJson = response.text || \"\";\n\n    if (!rawJson) {\n      throw new Error(\"Empty response from Gemini\");\n    }\n\n    const parsedScenes = JSON.parse(rawJson);\n    \n    // Validate that the response is an array\n    if (!Array.isArray(parsedScenes)) {\n      throw new Error(\"Invalid response format: expected array of scenes\");\n    }\n\n    // Validate each scene matches the schema\n    const scenes: Scene[] = parsedScenes.map((scene, index) => {\n      if (typeof scene.scene !== 'number' || typeof scene.title !== 'string' || typeof scene.description !== 'string') {\n        throw new Error(`Invalid scene format at index ${index}`);\n      }\n      return {\n        scene: scene.scene,\n        title: scene.title,\n        description: scene.description,\n      };\n    });\n\n    return scenes;\n  } catch (error) {\n    console.error(\"Error generating scenes:\", error);\n    throw error;\n  }\n}\n\nexport async function generateScenes(storyInput: StoryInput): Promise<Scene[]> {\n  let lastError: Error | null = null;\n  \n  for (let attempt = 1; attempt <= MAX_RETRY_ATTEMPTS; attempt++) {\n    try {\n      console.log(`Scene generation attempt ${attempt}/${MAX_RETRY_ATTEMPTS}`);\n      \n      const scenes = await attemptSceneGeneration(storyInput);\n      \n      // Check if we got enough scenes\n      if (scenes.length < MIN_ACCEPTABLE_SCENES) {\n        console.log(`Generated only ${scenes.length} scenes, retrying for more...`);\n        lastError = new Error(`Insufficient scenes: got ${scenes.length}, need at least ${MIN_ACCEPTABLE_SCENES}`);\n        \n        // If this is the last attempt, throw error instead of continuing\n        if (attempt >= MAX_RETRY_ATTEMPTS) {\n          throw lastError;\n        }\n        \n        // Wait and retry\n        await new Promise(resolve => setTimeout(resolve, 1000 * attempt));\n        continue;\n      }\n      \n      // Success - we have enough scenes\n      console.log(`Successfully generated ${scenes.length} scenes on attempt ${attempt}`);\n      return scenes;\n      \n    } catch (error) {\n      lastError = error instanceof Error ? error : new Error(String(error));\n      console.error(`Attempt ${attempt} failed:`, lastError.message);\n      \n      // Only retry if not the last attempt\n      if (attempt < MAX_RETRY_ATTEMPTS) {\n        await new Promise(resolve => setTimeout(resolve, 1000 * attempt));\n        continue;\n      }\n    }\n  }\n  \n  // All attempts failed\n  throw new Error(`Failed to generate scenes after ${MAX_RETRY_ATTEMPTS} attempts: ${lastError?.message || 'Unknown error'}`);\n}\n\n/**\n * Generate script/storyboard using user's custom prompt template\n */\nexport async function generateScript(\n  storyAbout: string,\n  numberOfPrompts: number,\n  finalStep: string\n): Promise<string> {\n  try {\n    const prompt = `Output only paragraphs, with no need to label steps or prompts. Write a storyboard for an animated film about a ${storyAbout}, consisting of ${numberOfPrompts} steps. Each step should include an English prompt. The final step should ${finalStep}. Describe the animated character fully in English at the beginning, and repeat that full character description in each prompt (do not use pronouns or shorthand such as \"the same character\"). The purpose is to reinforce the character's identity in every scene.`;\n\n    const response = await ai.models.generateContent({\n      model: \"gemini-2.5-flash\",\n      config: {\n        systemInstruction: \"You are a creative screenwriter and storyboard artist. Generate detailed, vivid storyboards for animated films.\",\n      },\n      contents: prompt,\n    });\n\n    const storyboard = response.text || \"\";\n\n    if (!storyboard) {\n      throw new Error(\"Empty response from Gemini\");\n    }\n\n    return storyboard;\n  } catch (error) {\n    console.error(\"Script generation error:\", error);\n    throw new Error(`Failed to generate script: ${error instanceof Error ? error.message : String(error)}`);\n  }\n}\n","size_bytes":6396},"server/cloudinary.ts":{"content":"// Cloudinary video upload utility\n// Fetches video from VEO URL and uploads to Cloudinary\n\nimport { readFile } from 'fs/promises';\n\nconst CLOUDINARY_CLOUD_NAME = 'dy40igzli';\nconst CLOUDINARY_UPLOAD_PRESET = 'demo123';\nconst CLOUDINARY_UPLOAD_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/video/upload`;\n\ninterface CloudinaryUploadResponse {\n  secure_url: string;\n  public_id: string;\n  format: string;\n  duration: number;\n  width: number;\n  height: number;\n  url: string;\n}\n\nexport async function uploadVideoToCloudinary(videoUrlOrPath: string): Promise<string> {\n  try {\n    let videoBlob: Blob;\n    \n    // Check if it's a local file path or URL\n    if (videoUrlOrPath.startsWith('http://') || videoUrlOrPath.startsWith('https://')) {\n      // It's a URL - fetch from remote\n      console.log('[Cloudinary] Starting upload from URL:', videoUrlOrPath.substring(0, 100));\n      console.log('[Cloudinary] Fetching video from URL...');\n      const videoResponse = await fetch(videoUrlOrPath);\n      \n      if (!videoResponse.ok) {\n        throw new Error(`Failed to fetch video: ${videoResponse.statusText}`);\n      }\n\n      videoBlob = await videoResponse.blob();\n      console.log('[Cloudinary] Video fetched, size:', videoBlob.size, 'bytes');\n    } else {\n      // It's a local file path - read from disk and convert to Blob\n      console.log('[Cloudinary] Starting upload from local file:', videoUrlOrPath);\n      const fileBuffer = await readFile(videoUrlOrPath);\n      videoBlob = new Blob([fileBuffer], { type: 'video/mp4' });\n      console.log('[Cloudinary] File read, size:', videoBlob.size, 'bytes');\n    }\n\n    // Create FormData for Cloudinary upload\n    const formData = new FormData();\n    formData.append('file', videoBlob, 'video.mp4');\n    formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);\n\n    // Upload to Cloudinary\n    console.log('[Cloudinary] Uploading to Cloudinary...');\n    const uploadResponse = await fetch(CLOUDINARY_UPLOAD_URL, {\n      method: 'POST',\n      body: formData,\n    });\n\n    if (!uploadResponse.ok) {\n      const errorText = await uploadResponse.text();\n      throw new Error(`Cloudinary upload failed: ${uploadResponse.statusText} - ${errorText}`);\n    }\n\n    const result: CloudinaryUploadResponse = await uploadResponse.json();\n    console.log('[Cloudinary] Upload successful! URL:', result.secure_url);\n    \n    return result.secure_url;\n  } catch (error) {\n    console.error('[Cloudinary] Upload error:', error);\n    throw new Error(`Failed to upload video to Cloudinary: ${error instanceof Error ? error.message : 'Unknown error'}`);\n  }\n}\n","size_bytes":2616},"client/src/components/ProgressStepper.tsx":{"content":"import { Check } from \"lucide-react\";\n\ninterface Step {\n  id: number;\n  title: string;\n  description: string;\n}\n\ninterface ProgressStepperProps {\n  currentStep: number;\n  steps: Step[];\n}\n\nexport default function ProgressStepper({ currentStep, steps }: ProgressStepperProps) {\n  return (\n    <div className=\"sticky top-0 z-40 bg-[#1e2838]/90 dark:bg-[#181e2a]/90 backdrop-blur-md border-b border-white/10\">\n      <div className=\"max-w-4xl mx-auto px-4 py-6\">\n        <div className=\"flex items-center justify-between\">\n          {steps.map((step, index) => {\n            const isCompleted = currentStep > step.id;\n            const isCurrent = currentStep === step.id;\n            const isUpcoming = currentStep < step.id;\n            \n            return (\n              <div key={step.id} className=\"flex items-center flex-1\">\n                <div className=\"flex flex-col items-center flex-1\">\n                  <div className=\"flex items-center w-full\">\n                    <div \n                      className={`\n                        relative flex items-center justify-center w-10 h-10 md:w-12 md:h-12 rounded-full border-2 transition-all\n                        ${isCompleted ? \"bg-primary border-primary text-primary-foreground\" : \"\"}\n                        ${isCurrent ? \"bg-primary border-primary text-primary-foreground scale-110\" : \"\"}\n                        ${isUpcoming ? \"bg-white/5 border-white/20 text-gray-400\" : \"\"}\n                      `}\n                      data-testid={`step-indicator-${step.id}`}\n                    >\n                      {isCompleted ? (\n                        <Check className=\"w-5 h-5 md:w-6 md:h-6\" />\n                      ) : (\n                        <span className=\"font-semibold text-sm md:text-base\">{step.id}</span>\n                      )}\n                    </div>\n                    \n                    {index < steps.length - 1 && (\n                      <div className=\"flex-1 h-0.5 mx-2\">\n                        <div \n                          className={`h-full transition-all ${\n                            isCompleted ? \"bg-primary\" : \"bg-white/20\"\n                          }`}\n                        />\n                      </div>\n                    )}\n                  </div>\n                  \n                  <div className=\"mt-3 text-center hidden md:block\">\n                    <div className={`text-sm font-semibold ${isCurrent ? \"text-white\" : \"text-gray-300\"}`}>\n                      {step.title}\n                    </div>\n                    <div className=\"text-xs text-gray-400 mt-1\">\n                      {step.description}\n                    </div>\n                  </div>\n                </div>\n              </div>\n            );\n          })}\n        </div>\n      </div>\n    </div>\n  );\n}\n","size_bytes":2794},"client/src/components/ui/skeleton.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Skeleton({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) {\n  return (\n    <div\n      className={cn(\"animate-pulse rounded-md bg-muted\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Skeleton }\n","size_bytes":261},"client/src/components/ui/tooltip.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef<\n  React.ElementRef<typeof TooltipPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <TooltipPrimitive.Content\n    ref={ref}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }\n","size_bytes":1209},"client/src/components/Hero.tsx":{"content":"import { Button } from \"@/components/ui/button\";\nimport { Sparkles, Film, Wand2, Video, Layers, History } from \"lucide-react\";\n\ninterface HeroProps {\n  onGetStarted: () => void;\n}\n\nexport default function Hero({ onGetStarted }: HeroProps) {\n  return (\n    <div className=\"relative min-h-[600px] sm:min-h-[650px] md:min-h-[750px] w-full overflow-hidden bg-gradient-to-br from-[#1a2332] via-[#1e2838] to-[#242d3f] dark:from-[#141a25] dark:via-[#181e2a] dark:to-[#1c2230]\">\n      {/* Subtle background pattern */}\n      <div className=\"absolute inset-0 opacity-10\">\n        <div className=\"absolute inset-0 bg-[radial-gradient(circle_at_30%_20%,rgba(255,255,255,0.05),transparent_50%)]\" />\n        <div className=\"absolute inset-0 bg-[radial-gradient(circle_at_70%_80%,rgba(255,255,255,0.03),transparent_50%)]\" />\n      </div>\n      \n      <div className=\"relative z-10 flex flex-col items-center justify-center min-h-[600px] sm:min-h-[650px] md:min-h-[750px] px-4 text-center py-12\">\n        <div className=\"max-w-6xl animate-fade-in\">\n          {/* Icon badge */}\n          <div className=\"inline-flex items-center gap-2 px-5 py-2.5 rounded-full bg-white/5 backdrop-blur-sm border border-white/10 mb-8 animate-slide-up\">\n            <Film className=\"w-4 h-4 text-purple-400\" />\n            <span className=\"text-sm text-gray-200 font-medium\">AI-Powered Video Generation Platform</span>\n          </div>\n\n          <div className=\"flex flex-col items-center justify-center gap-4 mb-6 sm:mb-8\">\n            <h1 className=\"text-4xl sm:text-5xl md:text-6xl lg:text-7xl font-bold text-white leading-tight animate-slide-up\">\n              Cartoon Story Video Generator\n            </h1>\n          </div>\n          \n          <p className=\"text-lg sm:text-xl md:text-2xl text-gray-300 mb-6 max-w-4xl mx-auto px-2 animate-slide-up\" style={{animationDelay: '0.1s'}}>\n            Transform your creative scripts into stunning Disney Pixar-style 3D animated videos using cutting-edge AI technology. From story to screen in minutes.\n          </p>\n\n          <div className=\"max-w-5xl mx-auto mb-10 sm:mb-12 animate-slide-up\" style={{animationDelay: '0.15s'}}>\n            <div className=\"bg-white/5 backdrop-blur-sm border border-white/10 rounded-2xl p-6 sm:p-8\">\n              <h2 className=\"text-xl sm:text-2xl font-bold text-white mb-4\">🎬 Complete Video Production Suite</h2>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 text-left text-gray-300 text-sm sm:text-base\">\n                <div className=\"flex items-start gap-3\">\n                  <Wand2 className=\"w-5 h-5 text-purple-400 mt-0.5 shrink-0\" />\n                  <div>\n                    <strong className=\"text-white\">Cartoon Story Generator:</strong> Input your script and characters, AI breaks it into 8-second cinematic scenes with detailed descriptions for perfect video generation\n                  </div>\n                </div>\n                <div className=\"flex items-start gap-3\">\n                  <Video className=\"w-5 h-5 text-purple-400 mt-0.5 shrink-0\" />\n                  <div>\n                    <strong className=\"text-white\">VEO 3.1 Video Generator:</strong> Create individual high-quality videos from any prompt using Google's latest VEO 3.1 AI model\n                  </div>\n                </div>\n                <div className=\"flex items-start gap-3\">\n                  <Layers className=\"w-5 h-5 text-purple-400 mt-0.5 shrink-0\" />\n                  <div>\n                    <strong className=\"text-white\">Bulk Video Generator:</strong> Generate up to 20 videos simultaneously with smart API token rotation for maximum efficiency\n                  </div>\n                </div>\n                <div className=\"flex items-start gap-3\">\n                  <History className=\"w-5 h-5 text-purple-400 mt-0.5 shrink-0\" />\n                  <div>\n                    <strong className=\"text-white\">Video History & Projects:</strong> Track all your generated videos, manage projects, and access comprehensive analytics dashboard\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n          \n          <div className=\"flex flex-col sm:flex-row gap-4 justify-center items-center mb-12 sm:mb-16 animate-slide-up\" style={{animationDelay: '0.2s'}}>\n            <Button \n              size=\"lg\" \n              onClick={onGetStarted}\n              className=\"h-14 px-10 text-lg rounded-xl bg-purple-600 hover:bg-purple-700 text-white shadow-2xl hover-lift transform transition-all duration-300 w-full sm:w-auto max-w-xs font-semibold border-0\"\n              data-testid=\"button-get-started\"\n            >\n              <Sparkles className=\"w-5 h-5 mr-2\" />\n              Start Creating Stories\n            </Button>\n          </div>\n          \n          <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-6 max-w-5xl mx-auto px-2\">\n            <div className=\"space-y-3 bg-white/5 backdrop-blur-sm border border-white/10 rounded-2xl p-6 hover-lift animate-slide-up transition-all duration-300\" style={{animationDelay: '0.3s'}}>\n              <div className=\"w-14 h-14 rounded-xl bg-purple-600/20 flex items-center justify-center mb-2 border border-purple-500/30\">\n                <Wand2 className=\"w-7 h-7 text-purple-400\" />\n              </div>\n              <h3 className=\"text-lg font-bold text-white\">AI Scene Generation</h3>\n              <p className=\"text-sm text-gray-300\">Gemini AI analyzes your script and creates detailed scene descriptions optimized for video generation</p>\n            </div>\n            <div className=\"space-y-3 bg-white/5 backdrop-blur-sm border border-white/10 rounded-2xl p-6 hover-lift animate-slide-up transition-all duration-300\" style={{animationDelay: '0.4s'}}>\n              <div className=\"w-14 h-14 rounded-xl bg-purple-600/20 flex items-center justify-center mb-2 border border-purple-500/30\">\n                <Film className=\"w-7 h-7 text-purple-400\" />\n              </div>\n              <h3 className=\"text-lg font-bold text-white\">VEO 3.1 Powered</h3>\n              <p className=\"text-sm text-gray-300\">Generate 8-second high-quality videos using Google's cutting-edge VEO 3.1 AI video generation model</p>\n            </div>\n            <div className=\"space-y-3 bg-white/5 backdrop-blur-sm border border-white/10 rounded-2xl p-6 hover-lift animate-slide-up transition-all duration-300\" style={{animationDelay: '0.5s'}}>\n              <div className=\"w-14 h-14 rounded-xl bg-purple-600/20 flex items-center justify-center mb-2 border border-purple-500/30\">\n                <Sparkles className=\"w-7 h-7 text-purple-400\" />\n              </div>\n              <h3 className=\"text-lg font-bold text-white\">Pixar-Style Animation</h3>\n              <p className=\"text-sm text-gray-300\">All videos created in Disney Pixar's signature 3D animation style with cinematic quality</p>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","size_bytes":6953},"client/src/components/examples/SceneCard.tsx":{"content":"import SceneCard from \"../SceneCard\";\n\nexport default function SceneCardExample() {\n  const sampleScene = {\n    scene: 1,\n    title: \"Fitropolis Cityscape\",\n    description: `visuals: A wide, vibrant shot of Fitropolis city, filled with towering, colorful buildings and flying vehicles. Sunlight glints off reflective surfaces. Camera slowly pans across the bustling cityscape, focusing on the energy.\ndialogue_action: N/A (establishing shot)\nmusic: Upbeat, optimistic orchestral music with a driving rhythm (strings, brass, light percussion).\nsound_effects: Distant city hum, occasional whoosh of flying vehicles.\ntransition: Fade in from black.`\n  };\n\n  return (\n    <div className=\"max-w-2xl p-4\">\n      <SceneCard scene={sampleScene} />\n    </div>\n  );\n}\n","size_bytes":759},"client/src/components/ui/context-menu.tsx":{"content":"import * as React from \"react\"\nimport * as ContextMenuPrimitive from \"@radix-ui/react-context-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ContextMenu = ContextMenuPrimitive.Root\n\nconst ContextMenuTrigger = ContextMenuPrimitive.Trigger\n\nconst ContextMenuGroup = ContextMenuPrimitive.Group\n\nconst ContextMenuPortal = ContextMenuPrimitive.Portal\n\nconst ContextMenuSub = ContextMenuPrimitive.Sub\n\nconst ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup\n\nconst ContextMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <ContextMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </ContextMenuPrimitive.SubTrigger>\n))\nContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName\n\nconst ContextMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName\n\nconst ContextMenuContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Portal>\n    <ContextMenuPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"z-50 max-h-[--radix-context-menu-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </ContextMenuPrimitive.Portal>\n))\nContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName\n\nconst ContextMenuItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName\n\nconst ContextMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <ContextMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.CheckboxItem>\n))\nContextMenuCheckboxItem.displayName =\n  ContextMenuPrimitive.CheckboxItem.displayName\n\nconst ContextMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <ContextMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.RadioItem>\n))\nContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName\n\nconst ContextMenuLabel = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold text-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName\n\nconst ContextMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName\n\nconst ContextMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nContextMenuShortcut.displayName = \"ContextMenuShortcut\"\n\nexport {\n  ContextMenu,\n  ContextMenuTrigger,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuCheckboxItem,\n  ContextMenuRadioItem,\n  ContextMenuLabel,\n  ContextMenuSeparator,\n  ContextMenuShortcut,\n  ContextMenuGroup,\n  ContextMenuPortal,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuRadioGroup,\n}\n","size_bytes":7428},"client/src/pages/Projects.tsx":{"content":"import { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Link, useLocation } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Loader2, Home, Film, Trash2, Eye } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport type { Project, Character, Scene } from \"@shared/schema\";\n\nexport default function Projects() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n\n  const { data, isLoading } = useQuery<{ projects: Project[] }>({\n    queryKey: [\"/api/projects\"],\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (projectId: string) => {\n      const response = await apiRequest(\"DELETE\", `/api/projects/${projectId}`, {});\n      return await response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/projects\"] });\n      toast({\n        title: \"Project deleted\",\n        description: \"The project has been removed successfully.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Delete failed\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleDelete = (projectId: string, title: string) => {\n    if (confirm(`Are you sure you want to delete \"${title}\"?`)) {\n      deleteMutation.mutate(projectId);\n    }\n  };\n\n  const formatDate = (dateString: string) => {\n    return new Date(dateString).toLocaleDateString('en-US', {\n      year: 'numeric',\n      month: 'short',\n      day: 'numeric',\n      hour: '2-digit',\n      minute: '2-digit',\n    });\n  };\n\n  const getSceneCount = (scenesJson: string): number => {\n    try {\n      const scenes: Scene[] = JSON.parse(scenesJson);\n      return scenes.length;\n    } catch {\n      return 0;\n    }\n  };\n\n  const getCharacterCount = (charactersJson: string): number => {\n    try {\n      const characters: Character[] = JSON.parse(charactersJson);\n      return characters.length;\n    } catch {\n      return 0;\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-[#1a2332] via-[#1e2838] to-[#242d3f] dark:from-[#141a25] dark:via-[#181e2a] dark:to-[#1c2230]\">\n      <header className=\"border-b border-white/10 bg-[#1c2534]/80 dark:bg-[#161c28]/80 backdrop-blur-md sticky top-0 z-50\">\n        <div className=\"max-w-7xl mx-auto px-3 sm:px-4 py-2 sm:py-3 flex justify-between items-center\">\n          <h1 className=\"text-sm sm:text-base md:text-lg font-semibold text-white\">My Projects</h1>\n          <Link href=\"/\">\n            <Button variant=\"outline\" size=\"sm\" className=\"border-white/20 text-white hover:bg-white/10\" data-testid=\"link-home\">\n              <Home className=\"w-4 h-4 sm:mr-1\" />\n              <span className=\"hidden sm:inline\">Home</span>\n            </Button>\n          </Link>\n        </div>\n      </header>\n\n      <div className=\"max-w-7xl mx-auto px-3 sm:px-4 py-4 sm:py-8\">\n        <div className=\"mb-4 sm:mb-6\">\n          <h2 className=\"text-xl sm:text-2xl font-bold text-white\">Your Cartoon Story Projects</h2>\n          <p className=\"text-sm sm:text-base text-gray-300 mt-1\">\n            View and manage all your cartoon generation projects\n          </p>\n        </div>\n\n        {isLoading ? (\n          <div className=\"flex justify-center items-center py-12 sm:py-20\">\n            <Loader2 className=\"w-6 h-6 sm:w-8 sm:h-8 animate-spin text-primary\" />\n          </div>\n        ) : data?.projects && data.projects.length > 0 ? (\n          <div className=\"grid gap-4 sm:gap-6 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3\">\n            {data.projects.map((project) => (\n              <Card key={project.id} className=\"bg-[#1e2838] dark:bg-[#181e2a] border border-white/10\" data-testid={`project-card-${project.id}`}>\n                <CardHeader className=\"p-4 sm:p-6\">\n                  <CardTitle className=\"text-base sm:text-lg truncate text-white\">{project.title}</CardTitle>\n                  <CardDescription className=\"text-xs text-gray-300\">\n                    Created {formatDate(project.createdAt)}\n                  </CardDescription>\n                </CardHeader>\n                <CardContent className=\"space-y-3 sm:space-y-4 p-4 sm:p-6 pt-0\">\n                  <div className=\"space-y-2 text-sm\">\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-gray-300\">Scenes:</span>\n                      <span className=\"font-semibold text-white\">{getSceneCount(project.scenes)}</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-gray-300\">Characters:</span>\n                      <span className=\"font-semibold text-white\">{getCharacterCount(project.characters)}</span>\n                    </div>\n                    {project.mergedVideoUrl && (\n                      <div className=\"flex items-center gap-2 text-green-400\">\n                        <Film className=\"w-4 h-4\" />\n                        <span className=\"text-xs\">Video Generated</span>\n                      </div>\n                    )}\n                  </div>\n\n                  <div className=\"flex gap-2\">\n                    <Link href={`/projects/${project.id}`} className=\"flex-1\">\n                      <Button variant=\"default\" size=\"sm\" className=\"w-full\" data-testid={`button-view-${project.id}`}>\n                        <Eye className=\"w-4 h-4 mr-2\" />\n                        View\n                      </Button>\n                    </Link>\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={() => handleDelete(project.id, project.title)}\n                      disabled={deleteMutation.isPending}\n                      className=\"border-white/20 text-white hover:bg-white/10\"\n                      data-testid={`button-delete-${project.id}`}\n                    >\n                      <Trash2 className=\"w-4 h-4\" />\n                    </Button>\n                  </div>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        ) : (\n          <Card className=\"text-center p-8 sm:p-12 bg-[#1e2838] dark:bg-[#181e2a] border border-white/10\">\n            <CardContent className=\"space-y-4\">\n              <Film className=\"w-12 h-12 sm:w-16 sm:h-16 mx-auto text-gray-400\" />\n              <div>\n                <h3 className=\"text-lg sm:text-xl font-semibold mb-2 text-white\">No projects yet</h3>\n                <p className=\"text-sm sm:text-base text-gray-300 mb-4\">\n                  Create your first cartoon story project to get started\n                </p>\n                <Link href=\"/\">\n                  <Button className=\"bg-purple-600 hover:bg-purple-700 border-0\" data-testid=\"button-create-first\">\n                    Create Your First Project\n                  </Button>\n                </Link>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n      </div>\n    </div>\n  );\n}\n","size_bytes":7127},"client/src/components/ui/scroll-area.tsx":{"content":"import * as React from \"react\"\nimport * as ScrollAreaPrimitive from \"@radix-ui/react-scroll-area\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ScrollArea = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <ScrollAreaPrimitive.Root\n    ref={ref}\n    className={cn(\"relative overflow-hidden\", className)}\n    {...props}\n  >\n    <ScrollAreaPrimitive.Viewport className=\"h-full w-full rounded-[inherit]\">\n      {children}\n    </ScrollAreaPrimitive.Viewport>\n    <ScrollBar />\n    <ScrollAreaPrimitive.Corner />\n  </ScrollAreaPrimitive.Root>\n))\nScrollArea.displayName = ScrollAreaPrimitive.Root.displayName\n\nconst ScrollBar = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>\n>(({ className, orientation = \"vertical\", ...props }, ref) => (\n  <ScrollAreaPrimitive.ScrollAreaScrollbar\n    ref={ref}\n    orientation={orientation}\n    className={cn(\n      \"flex touch-none select-none transition-colors\",\n      orientation === \"vertical\" &&\n        \"h-full w-2.5 border-l border-l-transparent p-[1px]\",\n      orientation === \"horizontal\" &&\n        \"h-2.5 flex-col border-t border-t-transparent p-[1px]\",\n      className\n    )}\n    {...props}\n  >\n    <ScrollAreaPrimitive.ScrollAreaThumb className=\"relative flex-1 rounded-full bg-border\" />\n  </ScrollAreaPrimitive.ScrollAreaScrollbar>\n))\nScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName\n\nexport { ScrollArea, ScrollBar }\n","size_bytes":1642},"replit.md":{"content":"# Cartoon Story Video Generator\n\n## Overview\nThis web application transforms written cartoon scripts into detailed animated scene descriptions optimized for AI video generation tools. It leverages Google's Gemini AI to segment narratives into cinematic 8-second scenes, complete with visuals, dialogue, music, sound effects, and transitions. The application aims for a Disney Pixar-style 3D animation aesthetic and guides users through a multi-step wizard for creation, generation, and export. Key capabilities include a standalone VEO 3.1 video generator and a comprehensive video history tracking system, aiming to provide a complete video production suite.\n\n## User Preferences\nPreferred communication style: Simple, everyday language.\n\n## System Architecture\n\n### Frontend\n- **Framework**: React with TypeScript (Vite)\n- **Routing**: Wouter\n- **State Management**: TanStack Query for server state; React hooks for UI state\n- **UI**: Shadcn/ui (Radix UI, Tailwind CSS); Design inspired by creative AI tools and Material Design.\n- **Form Handling**: React Hook Form with Zod.\n- **Design Principles**: Multi-step wizard (progressive disclosure), hybrid playful/professional aesthetic, Inter and Quicksand typography, generous whitespace.\n\n### Backend\n- **Runtime**: Node.js with Express.js (TypeScript, ES modules)\n- **API**: RESTful, session-based authentication. Includes endpoints for authentication, user management, scene generation, video generation, video status, video merging, token rotation, and video history. Zod for shared client/server validation.\n- **Server Organization**: Modular structure for Express setup, routes, AI integration, storage, database setup, and Vite integration.\n\n### Data Storage\n- **Database**: PostgreSQL (Neon serverless) with Drizzle ORM.\n- **Schema**: Drizzle ORM definitions for Users, Character, Story Input, Scene Output, and Video History models.\n- **Authentication**: Session-based with bcrypt password hashing and role-based access control.\n- **User Management**: Admin panel for user oversight, plan management (free, basic, premium), API token assignment, and comprehensive video generation analytics. Includes bulk token replacement and token usage tracking per video.\n\n### UI/UX Decisions\n- **Design System**: Professional dark navy theme with purple accent buttons. Utilizes CSS gradients, icons, and animations (fadeIn, slideUp, scaleIn). Features glass-morphism effects, hover-lift interactions, and full mobile responsiveness. Supports light/dark modes with consistent navy palette.\n- **Multi-step Wizard**: Guides users through Story Input → Generation → Review/Export.\n- **Hero Section**: Dark navy gradient background with an icon badge, describing the \"Complete Video Production Suite\" and its tools: Cartoon Story Generator, VEO 3.1 Video Generator, Bulk Video Generator, Script Creator, and Video History & Projects.\n- **Navigation**: Hamburger menu providing access to all tools in a logical order.\n- **Script Creator Page (`/script-creator`)**: Standalone tool using OpenAI (GPT-5) to generate detailed animated storyboards. Takes user inputs for story subject, number of steps, and final step description. Outputs complete storyboard with character descriptions repeated in each scene for AI video generation consistency.\n- **Video History Page (`/history`)**: Grid view of user-generated videos with status, metadata, and player. Includes today's generation statistics, original prompt display, and a regenerate button. Features multi-select for merging up to 19 completed videos using local FFmpeg processing, with a retry mechanism for failed merges.\n- **Admin Statistics Dashboard**: Displays daily video generation statistics and per-token analytics, showing total videos, completed, failed counts, and success rates for each API token.\n- **My Projects Page (`/projects`)**: Grid view of cartoon projects including title, date, scene/character count, and video generation status. Auto-saves projects after successful AI generation.\n- **VEO Generator & Bulk Generator Pages**: Professional card designs with gradient icon badges, enhanced input fields, and mobile responsiveness. The Bulk Generator supports up to 200 videos per batch and displays token labels for real-time processing visibility.\n\n### Technical Implementations\n- **AI Integration**: Google Gemini AI (`gemini-2.5-flash`) for scene generation, including automatic retry logic and validation.\n- **Video Generation**: VEO 3 API, with prompts prefixed for \"Disney Pixar-style 3D animation.\" Uses sequential processing with Server-Sent Events (SSE) for progress, automatic prompt cleaning, and individual/bulk retry mechanisms with concurrency control. Features per-scene token rotation to distribute load.\n- **Video Regeneration**: Background polling with a 4-minute timeout. Smart token rotation attempts different API tokens if videos don't complete within 2 minutes.\n- **Bulk Generation**: Backend queue system with configurable batch processing (1-50 videos per batch, 10-120 second delays). Uses round-robin token rotation for videos. Processing continues in the background even if the user leaves the page.\n- **Automatic Timeout**: Videos stuck in pending status are marked as failed after 4 minutes, with a cleanup job running every 2 minutes.\n- **Daily History Cleanup**: Automatically clears all video history at midnight PKT (UTC+5) and cleans up expired temporary videos.\n- **Temporary Video Storage**: Stores merged videos in Replit Object Storage with a 24-hour expiry and hourly cleanup job.\n- **Video Merging**: Supports three approaches: fal.ai FFmpeg API for cloud-based merging of cartoon project scenes, local FFmpeg processing for user-selected history videos (uploading to Cloudinary), and temporary local FFmpeg processing to Object Storage. Includes smart migration of videos from Google Cloud Storage to Cloudinary before merging.\n\n## External Dependencies\n\n- **AI Service**: Google Gemini AI (gemini-2.5-flash model)\n- **Video Generation**: VEO 3 API\n- **Database**: Neon PostgreSQL, Drizzle ORM\n- **Video Storage**: Cloudinary for individual scene and merged video storage (unsigned upload preset). VEO-generated videos are initially on Google Cloud Storage but automatically migrated to Cloudinary during merge operations. fal.ai API for cartoon project merging.\n- **System Dependency**: FFmpeg (for video processing)","size_bytes":6380},"client/src/components/ui/breadcrumb.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Breadcrumb = React.forwardRef<\n  HTMLElement,\n  React.ComponentPropsWithoutRef<\"nav\"> & {\n    separator?: React.ReactNode\n  }\n>(({ ...props }, ref) => <nav ref={ref} aria-label=\"breadcrumb\" {...props} />)\nBreadcrumb.displayName = \"Breadcrumb\"\n\nconst BreadcrumbList = React.forwardRef<\n  HTMLOListElement,\n  React.ComponentPropsWithoutRef<\"ol\">\n>(({ className, ...props }, ref) => (\n  <ol\n    ref={ref}\n    className={cn(\n      \"flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5\",\n      className\n    )}\n    {...props}\n  />\n))\nBreadcrumbList.displayName = \"BreadcrumbList\"\n\nconst BreadcrumbItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentPropsWithoutRef<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    className={cn(\"inline-flex items-center gap-1.5\", className)}\n    {...props}\n  />\n))\nBreadcrumbItem.displayName = \"BreadcrumbItem\"\n\nconst BreadcrumbLink = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentPropsWithoutRef<\"a\"> & {\n    asChild?: boolean\n  }\n>(({ asChild, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      className={cn(\"transition-colors hover:text-foreground\", className)}\n      {...props}\n    />\n  )\n})\nBreadcrumbLink.displayName = \"BreadcrumbLink\"\n\nconst BreadcrumbPage = React.forwardRef<\n  HTMLSpanElement,\n  React.ComponentPropsWithoutRef<\"span\">\n>(({ className, ...props }, ref) => (\n  <span\n    ref={ref}\n    role=\"link\"\n    aria-disabled=\"true\"\n    aria-current=\"page\"\n    className={cn(\"font-normal text-foreground\", className)}\n    {...props}\n  />\n))\nBreadcrumbPage.displayName = \"BreadcrumbPage\"\n\nconst BreadcrumbSeparator = ({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) => (\n  <li\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"[&>svg]:w-3.5 [&>svg]:h-3.5\", className)}\n    {...props}\n  >\n    {children ?? <ChevronRight />}\n  </li>\n)\nBreadcrumbSeparator.displayName = \"BreadcrumbSeparator\"\n\nconst BreadcrumbEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More</span>\n  </span>\n)\nBreadcrumbEllipsis.displayName = \"BreadcrumbElipssis\"\n\nexport {\n  Breadcrumb,\n  BreadcrumbList,\n  BreadcrumbItem,\n  BreadcrumbLink,\n  BreadcrumbPage,\n  BreadcrumbSeparator,\n  BreadcrumbEllipsis,\n}\n","size_bytes":2712},"client/src/components/ui/radio-group.tsx":{"content":"import * as React from \"react\"\nimport * as RadioGroupPrimitive from \"@radix-ui/react-radio-group\"\nimport { Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Root\n      className={cn(\"grid gap-2\", className)}\n      {...props}\n      ref={ref}\n    />\n  )\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        \"aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    >\n      <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center\">\n        <Circle className=\"h-2.5 w-2.5 fill-current text-current\" />\n      </RadioGroupPrimitive.Indicator>\n    </RadioGroupPrimitive.Item>\n  )\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n","size_bytes":1467},"client/src/pages/Admin.tsx":{"content":"import { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { useMutation, useQuery } from \"@tanstack/react-query\";\nimport { useLocation } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n  FormDescription,\n} from \"@/components/ui/form\";\nimport { Input } from \"@/components/ui/input\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Shield, LogOut, UserPlus, Home, Edit, Key, Calendar, RefreshCw, TrendingUp, CheckCircle, XCircle, Clock, AlertCircle } from \"lucide-react\";\nimport { useEffect, useState, useMemo } from \"react\";\n\nconst createUserSchema = z.object({\n  username: z.string().min(3, \"Username must be at least 3 characters\"),\n  password: z.string().min(6, \"Password must be at least 6 characters\"),\n  isAdmin: z.boolean().default(false),\n});\n\nconst updatePlanSchema = z.object({\n  planType: z.enum([\"free\", \"basic\", \"premium\"]),\n  planStatus: z.enum([\"active\", \"expired\", \"cancelled\"]),\n  planExpiry: z.string().optional(),\n});\n\nconst updateTokenSchema = z.object({\n  apiToken: z.string().min(1, \"API token is required\"),\n});\n\nconst addApiTokenSchema = z.object({\n  token: z.string().min(1, \"Token is required\"),\n  label: z.string().min(1, \"Label is required\"),\n});\n\nconst tokenRotationSettingsSchema = z.object({\n  rotationEnabled: z.boolean(),\n  rotationIntervalMinutes: z.string().min(1, \"Interval is required\"),\n  maxRequestsPerToken: z.string().min(1, \"Max requests is required\"),\n  videosPerBatch: z.string().min(1, \"Videos per batch is required\"),\n  batchDelaySeconds: z.string().min(1, \"Batch delay is required\"),\n});\n\nconst bulkReplaceTokensSchema = z.object({\n  tokens: z.string().min(1, \"Please enter at least one token\"),\n});\n\ntype CreateUserFormData = z.infer<typeof createUserSchema>;\ntype UpdatePlanFormData = z.infer<typeof updatePlanSchema>;\ntype UpdateTokenFormData = z.infer<typeof updateTokenSchema>;\ntype AddApiTokenFormData = z.infer<typeof addApiTokenSchema>;\ntype TokenRotationSettingsFormData = z.infer<typeof tokenRotationSettingsSchema>;\ntype BulkReplaceTokensFormData = z.infer<typeof bulkReplaceTokensSchema>;\n\ninterface UserData {\n  id: string;\n  username: string;\n  isAdmin: boolean;\n  planType: string;\n  planStatus: string;\n  planExpiry: string | null;\n  apiToken: string | null;\n}\n\ninterface ApiTokenData {\n  id: string;\n  token: string;\n  label: string;\n  isActive: boolean;\n  lastUsedAt: string | null;\n  requestCount: string;\n  createdAt: string;\n}\n\ninterface TokenRotationSettings {\n  id: string;\n  rotationEnabled: boolean;\n  rotationIntervalMinutes: string;\n  maxRequestsPerToken: string;\n  videosPerBatch: string;\n  batchDelaySeconds: string;\n}\n\nexport default function Admin() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const [editingUserId, setEditingUserId] = useState<string | null>(null);\n  const [editingTokenUserId, setEditingTokenUserId] = useState<string | null>(null);\n  const [viewingTokenErrors, setViewingTokenErrors] = useState<string | null>(null);\n\n  const { data: session, isLoading: isLoadingSession } = useQuery<{\n    authenticated: boolean;\n    user?: { id: string; username: string; isAdmin: boolean };\n  }>({\n    queryKey: [\"/api/session\"],\n  });\n\n  const isAdmin = session?.authenticated && session?.user?.isAdmin;\n\n  const { data: usersData, isLoading: isLoadingUsers } = useQuery<{ users: UserData[] }>({\n    queryKey: [\"/api/users\"],\n    enabled: isAdmin === true,\n  });\n\n  const { data: tokensData, isLoading: isLoadingTokens } = useQuery<{ tokens: ApiTokenData[] }>({\n    queryKey: [\"/api/tokens\"],\n    enabled: isAdmin === true,\n  });\n\n  const { data: tokenSettingsData } = useQuery<{ settings: TokenRotationSettings }>({\n    queryKey: [\"/api/token-settings\"],\n    enabled: isAdmin === true,\n  });\n\n  const { data: allVideoHistory } = useQuery<{ videos: Array<{\n    id: string;\n    userId: string;\n    prompt: string;\n    aspectRatio: string;\n    videoUrl: string | null;\n    status: string;\n    createdAt: string;\n    title: string | null;\n    tokenUsed: string | null;\n    errorMessage: string | null;\n  }> }>({\n    queryKey: [\"/api/admin/video-history\"],\n    enabled: isAdmin === true,\n  });\n\n  // Calculate today's video statistics\n  const todayStats = useMemo(() => {\n    if (!allVideoHistory?.videos) return null;\n    \n    const today = new Date();\n    today.setHours(0, 0, 0, 0);\n    \n    const todayVideos = allVideoHistory.videos.filter(video => {\n      const videoDate = new Date(video.createdAt);\n      videoDate.setHours(0, 0, 0, 0);\n      return videoDate.getTime() === today.getTime();\n    });\n    \n    // Always return stats, even with zeros\n    return {\n      total: todayVideos.length,\n      completed: todayVideos.filter(v => v.status === 'completed').length,\n      failed: todayVideos.filter(v => v.status === 'failed').length,\n      pending: todayVideos.filter(v => v.status === 'pending').length,\n    };\n  }, [allVideoHistory]);\n\n  // Calculate per-token statistics\n  const tokenStats = useMemo(() => {\n    if (!allVideoHistory?.videos || !tokensData?.tokens) return [];\n    \n    const stats = new Map<string, { tokenId: string; label: string; total: number; completed: number; failed: number }>();\n    \n    // Initialize stats for all tokens\n    tokensData.tokens.forEach(token => {\n      stats.set(token.id, {\n        tokenId: token.id,\n        label: token.label,\n        total: 0,\n        completed: 0,\n        failed: 0,\n      });\n    });\n    \n    // Count videos by token\n    allVideoHistory.videos.forEach(video => {\n      if (video.tokenUsed && stats.has(video.tokenUsed)) {\n        const stat = stats.get(video.tokenUsed)!;\n        stat.total++;\n        if (video.status === 'completed') stat.completed++;\n        if (video.status === 'failed') stat.failed++;\n      }\n    });\n    \n    // Return all tokens, even those with zero usage to highlight inactivity\n    return Array.from(stats.values());\n  }, [allVideoHistory, tokensData]);\n\n  useEffect(() => {\n    if (isLoadingSession) return;\n    \n    if (!session?.authenticated || !session?.user?.isAdmin) {\n      toast({\n        variant: \"destructive\",\n        title: \"Access denied\",\n        description: \"You must be an admin to access this page\",\n      });\n      setLocation(\"/login\");\n    }\n  }, [session, isLoadingSession, setLocation, toast]);\n\n  useEffect(() => {\n    if (tokenSettingsData?.settings) {\n      rotationSettingsForm.reset({\n        rotationEnabled: tokenSettingsData.settings.rotationEnabled,\n        rotationIntervalMinutes: tokenSettingsData.settings.rotationIntervalMinutes,\n        maxRequestsPerToken: tokenSettingsData.settings.maxRequestsPerToken,\n        videosPerBatch: tokenSettingsData.settings.videosPerBatch,\n        batchDelaySeconds: tokenSettingsData.settings.batchDelaySeconds,\n      });\n    }\n  }, [tokenSettingsData]);\n\n  const createForm = useForm<CreateUserFormData>({\n    resolver: zodResolver(createUserSchema),\n    defaultValues: {\n      username: \"\",\n      password: \"\",\n      isAdmin: false,\n    },\n  });\n\n  const planForm = useForm<UpdatePlanFormData>({\n    resolver: zodResolver(updatePlanSchema),\n    defaultValues: {\n      planType: \"free\",\n      planStatus: \"active\",\n      planExpiry: \"\",\n    },\n  });\n\n  const tokenForm = useForm<UpdateTokenFormData>({\n    resolver: zodResolver(updateTokenSchema),\n    defaultValues: {\n      apiToken: \"\",\n    },\n  });\n\n  const addTokenForm = useForm<AddApiTokenFormData>({\n    resolver: zodResolver(addApiTokenSchema),\n    defaultValues: {\n      token: \"\",\n      label: \"\",\n    },\n  });\n\n  const rotationSettingsForm = useForm<TokenRotationSettingsFormData>({\n    resolver: zodResolver(tokenRotationSettingsSchema),\n    defaultValues: {\n      rotationEnabled: false,\n      rotationIntervalMinutes: \"60\",\n      maxRequestsPerToken: \"1000\",\n      videosPerBatch: \"5\",\n      batchDelaySeconds: \"20\",\n    },\n  });\n\n  const bulkReplaceForm = useForm<BulkReplaceTokensFormData>({\n    resolver: zodResolver(bulkReplaceTokensSchema),\n    defaultValues: {\n      tokens: \"\",\n    },\n  });\n\n  const [showBulkConfirmation, setShowBulkConfirmation] = useState(false);\n\n  const createUserMutation = useMutation({\n    mutationFn: async (data: CreateUserFormData) => {\n      const response = await apiRequest(\"POST\", \"/api/users\", data);\n      const result = await response.json();\n      return result as { success: boolean; user: UserData };\n    },\n    onSuccess: (data) => {\n      toast({\n        title: \"User created successfully\",\n        description: `${data.user.username} has been added${data.user.isAdmin ? \" as an admin\" : \"\"}`,\n      });\n      createForm.reset();\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\"] });\n    },\n    onError: (error: any) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Failed to create user\",\n        description: error.message || \"An error occurred\",\n      });\n    },\n  });\n\n  const updatePlanMutation = useMutation({\n    mutationFn: async ({ userId, data }: { userId: string; data: UpdatePlanFormData }) => {\n      const response = await apiRequest(\"PATCH\", `/api/users/${userId}/plan`, data);\n      const result = await response.json();\n      return result;\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Plan updated successfully\",\n      });\n      setEditingUserId(null);\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\"] });\n    },\n    onError: (error: any) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Failed to update plan\",\n        description: error.message || \"An error occurred\",\n      });\n    },\n  });\n\n  const updateTokenMutation = useMutation({\n    mutationFn: async ({ userId, data }: { userId: string; data: UpdateTokenFormData }) => {\n      const response = await apiRequest(\"PATCH\", `/api/users/${userId}/token`, data);\n      const result = await response.json();\n      return result;\n    },\n    onSuccess: () => {\n      toast({\n        title: \"API token updated successfully\",\n      });\n      setEditingTokenUserId(null);\n      tokenForm.reset();\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\"] });\n    },\n    onError: (error: any) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Failed to update token\",\n        description: error.message || \"An error occurred\",\n      });\n    },\n  });\n\n  const addTokenMutation = useMutation({\n    mutationFn: async (data: AddApiTokenFormData) => {\n      const response = await apiRequest(\"POST\", \"/api/tokens\", data);\n      const result = await response.json();\n      return result;\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Token added successfully\",\n      });\n      addTokenForm.reset();\n      queryClient.invalidateQueries({ queryKey: [\"/api/tokens\"] });\n    },\n    onError: (error: any) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Failed to add token\",\n        description: error.message || \"An error occurred\",\n      });\n    },\n  });\n\n  const deleteTokenMutation = useMutation({\n    mutationFn: async (tokenId: string) => {\n      const response = await apiRequest(\"DELETE\", `/api/tokens/${tokenId}`, {});\n      const result = await response.json();\n      return result;\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Token deleted successfully\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/tokens\"] });\n    },\n    onError: (error: any) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Failed to delete token\",\n        description: error.message || \"An error occurred\",\n      });\n    },\n  });\n\n  const toggleTokenMutation = useMutation({\n    mutationFn: async ({ tokenId, isActive }: { tokenId: string; isActive: boolean }) => {\n      const response = await apiRequest(\"PATCH\", `/api/tokens/${tokenId}/toggle`, { isActive });\n      const result = await response.json();\n      return result;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/tokens\"] });\n    },\n    onError: (error: any) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Failed to update token status\",\n        description: error.message || \"An error occurred\",\n      });\n    },\n  });\n\n  const updateRotationSettingsMutation = useMutation({\n    mutationFn: async (data: TokenRotationSettingsFormData) => {\n      const response = await apiRequest(\"PUT\", \"/api/token-settings\", {\n        rotationEnabled: data.rotationEnabled,\n        rotationIntervalMinutes: data.rotationIntervalMinutes,\n        maxRequestsPerToken: data.maxRequestsPerToken,\n        videosPerBatch: data.videosPerBatch,\n        batchDelaySeconds: data.batchDelaySeconds,\n      });\n      const result = await response.json();\n      return result;\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Settings updated successfully\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/token-settings\"] });\n    },\n    onError: (error: any) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Failed to update settings\",\n        description: error.message || \"An error occurred\",\n      });\n    },\n  });\n\n  const bulkReplaceTokensMutation = useMutation({\n    mutationFn: async (data: BulkReplaceTokensFormData) => {\n      const response = await apiRequest(\"POST\", \"/api/tokens/bulk-replace\", data);\n      const result = await response.json();\n      return result as { success: boolean; tokens: ApiTokenData[]; count: number };\n    },\n    onSuccess: (data) => {\n      toast({\n        title: \"Tokens replaced successfully\",\n        description: `Added ${data.count} new tokens. All previous tokens have been removed.`,\n      });\n      bulkReplaceForm.reset();\n      setShowBulkConfirmation(false);\n      queryClient.invalidateQueries({ queryKey: [\"/api/tokens\"] });\n    },\n    onError: (error: any) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Failed to replace tokens\",\n        description: error.message || \"An error occurred\",\n      });\n    },\n  });\n\n  const logoutMutation = useMutation({\n    mutationFn: async () => {\n      const response = await apiRequest(\"POST\", \"/api/logout\", {});\n      const result = await response.json();\n      return result;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/session\"] });\n      toast({\n        title: \"Logged out successfully\",\n      });\n      setLocation(\"/login\");\n    },\n  });\n\n  const handleEditPlan = (user: UserData) => {\n    setEditingUserId(user.id);\n    planForm.reset({\n      planType: user.planType as \"free\" | \"basic\" | \"premium\",\n      planStatus: user.planStatus as \"active\" | \"expired\" | \"cancelled\",\n      planExpiry: user.planExpiry || \"\",\n    });\n  };\n\n  const handleEditToken = (user: UserData) => {\n    setEditingTokenUserId(user.id);\n    tokenForm.reset({\n      apiToken: user.apiToken || \"\",\n    });\n  };\n\n  const onCreateSubmit = (data: CreateUserFormData) => {\n    createUserMutation.mutate(data);\n  };\n\n  const onPlanSubmit = (data: UpdatePlanFormData) => {\n    if (editingUserId) {\n      updatePlanMutation.mutate({ userId: editingUserId, data });\n    }\n  };\n\n  const onTokenSubmit = (data: UpdateTokenFormData) => {\n    if (editingTokenUserId) {\n      updateTokenMutation.mutate({ userId: editingTokenUserId, data });\n    }\n  };\n\n  if (isLoadingSession) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center bg-gradient-to-br from-[#1a2332] via-[#1e2838] to-[#242d3f] dark:from-[#141a25] dark:via-[#181e2a] dark:to-[#1c2230]\">\n        <p className=\"text-gray-300\">Loading...</p>\n      </div>\n    );\n  }\n\n  if (!session?.authenticated || !session?.user?.isAdmin) {\n    return null;\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-[#1a2332] via-[#1e2838] to-[#242d3f] dark:from-[#141a25] dark:via-[#181e2a] dark:to-[#1c2230] p-4\">\n      <div className=\"max-w-7xl mx-auto py-8\">\n        <div className=\"flex justify-between items-center mb-8\">\n          <div className=\"flex items-center gap-3\">\n            <div className=\"p-2 rounded-lg bg-purple-600/30 border border-purple-500/50\">\n              <Shield className=\"w-6 h-6 text-purple-400\" />\n            </div>\n            <div>\n              <h1 className=\"text-3xl font-bold text-white\">Admin Panel</h1>\n              <p className=\"text-gray-300\">\n                Logged in as <span className=\"font-medium text-white\">{session.user.username}</span>\n              </p>\n            </div>\n          </div>\n          <div className=\"flex gap-2\">\n            <Button\n              variant=\"outline\"\n              onClick={() => setLocation(\"/\")}\n              data-testid=\"button-home\"\n              className=\"border-white/20 text-white hover:bg-white/10\"\n            >\n              <Home className=\"w-4 h-4 mr-2\" />\n              Home\n            </Button>\n            <Button\n              variant=\"outline\"\n              onClick={() => logoutMutation.mutate()}\n              disabled={logoutMutation.isPending}\n              data-testid=\"button-logout\"\n              className=\"border-white/20 text-white hover:bg-white/10\"\n            >\n              <LogOut className=\"w-4 h-4 mr-2\" />\n              Logout\n            </Button>\n          </div>\n        </div>\n\n        {/* Today's Video Generation Statistics */}\n        {todayStats && (\n          <Card className=\"shadow-xl bg-[#1e2838] dark:bg-[#181e2a] border border-white/10 mb-6\">\n            <CardHeader>\n              <div className=\"flex items-center gap-2\">\n                <TrendingUp className=\"w-5 h-5 text-purple-400\" />\n                <CardTitle className=\"text-white\">Today's Video Generation Statistics</CardTitle>\n              </div>\n              <CardDescription className=\"text-gray-300\">\n                Overview of videos generated today\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n                <div className=\"p-4 bg-purple-600/10 border border-purple-500/30 rounded-lg\">\n                  <div className=\"flex items-center gap-2 mb-2\">\n                    <TrendingUp className=\"w-4 h-4 text-purple-400\" />\n                    <p className=\"text-sm font-medium text-gray-300\">Total</p>\n                  </div>\n                  <p className=\"text-2xl font-bold text-white\">{todayStats.total}</p>\n                </div>\n                <div className=\"p-4 bg-green-600/10 border border-green-500/30 rounded-lg\">\n                  <div className=\"flex items-center gap-2 mb-2\">\n                    <CheckCircle className=\"w-4 h-4 text-green-400\" />\n                    <p className=\"text-sm font-medium text-gray-300\">Completed</p>\n                  </div>\n                  <p className=\"text-2xl font-bold text-white\">{todayStats.completed}</p>\n                </div>\n                <div className=\"p-4 bg-red-600/10 border border-red-500/30 rounded-lg\">\n                  <div className=\"flex items-center gap-2 mb-2\">\n                    <XCircle className=\"w-4 h-4 text-red-400\" />\n                    <p className=\"text-sm font-medium text-gray-300\">Failed</p>\n                  </div>\n                  <p className=\"text-2xl font-bold text-white\">{todayStats.failed}</p>\n                </div>\n                <div className=\"p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg\">\n                  <div className=\"flex items-center gap-2 mb-2\">\n                    <Clock className=\"w-4 h-4 text-yellow-600 dark:text-yellow-400\" />\n                    <p className=\"text-sm font-medium text-gray-600 dark:text-gray-400\">Pending</p>\n                  </div>\n                  <p className=\"text-2xl font-bold text-gray-900 dark:text-white\">{todayStats.pending}</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n\n        {/* Per-Token Statistics */}\n        {tokenStats.length > 0 && (\n          <Card className=\"shadow-xl dark:bg-gray-800 dark:border-gray-700 mb-6\">\n            <CardHeader>\n              <div className=\"flex items-center gap-2\">\n                <Key className=\"w-5 h-5 text-purple-600 dark:text-purple-400\" />\n                <CardTitle className=\"text-gray-900 dark:text-white\">API Token Usage Statistics</CardTitle>\n              </div>\n              <CardDescription className=\"text-gray-600 dark:text-gray-400\">\n                Video generation statistics per API token\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <div className=\"overflow-x-auto\">\n                <Table>\n                  <TableHeader>\n                    <TableRow className=\"dark:border-gray-700\">\n                      <TableHead className=\"text-gray-700 dark:text-gray-300\">Token Label</TableHead>\n                      <TableHead className=\"text-gray-700 dark:text-gray-300\">Total Videos</TableHead>\n                      <TableHead className=\"text-gray-700 dark:text-gray-300\">Completed</TableHead>\n                      <TableHead className=\"text-gray-700 dark:text-gray-300\">Failed</TableHead>\n                      <TableHead className=\"text-gray-700 dark:text-gray-300\">Success Rate</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {tokenStats.map((stat) => {\n                      const successRate = stat.total > 0 ? ((stat.completed / stat.total) * 100).toFixed(1) : '0.0';\n                      return (\n                        <TableRow key={stat.tokenId} className=\"dark:border-gray-700\">\n                          <TableCell className=\"font-medium text-gray-900 dark:text-white\">\n                            {stat.label}\n                          </TableCell>\n                          <TableCell className=\"text-gray-700 dark:text-gray-300\">\n                            {stat.total}\n                          </TableCell>\n                          <TableCell className=\"text-gray-700 dark:text-gray-300\">\n                            <span className=\"inline-flex items-center gap-1 px-2 py-1 bg-green-100 dark:bg-green-900/20 text-green-800 dark:text-green-300 text-sm rounded\">\n                              <CheckCircle className=\"w-3 h-3\" />\n                              {stat.completed}\n                            </span>\n                          </TableCell>\n                          <TableCell className=\"text-gray-700 dark:text-gray-300\">\n                            <button\n                              onClick={() => stat.failed > 0 && setViewingTokenErrors(stat.tokenId)}\n                              className={`inline-flex items-center gap-1 px-2 py-1 bg-red-100 dark:bg-red-900/20 text-red-800 dark:text-red-300 text-sm rounded ${\n                                stat.failed > 0 ? 'cursor-pointer hover:bg-red-200 dark:hover:bg-red-900/30' : ''\n                              }`}\n                              disabled={stat.failed === 0}\n                            >\n                              <XCircle className=\"w-3 h-3\" />\n                              {stat.failed}\n                            </button>\n                          </TableCell>\n                          <TableCell className=\"text-gray-700 dark:text-gray-300\">\n                            <span className={`px-2 py-1 text-sm rounded ${\n                              parseFloat(successRate) >= 80 \n                                ? 'bg-green-100 dark:bg-green-900/20 text-green-800 dark:text-green-300'\n                                : parseFloat(successRate) >= 50\n                                ? 'bg-yellow-100 dark:bg-yellow-900/20 text-yellow-800 dark:text-yellow-300'\n                                : 'bg-red-100 dark:bg-red-900/20 text-red-800 dark:text-red-300'\n                            }`}>\n                              {successRate}%\n                            </span>\n                          </TableCell>\n                        </TableRow>\n                      );\n                    })}\n                  </TableBody>\n                </Table>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n\n        {/* Error Details Dialog */}\n        <Dialog open={!!viewingTokenErrors} onOpenChange={(open) => !open && setViewingTokenErrors(null)}>\n          <DialogContent className=\"max-w-4xl dark:bg-gray-800 dark:border-gray-700\">\n            <DialogHeader>\n              <DialogTitle className=\"text-gray-900 dark:text-white flex items-center gap-2\">\n                <AlertCircle className=\"w-5 h-5 text-red-500\" />\n                Failed Video Details\n              </DialogTitle>\n              <DialogDescription className=\"text-gray-600 dark:text-gray-400\">\n                Error messages for failed video generations using {tokensData?.tokens.find(t => t.id === viewingTokenErrors)?.label || 'this token'}\n              </DialogDescription>\n            </DialogHeader>\n            <ScrollArea className=\"max-h-[500px] pr-4\">\n              <div className=\"space-y-3\">\n                {allVideoHistory?.videos\n                  .filter(v => v.tokenUsed === viewingTokenErrors && v.status === 'failed')\n                  .map((video) => (\n                    <div key={video.id} className=\"p-4 border border-gray-200 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700\">\n                      <div className=\"flex flex-col gap-2\">\n                        <div className=\"flex items-start justify-between\">\n                          <div className=\"flex-1\">\n                            <p className=\"text-sm font-medium text-gray-900 dark:text-white\">\n                              {video.title || 'Untitled Video'}\n                            </p>\n                            <p className=\"text-xs text-gray-600 dark:text-gray-400 mt-1\">\n                              ID: {video.id}\n                            </p>\n                            <p className=\"text-xs text-gray-600 dark:text-gray-400\">\n                              Created: {new Date(video.createdAt).toLocaleString()}\n                            </p>\n                          </div>\n                          <Badge variant=\"destructive\">Failed</Badge>\n                        </div>\n                        <div className=\"mt-2\">\n                          <p className=\"text-xs font-medium text-gray-700 dark:text-gray-300 mb-1\">Prompt:</p>\n                          <p className=\"text-xs text-gray-600 dark:text-gray-400 bg-white dark:bg-gray-800 p-2 rounded border border-gray-200 dark:border-gray-600\">\n                            {video.prompt}\n                          </p>\n                        </div>\n                        {video.errorMessage && (\n                          <div className=\"mt-2\">\n                            <p className=\"text-xs font-medium text-red-700 dark:text-red-300 mb-1 flex items-center gap-1\">\n                              <AlertCircle className=\"w-3 h-3\" />\n                              Error Message:\n                            </p>\n                            <p className=\"text-xs text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20 p-2 rounded border border-red-200 dark:border-red-800\">\n                              {video.errorMessage}\n                            </p>\n                          </div>\n                        )}\n                      </div>\n                    </div>\n                  ))}\n                {allVideoHistory?.videos\n                  .filter(v => v.tokenUsed === viewingTokenErrors && v.status === 'failed')\n                  .length === 0 && (\n                  <p className=\"text-center text-gray-500 dark:text-gray-400 py-8\">\n                    No failed videos found for this token\n                  </p>\n                )}\n              </div>\n            </ScrollArea>\n          </DialogContent>\n        </Dialog>\n\n        <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6\">\n          <Card className=\"shadow-xl dark:bg-gray-800 dark:border-gray-700\">\n            <CardHeader>\n              <div className=\"flex items-center gap-2\">\n                <UserPlus className=\"w-5 h-5 text-purple-600 dark:text-purple-400\" />\n                <CardTitle className=\"text-gray-900 dark:text-white\">Create New User</CardTitle>\n              </div>\n              <CardDescription className=\"text-gray-600 dark:text-gray-400\">\n                Add a new user account to the system\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <Form {...createForm}>\n                <form onSubmit={createForm.handleSubmit(onCreateSubmit)} className=\"space-y-4\">\n                  <FormField\n                    control={createForm.control}\n                    name=\"username\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel className=\"text-gray-700 dark:text-gray-300\">Username</FormLabel>\n                        <FormControl>\n                          <Input\n                            {...field}\n                            placeholder=\"Enter username\"\n                            data-testid=\"input-create-username\"\n                            className=\"dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400\"\n                            disabled={createUserMutation.isPending}\n                          />\n                        </FormControl>\n                        <FormMessage className=\"dark:text-red-400\" />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={createForm.control}\n                    name=\"password\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel className=\"text-gray-700 dark:text-gray-300\">Password</FormLabel>\n                        <FormControl>\n                          <Input\n                            {...field}\n                            type=\"password\"\n                            placeholder=\"Enter password\"\n                            data-testid=\"input-create-password\"\n                            className=\"dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400\"\n                            disabled={createUserMutation.isPending}\n                          />\n                        </FormControl>\n                        <FormMessage className=\"dark:text-red-400\" />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={createForm.control}\n                    name=\"isAdmin\"\n                    render={({ field }) => (\n                      <FormItem className=\"flex flex-row items-center justify-between rounded-lg border border-gray-200 dark:border-gray-600 p-4 bg-gray-50 dark:bg-gray-700\">\n                        <div className=\"space-y-0.5\">\n                          <FormLabel className=\"text-base text-gray-900 dark:text-white\">\n                            Admin privileges\n                          </FormLabel>\n                          <FormDescription className=\"text-gray-600 dark:text-gray-400\">\n                            Grant administrator access\n                          </FormDescription>\n                        </div>\n                        <FormControl>\n                          <Switch\n                            checked={field.value}\n                            onCheckedChange={field.onChange}\n                            data-testid=\"switch-admin\"\n                            disabled={createUserMutation.isPending}\n                          />\n                        </FormControl>\n                      </FormItem>\n                    )}\n                  />\n\n                  <Button\n                    type=\"submit\"\n                    className=\"w-full bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 dark:from-purple-500 dark:to-blue-500 dark:hover:from-purple-600 dark:hover:to-blue-600 text-white dark:text-white\"\n                    disabled={createUserMutation.isPending}\n                    data-testid=\"button-create-user\"\n                  >\n                    {createUserMutation.isPending ? \"Creating...\" : \"Create User\"}\n                  </Button>\n                </form>\n              </Form>\n            </CardContent>\n          </Card>\n        </div>\n\n        <Card className=\"shadow-xl dark:bg-gray-800 dark:border-gray-700\">\n          <CardHeader>\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-2\">\n                <Shield className=\"w-5 h-5 text-purple-600 dark:text-purple-400\" />\n                <CardTitle className=\"text-gray-900 dark:text-white\">User Management</CardTitle>\n              </div>\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={() => queryClient.invalidateQueries({ queryKey: [\"/api/users\"] })}\n                data-testid=\"button-refresh-users\"\n                className=\"dark:border-gray-600 dark:text-gray-300\"\n              >\n                <RefreshCw className=\"w-4 h-4 mr-2\" />\n                Refresh\n              </Button>\n            </div>\n            <CardDescription className=\"text-gray-600 dark:text-gray-400\">\n              Manage user plans and access tokens\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            {isLoadingUsers ? (\n              <p className=\"text-gray-600 dark:text-gray-400 text-center py-4\">Loading users...</p>\n            ) : !usersData?.users || usersData.users.length === 0 ? (\n              <p className=\"text-gray-600 dark:text-gray-400 text-center py-4\">No users found</p>\n            ) : (\n              <div className=\"overflow-x-auto\">\n                <Table>\n                  <TableHeader>\n                    <TableRow className=\"dark:border-gray-700\">\n                      <TableHead className=\"text-gray-700 dark:text-gray-300\">Username</TableHead>\n                      <TableHead className=\"text-gray-700 dark:text-gray-300\">Role</TableHead>\n                      <TableHead className=\"text-gray-700 dark:text-gray-300\">Plan</TableHead>\n                      <TableHead className=\"text-gray-700 dark:text-gray-300\">Status</TableHead>\n                      <TableHead className=\"text-gray-700 dark:text-gray-300\">Expiry</TableHead>\n                      <TableHead className=\"text-gray-700 dark:text-gray-300\">API Token</TableHead>\n                      <TableHead className=\"text-gray-700 dark:text-gray-300\">Actions</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {usersData.users.map((user) => (\n                      <TableRow key={user.id} className=\"dark:border-gray-700\" data-testid={`row-user-${user.id}`}>\n                        <TableCell className=\"font-medium text-gray-900 dark:text-white\" data-testid={`text-username-${user.id}`}>\n                          {user.username}\n                        </TableCell>\n                        <TableCell className=\"text-gray-700 dark:text-gray-300\">\n                          {user.isAdmin ? (\n                            <span className=\"px-2 py-1 bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200 text-xs rounded-full\">\n                              Admin\n                            </span>\n                          ) : (\n                            <span className=\"px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-xs rounded-full\">\n                              User\n                            </span>\n                          )}\n                        </TableCell>\n                        <TableCell className=\"text-gray-700 dark:text-gray-300 capitalize\" data-testid={`text-plan-${user.id}`}>\n                          {user.planType}\n                        </TableCell>\n                        <TableCell className=\"text-gray-700 dark:text-gray-300\">\n                          <span className={`px-2 py-1 text-xs rounded-full ${\n                            user.planStatus === \"active\" \n                              ? \"bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200\"\n                              : user.planStatus === \"expired\"\n                              ? \"bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200\"\n                              : \"bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200\"\n                          }`} data-testid={`text-status-${user.id}`}>\n                            {user.planStatus}\n                          </span>\n                        </TableCell>\n                        <TableCell className=\"text-gray-700 dark:text-gray-300 text-sm\" data-testid={`text-expiry-${user.id}`}>\n                          {user.planExpiry || \"—\"}\n                        </TableCell>\n                        <TableCell className=\"text-gray-700 dark:text-gray-300 font-mono text-xs\" data-testid={`text-token-${user.id}`}>\n                          {user.apiToken ? `${user.apiToken.slice(0, 20)}...` : \"—\"}\n                        </TableCell>\n                        <TableCell>\n                          <div className=\"flex gap-2\">\n                            <Dialog open={editingUserId === user.id} onOpenChange={(open) => !open && setEditingUserId(null)}>\n                              <DialogTrigger asChild>\n                                <Button\n                                  variant=\"outline\"\n                                  size=\"sm\"\n                                  onClick={() => handleEditPlan(user)}\n                                  data-testid={`button-edit-plan-${user.id}`}\n                                  className=\"dark:border-gray-600 dark:text-gray-300\"\n                                >\n                                  <Edit className=\"w-3 h-3 mr-1\" />\n                                  Plan\n                                </Button>\n                              </DialogTrigger>\n                              <DialogContent className=\"dark:bg-gray-800 dark:border-gray-700\">\n                                <DialogHeader>\n                                  <DialogTitle className=\"text-gray-900 dark:text-white\">Edit User Plan</DialogTitle>\n                                  <DialogDescription className=\"text-gray-600 dark:text-gray-400\">\n                                    Update plan settings for {user.username}\n                                  </DialogDescription>\n                                </DialogHeader>\n                                <Form {...planForm}>\n                                  <form onSubmit={planForm.handleSubmit(onPlanSubmit)} className=\"space-y-4\">\n                                    <FormField\n                                      control={planForm.control}\n                                      name=\"planType\"\n                                      render={({ field }) => (\n                                        <FormItem>\n                                          <FormLabel className=\"text-gray-700 dark:text-gray-300\">Plan Type</FormLabel>\n                                          <Select onValueChange={field.onChange} defaultValue={field.value}>\n                                            <FormControl>\n                                              <SelectTrigger className=\"dark:bg-gray-700 dark:border-gray-600 dark:text-white\" data-testid=\"select-plan-type\">\n                                                <SelectValue placeholder=\"Select plan type\" />\n                                              </SelectTrigger>\n                                            </FormControl>\n                                            <SelectContent className=\"dark:bg-gray-800 dark:border-gray-700\">\n                                              <SelectItem value=\"free\">Free</SelectItem>\n                                              <SelectItem value=\"basic\">Basic</SelectItem>\n                                              <SelectItem value=\"premium\">Premium</SelectItem>\n                                            </SelectContent>\n                                          </Select>\n                                          <FormMessage className=\"dark:text-red-400\" />\n                                        </FormItem>\n                                      )}\n                                    />\n\n                                    <FormField\n                                      control={planForm.control}\n                                      name=\"planStatus\"\n                                      render={({ field }) => (\n                                        <FormItem>\n                                          <FormLabel className=\"text-gray-700 dark:text-gray-300\">Plan Status</FormLabel>\n                                          <Select onValueChange={field.onChange} defaultValue={field.value}>\n                                            <FormControl>\n                                              <SelectTrigger className=\"dark:bg-gray-700 dark:border-gray-600 dark:text-white\" data-testid=\"select-plan-status\">\n                                                <SelectValue placeholder=\"Select status\" />\n                                              </SelectTrigger>\n                                            </FormControl>\n                                            <SelectContent className=\"dark:bg-gray-800 dark:border-gray-700\">\n                                              <SelectItem value=\"active\">Active</SelectItem>\n                                              <SelectItem value=\"expired\">Expired</SelectItem>\n                                              <SelectItem value=\"cancelled\">Cancelled</SelectItem>\n                                            </SelectContent>\n                                          </Select>\n                                          <FormMessage className=\"dark:text-red-400\" />\n                                        </FormItem>\n                                      )}\n                                    />\n\n                                    <FormField\n                                      control={planForm.control}\n                                      name=\"planExpiry\"\n                                      render={({ field }) => (\n                                        <FormItem>\n                                          <FormLabel className=\"text-gray-700 dark:text-gray-300\">\n                                            <Calendar className=\"w-4 h-4 inline mr-1\" />\n                                            Plan Expiry (optional)\n                                          </FormLabel>\n                                          <FormControl>\n                                            <Input\n                                              {...field}\n                                              type=\"date\"\n                                              data-testid=\"input-plan-expiry\"\n                                              className=\"dark:bg-gray-700 dark:border-gray-600 dark:text-white\"\n                                            />\n                                          </FormControl>\n                                          <FormMessage className=\"dark:text-red-400\" />\n                                        </FormItem>\n                                      )}\n                                    />\n\n                                    <Button\n                                      type=\"submit\"\n                                      className=\"w-full bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 dark:from-purple-500 dark:to-blue-500 text-white dark:text-white\"\n                                      disabled={updatePlanMutation.isPending}\n                                      data-testid=\"button-save-plan\"\n                                    >\n                                      {updatePlanMutation.isPending ? \"Saving...\" : \"Save Changes\"}\n                                    </Button>\n                                  </form>\n                                </Form>\n                              </DialogContent>\n                            </Dialog>\n\n                            <Dialog open={editingTokenUserId === user.id} onOpenChange={(open) => !open && setEditingTokenUserId(null)}>\n                              <DialogTrigger asChild>\n                                <Button\n                                  variant=\"outline\"\n                                  size=\"sm\"\n                                  onClick={() => handleEditToken(user)}\n                                  data-testid={`button-edit-token-${user.id}`}\n                                  className=\"dark:border-gray-600 dark:text-gray-300\"\n                                >\n                                  <Key className=\"w-3 h-3 mr-1\" />\n                                  Token\n                                </Button>\n                              </DialogTrigger>\n                              <DialogContent className=\"dark:bg-gray-800 dark:border-gray-700\">\n                                <DialogHeader>\n                                  <DialogTitle className=\"text-gray-900 dark:text-white\">Edit API Token</DialogTitle>\n                                  <DialogDescription className=\"text-gray-600 dark:text-gray-400\">\n                                    Update bearer token for {user.username}\n                                  </DialogDescription>\n                                </DialogHeader>\n                                <Form {...tokenForm}>\n                                  <form onSubmit={tokenForm.handleSubmit(onTokenSubmit)} className=\"space-y-4\">\n                                    <FormField\n                                      control={tokenForm.control}\n                                      name=\"apiToken\"\n                                      render={({ field }) => (\n                                        <FormItem>\n                                          <FormLabel className=\"text-gray-700 dark:text-gray-300\">\n                                            <Key className=\"w-4 h-4 inline mr-1\" />\n                                            API Token\n                                          </FormLabel>\n                                          <FormControl>\n                                            <Input\n                                              {...field}\n                                              placeholder=\"Enter API token\"\n                                              data-testid=\"input-api-token\"\n                                              className=\"font-mono dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400\"\n                                            />\n                                          </FormControl>\n                                          <FormMessage className=\"dark:text-red-400\" />\n                                        </FormItem>\n                                      )}\n                                    />\n\n                                    <Button\n                                      type=\"submit\"\n                                      className=\"w-full bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 dark:from-purple-500 dark:to-blue-500 text-white dark:text-white\"\n                                      disabled={updateTokenMutation.isPending}\n                                      data-testid=\"button-save-token\"\n                                    >\n                                      {updateTokenMutation.isPending ? \"Saving...\" : \"Save Token\"}\n                                    </Button>\n                                  </form>\n                                </Form>\n                              </DialogContent>\n                            </Dialog>\n                          </div>\n                        </TableCell>\n                      </TableRow>\n                    ))}\n                  </TableBody>\n                </Table>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        {/* Token Rotation Management */}\n        <Card className=\"shadow-xl border-purple-100 dark:border-gray-700 dark:bg-gray-800\">\n          <CardHeader className=\"bg-gradient-to-r from-purple-50 to-blue-50 dark:from-gray-700 dark:to-gray-700\">\n            <CardTitle className=\"flex items-center gap-2 text-gray-800 dark:text-white\">\n              <RefreshCw className=\"w-5 h-5\" />\n              API Token Rotation\n            </CardTitle>\n            <CardDescription className=\"dark:text-gray-400\">\n              Manage multiple API tokens for load balancing and automatic rotation\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"pt-6 dark:bg-gray-800\">\n            {/* Rotation Settings */}\n            <div className=\"mb-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg\">\n              <h3 className=\"font-semibold mb-3 text-gray-800 dark:text-white\">Rotation Settings</h3>\n              <Form {...rotationSettingsForm}>\n                <form\n                  onSubmit={rotationSettingsForm.handleSubmit((data) =>\n                    updateRotationSettingsMutation.mutate(data)\n                  )}\n                  className=\"space-y-4\"\n                >\n                  <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                    <FormField\n                      control={rotationSettingsForm.control}\n                      name=\"rotationEnabled\"\n                      render={({ field }) => (\n                        <FormItem className=\"flex items-center gap-2\">\n                          <FormControl>\n                            <Switch\n                              checked={field.value}\n                              onCheckedChange={field.onChange}\n                              data-testid=\"switch-rotation-enabled\"\n                            />\n                          </FormControl>\n                          <FormLabel className=\"text-gray-700 dark:text-gray-300 mb-0\">\n                            Enable Rotation\n                          </FormLabel>\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={rotationSettingsForm.control}\n                      name=\"rotationIntervalMinutes\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel className=\"text-gray-700 dark:text-gray-300\">\n                            Interval (minutes)\n                          </FormLabel>\n                          <FormControl>\n                            <Input\n                              {...field}\n                              type=\"number\"\n                              data-testid=\"input-rotation-interval\"\n                              className=\"dark:bg-gray-600 dark:border-gray-500 dark:text-white\"\n                            />\n                          </FormControl>\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={rotationSettingsForm.control}\n                      name=\"maxRequestsPerToken\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel className=\"text-gray-700 dark:text-gray-300\">\n                            Max Requests/Token\n                          </FormLabel>\n                          <FormControl>\n                            <Input\n                              {...field}\n                              type=\"number\"\n                              data-testid=\"input-max-requests\"\n                              className=\"dark:bg-gray-600 dark:border-gray-500 dark:text-white\"\n                            />\n                          </FormControl>\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n\n                  {/* Batch Processing Settings */}\n                  <div className=\"mt-6 pt-4 border-t border-gray-200 dark:border-gray-600\">\n                    <h4 className=\"font-semibold mb-3 text-gray-800 dark:text-white\">Batch Processing Configuration</h4>\n                    <p className=\"text-sm text-gray-600 dark:text-gray-400 mb-4\">\n                      Configure how many videos are sent to the VEO API in each batch and the delay between batches to optimize generation performance.\n                    </p>\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                      <FormField\n                        control={rotationSettingsForm.control}\n                        name=\"videosPerBatch\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel className=\"text-gray-700 dark:text-gray-300\">\n                              Videos per Batch (1-50)\n                            </FormLabel>\n                            <FormControl>\n                              <Input\n                                {...field}\n                                type=\"number\"\n                                min=\"1\"\n                                max=\"50\"\n                                data-testid=\"input-videos-per-batch\"\n                                className=\"dark:bg-gray-600 dark:border-gray-500 dark:text-white\"\n                              />\n                            </FormControl>\n                            <FormDescription className=\"text-xs text-gray-500 dark:text-gray-400\">\n                              Number of videos sent in parallel in each batch\n                            </FormDescription>\n                          </FormItem>\n                        )}\n                      />\n                      <FormField\n                        control={rotationSettingsForm.control}\n                        name=\"batchDelaySeconds\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel className=\"text-gray-700 dark:text-gray-300\">\n                              Batch Delay (10-120 seconds)\n                            </FormLabel>\n                            <FormControl>\n                              <Input\n                                {...field}\n                                type=\"number\"\n                                min=\"10\"\n                                max=\"120\"\n                                data-testid=\"input-batch-delay\"\n                                className=\"dark:bg-gray-600 dark:border-gray-500 dark:text-white\"\n                              />\n                            </FormControl>\n                            <FormDescription className=\"text-xs text-gray-500 dark:text-gray-400\">\n                              Delay in seconds between processing batches\n                            </FormDescription>\n                          </FormItem>\n                        )}\n                      />\n                    </div>\n                  </div>\n\n                  <Button\n                    type=\"submit\"\n                    className=\"bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 dark:from-purple-500 dark:to-blue-500 text-white\"\n                    disabled={updateRotationSettingsMutation.isPending}\n                    data-testid=\"button-save-rotation-settings\"\n                  >\n                    {updateRotationSettingsMutation.isPending ? \"Saving...\" : \"Save Settings\"}\n                  </Button>\n                </form>\n              </Form>\n            </div>\n\n            {/* Bulk Replace Tokens */}\n            <div className=\"mb-6 p-4 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg\">\n              <h3 className=\"font-semibold mb-2 text-gray-800 dark:text-white flex items-center gap-2\">\n                <svg className=\"w-5 h-5 text-yellow-600 dark:text-yellow-400\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n                </svg>\n                Bulk Replace All Tokens\n              </h3>\n              <p className=\"text-sm text-gray-600 dark:text-gray-400 mb-3\">\n                ⚠️ This will DELETE all existing tokens and replace them with new ones. \"Bearer \" prefix will be automatically removed.\n              </p>\n              <Form {...bulkReplaceForm}>\n                <form\n                  onSubmit={bulkReplaceForm.handleSubmit((data) => setShowBulkConfirmation(true))}\n                  className=\"space-y-4\"\n                >\n                  <FormField\n                    control={bulkReplaceForm.control}\n                    name=\"tokens\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel className=\"text-gray-700 dark:text-gray-300\">\n                          Paste Tokens (one per line)\n                        </FormLabel>\n                        <FormControl>\n                          <textarea\n                            {...field}\n                            rows={6}\n                            placeholder=\"ya29.a0ARrdaM_example1&#10;Bearer ya29.a0ARrdaM_example2&#10;ya29.a0ARrdaM_example3\"\n                            className=\"w-full px-3 py-2 rounded-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-mono text-sm resize-vertical\"\n                            data-testid=\"textarea-bulk-tokens\"\n                          />\n                        </FormControl>\n                        <FormMessage className=\"dark:text-red-400\" />\n                      </FormItem>\n                    )}\n                  />\n                  <Button\n                    type=\"submit\"\n                    className=\"bg-yellow-600 hover:bg-yellow-700 dark:bg-yellow-600 dark:hover:bg-yellow-700 text-white\"\n                    data-testid=\"button-bulk-replace\"\n                  >\n                    Replace All Tokens\n                  </Button>\n                </form>\n              </Form>\n              \n              {/* Confirmation Dialog */}\n              {showBulkConfirmation && (\n                <Dialog open={showBulkConfirmation} onOpenChange={setShowBulkConfirmation}>\n                  <DialogContent className=\"dark:bg-gray-800\">\n                    <DialogHeader>\n                      <DialogTitle className=\"text-red-600 dark:text-red-400\">Confirm Token Replacement</DialogTitle>\n                      <DialogDescription className=\"dark:text-gray-300\">\n                        Are you sure you want to replace ALL existing tokens? This action cannot be undone.\n                        All current tokens will be permanently deleted.\n                      </DialogDescription>\n                    </DialogHeader>\n                    <div className=\"flex gap-3 justify-end mt-4\">\n                      <Button\n                        variant=\"outline\"\n                        onClick={() => setShowBulkConfirmation(false)}\n                        data-testid=\"button-cancel-bulk\"\n                      >\n                        Cancel\n                      </Button>\n                      <Button\n                        className=\"bg-red-600 hover:bg-red-700 text-white dark:bg-red-600 dark:hover:bg-red-700\"\n                        onClick={() => bulkReplaceTokensMutation.mutate(bulkReplaceForm.getValues())}\n                        disabled={bulkReplaceTokensMutation.isPending}\n                        data-testid=\"button-confirm-bulk\"\n                      >\n                        {bulkReplaceTokensMutation.isPending ? \"Replacing...\" : \"Yes, Replace All\"}\n                      </Button>\n                    </div>\n                  </DialogContent>\n                </Dialog>\n              )}\n            </div>\n\n            {/* Add New Token */}\n            <div className=\"mb-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg\">\n              <h3 className=\"font-semibold mb-3 text-gray-800 dark:text-white\">Add New Token</h3>\n              <Form {...addTokenForm}>\n                <form\n                  onSubmit={addTokenForm.handleSubmit((data) => addTokenMutation.mutate(data))}\n                  className=\"space-y-4\"\n                >\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                    <FormField\n                      control={addTokenForm.control}\n                      name=\"label\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel className=\"text-gray-700 dark:text-gray-300\">Label</FormLabel>\n                          <FormControl>\n                            <Input\n                              {...field}\n                              placeholder=\"e.g., Primary Token\"\n                              data-testid=\"input-token-label\"\n                              className=\"dark:bg-gray-600 dark:border-gray-500 dark:text-white dark:placeholder-gray-400\"\n                            />\n                          </FormControl>\n                          <FormMessage className=\"dark:text-red-400\" />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={addTokenForm.control}\n                      name=\"token\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel className=\"text-gray-700 dark:text-gray-300\">Token</FormLabel>\n                          <FormControl>\n                            <Input\n                              {...field}\n                              placeholder=\"Enter API bearer token\"\n                              data-testid=\"input-new-token\"\n                              className=\"font-mono dark:bg-gray-600 dark:border-gray-500 dark:text-white dark:placeholder-gray-400\"\n                            />\n                          </FormControl>\n                          <FormMessage className=\"dark:text-red-400\" />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n                  <Button\n                    type=\"submit\"\n                    className=\"bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 dark:from-purple-500 dark:to-blue-500 text-white\"\n                    disabled={addTokenMutation.isPending}\n                    data-testid=\"button-add-token\"\n                  >\n                    {addTokenMutation.isPending ? \"Adding...\" : \"Add Token\"}\n                  </Button>\n                </form>\n              </Form>\n            </div>\n\n            {/* Token List */}\n            {isLoadingTokens ? (\n              <p className=\"text-center py-4 text-gray-600 dark:text-gray-400\">Loading tokens...</p>\n            ) : tokensData?.tokens.length === 0 ? (\n              <p className=\"text-center py-4 text-gray-600 dark:text-gray-400\">\n                No tokens added yet. Add a token above to start.\n              </p>\n            ) : (\n              <div className=\"overflow-x-auto\">\n                <Table>\n                  <TableHeader>\n                    <TableRow className=\"dark:border-gray-600\">\n                      <TableHead className=\"dark:text-gray-300\">Label</TableHead>\n                      <TableHead className=\"dark:text-gray-300\">Token</TableHead>\n                      <TableHead className=\"dark:text-gray-300\">Status</TableHead>\n                      <TableHead className=\"dark:text-gray-300\">Requests</TableHead>\n                      <TableHead className=\"dark:text-gray-300\">Last Used</TableHead>\n                      <TableHead className=\"dark:text-gray-300\">Actions</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {tokensData?.tokens.map((token) => (\n                      <TableRow key={token.id} className=\"dark:border-gray-600\">\n                        <TableCell className=\"font-medium dark:text-white\" data-testid={`token-label-${token.id}`}>\n                          {token.label}\n                        </TableCell>\n                        <TableCell className=\"font-mono text-sm dark:text-gray-300\" data-testid={`token-value-${token.id}`}>\n                          {token.token.substring(0, 20)}...\n                        </TableCell>\n                        <TableCell data-testid={`token-status-${token.id}`}>\n                          <Switch\n                            checked={token.isActive}\n                            onCheckedChange={(checked) =>\n                              toggleTokenMutation.mutate({ tokenId: token.id, isActive: checked })\n                            }\n                            data-testid={`switch-token-status-${token.id}`}\n                          />\n                          <span className={`ml-2 text-sm ${token.isActive ? 'text-green-600 dark:text-green-400' : 'text-gray-500 dark:text-gray-500'}`}>\n                            {token.isActive ? \"Active\" : \"Inactive\"}\n                          </span>\n                        </TableCell>\n                        <TableCell className=\"dark:text-gray-300\" data-testid={`token-requests-${token.id}`}>\n                          {token.requestCount}\n                        </TableCell>\n                        <TableCell className=\"dark:text-gray-300\" data-testid={`token-last-used-${token.id}`}>\n                          {token.lastUsedAt ? new Date(token.lastUsedAt).toLocaleString() : \"Never\"}\n                        </TableCell>\n                        <TableCell>\n                          <Button\n                            variant=\"destructive\"\n                            size=\"sm\"\n                            onClick={() => deleteTokenMutation.mutate(token.id)}\n                            disabled={deleteTokenMutation.isPending}\n                            data-testid={`button-delete-token-${token.id}`}\n                            className=\"dark:bg-red-600 dark:hover:bg-red-700\"\n                          >\n                            Delete\n                          </Button>\n                        </TableCell>\n                      </TableRow>\n                    ))}\n                  </TableBody>\n                </Table>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","size_bytes":67324},"client/src/pages/History.tsx":{"content":"import { useEffect, useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Link, useLocation } from \"wouter\";\nimport { Home, Download, Calendar, Film, Loader2, RefreshCw, Merge, Play, AlertCircle, CheckCircle2, Clock } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport type { VideoHistory, Scene } from \"@shared/schema\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from \"@/components/ui/accordion\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\n\ninterface GroupedVideo {\n  project?: {\n    id: string;\n    title: string;\n    scenes: Scene[];\n    characters: any[];\n    mergedVideoUrl?: string;\n  };\n  videos: VideoHistory[];\n}\n\nexport default function History() {\n  const { toast } = useToast();\n  const [, setLocation] = useLocation();\n  const [mergingProject, setMergingProject] = useState<string | null>(null);\n  const [mergedVideoUrls, setMergedVideoUrls] = useState<Record<string, string>>({});\n  const [selectedVideos, setSelectedVideos] = useState<Set<string>>(new Set());\n  const [isMergingSelected, setIsMergingSelected] = useState(false);\n\n  const { data: session, isLoading: sessionLoading } = useQuery<{\n    authenticated: boolean;\n    user?: { id: string; username: string; isAdmin: boolean };\n  }>({\n    queryKey: [\"/api/session\"],\n  });\n\n  const { data, isLoading, refetch } = useQuery<{ \n    videos: VideoHistory[]; \n    grouped: Record<string, GroupedVideo>;\n  }>({\n    queryKey: [\"/api/video-history\"],\n    enabled: session?.authenticated === true,\n    refetchInterval: (query) => {\n      // Auto-refresh every 3 seconds if there are pending or queued videos\n      const videos = query.state.data?.videos;\n      if (!videos) return false;\n      \n      const hasProcessingVideos = videos.some(\n        video => video.status === 'pending' || video.status === 'queued'\n      );\n      \n      return hasProcessingVideos ? 3000 : false;\n    },\n  });\n\n  const regenerateMutation = useMutation({\n    mutationFn: async ({ prompt, sceneNumber, videoId, projectId }: { \n      prompt: string; \n      sceneNumber: number;\n      videoId: string;\n      projectId?: string;\n    }) => {\n      // Use the dedicated regenerate endpoint\n      const response = await fetch('/api/regenerate-video', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        credentials: 'include',\n        body: JSON.stringify({ \n          videoId,\n          prompt,\n          aspectRatio: \"landscape\",\n          projectId,\n          sceneNumber\n        }),\n      });\n\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.error || 'Failed to regenerate video');\n      }\n\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Video Regeneration Started\",\n        description: \"Your video is being regenerated. This may take a few minutes.\",\n      });\n      refetch();\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Regeneration Failed\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const retryMergeMutation = useMutation({\n    mutationFn: async (videoId: string) => {\n      const response = await fetch(`/api/retry-merge/${videoId}`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        credentials: 'include',\n      });\n\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || 'Failed to retry merge');\n      }\n\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Merge Retry Started\",\n        description: \"Your videos are being merged again. This may take a few minutes.\",\n      });\n      refetch();\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Retry Failed\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Redirect to login if not authenticated\n  useEffect(() => {\n    if (!sessionLoading && session && !session.authenticated) {\n      toast({\n        title: \"Authentication required\",\n        description: \"Please log in to view your video history.\",\n        variant: \"destructive\",\n      });\n      setLocation(\"/login\");\n    }\n  }, [session, sessionLoading, setLocation, toast]);\n\n  const formatDate = (dateString: string) => {\n    const date = new Date(dateString);\n    return date.toLocaleDateString() + \" \" + date.toLocaleTimeString();\n  };\n\n  // Calculate today's statistics\n  const getTodayStats = () => {\n    if (!data?.videos) return { total: 0, completed: 0, failed: 0, pending: 0, queued: 0 };\n    \n    const today = new Date();\n    today.setHours(0, 0, 0, 0);\n    \n    const todayVideos = data.videos.filter(video => {\n      const videoDate = new Date(video.createdAt);\n      videoDate.setHours(0, 0, 0, 0);\n      return videoDate.getTime() === today.getTime();\n    });\n    \n    return {\n      total: todayVideos.length,\n      completed: todayVideos.filter(v => v.status === 'completed').length,\n      failed: todayVideos.filter(v => v.status === 'failed').length,\n      pending: todayVideos.filter(v => v.status === 'pending').length,\n      queued: todayVideos.filter(v => v.status === 'queued').length,\n    };\n  };\n\n  const todayStats = getTodayStats();\n\n  const handleDownload = (videoUrl: string) => {\n    window.open(videoUrl, '_blank');\n  };\n\n  const handleVideoSelect = (videoId: string, isCompleted: boolean) => {\n    if (!isCompleted) {\n      toast({\n        title: \"Cannot Select\",\n        description: \"Only completed videos can be selected for merging.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setSelectedVideos(prev => {\n      const newSelection = new Set(prev);\n      if (newSelection.has(videoId)) {\n        newSelection.delete(videoId);\n      } else {\n        if (newSelection.size >= 19) {\n          toast({\n            title: \"Maximum Selection Reached\",\n            description: \"You can select maximum 19 videos at a time.\",\n            variant: \"destructive\",\n          });\n          return prev;\n        }\n        newSelection.add(videoId);\n      }\n      return newSelection;\n    });\n  };\n\n  const handleMergeSelected = async () => {\n    if (selectedVideos.size < 2) {\n      toast({\n        title: \"Select More Videos\",\n        description: \"Please select at least 2 videos to merge.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    try {\n      setIsMergingSelected(true);\n\n      // Send video IDs (not URLs) for security - backend will verify ownership\n      const videoIds = Array.from(selectedVideos);\n\n      const response = await fetch('/api/merge-selected-videos', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        credentials: 'include',\n        body: JSON.stringify({\n          videoIds: videoIds,\n        }),\n      });\n\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || 'Failed to merge videos');\n      }\n\n      const result = await response.json();\n\n      toast({\n        title: \"Videos Merged Successfully!\",\n        description: `${selectedVideos.size} videos have been merged.`,\n      });\n\n      // Clear selection\n      setSelectedVideos(new Set());\n\n      // Show the merged video in a new window or download\n      if (result.mergedVideoUrl) {\n        window.open(result.mergedVideoUrl, '_blank');\n      }\n\n      refetch();\n    } catch (error) {\n      console.error(\"Error merging selected videos:\", error);\n      toast({\n        title: \"Merge Failed\",\n        description: error instanceof Error ? error.message : \"Failed to merge selected videos.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsMergingSelected(false);\n    }\n  };\n\n  const handleMergeVideos = async (projectKey: string, videos: VideoHistory[], projectId?: string) => {\n    try {\n      const completedVideos = videos.filter(v => v.status === 'completed' && v.videoUrl);\n      \n      if (completedVideos.length < 2) {\n        toast({\n          title: \"Cannot Merge\",\n          description: \"You need at least 2 completed videos to merge.\",\n          variant: \"destructive\",\n        });\n        return;\n      }\n\n      setMergingProject(projectKey);\n\n      // Sort by scene number (extract from title)\n      const sortedVideos = completedVideos.sort((a, b) => {\n        const aNum = parseInt(a.title?.match(/Scene (\\d+)/)?.[1] || '0');\n        const bNum = parseInt(b.title?.match(/Scene (\\d+)/)?.[1] || '0');\n        return aNum - bNum;\n      });\n\n      const payload: any = {\n        videos: sortedVideos.map((v, idx) => ({\n          sceneNumber: idx + 1,\n          videoUrl: v.videoUrl!\n        }))\n      };\n\n      if (projectId) {\n        payload.projectId = projectId;\n      }\n\n      const response = await fetch('/api/merge-videos', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        credentials: 'include',\n        body: JSON.stringify(payload),\n      });\n\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || 'Failed to merge videos');\n      }\n\n      const result = await response.json();\n      \n      setMergedVideoUrls(prev => ({\n        ...prev,\n        [projectKey]: result.mergedVideoUrl\n      }));\n\n      toast({\n        title: \"Videos Merged!\",\n        description: \"All videos have been successfully merged into one.\",\n      });\n\n      refetch();\n    } catch (error) {\n      console.error(\"Error merging videos:\", error);\n      toast({\n        title: \"Merge Failed\",\n        description: error instanceof Error ? error.message : \"Failed to merge videos.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setMergingProject(null);\n    }\n  };\n\n  const renderVideoCard = (video: VideoHistory, showRegenerateButton = false) => {\n    const isSelected = selectedVideos.has(video.id);\n    const isCompleted = video.status === 'completed';\n    \n    return (\n      <Card key={video.id} data-testid={`video-card-${video.id}`} className={`h-full bg-[#1e2838] dark:bg-[#181e2a] border transition-all ${\n        isSelected ? 'border-purple-500 ring-2 ring-purple-500/50' : 'border-white/10'\n      }`}>\n        <CardHeader className=\"p-3 sm:p-4\">\n          <div className=\"flex items-start gap-2 mb-2\">\n            <Checkbox\n              checked={isSelected}\n              onCheckedChange={() => handleVideoSelect(video.id, isCompleted)}\n              disabled={!isCompleted}\n              className=\"mt-0.5 border-white/30 data-[state=checked]:bg-purple-600 data-[state=checked]:border-purple-600\"\n              data-testid={`checkbox-select-${video.id}`}\n            />\n            <div className=\"flex-1\">\n              <CardTitle className=\"flex items-center gap-2 text-sm sm:text-base text-white\">\n                <Film className=\"w-4 h-4\" />\n                <span className=\"truncate\">{video.title || `Video ${video.id.slice(0, 8)}`}</span>\n              </CardTitle>\n              <CardDescription className=\"flex items-center gap-2 text-xs text-gray-300 mt-1\">\n                <Calendar className=\"w-3 h-3\" />\n                {formatDate(video.createdAt)}\n              </CardDescription>\n            </div>\n          </div>\n        </CardHeader>\n      <CardContent className=\"space-y-2 sm:space-y-3 p-3 sm:p-4\">\n        <p className=\"text-xs sm:text-sm\">\n          <span className={`inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium ${\n            video.status === 'completed' \n              ? 'bg-green-600/20 border border-green-500/30 text-green-300'\n              : video.status === 'failed'\n              ? 'bg-red-600/20 border border-red-500/30 text-red-300'\n              : video.status === 'queued'\n              ? 'bg-purple-600/20 border border-purple-500/30 text-purple-300'\n              : 'bg-yellow-600/20 border border-yellow-500/30 text-yellow-300'\n          }`}>\n            {video.status === 'completed' && <CheckCircle2 className=\"w-3 h-3\" />}\n            {video.status === 'failed' && <AlertCircle className=\"w-3 h-3\" />}\n            {video.status === 'pending' && <Loader2 className=\"w-3 h-3 animate-spin\" />}\n            {video.status === 'queued' && <Clock className=\"w-3 h-3\" />}\n            {video.status.charAt(0).toUpperCase() + video.status.slice(1)}\n          </span>\n        </p>\n\n        {/* Display the original prompt */}\n        {video.prompt && (\n          <div className=\"bg-white/5 border border-white/10 rounded-lg p-2 sm:p-3\">\n            <p className=\"text-xs text-gray-300 font-medium mb-1\">Prompt:</p>\n            <p className=\"text-xs sm:text-sm text-white line-clamp-3\" data-testid={`text-prompt-${video.id}`}>\n              {video.prompt}\n            </p>\n          </div>\n        )}\n\n        {video.videoUrl && video.status === 'completed' && (\n          <>\n            <div className=\"aspect-video bg-black rounded-lg overflow-hidden\">\n              <video\n                src={video.videoUrl}\n                controls\n                className=\"w-full h-full\"\n                data-testid={`video-player-${video.id}`}\n              />\n            </div>\n            <Button\n              onClick={() => handleDownload(video.videoUrl!)}\n              className=\"w-full\"\n              size=\"sm\"\n              data-testid={`button-download-${video.id}`}\n            >\n              <Download className=\"w-4 h-4 mr-2\" />\n              Download\n            </Button>\n          </>\n        )}\n\n        {/* Check if this is a merged video (has metadata with mergedVideoIds) */}\n        {(() => {\n          try {\n            const metadata = video.metadata ? JSON.parse(video.metadata) : null;\n            const isMergedVideo = metadata?.mergedVideoIds && Array.isArray(metadata.mergedVideoIds);\n            \n            // Show retry button for failed merged videos\n            if (isMergedVideo && video.status === 'failed') {\n              return (\n                <Button\n                  onClick={() => retryMergeMutation.mutate(video.id)}\n                  variant=\"outline\"\n                  className=\"w-full border-red-500/50 text-red-400 hover:bg-red-500/10\"\n                  size=\"sm\"\n                  disabled={retryMergeMutation.isPending}\n                  data-testid={`button-retry-merge-${video.id}`}\n                >\n                  <RefreshCw className=\"w-4 h-4 mr-2\" />\n                  Retry Merge\n                </Button>\n              );\n            }\n            \n            // Show regenerate button for regular videos when enabled\n            if (showRegenerateButton && !isMergedVideo) {\n              return (\n                <Button\n                  onClick={() => regenerateMutation.mutate({ \n                    sceneNumber: parseInt(video.title?.match(/Scene (\\d+)/)?.[1] || '1'),\n                    prompt: video.prompt,\n                    videoId: video.id,\n                    projectId: video.projectId || undefined\n                  })}\n                  variant=\"outline\"\n                  className=\"w-full border-white/20 text-white hover:bg-white/10\"\n                  size=\"sm\"\n                  disabled={regenerateMutation.isPending || video.status === 'queued'}\n                  data-testid={`button-regenerate-${video.id}`}\n                >\n                  <RefreshCw className=\"w-4 h-4 mr-2\" />\n                  Regenerate\n                </Button>\n              );\n            }\n          } catch (e) {\n            // If metadata parsing fails, show normal regenerate button\n            if (showRegenerateButton) {\n              return (\n                <Button\n                  onClick={() => regenerateMutation.mutate({ \n                    sceneNumber: parseInt(video.title?.match(/Scene (\\d+)/)?.[1] || '1'),\n                    prompt: video.prompt,\n                    videoId: video.id,\n                    projectId: video.projectId || undefined\n                  })}\n                  variant=\"outline\"\n                  className=\"w-full border-white/20 text-white hover:bg-white/10\"\n                  size=\"sm\"\n                  disabled={regenerateMutation.isPending || video.status === 'queued'}\n                  data-testid={`button-regenerate-${video.id}`}\n                >\n                  <RefreshCw className=\"w-4 h-4 mr-2\" />\n                  Regenerate\n                </Button>\n              );\n            }\n          }\n          return null;\n        })()}\n      </CardContent>\n    </Card>\n  );\n  };\n\n  const renderProjectGroup = (key: string, group: GroupedVideo) => {\n    const completedCount = group.videos.filter(v => v.status === 'completed').length;\n    const failedCount = group.videos.filter(v => v.status === 'failed').length;\n    const mergedUrl = group.project?.mergedVideoUrl || mergedVideoUrls[key];\n\n    if (group.project) {\n      // Cartoon project with scenes\n      return (\n        <Card key={key} className=\"mb-6 bg-[#1e2838] dark:bg-[#181e2a] border border-white/10\">\n          <CardHeader className=\"p-4 sm:p-6 bg-purple-600/10 border-b border-white/10\">\n            <div className=\"flex justify-between items-start gap-4\">\n              <div className=\"flex-1\">\n                <CardTitle className=\"text-lg sm:text-xl mb-2 text-white\">{group.project.title}</CardTitle>\n                <CardDescription className=\"text-sm text-gray-300\">\n                  {completedCount} of {group.videos.length} scenes completed\n                  {failedCount > 0 && ` • ${failedCount} failed`}\n                </CardDescription>\n              </div>\n              {completedCount >= 2 && (\n                <Button\n                  onClick={() => handleMergeVideos(key, group.videos, group.project?.id)}\n                  disabled={mergingProject === key}\n                  size=\"sm\"\n                  className=\"bg-purple-600 hover:bg-purple-700 border-0\"\n                  data-testid={`button-merge-${key}`}\n                >\n                  {mergingProject === key ? (\n                    <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                  ) : (\n                    <Merge className=\"w-4 h-4 mr-2\" />\n                  )}\n                  Merge Videos\n                </Button>\n              )}\n            </div>\n          </CardHeader>\n          <CardContent className=\"p-4 sm:p-6\">\n            {mergedUrl && (\n              <div className=\"mb-6 p-4 bg-green-600/10 border border-green-500/30 rounded-lg\">\n                <h3 className=\"font-semibold mb-3 flex items-center gap-2 text-white\">\n                  <Play className=\"w-5 h-5 text-green-400\" />\n                  Merged Video\n                </h3>\n                <div className=\"aspect-video bg-black rounded-lg overflow-hidden mb-3\">\n                  <video\n                    src={mergedUrl}\n                    controls\n                    className=\"w-full h-full\"\n                    data-testid={`merged-video-${key}`}\n                  />\n                </div>\n                <Button\n                  onClick={() => handleDownload(mergedUrl)}\n                  className=\"w-full bg-purple-600 hover:bg-purple-700 border-0\"\n                  size=\"sm\"\n                >\n                  <Download className=\"w-4 h-4 mr-2\" />\n                  Download Merged Video\n                </Button>\n              </div>\n            )}\n\n            <Accordion type=\"single\" collapsible className=\"w-full\">\n              <AccordionItem value=\"scenes\" className=\"border-white/10\">\n                <AccordionTrigger className=\"text-sm sm:text-base text-white hover:text-white\">\n                  View All Scenes ({group.videos.length})\n                </AccordionTrigger>\n                <AccordionContent>\n                  <div className=\"grid gap-3 sm:gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 mt-4\">\n                    {group.videos.map(video => renderVideoCard(video, true))}\n                  </div>\n                </AccordionContent>\n              </AccordionItem>\n            </Accordion>\n          </CardContent>\n        </Card>\n      );\n    } else {\n      // Standalone videos\n      return (\n        <div key={key} className=\"mb-6\">\n          <h3 className=\"text-lg font-semibold mb-4 text-white\">Standalone Videos</h3>\n          <div className=\"grid gap-3 sm:gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3\">\n            {group.videos.map(video => renderVideoCard(video, true))}\n          </div>\n        </div>\n      );\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-[#1a2332] via-[#1e2838] to-[#242d3f] dark:from-[#141a25] dark:via-[#181e2a] dark:to-[#1c2230]\">\n      <header className=\"border-b border-white/10 bg-[#1c2534]/80 dark:bg-[#161c28]/80 backdrop-blur-md sticky top-0 z-50\">\n        <div className=\"max-w-7xl mx-auto px-3 sm:px-4 py-2 sm:py-3 flex justify-between items-center\">\n          <h1 className=\"text-sm sm:text-base md:text-lg font-semibold text-white\">Video History</h1>\n          <Link href=\"/\">\n            <Button variant=\"outline\" size=\"sm\" className=\"border-white/20 text-white hover:bg-white/10\" data-testid=\"link-home\">\n              <Home className=\"w-4 h-4 sm:mr-1\" />\n              <span className=\"hidden sm:inline\">Home</span>\n            </Button>\n          </Link>\n        </div>\n      </header>\n\n      <div className=\"max-w-7xl mx-auto px-3 sm:px-4 py-4 sm:py-8\">\n        <div className=\"mb-4 sm:mb-6\">\n          <div className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-4\">\n            <div>\n              <h2 className=\"text-xl sm:text-2xl font-bold text-white\">Your Generated Videos</h2>\n              <p className=\"text-sm sm:text-base text-gray-300 mt-1\">\n                View, download, regenerate, and merge your cartoon videos\n              </p>\n            </div>\n            \n            {/* Merge Selected Button */}\n            {selectedVideos.size > 0 && (\n              <div className=\"flex items-center gap-3\">\n                <div className=\"text-sm text-gray-300\">\n                  {selectedVideos.size} selected (max 19)\n                </div>\n                <Button\n                  onClick={handleMergeSelected}\n                  disabled={selectedVideos.size < 2 || isMergingSelected}\n                  className=\"bg-purple-600 hover:bg-purple-700 border-0 shrink-0\"\n                  data-testid=\"button-merge-selected\"\n                >\n                  {isMergingSelected ? (\n                    <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                  ) : (\n                    <Merge className=\"w-4 h-4 mr-2\" />\n                  )}\n                  Merge Selected ({selectedVideos.size})\n                </Button>\n              </div>\n            )}\n          </div>\n        </div>\n\n        {/* Today's Statistics Card */}\n        {todayStats.total > 0 && (\n          <Card className=\"mb-6 bg-[#1e2838] dark:bg-[#181e2a] border border-white/10\">\n            <CardHeader className=\"p-4\">\n              <CardTitle className=\"flex items-center gap-2 text-lg text-white\">\n                <Calendar className=\"w-5 h-5 text-purple-400\" />\n                Today's Generation Summary\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"p-4 pt-0\">\n              <div className=\"grid grid-cols-2 sm:grid-cols-5 gap-3\">\n                <div className=\"text-center p-3 bg-white/5 border border-white/10 rounded-lg\">\n                  <div className=\"text-2xl font-bold text-white\">{todayStats.total}</div>\n                  <div className=\"text-xs text-gray-300 mt-1\">Total</div>\n                </div>\n                <div className=\"text-center p-3 bg-white/5 border border-white/10 rounded-lg\">\n                  <div className=\"flex items-center justify-center gap-1\">\n                    <CheckCircle2 className=\"w-5 h-5 text-green-400\" />\n                    <span className=\"text-2xl font-bold text-green-400\">{todayStats.completed}</span>\n                  </div>\n                  <div className=\"text-xs text-gray-300 mt-1\">Completed</div>\n                </div>\n                <div className=\"text-center p-3 bg-white/5 border border-white/10 rounded-lg\">\n                  <div className=\"flex items-center justify-center gap-1\">\n                    <Loader2 className=\"w-5 h-5 text-yellow-400\" />\n                    <span className=\"text-2xl font-bold text-yellow-400\">{todayStats.pending}</span>\n                  </div>\n                  <div className=\"text-xs text-gray-300 mt-1\">Processing</div>\n                </div>\n                <div className=\"text-center p-3 bg-white/5 border border-white/10 rounded-lg\">\n                  <div className=\"flex items-center justify-center gap-1\">\n                    <Clock className=\"w-5 h-5 text-purple-400\" />\n                    <span className=\"text-2xl font-bold text-purple-400\">{todayStats.queued}</span>\n                  </div>\n                  <div className=\"text-xs text-gray-300 mt-1\">Queued</div>\n                </div>\n                <div className=\"text-center p-3 bg-white/5 border border-white/10 rounded-lg\">\n                  <div className=\"flex items-center justify-center gap-1\">\n                    <AlertCircle className=\"w-5 h-5 text-red-400\" />\n                    <span className=\"text-2xl font-bold text-red-400\">{todayStats.failed}</span>\n                  </div>\n                  <div className=\"text-xs text-gray-300 mt-1\">Failed</div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n\n        {isLoading ? (\n          <div className=\"flex justify-center items-center py-12 sm:py-20\">\n            <Loader2 className=\"w-6 h-6 sm:w-8 sm:h-8 animate-spin text-primary\" />\n          </div>\n        ) : data?.grouped && Object.keys(data.grouped).length > 0 ? (\n          <div>\n            {Object.entries(data.grouped).map(([key, group]) => renderProjectGroup(key, group))}\n          </div>\n        ) : (\n          <div className=\"text-center py-20\">\n            <div className=\"mx-auto w-16 h-16 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center mb-4\">\n              <Film className=\"w-8 h-8 text-gray-400\" />\n            </div>\n            <h3 className=\"text-lg font-semibold text-gray-900 dark:text-white mb-2\">\n              No videos yet\n            </h3>\n            <p className=\"text-gray-600 dark:text-gray-400 mb-6\">\n              Start generating videos to build your collection\n            </p>\n            <Link href=\"/veo-generator\">\n              <Button data-testid=\"button-generate-first\">\n                <Film className=\"w-4 h-4 mr-2\" />\n                Generate Your First Video\n              </Button>\n            </Link>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n","size_bytes":27077},"client/src/pages/Home.tsx":{"content":"import { useState, useEffect, useRef } from \"react\";\nimport { useMutation, useQuery } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Button } from \"@/components/ui/button\";\nimport { Link, useLocation } from \"wouter\";\nimport Hero from \"@/components/Hero\";\nimport ProgressStepper from \"@/components/ProgressStepper\";\nimport ScriptForm from \"@/components/ScriptForm\";\nimport ProcessingState from \"@/components/ProcessingState\";\nimport ScenesDisplay from \"@/components/ScenesDisplay\";\nimport VideoGenerationProgress from \"@/components/VideoGenerationProgress\";\nimport VideosDisplay from \"@/components/VideosDisplay\";\nimport type { StoryInput, Scene } from \"@shared/schema\";\nimport { LogIn, Shield, LogOut, User, Menu, PlayCircle, History as HistoryIcon, Film, Layers, Sparkles, Wand2 } from \"lucide-react\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\n\nconst STEPS = [\n  { id: 1, title: \"Story & Characters\", description: \"Input details\" },\n  { id: 2, title: \"Generate Scenes\", description: \"AI processing\" },\n  { id: 3, title: \"Review Scenes\", description: \"View scenes\" },\n  { id: 4, title: \"Generate Videos\", description: \"Create videos\" },\n  { id: 5, title: \"View Videos\", description: \"Watch & download\" },\n];\n\ninterface VideoProgress {\n  sceneNumber: number;\n  sceneTitle: string;\n  status: 'pending' | 'starting' | 'generating' | 'completed' | 'failed';\n  videoUrl?: string;\n  error?: string;\n  message?: string;\n  timestamp?: string;\n}\n\ninterface GeneratedVideo {\n  sceneNumber: number;\n  sceneTitle: string;\n  videoUrl?: string;\n  status: string;\n  error?: string;\n}\n\nexport default function Home() {\n  const [currentStep, setCurrentStep] = useState(0);\n  const [storyInput, setStoryInput] = useState<StoryInput | null>(null);\n  const [scenes, setScenes] = useState<Scene[]>([]);\n  const [currentProjectId, setCurrentProjectId] = useState<string | null>(null);\n  const [videoProgress, setVideoProgress] = useState<VideoProgress[]>([]);\n  const [generatedVideos, setGeneratedVideos] = useState<GeneratedVideo[]>([]);\n  const [currentVideoScene, setCurrentVideoScene] = useState(0);\n  const [sceneGenerationError, setSceneGenerationError] = useState<string | null>(null);\n  const { toast } = useToast();\n  const abortControllersRef = useRef<Map<number, AbortController>>(new Map());\n  const [, setLocation] = useLocation();\n\n  const { data: session, isLoading: sessionLoading } = useQuery<{\n    authenticated: boolean;\n    user?: { id: string; username: string; isAdmin: boolean };\n  }>({\n    queryKey: [\"/api/session\"],\n  });\n\n  // Redirect to login if not authenticated and trying to create content\n  useEffect(() => {\n    if (!sessionLoading && session && !session.authenticated && currentStep > 0) {\n      toast({\n        title: \"Authentication required\",\n        description: \"Please log in to create videos and cartoons.\",\n        variant: \"destructive\",\n      });\n      setLocation(\"/login\");\n    }\n  }, [session, sessionLoading, currentStep, setLocation, toast]);\n\n  const logoutMutation = useMutation({\n    mutationFn: async () => {\n      const response = await apiRequest(\"POST\", \"/api/logout\", {});\n      const result = await response.json();\n      return result;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/session\"] });\n      toast({\n        title: \"Logged out successfully\",\n      });\n    },\n  });\n\n  // Cleanup abort controllers on unmount or step change\n  useEffect(() => {\n    return () => {\n      // Abort all ongoing retries when component unmounts or step changes\n      abortControllersRef.current.forEach(controller => controller.abort());\n      abortControllersRef.current.clear();\n    };\n  }, [currentStep]);\n\n  const generateScenesMutation = useMutation({\n    mutationFn: async (data: StoryInput) => {\n      const response = await apiRequest(\"POST\", \"/api/generate-scenes\", data);\n      const result = await response.json();\n      return result as { scenes: Scene[]; projectId: string };\n    },\n    onSuccess: (data) => {\n      setScenes(data.scenes);\n      setCurrentProjectId(data.projectId);\n      setSceneGenerationError(null);\n      setCurrentStep(3);\n      toast({\n        title: \"Success!\",\n        description: `Generated ${data.scenes.length} scenes for your story.`,\n      });\n    },\n    onError: (error: Error) => {\n      console.error(\"Error generating scenes:\", error);\n      setSceneGenerationError(error.message || \"Failed to generate scenes. Please try again.\");\n      toast({\n        title: \"Scene Generation Failed\",\n        description: error.message || \"Failed to generate scenes. Please try again.\",\n        variant: \"destructive\",\n      });\n      // Stay on step 2 to show error with retry button\n    },\n  });\n\n  const handleGetStarted = () => {\n    if (!session?.authenticated) {\n      toast({\n        title: \"Authentication required\",\n        description: \"Please log in to create videos and cartoons.\",\n        variant: \"destructive\",\n      });\n      setLocation(\"/login\");\n      return;\n    }\n    setCurrentStep(1);\n  };\n\n  const handleFormSubmit = async (data: StoryInput) => {\n    setStoryInput(data); // Store the story input for later use\n    setSceneGenerationError(null); // Clear any previous errors\n    setCurrentStep(2);\n    generateScenesMutation.mutate(data);\n  };\n\n  const handleStartNew = () => {\n    setCurrentStep(1);\n    setStoryInput(null);\n    setScenes([]);\n    setVideoProgress([]);\n    setGeneratedVideos([]);\n    setCurrentVideoScene(0);\n    setSceneGenerationError(null);\n  };\n\n  const handleRegenerateScenes = () => {\n    if (!storyInput) {\n      toast({\n        title: \"Error\",\n        description: \"No story input found. Please start a new story.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    setSceneGenerationError(null); // Clear error before retry\n    setCurrentStep(2);\n    generateScenesMutation.mutate(storyInput);\n  };\n\n  const handleRetrySceneGeneration = () => {\n    if (!storyInput) {\n      toast({\n        title: \"Error\",\n        description: \"No story input found. Please start a new story.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    setSceneGenerationError(null); // Clear error before retry\n    generateScenesMutation.mutate(storyInput);\n  };\n\n  const handleRetryVideo = async (sceneNumber: number) => {\n    // Find the scene to retry\n    const scene = scenes.find(s => s.scene === sceneNumber);\n    if (!scene) {\n      toast({\n        title: \"Error\",\n        description: \"Scene not found\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    // Abort any existing retry for this scene to prevent concurrent retries\n    const existingController = abortControllersRef.current.get(sceneNumber);\n    if (existingController) {\n      existingController.abort();\n      abortControllersRef.current.delete(sceneNumber);\n    }\n\n    // Create abort controller for this retry\n    const abortController = new AbortController();\n    abortControllersRef.current.set(sceneNumber, abortController);\n\n    // Update the video status to show it's being regenerated (functional update)\n    setGeneratedVideos(prev => prev.map(v => \n      v.sceneNumber === sceneNumber \n        ? { ...v, status: 'generating', error: undefined }\n        : v\n    ));\n\n    try {\n      const response = await fetch('/api/generate-video', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({ scene }),\n        signal: abortController.signal,\n      });\n\n      const result = await response.json();\n\n      if (!response.ok) {\n        throw new Error(result.message || 'Failed to start video generation');\n      }\n\n      // Poll for completion\n      const { operationName, sceneId } = result;\n      const maxAttempts = 300; // 5 minutes max with 1s polling\n      \n      for (let i = 0; i < maxAttempts; i++) {\n        if (abortController.signal.aborted) break;\n        \n        await new Promise(resolve => setTimeout(resolve, 1000)); // Wait 1 second\n        \n        if (abortController.signal.aborted) break;\n        \n        const statusResponse = await fetch('/api/check-video-status', {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n          },\n          credentials: 'include',\n          body: JSON.stringify({ operationName, sceneId }),\n          signal: abortController.signal,\n        });\n\n        const statusData = await statusResponse.json();\n        \n        if (statusData.status === 'COMPLETED' || statusData.status === 'MEDIA_GENERATION_STATUS_COMPLETE' || statusData.status === 'MEDIA_GENERATION_STATUS_SUCCESSFUL') {\n          if (abortController.signal.aborted) break;\n          \n          // Use functional update to ensure we work with latest state\n          // Add cache-busting timestamp to force browser to reload the new video\n          const cacheBustedUrl = statusData.videoUrl ? `${statusData.videoUrl}${statusData.videoUrl.includes('?') ? '&' : '?'}t=${Date.now()}` : undefined;\n          setGeneratedVideos(prev => prev.map(v => \n            v.sceneNumber === sceneNumber \n              ? { sceneNumber: v.sceneNumber, sceneTitle: v.sceneTitle, status: 'completed', videoUrl: cacheBustedUrl }\n              : v\n          ));\n          toast({\n            title: \"Video Regenerated!\",\n            description: `Scene ${sceneNumber} has been successfully regenerated.`,\n          });\n          return;\n        } else if (statusData.status === 'FAILED' || statusData.status === 'MEDIA_GENERATION_STATUS_FAILED') {\n          throw new Error(statusData.error || 'Video generation failed');\n        }\n      }\n\n      if (!abortController.signal.aborted) {\n        throw new Error('Video generation timed out');\n      }\n    } catch (error) {\n      // Don't show errors if aborted\n      if (abortController.signal.aborted) return;\n      \n      console.error(\"Error regenerating video:\", error);\n      // Use functional update to ensure we work with latest state\n      setGeneratedVideos(prev => prev.map(v => \n        v.sceneNumber === sceneNumber \n          ? { ...v, status: 'failed', error: error instanceof Error ? error.message : 'Unknown error' }\n          : v\n      ));\n      toast({\n        title: \"Regeneration Failed\",\n        description: error instanceof Error ? error.message : \"Failed to regenerate video.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      // Clean up abort controller\n      abortControllersRef.current.delete(sceneNumber);\n    }\n  };\n\n  const handleRetryAllFailed = async () => {\n    // Get current failed videos using functional state access\n    let failedSceneNumbers: number[] = [];\n    setGeneratedVideos(prev => {\n      failedSceneNumbers = prev.filter(v => v.status === 'failed').map(v => v.sceneNumber);\n      return prev;\n    });\n    \n    // Process each failed video sequentially\n    for (const sceneNumber of failedSceneNumbers) {\n      // Check if still failed (in case state changed)\n      let shouldRetry = false;\n      setGeneratedVideos(prev => {\n        shouldRetry = prev.some(v => v.sceneNumber === sceneNumber && v.status === 'failed');\n        return prev;\n      });\n      \n      if (shouldRetry) {\n        await handleRetryVideo(sceneNumber);\n      }\n    }\n  };\n\n  const handleGenerateVideos = async () => {\n    setCurrentStep(4);\n    \n    // Initialize progress for all scenes\n    const initialProgress: VideoProgress[] = scenes.map(scene => ({\n      sceneNumber: scene.scene,\n      sceneTitle: scene.title,\n      status: 'pending' as const\n    }));\n    setVideoProgress(initialProgress);\n    setCurrentVideoScene(0);\n\n    try {\n      const response = await fetch('/api/generate-all-videos', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({ \n          scenes,\n          characters: storyInput?.characters \n        }),\n      });\n\n      const reader = response.body?.getReader();\n      const decoder = new TextDecoder();\n\n      if (!reader) {\n        throw new Error('No response reader available');\n      }\n\n      let buffer = '';\n\n      while (true) {\n        const { done, value } = await reader.read();\n        if (done) break;\n\n        // Decode chunk and add to buffer\n        buffer += decoder.decode(value, { stream: true });\n        \n        // Process complete lines from buffer\n        const lines = buffer.split('\\n');\n        \n        // Keep the last incomplete line in the buffer\n        buffer = lines.pop() || '';\n\n        for (const line of lines) {\n          if (line.startsWith('data: ')) {\n            try {\n              const data = JSON.parse(line.substring(6));\n              \n              // Log all SSE updates for debugging\n              console.log('[SSE Received]', data.type, 'Scene:', data.sceneNumber, '-', data.message || data.status);\n\n              if (data.type === 'progress') {\n                if (data.current) {\n                  setCurrentVideoScene(data.current);\n                }\n                setVideoProgress(prev => prev.map(p => \n                  p.sceneNumber === data.sceneNumber \n                    ? { \n                        ...p, \n                        status: data.status,\n                        message: data.message,\n                        timestamp: data.timestamp\n                      }\n                    : p\n                ));\n              } else if (data.type === 'video_complete') {\n                setVideoProgress(prev => prev.map(p => \n                  p.sceneNumber === data.sceneNumber \n                    ? { \n                        ...p, \n                        status: 'completed', \n                        videoUrl: data.videoUrl,\n                        message: 'Complete',\n                        timestamp: data.timestamp\n                      }\n                    : p\n                ));\n\n                // Save completed video to history\n                (async () => {\n                  try {\n                    const sceneData = scenes.find(s => s.scene === data.sceneNumber);\n                    console.log('[Video History] Saving scene', data.sceneNumber, 'to history');\n                    const response = await fetch('/api/video-history', {\n                      method: 'POST',\n                      headers: {\n                        'Content-Type': 'application/json',\n                      },\n                      credentials: 'include',\n                      body: JSON.stringify({\n                        prompt: sceneData?.description || 'Scene video',\n                        aspectRatio: 'landscape',\n                        status: 'completed',\n                        videoUrl: data.videoUrl,\n                        title: sceneData?.title || `Scene ${data.sceneNumber}`,\n                      }),\n                    });\n                    \n                    if (response.ok) {\n                      const result = await response.json();\n                      console.log('[Video History] Saved successfully:', result.video.id);\n                    } else {\n                      console.error('[Video History] Failed to save:', await response.text());\n                    }\n                  } catch (historyError) {\n                    console.error('[Video History] Error:', historyError);\n                  }\n                })();\n              } else if (data.type === 'error') {\n                setVideoProgress(prev => prev.map(p => \n                  p.sceneNumber === data.sceneNumber \n                    ? { \n                        ...p, \n                        status: 'failed', \n                        error: data.error,\n                        timestamp: data.timestamp\n                      }\n                    : p\n                ));\n              } else if (data.type === 'complete') {\n                setGeneratedVideos(data.videos);\n                setCurrentStep(5);\n                toast({\n                  title: \"Videos Generated!\",\n                  description: `Successfully generated ${data.videos.filter((v: GeneratedVideo) => v.status === 'completed').length} videos.`,\n                });\n              }\n            } catch (parseError) {\n              console.error(\"Error parsing SSE data:\", parseError, \"Line:\", line);\n            }\n          }\n        }\n      }\n    } catch (error) {\n      console.error(\"Error generating videos:\", error);\n      toast({\n        title: \"Error\",\n        description: error instanceof Error ? error.message : \"Failed to generate videos.\",\n        variant: \"destructive\",\n      });\n      setCurrentStep(3);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-[#1a2332] via-[#1e2838] to-[#242d3f] dark:from-[#141a25] dark:via-[#181e2a] dark:to-[#1c2230]\">\n      <header className=\"border-b border-white/10 bg-[#1c2534]/80 dark:bg-[#161c28]/80 backdrop-blur-md sticky top-0 z-50\">\n        <div className=\"max-w-7xl mx-auto px-2 sm:px-4 py-2 sm:py-3 flex justify-between items-center gap-2\">\n          <div className=\"flex items-center gap-1 sm:gap-3 flex-1 min-w-0\">\n            <DropdownMenu>\n              <DropdownMenuTrigger asChild>\n                <Button variant=\"ghost\" size=\"sm\" data-testid=\"button-menu\" className=\"shrink-0 text-white hover:bg-white/10\">\n                  <Menu className=\"w-5 h-5\" />\n                </Button>\n              </DropdownMenuTrigger>\n              <DropdownMenuContent align=\"start\">\n                <Link href=\"/\">\n                  <DropdownMenuItem data-testid=\"menu-cartoon-generator\">\n                    <Sparkles className=\"w-4 h-4 mr-2\" />\n                    Cartoon Story Generator\n                  </DropdownMenuItem>\n                </Link>\n                <Link href=\"/veo-generator\">\n                  <DropdownMenuItem data-testid=\"menu-veo-generator\">\n                    <PlayCircle className=\"w-4 h-4 mr-2\" />\n                    VEO 3.1 Video Generator\n                  </DropdownMenuItem>\n                </Link>\n                <Link href=\"/bulk-generator\">\n                  <DropdownMenuItem data-testid=\"menu-bulk-generator\">\n                    <Layers className=\"w-4 h-4 mr-2\" />\n                    Bulk Video Generator\n                  </DropdownMenuItem>\n                </Link>\n                <Link href=\"/script-creator\">\n                  <DropdownMenuItem data-testid=\"menu-script-creator\">\n                    <Wand2 className=\"w-4 h-4 mr-2\" />\n                    Script Creator\n                  </DropdownMenuItem>\n                </Link>\n                <Link href=\"/projects\">\n                  <DropdownMenuItem data-testid=\"menu-projects\">\n                    <Film className=\"w-4 h-4 mr-2\" />\n                    My Projects\n                  </DropdownMenuItem>\n                </Link>\n                <Link href=\"/history\">\n                  <DropdownMenuItem data-testid=\"menu-history\">\n                    <HistoryIcon className=\"w-4 h-4 mr-2\" />\n                    Video History\n                  </DropdownMenuItem>\n                </Link>\n              </DropdownMenuContent>\n            </DropdownMenu>\n            <h1 className=\"text-sm sm:text-base md:text-lg font-semibold text-white truncate\">\n              <span className=\"hidden sm:inline\">Cartoon Story Video Generator</span>\n              <span className=\"sm:hidden\">Story Generator</span>\n            </h1>\n          </div>\n          <div className=\"flex items-center gap-1 sm:gap-2 shrink-0\">\n            {session?.authenticated ? (\n              <>\n                <div className=\"hidden md:flex items-center gap-2 text-sm text-gray-300\">\n                  <User className=\"w-4 h-4\" />\n                  <span className=\"text-white\">{session.user?.username}</span>\n                </div>\n                {session.user?.isAdmin && (\n                  <Link href=\"/admin\">\n                    <Button variant=\"outline\" size=\"sm\" data-testid=\"link-admin\" className=\"border-white/20 text-white hover:bg-white/10 hidden sm:inline-flex\">\n                      <Shield className=\"w-4 h-4 sm:mr-1\" />\n                      <span className=\"hidden sm:inline\">Admin</span>\n                    </Button>\n                  </Link>\n                )}\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={() => logoutMutation.mutate()}\n                  disabled={logoutMutation.isPending}\n                  data-testid=\"button-header-logout\"\n                  className=\"border-white/20 text-white hover:bg-white/10\"\n                >\n                  <LogOut className=\"w-4 h-4 sm:mr-1\" />\n                  <span className=\"hidden sm:inline\">Logout</span>\n                </Button>\n              </>\n            ) : (\n              <Link href=\"/login\">\n                <Button variant=\"outline\" size=\"sm\" data-testid=\"link-login\" className=\"border-white/20 text-white hover:bg-white/10\">\n                  <LogIn className=\"w-4 h-4 sm:mr-1\" />\n                  <span className=\"hidden sm:inline\">Login</span>\n                </Button>\n              </Link>\n            )}\n          </div>\n        </div>\n      </header>\n      {currentStep === 0 ? (\n        <Hero onGetStarted={handleGetStarted} />\n      ) : (\n        <>\n          <ProgressStepper currentStep={currentStep} steps={STEPS} />\n          \n          {currentStep === 1 && <ScriptForm onSubmit={handleFormSubmit} />}\n          \n          {currentStep === 2 && !sceneGenerationError && (\n            <ProcessingState status=\"Analyzing your script and generating scenes...\" />\n          )}\n\n          {currentStep === 2 && sceneGenerationError && (\n            <div className=\"max-w-2xl mx-auto px-4 py-16\">\n              <div className=\"bg-red-50 dark:bg-red-900/20 border-2 border-red-200 dark:border-red-800 rounded-2xl p-8 text-center\">\n                <div className=\"mb-6\">\n                  <div className=\"mx-auto w-16 h-16 bg-red-100 dark:bg-red-900/40 rounded-full flex items-center justify-center mb-4\">\n                    <svg \n                      className=\"w-8 h-8 text-red-600 dark:text-red-400\" \n                      fill=\"none\" \n                      viewBox=\"0 0 24 24\" \n                      stroke=\"currentColor\"\n                    >\n                      <path \n                        strokeLinecap=\"round\" \n                        strokeLinejoin=\"round\" \n                        strokeWidth={2} \n                        d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" \n                      />\n                    </svg>\n                  </div>\n                  <h2 className=\"text-2xl font-bold text-red-900 dark:text-red-100 mb-2\">\n                    Scene Generation Failed\n                  </h2>\n                  <p className=\"text-red-700 dark:text-red-300 mb-6\">\n                    {sceneGenerationError}\n                  </p>\n                </div>\n                \n                <div className=\"flex flex-col sm:flex-row gap-3 justify-center\">\n                  <Button\n                    size=\"lg\"\n                    onClick={handleRetrySceneGeneration}\n                    disabled={generateScenesMutation.isPending}\n                    className=\"bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 dark:from-purple-500 dark:to-blue-500 text-white\"\n                    data-testid=\"button-retry-scenes\"\n                  >\n                    {generateScenesMutation.isPending ? (\n                      <>\n                        <svg className=\"animate-spin -ml-1 mr-3 h-5 w-5 text-white\" xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\">\n                          <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\"></circle>\n                          <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"></path>\n                        </svg>\n                        Retrying...\n                      </>\n                    ) : (\n                      <>\n                        <svg className=\"w-5 h-5 mr-2\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15\" />\n                        </svg>\n                        Try Again\n                      </>\n                    )}\n                  </Button>\n                  \n                  <Button\n                    size=\"lg\"\n                    variant=\"outline\"\n                    onClick={handleStartNew}\n                    disabled={generateScenesMutation.isPending}\n                    className=\"border-2\"\n                    data-testid=\"button-start-over\"\n                  >\n                    Start Over\n                  </Button>\n                </div>\n              </div>\n            </div>\n          )}\n          \n          {currentStep === 3 && (\n            <div>\n              <ScenesDisplay \n                scenes={scenes} \n                onStartNew={handleStartNew}\n                onRegenerate={handleRegenerateScenes}\n                isRegenerating={generateScenesMutation.isPending}\n              />\n              <div className=\"max-w-6xl mx-auto px-4 pb-8\">\n                <div className=\"flex justify-center\">\n                  <Button\n                    size=\"lg\"\n                    onClick={handleGenerateVideos}\n                    className=\"h-14 px-12 rounded-full\"\n                    data-testid=\"button-generate-videos\"\n                  >\n                    Generate Videos with VEO 3\n                  </Button>\n                </div>\n              </div>\n            </div>\n          )}\n          \n          {currentStep === 4 && (\n            <>\n              <VideoGenerationProgress \n                progress={videoProgress}\n                currentScene={currentVideoScene}\n                totalScenes={scenes.length}\n              />\n              {videoProgress.some(v => v.status !== 'completed' && v.status !== 'failed') && (\n                <div className=\"max-w-4xl mx-auto px-4 pb-4\">\n                  <p className=\"text-center text-sm text-muted-foreground\">\n                    💡 Tip: If videos seem stuck, check <Link href=\"/history\" className=\"text-purple-400 hover:text-purple-300 underline\">Video History</Link> - they might already be ready!\n                  </p>\n                </div>\n              )}\n            </>\n          )}\n          \n          {currentStep === 5 && (\n            <VideosDisplay \n              videos={generatedVideos}\n              projectId={currentProjectId}\n              onStartNew={handleStartNew}\n              onRetryVideo={handleRetryVideo}\n              onRetryAllFailed={handleRetryAllFailed}\n            />\n          )}\n        </>\n      )}\n    </div>\n  );\n}\n","size_bytes":27215},"server/veo3.ts":{"content":"import type { Scene } from \"@shared/schema\";\n\nconst VEO3_BASE_URL = \"https://aisandbox-pa.googleapis.com/v1/video\";\n\ninterface VideoGenerationRequest {\n  clientContext: {\n    projectId: string;\n    tool: string;\n    userPaygateTier: string;\n  };\n  requests: Array<{\n    aspectRatio: string;\n    seed: number;\n    textInput: {\n      prompt: string;\n    };\n    videoModelKey: string;\n    metadata: {\n      sceneId: string;\n    };\n  }>;\n}\n\ninterface VideoGenerationResponse {\n  operations?: Array<{\n    operation: {\n      name: string;\n    };\n    sceneId: string;\n    status: string;\n  }>;\n  remainingCredits?: number;\n}\n\ninterface VideoStatusRequest {\n  operations: Array<{\n    operation: {\n      name: string;\n    };\n    sceneId: string;\n    status: string;\n  }>;\n}\n\ninterface VideoStatusResponse {\n  operations?: Array<{\n    operation: {\n      error?: {\n        message: string;\n      };\n      videoUrl?: string;\n      fileUrl?: string;\n      downloadUrl?: string;\n      [key: string]: any; // Allow for other fields\n    };\n    sceneId: string;\n    status: string;\n  }>;\n  remainingCredits?: number;\n}\n\nexport interface GeneratedVideo {\n  sceneId: string;\n  sceneNumber: number;\n  operationName: string;\n  status: string;\n  videoUrl?: string;\n  error?: string;\n}\n\n// Clean prompt by removing special characters that can cause errors\nfunction cleanPrompt(prompt: string): string {\n  // Remove special characters: \" * , : ; _ -\n  return prompt\n    .replace(/[\"*,:;_-]/g, ' ')\n    .replace(/\\s+/g, ' ')\n    .trim();\n}\n\n// Parse scene description to get the full prompt text\nfunction getScenePrompt(scene: Scene, characters?: Array<{ name: string; description: string }>): string {\n  // Disney Pixar style prefix for all prompts\n  const stylePrefix = \"In this vibrant and colourful scene, in the style of Disney Pixar's 3D animation,\";\n  let fullText = stylePrefix;\n  \n  // Prepend character details if provided\n  if (characters && characters.length > 0) {\n    const characterDescriptions = characters\n      .map(char => `${char.name}: ${char.description}`)\n      .join('. ');\n    fullText += ` Characters: ${characterDescriptions}. Scene: ${scene.title}. ${scene.description}`;\n  } else {\n    fullText += ` ${scene.title}. ${scene.description}`;\n  }\n  \n  return cleanPrompt(fullText);\n}\n\nexport async function generateVideoForScene(\n  scene: Scene,\n  projectId: string,\n  apiKey: string,\n  characters?: Array<{ name: string; description: string }>\n): Promise<{ operationName: string; sceneId: string }> {\n  const sceneId = `scene-${scene.scene}-${Date.now()}`;\n  const prompt = getScenePrompt(scene, characters);\n\n  // Trim the API key and remove \"Bearer \" prefix if present\n  let trimmedApiKey = apiKey.trim();\n  if (trimmedApiKey.startsWith('Bearer ')) {\n    trimmedApiKey = trimmedApiKey.substring(7); // Remove \"Bearer \" prefix\n  }\n\n  console.log(`[VEO3] Generating video for scene ${scene.scene}`);\n  console.log(`[VEO3] Project ID: ${projectId}`);\n  console.log(`[VEO3] API Key length: ${trimmedApiKey.length}, starts with: ${trimmedApiKey.substring(0, 10)}...`);\n  console.log(`[VEO3] Prompt: ${prompt}`);\n\n  const requestBody: VideoGenerationRequest = {\n    clientContext: {\n      projectId: projectId,\n      tool: \"PINHOLE\",\n      userPaygateTier: \"PAYGATE_TIER_TWO\"\n    },\n    requests: [{\n      aspectRatio: \"VIDEO_ASPECT_RATIO_LANDSCAPE\",\n      seed: Math.floor(Math.random() * 10000),\n      textInput: {\n        prompt: prompt\n      },\n      videoModelKey: \"veo_3_1_t2v_fast_ultra\",\n      metadata: {\n        sceneId: sceneId\n      }\n    }]\n  };\n\n  console.log(`[VEO3] Request URL: ${VEO3_BASE_URL}:batchAsyncGenerateVideoText`);\n  console.log(`[VEO3] Request body:`, JSON.stringify(requestBody, null, 2));\n\n  // Create an AbortController for timeout handling (60 seconds for generation)\n  const controller = new AbortController();\n  const timeoutId = setTimeout(() => controller.abort(), 60000);\n\n  try {\n    const response = await fetch(`${VEO3_BASE_URL}:batchAsyncGenerateVideoText`, {\n      method: \"POST\",\n      headers: {\n        \"Authorization\": `Bearer ${trimmedApiKey}`,\n        \"Content-Type\": \"application/json\"\n      },\n      body: JSON.stringify(requestBody),\n      signal: controller.signal\n    });\n\n    clearTimeout(timeoutId);\n\n    console.log(`[VEO3] Response status: ${response.status} ${response.statusText}`);\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      throw new Error(`VEO 3 API error: ${response.status} - ${errorText}`);\n    }\n\n    const data: VideoGenerationResponse = await response.json();\n    console.log(`[VEO3] Response data:`, JSON.stringify(data, null, 2));\n\n    if (!data.operations || data.operations.length === 0) {\n      throw new Error(\"No operation returned from VEO 3 API\");\n    }\n\n    // Flow API nests the operation name inside operation.name\n    const operationName = data.operations[0].operation?.name;\n    console.log(`[VEO3] Operation name: ${operationName}`);\n    \n    if (!operationName) {\n      throw new Error(\"No operation name in response\");\n    }\n    \n    return {\n      operationName,\n      sceneId\n    };\n  } catch (error: any) {\n    clearTimeout(timeoutId);\n    \n    // Handle timeout specifically\n    if (error.name === 'AbortError') {\n      console.error(`[VEO3] Video generation request timeout after 60 seconds for scene ${scene.scene}`);\n      throw new Error('VEO 3 API request timed out. Please try again.');\n    }\n    \n    throw error;\n  }\n}\n\nexport async function checkVideoStatus(\n  operationName: string,\n  sceneId: string,\n  apiKey: string,\n  retryCount: number = 0\n): Promise<{ status: string; videoUrl?: string; error?: string }> {\n  const MAX_RETRIES = 3;\n  \n  // Trim the API key and remove \"Bearer \" prefix if present\n  let trimmedApiKey = apiKey.trim();\n  if (trimmedApiKey.startsWith('Bearer ')) {\n    trimmedApiKey = trimmedApiKey.substring(7); // Remove \"Bearer \" prefix\n  }\n\n  const requestBody: VideoStatusRequest = {\n    operations: [{\n      operation: {\n        name: operationName\n      },\n      sceneId: sceneId,\n      status: \"MEDIA_GENERATION_STATUS_PENDING\"\n    }]\n  };\n\n  // Create an AbortController for timeout handling (30 seconds)\n  const controller = new AbortController();\n  const timeoutId = setTimeout(() => controller.abort(), 30000);\n\n  try {\n    const response = await fetch(`${VEO3_BASE_URL}:batchCheckAsyncVideoGenerationStatus`, {\n      method: \"POST\",\n      headers: {\n        \"Authorization\": `Bearer ${trimmedApiKey}`,\n        \"Content-Type\": \"application/json\"\n      },\n      body: JSON.stringify(requestBody),\n      signal: controller.signal\n    });\n\n    clearTimeout(timeoutId);\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      throw new Error(`VEO 3 status check error: ${response.status} - ${errorText}`);\n    }\n\n    const data: VideoStatusResponse = await response.json();\n    console.log(`[VEO3] Status check response:`, JSON.stringify(data, null, 2));\n\n    if (!data.operations || data.operations.length === 0) {\n      console.log(`[VEO3] No operations in status response, returning PENDING`);\n      return { status: \"PENDING\" };\n    }\n\n  const operationData = data.operations[0];\n  console.log(`[VEO3] Operation status: ${operationData.status}`);\n  console.log(`[VEO3] Operation data:`, JSON.stringify(operationData.operation, null, 2));\n  \n  // Extract video URL from the nested metadata structure\n  let videoUrl: string | undefined;\n  \n  // Try to get from metadata.video.fifeUrl (the actual location)\n  if (operationData.operation?.metadata?.video?.fifeUrl) {\n    videoUrl = operationData.operation.metadata.video.fifeUrl;\n  }\n  // Fallback to other possible locations\n  else if ((operationData.operation as any).videoUrl) {\n    videoUrl = (operationData.operation as any).videoUrl;\n  }\n  else if ((operationData.operation as any).fileUrl) {\n    videoUrl = (operationData.operation as any).fileUrl;\n  }\n  else if ((operationData.operation as any).downloadUrl) {\n    videoUrl = (operationData.operation as any).downloadUrl;\n  }\n  \n  // Decode HTML entities in the URL (VEO 3 returns &amp; instead of &)\n  if (videoUrl) {\n    const originalUrl = videoUrl;\n    // Use a comprehensive HTML entity decoder\n    videoUrl = videoUrl\n      .replace(/&amp;/g, '&')\n      .replace(/&lt;/g, '<')\n      .replace(/&gt;/g, '>')\n      .replace(/&quot;/g, '\"')\n      .replace(/&#39;/g, \"'\");\n    \n    console.log(`[VEO3] Found video URL`);\n    console.log(`[VEO3] Original length: ${originalUrl.length}, Decoded length: ${videoUrl.length}`);\n    console.log(`[VEO3] URL starts with: ${videoUrl.substring(0, 100)}`);\n    console.log(`[VEO3] Has &: ${videoUrl.includes('&')}, Has &amp;: ${videoUrl.includes('&amp;')}`);\n  } else {\n    console.log(`[VEO3] No video URL found in response`);\n  }\n  \n    return {\n      status: operationData.status,\n      videoUrl: videoUrl,\n      error: operationData.operation.error?.message\n    };\n  } catch (error: any) {\n    clearTimeout(timeoutId);\n    \n    // Handle timeout specifically with retry logic\n    if (error.name === 'AbortError') {\n      if (retryCount < MAX_RETRIES) {\n        const waitTime = Math.pow(2, retryCount) * 1000; // Exponential backoff: 1s, 2s, 4s\n        console.log(`[VEO3] Status check timeout for ${sceneId}, retrying in ${waitTime}ms (attempt ${retryCount + 1}/${MAX_RETRIES})`);\n        await new Promise(resolve => setTimeout(resolve, waitTime));\n        return checkVideoStatus(operationName, sceneId, apiKey, retryCount + 1);\n      } else {\n        console.error(`[VEO3] Status check timeout after ${MAX_RETRIES} retries for ${sceneId}`);\n        // Return PENDING status instead of throwing to allow polling to continue\n        return { status: \"PENDING\" };\n      }\n    }\n    \n    throw error;\n  }\n}\n\n// Poll for video completion with timeout\nexport async function waitForVideoCompletion(\n  operationName: string,\n  sceneId: string,\n  apiKey: string,\n  maxWaitTime: number = 300000 // 5 minutes default\n): Promise<{ videoUrl: string }> {\n  const startTime = Date.now();\n  const pollInterval = 1000; // Check every 1 second\n  const initialDelay = 1000; // Wait 1 second before first check\n\n  // Wait initially to give the API time to process\n  console.log(`[VEO3] Waiting ${initialDelay/1000}s before first status check for ${sceneId}`);\n  await new Promise(resolve => setTimeout(resolve, initialDelay));\n\n  while (Date.now() - startTime < maxWaitTime) {\n    const status = await checkVideoStatus(operationName, sceneId, apiKey);\n\n    console.log(`[VEO3] Polling status for ${sceneId}: ${status.status}`);\n\n    if (status.status === \"COMPLETED\" || status.status === \"MEDIA_GENERATION_STATUS_COMPLETE\" || status.status === \"MEDIA_GENERATION_STATUS_SUCCESSFUL\") {\n      if (status.videoUrl) {\n        console.log(`[VEO3] Video completed successfully with URL: ${status.videoUrl}`);\n        return { videoUrl: status.videoUrl };\n      }\n      throw new Error(\"Video completed but no URL provided\");\n    }\n\n    if (status.status === \"FAILED\" || status.status === \"MEDIA_GENERATION_STATUS_FAILED\") {\n      throw new Error(`Video generation failed: ${status.error || \"Unknown error\"}`);\n    }\n\n    // Wait before next poll\n    await new Promise(resolve => setTimeout(resolve, pollInterval));\n  }\n\n  throw new Error(\"Video generation timed out\");\n}\n\n// Poll for video completion with timeout and status updates callback\nexport async function waitForVideoCompletionWithUpdates(\n  operationName: string,\n  sceneId: string,\n  apiKey: string,\n  onStatusUpdate?: (message: string) => void,\n  maxWaitTime: number = 300000 // 5 minutes default\n): Promise<{ videoUrl: string }> {\n  const startTime = Date.now();\n  const pollInterval = 1000; // Check every 1 second\n  const initialDelay = 1000; // Wait 1 second before first check\n\n  // Wait initially to give the API time to process\n  console.log(`[VEO3] Waiting ${initialDelay/1000}s before first status check for ${sceneId}`);\n  if (onStatusUpdate) {\n    onStatusUpdate('Waiting for VEO to start processing...');\n  }\n  await new Promise(resolve => setTimeout(resolve, initialDelay));\n\n  let pollCount = 0;\n  while (Date.now() - startTime < maxWaitTime) {\n    pollCount++;\n    const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);\n    \n    const status = await checkVideoStatus(operationName, sceneId, apiKey);\n\n    console.log(`[VEO3] Polling status for ${sceneId}: ${status.status}`);\n\n    // Send status update every 10 seconds to show activity\n    if (pollCount % 10 === 0 && onStatusUpdate) {\n      onStatusUpdate(`Still generating... (${elapsedSeconds}s elapsed)`);\n    }\n\n    if (status.status === \"COMPLETED\" || status.status === \"MEDIA_GENERATION_STATUS_COMPLETE\" || status.status === \"MEDIA_GENERATION_STATUS_SUCCESSFUL\") {\n      if (status.videoUrl) {\n        console.log(`[VEO3] Video completed successfully with URL: ${status.videoUrl}`);\n        if (onStatusUpdate) {\n          onStatusUpdate('Video generation complete!');\n        }\n        return { videoUrl: status.videoUrl };\n      }\n      throw new Error(\"Video completed but no URL provided\");\n    }\n\n    if (status.status === \"FAILED\" || status.status === \"MEDIA_GENERATION_STATUS_FAILED\") {\n      throw new Error(`Video generation failed: ${status.error || \"Unknown error\"}`);\n    }\n\n    // Wait before next poll\n    await new Promise(resolve => setTimeout(resolve, pollInterval));\n  }\n\n  throw new Error(\"Video generation timed out\");\n}\n","size_bytes":13400},"drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL, ensure the database is provisioned\");\n}\n\nexport default defineConfig({\n  out: \"./migrations\",\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n","size_bytes":325},"client/src/components/ui/accordion.tsx":{"content":"import * as React from \"react\"\nimport * as AccordionPrimitive from \"@radix-ui/react-accordion\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Accordion = AccordionPrimitive.Root\n\nconst AccordionItem = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <AccordionPrimitive.Item\n    ref={ref}\n    className={cn(\"border-b\", className)}\n    {...props}\n  />\n))\nAccordionItem.displayName = \"AccordionItem\"\n\nconst AccordionTrigger = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Header className=\"flex\">\n    <AccordionPrimitive.Trigger\n      ref={ref}\n      className={cn(\n        \"flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <ChevronDown className=\"h-4 w-4 shrink-0 transition-transform duration-200\" />\n    </AccordionPrimitive.Trigger>\n  </AccordionPrimitive.Header>\n))\nAccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName\n\nconst AccordionContent = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Content\n    ref={ref}\n    className=\"overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down\"\n    {...props}\n  >\n    <div className={cn(\"pb-4 pt-0\", className)}>{children}</div>\n  </AccordionPrimitive.Content>\n))\n\nAccordionContent.displayName = AccordionPrimitive.Content.displayName\n\nexport { Accordion, AccordionItem, AccordionTrigger, AccordionContent }\n","size_bytes":1977},"client/src/components/ui/sidebar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, VariantProps } from \"class-variance-authority\"\nimport { PanelLeftIcon } from \"lucide-react\"\n\nimport { useIsMobile } from \"@/hooks/use-mobile\"\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Separator } from \"@/components/ui/separator\"\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\n\nconst SIDEBAR_COOKIE_NAME = \"sidebar_state\"\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\nconst SIDEBAR_WIDTH = \"16rem\"\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\n\ntype SidebarContextProps = {\n  state: \"expanded\" | \"collapsed\"\n  open: boolean\n  setOpen: (open: boolean) => void\n  openMobile: boolean\n  setOpenMobile: (open: boolean) => void\n  isMobile: boolean\n  toggleSidebar: () => void\n}\n\nconst SidebarContext = React.createContext<SidebarContextProps | null>(null)\n\nfunction useSidebar() {\n  const context = React.useContext(SidebarContext)\n  if (!context) {\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\n  }\n\n  return context\n}\n\nfunction SidebarProvider({\n  defaultOpen = true,\n  open: openProp,\n  onOpenChange: setOpenProp,\n  className,\n  style,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  defaultOpen?: boolean\n  open?: boolean\n  onOpenChange?: (open: boolean) => void\n}) {\n  const isMobile = useIsMobile()\n  const [openMobile, setOpenMobile] = React.useState(false)\n\n  // This is the internal state of the sidebar.\n  // We use openProp and setOpenProp for control from outside the component.\n  const [_open, _setOpen] = React.useState(defaultOpen)\n  const open = openProp ?? _open\n  const setOpen = React.useCallback(\n    (value: boolean | ((value: boolean) => boolean)) => {\n      const openState = typeof value === \"function\" ? value(open) : value\n      if (setOpenProp) {\n        setOpenProp(openState)\n      } else {\n        _setOpen(openState)\n      }\n\n      // This sets the cookie to keep the sidebar state.\n      document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\n    },\n    [setOpenProp, open]\n  )\n\n  // Helper to toggle the sidebar.\n  const toggleSidebar = React.useCallback(() => {\n    return isMobile ? setOpenMobile((open) => !open) : setOpen((open) => !open)\n  }, [isMobile, setOpen, setOpenMobile])\n\n  // Adds a keyboard shortcut to toggle the sidebar.\n  React.useEffect(() => {\n    const handleKeyDown = (event: KeyboardEvent) => {\n      if (\n        event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\n        (event.metaKey || event.ctrlKey)\n      ) {\n        event.preventDefault()\n        toggleSidebar()\n      }\n    }\n\n    window.addEventListener(\"keydown\", handleKeyDown)\n    return () => window.removeEventListener(\"keydown\", handleKeyDown)\n  }, [toggleSidebar])\n\n  // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\n  // This makes it easier to style the sidebar with Tailwind classes.\n  const state = open ? \"expanded\" : \"collapsed\"\n\n  const contextValue = React.useMemo<SidebarContextProps>(\n    () => ({\n      state,\n      open,\n      setOpen,\n      isMobile,\n      openMobile,\n      setOpenMobile,\n      toggleSidebar,\n    }),\n    [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\n  )\n\n  return (\n    <SidebarContext.Provider value={contextValue}>\n      <TooltipProvider delayDuration={0}>\n        <div\n          data-slot=\"sidebar-wrapper\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH,\n              \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\n              ...style,\n            } as React.CSSProperties\n          }\n          className={cn(\n            \"group/sidebar-wrapper has-data-[variant=inset]:bg-sidebar flex min-h-svh w-full\",\n            className\n          )}\n          {...props}\n        >\n          {children}\n        </div>\n      </TooltipProvider>\n    </SidebarContext.Provider>\n  )\n}\n\nfunction Sidebar({\n  side = \"left\",\n  variant = \"sidebar\",\n  collapsible = \"offcanvas\",\n  className,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  side?: \"left\" | \"right\"\n  variant?: \"sidebar\" | \"floating\" | \"inset\"\n  collapsible?: \"offcanvas\" | \"icon\" | \"none\"\n}) {\n  const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\n\n  if (collapsible === \"none\") {\n    return (\n      <div\n        data-slot=\"sidebar\"\n        className={cn(\n          \"bg-sidebar text-sidebar-foreground flex h-full w-[var(--sidebar-width)] flex-col\",\n          className\n        )}\n        {...props}\n      >\n        {children}\n      </div>\n    )\n  }\n\n  if (isMobile) {\n    return (\n      <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\n        <SheetContent\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar\"\n          data-mobile=\"true\"\n          className=\"bg-sidebar text-sidebar-foreground w-[var(--sidebar-width)] p-0 [&>button]:hidden\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\n            } as React.CSSProperties\n          }\n          side={side}\n        >\n          <SheetHeader className=\"sr-only\">\n            <SheetTitle>Sidebar</SheetTitle>\n            <SheetDescription>Displays the mobile sidebar.</SheetDescription>\n          </SheetHeader>\n          <div className=\"flex h-full w-full flex-col\">{children}</div>\n        </SheetContent>\n      </Sheet>\n    )\n  }\n\n  return (\n    <div\n      className=\"group peer text-sidebar-foreground hidden md:block\"\n      data-state={state}\n      data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\n      data-variant={variant}\n      data-side={side}\n      data-slot=\"sidebar\"\n    >\n      {/* This is what handles the sidebar gap on desktop */}\n      <div\n        data-slot=\"sidebar-gap\"\n        className={cn(\n          \"relative w-[var(--sidebar-width)] bg-transparent transition-[width] duration-200 ease-linear\",\n          \"group-data-[collapsible=offcanvas]:w-0\",\n          \"group-data-[side=right]:rotate-180\",\n          variant === \"floating\" || variant === \"inset\"\n            ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4))]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)]\"\n        )}\n      />\n      <div\n        data-slot=\"sidebar-container\"\n        className={cn(\n          \"fixed inset-y-0 z-10 hidden h-svh w-[var(--sidebar-width)] transition-[left,right,width] duration-200 ease-linear md:flex\",\n          side === \"left\"\n            ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\n            : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\n          // Adjust the padding for floating and inset variants.\n          variant === \"floating\" || variant === \"inset\"\n            ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4)+2px)]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\n          className\n        )}\n        {...props}\n      >\n        <div\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar-inner\"\n          className=\"bg-sidebar group-data-[variant=floating]:border-sidebar-border flex h-full w-full flex-col group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:shadow-sm\"\n        >\n          {children}\n        </div>\n      </div>\n    </div>\n  )\n}\n\nfunction SidebarTrigger({\n  className,\n  onClick,\n  ...props\n}: React.ComponentProps<typeof Button>) {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <Button\n      data-sidebar=\"trigger\"\n      data-slot=\"sidebar-trigger\"\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\"h-7 w-7\", className)}\n      onClick={(event) => {\n        onClick?.(event)\n        toggleSidebar()\n      }}\n      {...props}\n    >\n      <PanelLeftIcon />\n      <span className=\"sr-only\">Toggle Sidebar</span>\n    </Button>\n  )\n}\n\nfunction SidebarRail({ className, ...props }: React.ComponentProps<\"button\">) {\n  const { toggleSidebar } = useSidebar()\n\n  // Note: Tailwind v3.4 doesn't support \"in-\" selectors. So the rail won't work perfectly.\n  return (\n    <button\n      data-sidebar=\"rail\"\n      data-slot=\"sidebar-rail\"\n      aria-label=\"Toggle Sidebar\"\n      tabIndex={-1}\n      onClick={toggleSidebar}\n      title=\"Toggle Sidebar\"\n      className={cn(\n        \"hover:after:bg-sidebar-border absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear group-data-[side=left]:-right-4 group-data-[side=right]:left-0 after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] sm:flex\",\n        \"in-data-[side=left]:cursor-w-resize in-data-[side=right]:cursor-e-resize\",\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\n        \"hover:group-data-[collapsible=offcanvas]:bg-sidebar group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full\",\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInset({ className, ...props }: React.ComponentProps<\"main\">) {\n  return (\n    <main\n      data-slot=\"sidebar-inset\"\n      className={cn(\n        \"bg-background relative flex w-full flex-1 flex-col\",\n        \"md:peer-data-[variant=inset]:m-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow-sm md:peer-data-[variant=inset]:peer-data-[state=collapsed]:ml-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInput({\n  className,\n  ...props\n}: React.ComponentProps<typeof Input>) {\n  return (\n    <Input\n      data-slot=\"sidebar-input\"\n      data-sidebar=\"input\"\n      className={cn(\"bg-background h-8 w-full shadow-none\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarHeader({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-header\"\n      data-sidebar=\"header\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarFooter({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-footer\"\n      data-sidebar=\"footer\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarSeparator({\n  className,\n  ...props\n}: React.ComponentProps<typeof Separator>) {\n  return (\n    <Separator\n      data-slot=\"sidebar-separator\"\n      data-sidebar=\"separator\"\n      className={cn(\"bg-sidebar-border mx-2 w-auto\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-content\"\n      data-sidebar=\"content\"\n      className={cn(\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group\"\n      data-sidebar=\"group\"\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupLabel({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"div\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-label\"\n      data-sidebar=\"group-label\"\n      className={cn(\n        \"text-sidebar-foreground/70 ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:h-4 [&>svg]:w-4 [&>svg]:shrink-0\",\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupAction({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"button\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-action\"\n      data-sidebar=\"group-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground absolute top-3.5 right-3 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupContent({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group-content\"\n      data-sidebar=\"group-content\"\n      className={cn(\"w-full text-sm\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenu({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu\"\n      data-sidebar=\"menu\"\n      className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuItem({ className, ...props }: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-item\"\n      data-sidebar=\"menu-item\"\n      className={cn(\"group/menu-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nconst sidebarMenuButtonVariants = cva(\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-hidden ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:w-8! group-data-[collapsible=icon]:h-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n        outline:\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\n      },\n      size: {\n        default: \"h-8 text-sm\",\n        sm: \"h-7 text-xs\",\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:p-0!\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nfunction SidebarMenuButton({\n  asChild = false,\n  isActive = false,\n  variant = \"default\",\n  size = \"default\",\n  tooltip,\n  className,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  isActive?: boolean\n  tooltip?: string | React.ComponentProps<typeof TooltipContent>\n} & VariantProps<typeof sidebarMenuButtonVariants>) {\n  const Comp = asChild ? Slot : \"button\"\n  const { isMobile, state } = useSidebar()\n\n  const button = (\n    <Comp\n      data-slot=\"sidebar-menu-button\"\n      data-sidebar=\"menu-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\n      {...props}\n    />\n  )\n\n  if (!tooltip) {\n    return button\n  }\n\n  if (typeof tooltip === \"string\") {\n    tooltip = {\n      children: tooltip,\n    }\n  }\n\n  return (\n    <Tooltip>\n      <TooltipTrigger asChild>{button}</TooltipTrigger>\n      <TooltipContent\n        side=\"right\"\n        align=\"center\"\n        hidden={state !== \"collapsed\" || isMobile}\n        {...tooltip}\n      />\n    </Tooltip>\n  )\n}\n\nfunction SidebarMenuAction({\n  className,\n  asChild = false,\n  showOnHover = false,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  showOnHover?: boolean\n}) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-action\"\n      data-sidebar=\"menu-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer-hover/menu-button:text-sidebar-accent-foreground absolute top-1.5 right-1 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        showOnHover &&\n          \"peer-data-[active=true]/menu-button:text-sidebar-accent-foreground group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 md:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuBadge({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-menu-badge\"\n      data-sidebar=\"menu-badge\"\n      className={cn(\n        \"text-sidebar-foreground pointer-events-none absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums select-none\",\n        \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSkeleton({\n  className,\n  showIcon = false,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  showIcon?: boolean\n}) {\n  // Random width between 50 to 90%.\n  const width = React.useMemo(() => {\n    return `${Math.floor(Math.random() * 40) + 50}%`\n  }, [])\n\n  return (\n    <div\n      data-slot=\"sidebar-menu-skeleton\"\n      data-sidebar=\"menu-skeleton\"\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\n      {...props}\n    >\n      {showIcon && (\n        <Skeleton\n          className=\"size-4 rounded-md\"\n          data-sidebar=\"menu-skeleton-icon\"\n        />\n      )}\n      <Skeleton\n        className=\"h-4 max-w-[var(--skeleton-width)] flex-1\"\n        data-sidebar=\"menu-skeleton-text\"\n        style={\n          {\n            \"--skeleton-width\": width,\n          } as React.CSSProperties\n        }\n      />\n    </div>\n  )\n}\n\nfunction SidebarMenuSub({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu-sub\"\n      data-sidebar=\"menu-sub\"\n      className={cn(\n        \"border-sidebar-border mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l px-2.5 py-0.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubItem({\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-sub-item\"\n      data-sidebar=\"menu-sub-item\"\n      className={cn(\"group/menu-sub-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubButton({\n  asChild = false,\n  size = \"md\",\n  isActive = false,\n  className,\n  ...props\n}: React.ComponentProps<\"a\"> & {\n  asChild?: boolean\n  size?: \"sm\" | \"md\"\n  isActive?: boolean\n}) {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-sub-button\"\n      data-sidebar=\"menu-sub-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground active:bg-sidebar-accent active:text-sidebar-accent-foreground [&>svg]:text-sidebar-accent-foreground flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 outline outline-2 outline-transparent outline-offset-2 focus-visible:ring-2 disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\n        size === \"sm\" && \"text-xs\",\n        size === \"md\" && \"text-sm\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupAction,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarInput,\n  SidebarInset,\n  SidebarMenu,\n  SidebarMenuAction,\n  SidebarMenuBadge,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSkeleton,\n  SidebarMenuSub,\n  SidebarMenuSubButton,\n  SidebarMenuSubItem,\n  SidebarProvider,\n  SidebarRail,\n  SidebarSeparator,\n  SidebarTrigger,\n  useSidebar,\n}\n","size_bytes":21846},"server/storage.ts":{"content":"import {\n  type User,\n  type InsertUser,\n  type UpdateUserPlan,\n  type UpdateUserApiToken,\n  type ApiToken,\n  type InsertApiToken,\n  type TokenSettings,\n  type UpdateTokenSettings,\n  type VideoHistory,\n  type InsertVideoHistory,\n  type Project,\n  type InsertProject,\n  users,\n  apiTokens,\n  tokenSettings,\n  videoHistory,\n  projects,\n} from \"@shared/schema\";\nimport { db } from \"./db\";\nimport { eq, and, desc } from \"drizzle-orm\";\nimport bcrypt from \"bcrypt\";\n\nconst SALT_ROUNDS = 10;\n\n// Token error tracking: tokenId -> array of error timestamps\nconst tokenErrorTracking = new Map<string, number[]>();\n// Token cooldown: tokenId -> cooldown end timestamp\nconst tokenCooldowns = new Map<string, number>();\n\nconst ERROR_THRESHOLD = 10; // Max errors allowed (increased from 5 to allow more retries)\nconst ERROR_WINDOW_MS = 20 * 60 * 1000; // 20 minutes in milliseconds\nconst COOLDOWN_DURATION_MS = 60 * 60 * 1000; // 1 hour in milliseconds\n\n// Storage interface for user operations\nexport interface IStorage {\n  getUser(id: string): Promise<User | undefined>;\n  getUserByUsername(username: string): Promise<User | undefined>;\n  getAllUsers(): Promise<User[]>;\n  createUser(user: InsertUser): Promise<User>;\n  updateUserPlan(userId: string, plan: UpdateUserPlan): Promise<User | undefined>;\n  updateUserApiToken(userId: string, token: UpdateUserApiToken): Promise<User | undefined>;\n  verifyPassword(user: User, password: string): Promise<boolean>;\n  initializeDefaultAdmin(): Promise<void>;\n  \n  // Token pool management\n  getAllApiTokens(): Promise<ApiToken[]>;\n  getActiveApiTokens(): Promise<ApiToken[]>;\n  addApiToken(token: InsertApiToken): Promise<ApiToken>;\n  deleteApiToken(tokenId: string): Promise<void>;\n  toggleApiTokenStatus(tokenId: string, isActive: boolean): Promise<ApiToken | undefined>;\n  getNextRotationToken(): Promise<ApiToken | undefined>;\n  getTokenByIndex(index: number): Promise<ApiToken | undefined>;\n  updateTokenUsage(tokenId: string): Promise<void>;\n  replaceAllTokens(tokens: string[]): Promise<ApiToken[]>;\n  recordTokenError(tokenId: string): void;\n  isTokenInCooldown(tokenId: string): boolean;\n  \n  // Token settings\n  getTokenSettings(): Promise<TokenSettings | undefined>;\n  updateTokenSettings(settings: UpdateTokenSettings): Promise<TokenSettings>;\n  initializeTokenSettings(): Promise<void>;\n  \n  // Video history\n  getUserVideoHistory(userId: string): Promise<VideoHistory[]>;\n  addVideoHistory(video: InsertVideoHistory): Promise<VideoHistory>;\n  updateVideoHistoryStatus(videoId: string, userId: string, status: string, videoUrl?: string, errorMessage?: string): Promise<VideoHistory | undefined>;\n  updateVideoHistoryFields(videoId: string, fields: Partial<VideoHistory>): Promise<VideoHistory | undefined>;\n  \n  // Projects\n  getUserProjects(userId: string): Promise<Project[]>;\n  getProject(projectId: string, userId: string): Promise<Project | undefined>;\n  createProject(project: InsertProject): Promise<Project>;\n  updateProject(projectId: string, userId: string, updates: Partial<InsertProject>): Promise<Project | undefined>;\n  deleteProject(projectId: string, userId: string): Promise<boolean>;\n}\n\nexport class DatabaseStorage implements IStorage {\n  async getUser(id: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.id, id));\n    return user || undefined;\n  }\n\n  async getUserByUsername(username: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.username, username));\n    return user || undefined;\n  }\n\n  async getAllUsers(): Promise<User[]> {\n    return await db.select().from(users);\n  }\n\n  async createUser(insertUser: InsertUser): Promise<User> {\n    const hashedPassword = await bcrypt.hash(insertUser.password, SALT_ROUNDS);\n    const [user] = await db\n      .insert(users)\n      .values({\n        username: insertUser.username,\n        password: hashedPassword,\n        isAdmin: insertUser.isAdmin ?? false,\n      })\n      .returning();\n    return user;\n  }\n\n  async updateUserPlan(userId: string, plan: UpdateUserPlan): Promise<User | undefined> {\n    try {\n      const [updatedUser] = await db\n        .update(users)\n        .set({\n          planType: plan.planType,\n          planStatus: plan.planStatus,\n          planExpiry: plan.planExpiry || null,\n        })\n        .where(eq(users.id, userId))\n        .returning();\n      \n      return updatedUser || undefined;\n    } catch (error) {\n      console.error(\"Error updating user plan:\", error);\n      throw error;\n    }\n  }\n\n  async updateUserApiToken(userId: string, token: UpdateUserApiToken): Promise<User | undefined> {\n    try {\n      const [updatedUser] = await db\n        .update(users)\n        .set({\n          apiToken: token.apiToken,\n        })\n        .where(eq(users.id, userId))\n        .returning();\n      \n      return updatedUser || undefined;\n    } catch (error) {\n      console.error(\"Error updating user API token:\", error);\n      throw error;\n    }\n  }\n\n  async verifyPassword(user: User, password: string): Promise<boolean> {\n    return await bcrypt.compare(password, user.password);\n  }\n\n  async initializeDefaultAdmin(): Promise<void> {\n    try {\n      // Check if default admin already exists\n      const existingAdmin = await this.getUserByUsername(\"muzi\");\n      \n      if (!existingAdmin) {\n        // Create default admin user\n        const hashedPassword = await bcrypt.hash(\"muzi123\", SALT_ROUNDS);\n        await db.insert(users).values({\n          username: \"muzi\",\n          password: hashedPassword,\n          isAdmin: true,\n          planType: \"premium\",\n          planStatus: \"active\",\n        });\n        console.log(\"✓ Default admin user created (username: muzi, password: muzi123)\");\n      }\n    } catch (error) {\n      // If unique constraint error, admin already exists (race condition)\n      if (error && typeof error === 'object' && 'code' in error && error.code === '23505') {\n        console.log(\"✓ Default admin user already exists\");\n      } else {\n        console.error(\"Error initializing default admin:\", error);\n        throw error;\n      }\n    }\n  }\n\n  // Token pool management methods\n  async getAllApiTokens(): Promise<ApiToken[]> {\n    return await db.select().from(apiTokens).orderBy(desc(apiTokens.createdAt));\n  }\n\n  async getActiveApiTokens(): Promise<ApiToken[]> {\n    return await db.select().from(apiTokens).where(eq(apiTokens.isActive, true));\n  }\n\n  async addApiToken(token: InsertApiToken): Promise<ApiToken> {\n    const [newToken] = await db.insert(apiTokens).values(token).returning();\n    return newToken;\n  }\n\n  async deleteApiToken(tokenId: string): Promise<void> {\n    await db.delete(apiTokens).where(eq(apiTokens.id, tokenId));\n  }\n\n  async toggleApiTokenStatus(tokenId: string, isActive: boolean): Promise<ApiToken | undefined> {\n    const [updatedToken] = await db\n      .update(apiTokens)\n      .set({ isActive })\n      .where(eq(apiTokens.id, tokenId))\n      .returning();\n    return updatedToken || undefined;\n  }\n\n  async getNextRotationToken(): Promise<ApiToken | undefined> {\n    // Get active tokens ordered by least recently used\n    const tokens = await db\n      .select()\n      .from(apiTokens)\n      .where(eq(apiTokens.isActive, true))\n      .orderBy(apiTokens.lastUsedAt);\n    \n    // Filter out tokens in cooldown or close to error threshold\n    // Use threshold-1 to prevent race conditions with concurrent requests\n    const SAFE_THRESHOLD = ERROR_THRESHOLD - 1;\n    \n    for (const token of tokens) {\n      if (this.isTokenInCooldown(token.id)) {\n        console.log(`[Token Rotation] Skipping token ${token.id} - in cooldown`);\n        continue;\n      }\n      \n      const errorCount = this.getRecentErrorCount(token.id);\n      if (errorCount >= SAFE_THRESHOLD) {\n        console.log(`[Token Rotation] Skipping token ${token.id} - ${errorCount}/${ERROR_THRESHOLD} errors (too close to threshold)`);\n        continue;\n      }\n      \n      return token;\n    }\n    \n    console.log('[Token Rotation] All active tokens are in cooldown or near error threshold');\n    return undefined;\n  }\n\n  async getTokenByIndex(index: number): Promise<ApiToken | undefined> {\n    // Get all active tokens in consistent order (by creation time)\n    const tokens = await db\n      .select()\n      .from(apiTokens)\n      .where(eq(apiTokens.isActive, true))\n      .orderBy(apiTokens.createdAt);\n    \n    if (tokens.length === 0) {\n      console.log('[Token Rotation] No active tokens available');\n      return undefined;\n    }\n    \n    // Filter out tokens in cooldown\n    const availableTokens = tokens.filter(token => !this.isTokenInCooldown(token.id));\n    \n    if (availableTokens.length === 0) {\n      console.log('[Token Rotation] All active tokens are in cooldown');\n      return undefined;\n    }\n    \n    // Round-robin: select token by index modulo number of available tokens\n    const selectedToken = availableTokens[index % availableTokens.length];\n    console.log(`[Token Rotation] Selected token ${selectedToken.label} (index ${index} % ${availableTokens.length} tokens = ${index % availableTokens.length})`);\n    \n    return selectedToken;\n  }\n\n  async updateTokenUsage(tokenId: string): Promise<void> {\n    const token = await db.select().from(apiTokens).where(eq(apiTokens.id, tokenId));\n    if (token[0]) {\n      const currentCount = parseInt(token[0].requestCount || \"0\");\n      await db\n        .update(apiTokens)\n        .set({\n          lastUsedAt: new Date().toISOString(),\n          requestCount: (currentCount + 1).toString(),\n        })\n        .where(eq(apiTokens.id, tokenId));\n    }\n  }\n\n  async replaceAllTokens(tokens: string[]): Promise<ApiToken[]> {\n    // Check for duplicates in input\n    const uniqueTokens = new Set(tokens);\n    if (uniqueTokens.size !== tokens.length) {\n      throw new Error(\"Duplicate tokens found in input\");\n    }\n    \n    // Execute deletion and insertion in a single transaction\n    return await db.transaction(async (tx) => {\n      // First, nullify all tokenUsed references in video_history to avoid foreign key constraint\n      await tx\n        .update(videoHistory)\n        .set({ tokenUsed: null });\n      \n      console.log('[Bulk Replace] Nullified all tokenUsed references in video history');\n      \n      // Delete all existing tokens\n      await tx.delete(apiTokens);\n      \n      console.log('[Bulk Replace] Deleted all old tokens');\n      \n      // Add all new tokens with auto-generated labels\n      const newTokens: ApiToken[] = [];\n      for (let i = 0; i < tokens.length; i++) {\n        const [token] = await tx\n          .insert(apiTokens)\n          .values({\n            token: tokens[i],\n            label: `Token ${i + 1}`,\n            isActive: true,\n          })\n          .returning();\n        newTokens.push(token);\n      }\n      \n      console.log(`[Bulk Replace] Added ${newTokens.length} new tokens`);\n      \n      return newTokens;\n    });\n  }\n\n  recordTokenError(tokenId: string): void {\n    const now = Date.now();\n    \n    // Get or initialize error array for this token\n    const errors = tokenErrorTracking.get(tokenId) || [];\n    \n    // Add new error timestamp\n    errors.push(now);\n    \n    // Remove errors older than ERROR_WINDOW_MS (20 minutes)\n    const recentErrors = errors.filter(timestamp => now - timestamp < ERROR_WINDOW_MS);\n    \n    tokenErrorTracking.set(tokenId, recentErrors);\n    \n    // Check if we've exceeded the threshold\n    if (recentErrors.length >= ERROR_THRESHOLD) {\n      const cooldownEnd = now + COOLDOWN_DURATION_MS;\n      tokenCooldowns.set(tokenId, cooldownEnd);\n      console.log(`[Token Error Tracking] Token ${tokenId} exceeded ${ERROR_THRESHOLD} errors in 20 minutes. Disabled for 1 hour until ${new Date(cooldownEnd).toISOString()}`);\n    } else {\n      console.log(`[Token Error Tracking] Recorded error for token ${tokenId}. ${recentErrors.length}/${ERROR_THRESHOLD} errors in last 20 minutes`);\n    }\n  }\n\n  isTokenInCooldown(tokenId: string): boolean {\n    const cooldownEnd = tokenCooldowns.get(tokenId);\n    \n    if (!cooldownEnd) {\n      return false;\n    }\n    \n    const now = Date.now();\n    \n    // Check if cooldown has expired\n    if (now >= cooldownEnd) {\n      tokenCooldowns.delete(tokenId);\n      tokenErrorTracking.delete(tokenId);\n      console.log(`[Token Error Tracking] Token ${tokenId} cooldown expired. Re-enabled.`);\n      return false;\n    }\n    \n    return true;\n  }\n\n  getRecentErrorCount(tokenId: string): number {\n    const errors = tokenErrorTracking.get(tokenId) || [];\n    const now = Date.now();\n    \n    // Count errors within the last 20 minutes\n    const recentErrors = errors.filter(timestamp => now - timestamp < ERROR_WINDOW_MS);\n    return recentErrors.length;\n  }\n\n  // Token settings methods\n  async getTokenSettings(): Promise<TokenSettings | undefined> {\n    const [settings] = await db.select().from(tokenSettings).limit(1);\n    return settings || undefined;\n  }\n\n  async updateTokenSettings(settings: UpdateTokenSettings): Promise<TokenSettings> {\n    const existing = await this.getTokenSettings();\n    \n    if (existing) {\n      const [updated] = await db\n        .update(tokenSettings)\n        .set(settings)\n        .where(eq(tokenSettings.id, existing.id))\n        .returning();\n      return updated;\n    } else {\n      const [newSettings] = await db.insert(tokenSettings).values(settings).returning();\n      return newSettings;\n    }\n  }\n\n  async initializeTokenSettings(): Promise<void> {\n    const existing = await this.getTokenSettings();\n    if (!existing) {\n      await db.insert(tokenSettings).values({});\n      console.log(\"✓ Token rotation settings initialized\");\n    }\n  }\n\n  // Video history methods\n  async getUserVideoHistory(userId: string): Promise<VideoHistory[]> {\n    return await db\n      .select()\n      .from(videoHistory)\n      .where(eq(videoHistory.userId, userId))\n      .orderBy(desc(videoHistory.createdAt));\n  }\n\n  async addVideoHistory(video: InsertVideoHistory): Promise<VideoHistory> {\n    const [newVideo] = await db\n      .insert(videoHistory)\n      .values(video)\n      .returning();\n    return newVideo;\n  }\n\n  async updateVideoHistoryStatus(\n    videoId: string,\n    userId: string,\n    status: string,\n    videoUrl?: string,\n    errorMessage?: string\n  ): Promise<VideoHistory | undefined> {\n    const updateData: Partial<VideoHistory> = { status };\n    if (videoUrl) {\n      updateData.videoUrl = videoUrl;\n    }\n    if (errorMessage) {\n      updateData.errorMessage = errorMessage;\n    }\n\n    const [updated] = await db\n      .update(videoHistory)\n      .set(updateData)\n      .where(and(eq(videoHistory.id, videoId), eq(videoHistory.userId, userId)))\n      .returning();\n    return updated || undefined;\n  }\n\n  async updateVideoHistoryFields(\n    videoId: string,\n    fields: Partial<VideoHistory>\n  ): Promise<VideoHistory | undefined> {\n    const [updated] = await db\n      .update(videoHistory)\n      .set(fields)\n      .where(eq(videoHistory.id, videoId))\n      .returning();\n    return updated || undefined;\n  }\n\n  async clearAllVideoHistory(): Promise<void> {\n    await db.delete(videoHistory);\n  }\n\n  // Project methods\n  async getUserProjects(userId: string): Promise<Project[]> {\n    return await db\n      .select()\n      .from(projects)\n      .where(eq(projects.userId, userId))\n      .orderBy(desc(projects.createdAt));\n  }\n\n  async getProject(projectId: string, userId: string): Promise<Project | undefined> {\n    const [project] = await db\n      .select()\n      .from(projects)\n      .where(and(eq(projects.id, projectId), eq(projects.userId, userId)));\n    return project || undefined;\n  }\n\n  async createProject(project: InsertProject): Promise<Project> {\n    const [newProject] = await db\n      .insert(projects)\n      .values(project)\n      .returning();\n    return newProject;\n  }\n\n  async updateProject(\n    projectId: string,\n    userId: string,\n    updates: Partial<InsertProject>\n  ): Promise<Project | undefined> {\n    const [updated] = await db\n      .update(projects)\n      .set({ ...updates, updatedAt: new Date().toISOString() })\n      .where(and(eq(projects.id, projectId), eq(projects.userId, userId)))\n      .returning();\n    return updated || undefined;\n  }\n\n  async deleteProject(projectId: string, userId: string): Promise<boolean> {\n    const result = await db\n      .delete(projects)\n      .where(and(eq(projects.id, projectId), eq(projects.userId, userId)))\n      .returning();\n    return result.length > 0;\n  }\n}\n\nexport const storage = new DatabaseStorage();\n","size_bytes":16517},"client/src/components/ui/alert.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst alertVariants = cva(\n  \"relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-background text-foreground\",\n        destructive:\n          \"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Alert = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>\n>(({ className, variant, ...props }, ref) => (\n  <div\n    ref={ref}\n    role=\"alert\"\n    className={cn(alertVariants({ variant }), className)}\n    {...props}\n  />\n))\nAlert.displayName = \"Alert\"\n\nconst AlertTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h5\n    ref={ref}\n    className={cn(\"mb-1 font-medium leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nAlertTitle.displayName = \"AlertTitle\"\n\nconst AlertDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm [&_p]:leading-relaxed\", className)}\n    {...props}\n  />\n))\nAlertDescription.displayName = \"AlertDescription\"\n\nexport { Alert, AlertTitle, AlertDescription }\n","size_bytes":1584},"client/src/components/examples/Home.tsx":{"content":"import Home from \"../../pages/Home\";\n\nexport default function HomeExample() {\n  return <Home />;\n}\n","size_bytes":99},"client/src/components/examples/ScriptForm.tsx":{"content":"import ScriptForm from \"../ScriptForm\";\n\nexport default function ScriptFormExample() {\n  return (\n    <ScriptForm \n      onSubmit={(data) => console.log(\"Form submitted:\", data)} \n    />\n  );\n}\n","size_bytes":194},"client/src/components/ui/dialog.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Dialog = DialogPrimitive.Root\n\nconst DialogTrigger = DialogPrimitive.Trigger\n\nconst DialogPortal = DialogPrimitive.Portal\n\nconst DialogClose = DialogPrimitive.Close\n\nconst DialogOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\nconst DialogContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <DialogPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\nconst DialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-1.5 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogHeader.displayName = \"DialogHeader\"\n\nconst DialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogFooter.displayName = \"DialogFooter\"\n\nconst DialogTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\nconst DialogDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogClose,\n  DialogTrigger,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n}\n","size_bytes":3848},"server/index.ts":{"content":"import express, { type Request, Response, NextFunction } from \"express\";\nimport session from \"express-session\";\nimport MemoryStore from \"memorystore\";\nimport { registerRoutes } from \"./routes\";\nimport { setupVite, serveStatic, log } from \"./vite\";\n\nconst app = express();\n\ndeclare module 'http' {\n  interface IncomingMessage {\n    rawBody: unknown\n  }\n}\n\ndeclare module 'express-session' {\n  interface SessionData {\n    userId?: string;\n  }\n}\n\nconst MemoryStoreSession = MemoryStore(session);\n\napp.use(express.json({\n  verify: (req, _res, buf) => {\n    req.rawBody = buf;\n  }\n}));\napp.use(express.urlencoded({ extended: false }));\n\napp.use(\n  session({\n    secret: process.env.SESSION_SECRET || \"dev-secret-change-in-production\",\n    resave: false,\n    saveUninitialized: false,\n    store: new MemoryStoreSession({\n      checkPeriod: 86400000,\n    }),\n    cookie: {\n      maxAge: 24 * 60 * 60 * 1000,\n      httpOnly: true,\n      secure: false,\n      sameSite: 'lax',\n    },\n  })\n);\n\napp.use((req, res, next) => {\n  const start = Date.now();\n  const path = req.path;\n  let capturedJsonResponse: Record<string, any> | undefined = undefined;\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    capturedJsonResponse = bodyJson;\n    return originalResJson.apply(res, [bodyJson, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (path.startsWith(\"/api\")) {\n      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n      if (capturedJsonResponse) {\n        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;\n      }\n\n      if (logLine.length > 80) {\n        logLine = logLine.slice(0, 79) + \"…\";\n      }\n\n      log(logLine);\n    }\n  });\n\n  next();\n});\n\n(async () => {\n  // Initialize database, default admin user, and token settings\n  const { storage } = await import(\"./storage\");\n  await storage.initializeDefaultAdmin();\n  await storage.initializeTokenSettings();\n  \n  const server = await registerRoutes(app);\n\n  app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {\n    const status = err.status || err.statusCode || 500;\n    const message = err.message || \"Internal Server Error\";\n\n    res.status(status).json({ message });\n    throw err;\n  });\n\n  // importantly only setup vite in development and after\n  // setting up all the other routes so the catch-all route\n  // doesn't interfere with the other routes\n  if (app.get(\"env\") === \"development\") {\n    await setupVite(app, server);\n  } else {\n    serveStatic(app);\n  }\n\n  // Daily cleanup job - runs at midnight Pakistan time (UTC+5)\n  // Initialize to empty string so cleanup runs on first midnight after server start\n  let lastCleanupDate = '';\n  \n  const checkAndCleanupHistory = async () => {\n    try {\n      const now = new Date();\n      const pktTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Karachi' }));\n      const currentDate = pktTime.toLocaleDateString('en-US', { timeZone: 'Asia/Karachi' });\n      const currentHour = pktTime.getHours();\n      const currentMinute = pktTime.getMinutes();\n      \n      // Check if it's midnight (00:00-00:01) and we haven't run cleanup today\n      if (currentHour === 0 && currentMinute === 0 && currentDate !== lastCleanupDate) {\n        console.log(`[Daily Cleanup] Running cleanup tasks at midnight PKT (${currentDate})`);\n        \n        // Cleanup video history\n        await storage.clearAllVideoHistory();\n        console.log('[Daily Cleanup] Video history cleared successfully');\n        \n        // Cleanup expired temporary videos\n        try {\n          const { ObjectStorageService } = await import('./objectStorage');\n          const objectStorageService = new ObjectStorageService();\n          const deletedCount = await objectStorageService.cleanupExpiredVideos();\n          console.log(`[Daily Cleanup] Deleted ${deletedCount} expired temporary videos`);\n        } catch (tempVideoError) {\n          console.error('[Daily Cleanup] Error cleaning up temporary videos:', tempVideoError);\n        }\n        \n        lastCleanupDate = currentDate;\n        console.log('[Daily Cleanup] All cleanup tasks completed');\n      }\n    } catch (error) {\n      console.error('[Daily Cleanup] Error during cleanup:', error);\n    }\n  };\n  \n  // Also run temporary video cleanup every hour (independent of midnight cleanup)\n  const checkAndCleanupTempVideos = async () => {\n    try {\n      const { ObjectStorageService } = await import('./objectStorage');\n      const objectStorageService = new ObjectStorageService();\n      const deletedCount = await objectStorageService.cleanupExpiredVideos();\n      if (deletedCount > 0) {\n        console.log(`[Hourly Cleanup] Deleted ${deletedCount} expired temporary videos`);\n      }\n    } catch (error) {\n      console.error('[Hourly Cleanup] Error cleaning up temporary videos:', error);\n    }\n  };\n  \n  // Run daily cleanup check every minute\n  setInterval(checkAndCleanupHistory, 60000);\n  console.log('[Daily Cleanup] History cleanup job scheduled for midnight PKT');\n  \n  // Run temporary video cleanup every hour\n  setInterval(checkAndCleanupTempVideos, 60 * 60 * 1000);\n  console.log('[Hourly Cleanup] Temporary video cleanup scheduled (runs every hour)');\n\n  // Timeout cleanup for stuck pending videos\n  const checkAndTimeoutPendingVideos = async () => {\n    try {\n      const { db } = await import('./db');\n      const { videoHistory } = await import('@shared/schema');\n      const { sql } = await import('drizzle-orm');\n      \n      const result = await db.execute(sql`\n        UPDATE video_history \n        SET status = 'failed' \n        WHERE status = 'pending' \n        AND (NOW() - created_at::timestamp) > INTERVAL '30 minutes'\n        RETURNING id\n      `);\n      \n      const count = result.rowCount || 0;\n      if (count > 0) {\n        console.log(`[Timeout Cleanup] Marked ${count} stuck videos as failed (pending > 30 minutes)`);\n      }\n    } catch (error) {\n      console.error('[Timeout Cleanup] Error timing out pending videos:', error);\n    }\n  };\n  \n  // Run timeout cleanup every 2 minutes\n  setInterval(checkAndTimeoutPendingVideos, 2 * 60 * 1000);\n  console.log('[Timeout Cleanup] Pending video timeout job scheduled (runs every 2 minutes)');\n\n  // ALWAYS serve the app on the port specified in the environment variable PORT\n  // Other ports are firewalled. Default to 5000 if not specified.\n  // this serves both the API and the client.\n  // It is the only port that is not firewalled.\n  const port = parseInt(process.env.PORT || '5000', 10);\n  server.listen({\n    port,\n    host: \"0.0.0.0\",\n    reusePort: true,\n  }, () => {\n    log(`serving on port ${port}`);\n  });\n})();\n","size_bytes":6689},"client/src/components/ui/switch.tsx":{"content":"import * as React from \"react\"\nimport * as SwitchPrimitives from \"@radix-ui/react-switch\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Switch = React.forwardRef<\n  React.ElementRef<typeof SwitchPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>\n>(({ className, ...props }, ref) => (\n  <SwitchPrimitives.Root\n    className={cn(\n      \"peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  >\n    <SwitchPrimitives.Thumb\n      className={cn(\n        \"pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0\"\n      )}\n    />\n  </SwitchPrimitives.Root>\n))\nSwitch.displayName = SwitchPrimitives.Root.displayName\n\nexport { Switch }\n","size_bytes":1139},"GOOGLE_DRIVE_SETUP.md":{"content":"# Google Drive OAuth Setup Guide\n\nThis guide will help you set up Google Drive OAuth so your app can upload merged videos to your Google Drive (no file size limits!).\n\n## Prerequisites\n- A Google account\n- Admin access to this application (login as admin)\n\n---\n\n## Step 1: Create Google Cloud Project & OAuth Credentials\n\n### 1.1 Go to Google Cloud Console\nVisit: https://console.cloud.google.com/\n\n### 1.2 Create a New Project (or select existing)\n1. Click the project dropdown at the top\n2. Click \"New Project\"\n3. Name it something like \"Cartoon Video Generator\"\n4. Click \"Create\"\n\n### 1.3 Enable Google Drive API\n1. In the left sidebar, go to **APIs & Services** → **Library**\n2. Search for \"Google Drive API\"\n3. Click on it and press **Enable**\n\n### 1.4 Create OAuth Credentials\n1. Go to **APIs & Services** → **Credentials**\n2. Click **+ CREATE CREDENTIALS** → **OAuth client ID**\n3. If prompted to configure consent screen:\n   - Click **Configure Consent Screen**\n   - Select **External** (unless you have a Google Workspace)\n   - Click **Create**\n   - Fill in:\n     - App name: \"Cartoon Video Generator\"\n     - User support email: Your email\n     - Developer contact: Your email\n   - Click **Save and Continue** (skip optional info)\n   - Click **Save and Continue** again (skip scopes)\n   - Click **Save and Continue** again (skip test users)\n   - Click **Back to Dashboard**\n\n4. Now create the OAuth client:\n   - Go back to **Credentials** → **+ CREATE CREDENTIALS** → **OAuth client ID**\n   - Application type: **Web application**\n   - Name: \"Video Upload App\"\n   - Under **Authorized redirect URIs**, click **+ ADD URI**\n   - Add: `http://localhost:8080`\n   - Click **Create**\n\n5. **IMPORTANT:** Copy both:\n   - **Client ID** (looks like: `123456-abc.apps.googleusercontent.com`)\n   - **Client Secret** (looks like: `GOCSPX-abc123...`)\n\n---\n\n## Step 2: Add Credentials to Replit Secrets\n\n1. In your Replit project, click the **Lock icon** (🔒) in the left sidebar\n2. Click **+ New Secret** and add these THREE secrets:\n\n```\nSecret Name: GOOGLE_DRIVE_CLIENT_ID\nValue: [Paste your Client ID]\n```\n\n```\nSecret Name: GOOGLE_DRIVE_CLIENT_SECRET\nValue: [Paste your Client Secret]\n```\n\n**Don't add the refresh token yet - we'll generate it in the next step!**\n\n---\n\n## Step 3: Get Your Refresh Token\n\n### 3.1 Login as Admin\n1. Go to your app and login as admin\n2. Username: `muzi`\n3. Password: `muzi123`\n\n### 3.2 Get Authorization URL\nOpen this URL in your browser (make sure you're logged in as admin):\n```\nhttps://[your-replit-url]/api/google-drive/auth-url\n```\n\nYou should see a JSON response like:\n```json\n{\n  \"authUrl\": \"https://accounts.google.com/o/oauth2/v2/auth?...\"\n}\n```\n\n### 3.3 Authorize Your App\n1. Copy the entire `authUrl` value (the long URL)\n2. Open it in your browser\n3. Login with your Google account\n4. Click **Allow** to grant Drive access\n5. Google will redirect you to `http://localhost:8080/?code=...`\n6. **Your browser will show an error** (that's normal - localhost isn't running)\n7. Look at the URL bar and copy the **code** parameter\n   - Example URL: `http://localhost:8080/?code=4/0AY0e-g7X...&scope=...`\n   - Copy only the code part: `4/0AY0e-g7X...` (everything between `code=` and `&scope`)\n\n### 3.4 Exchange Code for Refresh Token\nUse a tool like Postman, or run this curl command (replace the code):\n\n```bash\ncurl -X POST https://[your-replit-url]/api/google-drive/exchange-token \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"code\":\"4/0AY0e-g7X...\"}'\n```\n\nYou'll get a response like:\n```json\n{\n  \"refreshToken\": \"1//0gH...\",\n  \"message\": \"Add this token to your secrets as GOOGLE_DRIVE_REFRESH_TOKEN\"\n}\n```\n\n### 3.5 Add Refresh Token to Secrets\n1. Copy the `refreshToken` value\n2. Go back to Replit Secrets (🔒 icon)\n3. Click **+ New Secret**:\n```\nSecret Name: GOOGLE_DRIVE_REFRESH_TOKEN\nValue: [Paste your refresh token]\n```\n\n---\n\n## Step 4: Verify Setup\n\n### 4.1 Check All Secrets Are Set\nMake sure you have all three:\n- ✅ `GOOGLE_DRIVE_CLIENT_ID`\n- ✅ `GOOGLE_DRIVE_CLIENT_SECRET`\n- ✅ `GOOGLE_DRIVE_REFRESH_TOKEN`\n\n### 4.2 Restart the Application\nThe app should automatically restart after adding secrets. If not, manually restart it.\n\n### 4.3 Test Upload\n1. Generate a cartoon story with videos\n2. Click \"Merge All Videos\"\n3. The merged video should upload to YOUR Google Drive!\n\n---\n\n## Troubleshooting\n\n### \"Missing Google Drive OAuth credentials\" error\n- Make sure all three secrets are added correctly\n- Restart the application\n\n### \"No refresh token received\" error\n- Make sure you used the auth URL from `/api/google-drive/auth-url`\n- The URL must include `prompt=consent`\n\n### \"Token has been expired or revoked\" error\n- Repeat Step 3 to get a new refresh token\n- Make sure your OAuth consent screen is published (not in testing mode)\n\n### Videos not appearing in Google Drive\n- Check your Google Drive home folder - they're uploaded to the root\n- Files are named like: `merged-video-1234567890.mp4`\n\n---\n\n## What Happens Behind the Scenes\n\n1. Your app uses the **Client ID** and **Client Secret** to identify itself to Google\n2. The **Refresh Token** allows your app to access YOUR Google Drive without asking for permission every time\n3. When you merge videos, they upload to YOUR Google Drive (using your 15GB free storage)\n4. Files are made publicly accessible so anyone can view/download them\n\n---\n\n## Security Notes\n\n- Keep your Client Secret and Refresh Token private (never share them)\n- These credentials only give access to files created by this app\n- You can revoke access anytime from: https://myaccount.google.com/permissions\n\n---\n\n## Need Help?\n\nIf you run into issues:\n1. Double-check all three secrets are set correctly\n2. Make sure the Google Drive API is enabled in your Google Cloud project\n3. Try generating a fresh refresh token (repeat Step 3)\n\nThat's it! Your videos will now upload to Google Drive with no size limits! 🎉\n","size_bytes":5920},"client/src/components/ui/progress.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ProgressPrimitive from \"@radix-ui/react-progress\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Progress = React.forwardRef<\n  React.ElementRef<typeof ProgressPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>\n>(({ className, value, ...props }, ref) => (\n  <ProgressPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative h-4 w-full overflow-hidden rounded-full bg-secondary\",\n      className\n    )}\n    {...props}\n  >\n    <ProgressPrimitive.Indicator\n      className=\"h-full w-full flex-1 bg-primary transition-all\"\n      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}\n    />\n  </ProgressPrimitive.Root>\n))\nProgress.displayName = ProgressPrimitive.Root.displayName\n\nexport { Progress }\n","size_bytes":791},"client/src/components/ui/form.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport {\n  Controller,\n  FormProvider,\n  useFormContext,\n  type ControllerProps,\n  type FieldPath,\n  type FieldValues,\n} from \"react-hook-form\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\n\nconst Form = FormProvider\n\ntype FormFieldContextValue<\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n> = {\n  name: TName\n}\n\nconst FormFieldContext = React.createContext<FormFieldContextValue>(\n  {} as FormFieldContextValue\n)\n\nconst FormField = <\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n>({\n  ...props\n}: ControllerProps<TFieldValues, TName>) => {\n  return (\n    <FormFieldContext.Provider value={{ name: props.name }}>\n      <Controller {...props} />\n    </FormFieldContext.Provider>\n  )\n}\n\nconst useFormField = () => {\n  const fieldContext = React.useContext(FormFieldContext)\n  const itemContext = React.useContext(FormItemContext)\n  const { getFieldState, formState } = useFormContext()\n\n  const fieldState = getFieldState(fieldContext.name, formState)\n\n  if (!fieldContext) {\n    throw new Error(\"useFormField should be used within <FormField>\")\n  }\n\n  const { id } = itemContext\n\n  return {\n    id,\n    name: fieldContext.name,\n    formItemId: `${id}-form-item`,\n    formDescriptionId: `${id}-form-item-description`,\n    formMessageId: `${id}-form-item-message`,\n    ...fieldState,\n  }\n}\n\ntype FormItemContextValue = {\n  id: string\n}\n\nconst FormItemContext = React.createContext<FormItemContextValue>(\n  {} as FormItemContextValue\n)\n\nconst FormItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const id = React.useId()\n\n  return (\n    <FormItemContext.Provider value={{ id }}>\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n    </FormItemContext.Provider>\n  )\n})\nFormItem.displayName = \"FormItem\"\n\nconst FormLabel = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  const { error, formItemId } = useFormField()\n\n  return (\n    <Label\n      ref={ref}\n      className={cn(error && \"text-destructive\", className)}\n      htmlFor={formItemId}\n      {...props}\n    />\n  )\n})\nFormLabel.displayName = \"FormLabel\"\n\nconst FormControl = React.forwardRef<\n  React.ElementRef<typeof Slot>,\n  React.ComponentPropsWithoutRef<typeof Slot>\n>(({ ...props }, ref) => {\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n  return (\n    <Slot\n      ref={ref}\n      id={formItemId}\n      aria-describedby={\n        !error\n          ? `${formDescriptionId}`\n          : `${formDescriptionId} ${formMessageId}`\n      }\n      aria-invalid={!!error}\n      {...props}\n    />\n  )\n})\nFormControl.displayName = \"FormControl\"\n\nconst FormDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => {\n  const { formDescriptionId } = useFormField()\n\n  return (\n    <p\n      ref={ref}\n      id={formDescriptionId}\n      className={cn(\"text-sm text-muted-foreground\", className)}\n      {...props}\n    />\n  )\n})\nFormDescription.displayName = \"FormDescription\"\n\nconst FormMessage = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, children, ...props }, ref) => {\n  const { error, formMessageId } = useFormField()\n  const body = error ? String(error?.message ?? \"\") : children\n\n  if (!body) {\n    return null\n  }\n\n  return (\n    <p\n      ref={ref}\n      id={formMessageId}\n      className={cn(\"text-sm font-medium text-destructive\", className)}\n      {...props}\n    >\n      {body}\n    </p>\n  )\n})\nFormMessage.displayName = \"FormMessage\"\n\nexport {\n  useFormField,\n  Form,\n  FormItem,\n  FormLabel,\n  FormControl,\n  FormDescription,\n  FormMessage,\n  FormField,\n}\n","size_bytes":4120},"server/db.ts":{"content":"import { Pool, neonConfig } from '@neondatabase/serverless';\nimport { drizzle } from 'drizzle-orm/neon-serverless';\nimport ws from \"ws\";\nimport * as schema from \"@shared/schema\";\n\nneonConfig.webSocketConstructor = ws;\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\n    \"DATABASE_URL must be set. Did you forget to provision a database?\",\n  );\n}\n\nexport const pool = new Pool({ connectionString: process.env.DATABASE_URL });\nexport const db = drizzle({ client: pool, schema });\n","size_bytes":483},"client/src/hooks/use-toast.ts":{"content":"import * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","size_bytes":3895},"client/src/index.css":{"content":"@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Quicksand:wght@400;500;600;700&display=swap');\n\n@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n/* LIGHT MODE */\n:root {\n  --button-outline: rgba(0,0,0, .10);\n  --badge-outline: rgba(0,0,0, .05);\n\n  /* Automatic computation of border around primary / danger buttons */\n  --opaque-button-border-intensity: -8; /* In terms of percentages */\n\n  /* Backgrounds applied on top of other backgrounds when hovered/active */\n  --elevate-1: rgba(0,0,0, .03);\n  --elevate-2: rgba(0,0,0, .08);\n\n  --background: 220 15% 96%;\n\n  --foreground: 220 15% 15%;\n\n  --border: 220 13% 88%;\n\n  --card: 220 15% 98%;\n\n  --card-foreground: 220 15% 15%;\n\n  --card-border: 220 13% 93%;\n\n  --sidebar: 220 13% 96%;\n\n  --sidebar-foreground: 220 15% 15%;\n\n  --sidebar-border: 220 13% 91%;\n\n  --sidebar-primary: 262 83% 58%;\n\n  --sidebar-primary-foreground: 0 0% 100%;\n\n  --sidebar-accent: 220 15% 92%;\n\n  --sidebar-accent-foreground: 220 15% 18%;\n\n  --sidebar-ring: 262 83% 58%;\n\n  --popover: 220 13% 94%;\n\n  --popover-foreground: 220 15% 15%;\n\n  --popover-border: 220 13% 89%;\n\n  --primary: 262 83% 58%;\n\n  --primary-foreground: 0 0% 100%;\n\n  --secondary: 220 13% 90%;\n\n  --secondary-foreground: 220 15% 15%;\n\n  --muted: 220 15% 92%;\n\n  --muted-foreground: 220 13% 40%;\n\n  --accent: 262 80% 94%;\n\n  --accent-foreground: 262 60% 25%;\n\n  --destructive: 0 72% 51%;\n\n  --destructive-foreground: 0 0% 100%;\n\n  --input: 220 13% 76%;\n  --ring: 262 83% 58%;\n  --chart-1: 262 83% 48%;\n  --chart-2: 291 76% 52%;\n  --chart-3: 338 82% 56%;\n  --chart-4: 24 88% 58%;\n  --chart-5: 173 80% 40%;\n\n  --font-sans: 'Inter', system-ui, -apple-system, sans-serif;\n  --font-serif: Georgia, serif;\n  --font-mono: Menlo, monospace;\n  --font-display: 'Quicksand', 'Inter', system-ui, sans-serif;\n  --radius: .5rem;\n  --shadow-2xs: 0px 1px 2px 0px hsl(240 6% 10% / 0.05);\n  --shadow-xs: 0px 1px 3px 0px hsl(240 6% 10% / 0.08);\n  --shadow-sm: 0px 2px 4px 0px hsl(240 6% 10% / 0.06), 0px 1px 2px -1px hsl(240 6% 10% / 0.08);\n  --shadow: 0px 4px 6px -1px hsl(240 6% 10% / 0.08), 0px 2px 4px -2px hsl(240 6% 10% / 0.06);\n  --shadow-md: 0px 6px 12px -2px hsl(240 6% 10% / 0.10), 0px 3px 6px -3px hsl(240 6% 10% / 0.08);\n  --shadow-lg: 0px 10px 20px -4px hsl(240 6% 10% / 0.12), 0px 4px 8px -4px hsl(240 6% 10% / 0.08);\n  --shadow-xl: 0px 20px 32px -8px hsl(240 6% 10% / 0.14), 0px 8px 16px -8px hsl(240 6% 10% / 0.10);\n  --shadow-2xl: 0px 32px 64px -12px hsl(240 6% 10% / 0.16);\n  --tracking-normal: 0em;\n  --spacing: 0.25rem;\n\n  /* Automatically computed borders - intensity can be controlled by the user by the --opaque-button-border-intensity setting */\n\n  /* Fallback for older browsers */\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n.dark {\n  --button-outline: rgba(255,255,255, .10);\n  --badge-outline: rgba(255,255,255, .05);\n\n  --opaque-button-border-intensity: 9;  /* In terms of percentages */\n\n  /* Backgrounds applied on top of other backgrounds when hovered/active */\n  --elevate-1: rgba(255,255,255, .04);\n  --elevate-2: rgba(255,255,255, .09);\n\n  --background: 218 28% 13%;\n\n  --foreground: 0 0% 98%;\n\n  --border: 218 20% 22%;\n\n  --card: 218 24% 17%;\n\n  --card-foreground: 0 0% 98%;\n\n  --card-border: 218 22% 20%;\n\n  --sidebar: 218 26% 15%;\n\n  --sidebar-foreground: 0 0% 98%;\n\n  --sidebar-border: 218 22% 19%;\n\n  --sidebar-primary: 262 83% 58%;\n\n  --sidebar-primary-foreground: 0 0% 100%;\n\n  --sidebar-accent: 218 24% 19%;\n\n  --sidebar-accent-foreground: 0 0% 95%;\n\n  --sidebar-ring: 262 83% 58%;\n\n  --popover: 218 24% 16%;\n\n  --popover-foreground: 0 0% 98%;\n\n  --popover-border: 218 22% 21%;\n\n  --primary: 262 83% 58%;\n\n  --primary-foreground: 0 0% 100%;\n\n  --secondary: 218 22% 22%;\n\n  --secondary-foreground: 0 0% 95%;\n\n  --muted: 218 20% 20%;\n\n  --muted-foreground: 218 10% 65%;\n\n  --accent: 262 70% 25%;\n\n  --accent-foreground: 0 0% 95%;\n\n  --destructive: 0 72% 51%;\n\n  --destructive-foreground: 0 0% 100%;\n\n  --input: 218 20% 25%;\n  --ring: 262 83% 58%;\n  --chart-1: 262 83% 68%;\n  --chart-2: 291 76% 72%;\n  --chart-3: 338 82% 76%;\n  --chart-4: 24 88% 78%;\n  --chart-5: 173 80% 60%;\n\n  --shadow-2xs: 0px 1px 2px 0px hsl(0 0% 0% / 0.20);\n  --shadow-xs: 0px 1px 3px 0px hsl(0 0% 0% / 0.30);\n  --shadow-sm: 0px 2px 4px 0px hsl(0 0% 0% / 0.25), 0px 1px 2px -1px hsl(0 0% 0% / 0.30);\n  --shadow: 0px 4px 6px -1px hsl(0 0% 0% / 0.30), 0px 2px 4px -2px hsl(0 0% 0% / 0.25);\n  --shadow-md: 0px 6px 12px -2px hsl(0 0% 0% / 0.35), 0px 3px 6px -3px hsl(0 0% 0% / 0.30);\n  --shadow-lg: 0px 10px 20px -4px hsl(0 0% 0% / 0.40), 0px 4px 8px -4px hsl(0 0% 0% / 0.30);\n  --shadow-xl: 0px 20px 32px -8px hsl(0 0% 0% / 0.45), 0px 8px 16px -8px hsl(0 0% 0% / 0.35);\n  --shadow-2xl: 0px 32px 64px -12px hsl(0 0% 0% / 0.50);\n\n  /* Automatically computed borders - intensity can be controlled by the user by the --opaque-button-border-intensity setting */\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n\n  body {\n    @apply font-sans antialiased bg-background text-foreground;\n  }\n\n  h1, h2, h3, h4, h5, h6 {\n    @apply font-display;\n  }\n\n  /* Smooth scrolling */\n  html {\n    scroll-behavior: smooth;\n  }\n}\n\n/* Professional animations and transitions */\n@layer utilities {\n  .animate-fade-in {\n    animation: fadeIn 0.5s ease-in-out;\n  }\n\n  .animate-slide-up {\n    animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);\n  }\n\n  .animate-slide-in-right {\n    animation: slideInRight 0.5s cubic-bezier(0.16, 1, 0.3, 1);\n  }\n\n  .animate-scale-in {\n    animation: scaleIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);\n  }\n\n  .animate-pulse-subtle {\n    animation: pulseSubtle 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;\n  }\n\n  @keyframes fadeIn {\n    from {\n      opacity: 0;\n    }\n    to {\n      opacity: 1;\n    }\n  }\n\n  @keyframes slideUp {\n    from {\n      opacity: 0;\n      transform: translateY(20px);\n    }\n    to {\n      opacity: 1;\n      transform: translateY(0);\n    }\n  }\n\n  @keyframes slideInRight {\n    from {\n      opacity: 0;\n      transform: translateX(30px);\n    }\n    to {\n      opacity: 1;\n      transform: translateX(0);\n    }\n  }\n\n  @keyframes scaleIn {\n    from {\n      opacity: 0;\n      transform: scale(0.95);\n    }\n    to {\n      opacity: 1;\n      transform: scale(1);\n    }\n  }\n\n  @keyframes pulseSubtle {\n    0%, 100% {\n      opacity: 1;\n    }\n    50% {\n      opacity: 0.8;\n    }\n  }\n\n  /* Smooth transitions for interactive elements */\n  .transition-smooth {\n    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n  }\n\n  /* Hover lift effect */\n  .hover-lift {\n    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;\n  }\n\n  .hover-lift:hover {\n    transform: translateY(-2px);\n    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.05);\n  }\n\n  /* Glass morphism effect */\n  .glass {\n    background: rgba(255, 255, 255, 0.1);\n    backdrop-filter: blur(10px);\n    -webkit-backdrop-filter: blur(10px);\n    border: 1px solid rgba(255, 255, 255, 0.2);\n  }\n\n  .dark .glass {\n    background: rgba(0, 0, 0, 0.2);\n    border: 1px solid rgba(255, 255, 255, 0.1);\n  }\n\n  /* Gradient text */\n  .gradient-text {\n    @apply bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent;\n  }\n\n  .dark .gradient-text {\n    @apply from-purple-400 to-blue-400;\n  }\n\n  /* Mobile optimizations */\n  @media (max-width: 768px) {\n    .mobile-responsive-padding {\n      @apply px-4 py-6;\n    }\n\n    .mobile-responsive-text {\n      @apply text-base;\n    }\n\n    .mobile-hide {\n      @apply hidden;\n    }\n  }\n}\n\n/**\n * Using the elevate system.\n * Automatic contrast adjustment.\n *\n * <element className=\"hover-elevate\" />\n * <element className=\"active-elevate-2\" />\n *\n * // Using the tailwind utility when a data attribute is \"on\"\n * <element className=\"toggle-elevate data-[state=on]:toggle-elevated\" />\n * // Or manually controlling the toggle state\n * <element className=\"toggle-elevate toggle-elevated\" />\n *\n * Elevation systems have to handle many states.\n * - not-hovered, vs. hovered vs. active  (three mutually exclusive states)\n * - toggled or not\n * - focused or not (this is not handled with these utilities)\n *\n * Even without handling focused or not, this is six possible combinations that\n * need to be distinguished from eachother visually.\n */\n@layer utilities {\n\n  /* Hide ugly search cancel button in Chrome until we can style it properly */\n  input[type=\"search\"]::-webkit-search-cancel-button {\n    @apply hidden;\n  }\n\n  /* Placeholder styling for contentEditable div */\n  [contenteditable][data-placeholder]:empty::before {\n    content: attr(data-placeholder);\n    color: hsl(var(--muted-foreground));\n    pointer-events: none;\n  }\n\n  /* .no-default-hover-elevate/no-default-active-elevate is an escape hatch so consumers of\n   * buttons/badges can remove the automatic brightness adjustment on interactions\n   * and program their own. */\n  .no-default-hover-elevate {}\n\n  .no-default-active-elevate {}\n\n\n  /**\n   * Toggleable backgrounds go behind the content. Hoverable/active goes on top.\n   * This way they can stack/compound. Both will overlap the parent's borders!\n   * So borders will be automatically adjusted both on toggle, and hover/active,\n   * and they will be compounded.\n   */\n  .toggle-elevate::before,\n  .toggle-elevate-2::before {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    /*border-radius: inherit;   match rounded corners */\n    border-radius: inherit;\n    z-index: -1;\n    /* sits behind content but above backdrop */\n  }\n\n  .toggle-elevate.toggle-elevated::before {\n    background-color: var(--elevate-2);\n  }\n\n  /* If there's a 1px border, adjust the inset so that it covers that parent's border */\n  .border.toggle-elevate::before {\n    inset: -1px;\n  }\n\n  /* Does not work on elements with overflow:hidden! */\n  .hover-elevate:not(.no-default-hover-elevate),\n  .active-elevate:not(.no-default-active-elevate),\n  .hover-elevate-2:not(.no-default-hover-elevate),\n  .active-elevate-2:not(.no-default-active-elevate) {\n    position: relative;\n    z-index: 0;\n  }\n\n  .hover-elevate:not(.no-default-hover-elevate)::after,\n  .active-elevate:not(.no-default-active-elevate)::after,\n  .hover-elevate-2:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:not(.no-default-active-elevate)::after {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    /*border-radius: inherit;   match rounded corners */\n    border-radius: inherit;\n    z-index: 999;\n    /* sits in front of content */\n  }\n\n  .hover-elevate:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-1);\n  }\n\n  .hover-elevate-2:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-2);\n  }\n\n  /* If there's a 1px border, adjust the inset so that it covers that parent's border */\n  .border.hover-elevate:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate:not(.no-active-interaction-elevate)::after,\n  .border.hover-elevate-2:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate-2:not(.no-active-interaction-elevate)::after,\n  .border.hover-elevate:not(.no-hover-interaction-elevate)::after {\n    inset: -1px;\n  }\n}","size_bytes":13432},"client/src/components/ui/alert-dialog.tsx":{"content":"import * as React from \"react\"\nimport * as AlertDialogPrimitive from \"@radix-ui/react-alert-dialog\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nconst AlertDialog = AlertDialogPrimitive.Root\n\nconst AlertDialogTrigger = AlertDialogPrimitive.Trigger\n\nconst AlertDialogPortal = AlertDialogPrimitive.Portal\n\nconst AlertDialogOverlay = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nAlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName\n\nconst AlertDialogContent = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPortal>\n    <AlertDialogOverlay />\n    <AlertDialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    />\n  </AlertDialogPortal>\n))\nAlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName\n\nconst AlertDialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogHeader.displayName = \"AlertDialogHeader\"\n\nconst AlertDialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogFooter.displayName = \"AlertDialogFooter\"\n\nconst AlertDialogTitle = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold\", className)}\n    {...props}\n  />\n))\nAlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName\n\nconst AlertDialogDescription = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nAlertDialogDescription.displayName =\n  AlertDialogPrimitive.Description.displayName\n\nconst AlertDialogAction = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Action>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Action\n    ref={ref}\n    className={cn(buttonVariants(), className)}\n    {...props}\n  />\n))\nAlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName\n\nconst AlertDialogCancel = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Cancel\n    ref={ref}\n    className={cn(\n      buttonVariants({ variant: \"outline\" }),\n      \"mt-2 sm:mt-0\",\n      className\n    )}\n    {...props}\n  />\n))\nAlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName\n\nexport {\n  AlertDialog,\n  AlertDialogPortal,\n  AlertDialogOverlay,\n  AlertDialogTrigger,\n  AlertDialogContent,\n  AlertDialogHeader,\n  AlertDialogFooter,\n  AlertDialogTitle,\n  AlertDialogDescription,\n  AlertDialogAction,\n  AlertDialogCancel,\n}\n","size_bytes":4420},"client/src/components/VideosDisplay.tsx":{"content":"import { Button } from \"@/components/ui/button\";\nimport { Card } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { RotateCcw, Download, Play, RefreshCw, Film } from \"lucide-react\";\nimport { useState } from \"react\";\nimport { useToast } from \"@/hooks/use-toast\";\n\ninterface GeneratedVideo {\n  sceneNumber: number;\n  sceneTitle: string;\n  videoUrl?: string;\n  status: string;\n  error?: string;\n}\n\ninterface VideosDisplayProps {\n  videos: GeneratedVideo[];\n  projectId: string | null;\n  onStartNew: () => void;\n  onRetryVideo: (sceneNumber: number) => Promise<void>;\n  onRetryAllFailed: () => Promise<void>;\n}\n\nexport default function VideosDisplay({ videos, projectId, onStartNew, onRetryVideo, onRetryAllFailed }: VideosDisplayProps) {\n  const [retryingScenes, setRetryingScenes] = useState<Set<number>>(new Set());\n  const [retryingAll, setRetryingAll] = useState(false);\n  const [merging, setMerging] = useState(false);\n  const [mergingStatus, setMergingStatus] = useState<string>('');\n  const [mergedVideoUrl, setMergedVideoUrl] = useState<string | null>(null);\n  const { toast } = useToast();\n\n  const completedVideos = videos.filter(v => v.status === 'completed');\n  const failedVideos = videos.filter(v => v.status === 'failed');\n\n  const handleDownloadAll = () => {\n    completedVideos.forEach(video => {\n      if (video.videoUrl) {\n        const link = document.createElement('a');\n        link.href = video.videoUrl;\n        link.download = `scene-${video.sceneNumber}-${video.sceneTitle}.mp4`;\n        link.click();\n      }\n    });\n  };\n\n  const handleRetryVideo = async (sceneNumber: number) => {\n    // Prevent duplicate retries\n    if (retryingScenes.has(sceneNumber)) {\n      return;\n    }\n    \n    setRetryingScenes(prev => new Set(prev).add(sceneNumber));\n    try {\n      await onRetryVideo(sceneNumber);\n    } finally {\n      setRetryingScenes(prev => {\n        const next = new Set(prev);\n        next.delete(sceneNumber);\n        return next;\n      });\n    }\n  };\n\n  const handleRetryAllFailed = async () => {\n    setRetryingAll(true);\n    try {\n      await onRetryAllFailed();\n    } finally {\n      setRetryingAll(false);\n    }\n  };\n\n  const handleMergeVideos = async () => {\n    if (completedVideos.length < 2) {\n      toast({\n        title: \"Cannot Merge\",\n        description: \"You need at least 2 completed videos to merge.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setMerging(true);\n    setMergedVideoUrl(null); // Clear previous merged video\n    setMergingStatus('Sending request...');\n    \n    try {\n      const videosToMerge = completedVideos\n        .sort((a, b) => a.sceneNumber - b.sceneNumber)\n        .map(v => ({\n          sceneNumber: v.sceneNumber,\n          videoUrl: v.videoUrl!\n        }));\n\n      setMergingStatus('Executed - Processing videos...');\n      \n      // Only include projectId in payload if it exists\n      const payload: { videos: typeof videosToMerge; projectId?: string } = {\n        videos: videosToMerge\n      };\n      if (projectId) {\n        payload.projectId = projectId;\n      }\n      \n      const response = await fetch('/api/merge-videos', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        credentials: 'include',\n        body: JSON.stringify(payload),\n      });\n\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || 'Failed to merge videos');\n      }\n\n      const result = await response.json();\n      \n      setMergingStatus('Complete!');\n      setMergedVideoUrl(result.mergedVideoUrl);\n      \n      toast({\n        title: \"Videos Merged!\",\n        description: \"All videos have been successfully merged into one.\",\n      });\n    } catch (error) {\n      console.error(\"Error merging videos:\", error);\n      toast({\n        title: \"Merge Failed\",\n        description: error instanceof Error ? error.message : \"Failed to merge videos.\",\n        variant: \"destructive\",\n      });\n      setMergingStatus('');\n    } finally {\n      setMerging(false);\n      setTimeout(() => setMergingStatus(''), 2000);\n    }\n  };\n\n  return (\n    <div className=\"max-w-6xl mx-auto px-4 py-8\">\n      <div className=\"flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8\">\n        <div>\n          <h2 className=\"text-3xl font-bold mb-2\">Generated Videos</h2>\n          <p className=\"text-muted-foreground\">\n            {completedVideos.length} of {videos.length} videos completed\n            {failedVideos.length > 0 && ` (${failedVideos.length} failed)`}\n          </p>\n        </div>\n        \n        <div className=\"flex gap-3 flex-wrap\">\n          {failedVideos.length > 0 && (\n            <Button\n              variant=\"destructive\"\n              onClick={handleRetryAllFailed}\n              disabled={retryingAll}\n              data-testid=\"button-retry-all-failed\"\n            >\n              <RefreshCw className={`w-4 h-4 mr-2 ${retryingAll ? 'animate-spin' : ''}`} />\n              Regenerate Failed Videos ({failedVideos.length})\n            </Button>\n          )}\n          <Button\n            variant=\"outline\"\n            onClick={onStartNew}\n            data-testid=\"button-start-new-story\"\n          >\n            <RotateCcw className=\"w-4 h-4 mr-2\" />\n            Start New Story\n          </Button>\n          {completedVideos.length > 0 && (\n            <>\n              <Button\n                onClick={handleMergeVideos}\n                disabled={merging || completedVideos.length < 2}\n                data-testid=\"button-merge-videos\"\n                variant=\"default\"\n              >\n                <Film className={`w-4 h-4 mr-2 ${merging ? 'animate-pulse' : ''}`} />\n                {merging ? mergingStatus : 'Merge All Videos'}\n              </Button>\n              <Button\n                onClick={handleDownloadAll}\n                data-testid=\"button-download-all\"\n              >\n                <Download className=\"w-4 h-4 mr-2\" />\n                Download All\n              </Button>\n            </>\n          )}\n        </div>\n      </div>\n\n      {merging && !mergedVideoUrl && (\n        <Card className=\"mb-8 p-8\" data-testid=\"merging-progress-card\">\n          <div className=\"flex flex-col items-center justify-center gap-4\">\n            <Film className=\"w-12 h-12 animate-pulse text-primary\" />\n            <div className=\"text-center\">\n              <h3 className=\"font-semibold text-lg mb-2\">{mergingStatus}</h3>\n              <p className=\"text-sm text-muted-foreground\">\n                Merging {completedVideos.length} videos into one...\n              </p>\n            </div>\n          </div>\n        </Card>\n      )}\n\n      {mergedVideoUrl && (\n        <Card className=\"mb-8 overflow-hidden\" data-testid=\"merged-video-card\">\n          <div className=\"p-4 border-b\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <div className=\"flex items-center gap-2 mb-1\">\n                  <Badge variant=\"default\">\n                    <Film className=\"w-3 h-3 mr-1\" />\n                    Merged Video\n                  </Badge>\n                  <Badge variant=\"default\">All {completedVideos.length} scenes</Badge>\n                </div>\n                <h3 className=\"font-semibold\">Complete Story</h3>\n              </div>\n            </div>\n          </div>\n          <div className=\"relative aspect-video bg-black\">\n            <video\n              key={mergedVideoUrl}\n              controls\n              className=\"w-full h-full\"\n              data-testid=\"merged-video-player\"\n            >\n              <source src={mergedVideoUrl} type=\"video/mp4\" />\n              Your browser does not support the video tag.\n            </video>\n            <div className=\"absolute bottom-4 right-4 flex gap-2\">\n              <Button\n                size=\"sm\"\n                variant=\"secondary\"\n                onClick={() => {\n                  const link = document.createElement('a');\n                  link.href = mergedVideoUrl;\n                  link.download = 'merged-story.mp4';\n                  link.click();\n                }}\n                data-testid=\"button-download-merged\"\n                title=\"Download Video\"\n              >\n                <Download className=\"w-4 h-4\" />\n              </Button>\n            </div>\n          </div>\n        </Card>\n      )}\n\n      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n        {videos.map((video) => (\n          <Card \n            key={video.sceneNumber} \n            className=\"overflow-hidden\"\n            data-testid={`video-card-${video.sceneNumber}`}\n          >\n            <div className=\"p-4 border-b\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <div className=\"flex items-center gap-2 mb-1\">\n                    <Badge variant=\"default\">Scene {video.sceneNumber}</Badge>\n                    <Badge variant={\n                      video.status === 'completed' ? 'default' :\n                      video.status === 'failed' ? 'destructive' : 'secondary'\n                    }>\n                      {video.status}\n                    </Badge>\n                  </div>\n                  <h3 className=\"font-semibold\">{video.sceneTitle}</h3>\n                </div>\n              </div>\n            </div>\n\n            {video.videoUrl ? (\n              <div className=\"relative aspect-video bg-black\">\n                <video\n                  key={video.videoUrl}\n                  controls\n                  className=\"w-full h-full\"\n                  data-testid={`video-player-${video.sceneNumber}`}\n                >\n                  <source src={video.videoUrl} type=\"video/mp4\" />\n                  Your browser does not support the video tag.\n                </video>\n                <div className=\"absolute bottom-4 right-4 flex gap-2\">\n                  <Button\n                    size=\"sm\"\n                    variant=\"secondary\"\n                    onClick={() => handleRetryVideo(video.sceneNumber)}\n                    disabled={retryingScenes.has(video.sceneNumber)}\n                    data-testid={`button-regenerate-${video.sceneNumber}`}\n                    title=\"Regenerate this video\"\n                  >\n                    <RefreshCw className={`w-4 h-4 ${retryingScenes.has(video.sceneNumber) ? 'animate-spin' : ''}`} />\n                  </Button>\n                  <Button\n                    size=\"sm\"\n                    variant=\"secondary\"\n                    onClick={() => {\n                      const link = document.createElement('a');\n                      link.href = video.videoUrl!;\n                      link.download = `scene-${video.sceneNumber}.mp4`;\n                      link.click();\n                    }}\n                    data-testid={`button-download-${video.sceneNumber}`}\n                    title=\"Download this video\"\n                  >\n                    <Download className=\"w-4 h-4\" />\n                  </Button>\n                </div>\n              </div>\n            ) : video.error ? (\n              <div className=\"aspect-video bg-destructive/10 flex flex-col items-center justify-center p-6\">\n                <div className=\"text-center mb-4\">\n                  <p className=\"text-destructive font-medium mb-2\">\n                    Failed to generate video\n                  </p>\n                  <p className=\"text-sm text-muted-foreground mb-4\">{video.error}</p>\n                </div>\n                <Button\n                  variant=\"outline\"\n                  onClick={() => handleRetryVideo(video.sceneNumber)}\n                  disabled={retryingScenes.has(video.sceneNumber)}\n                  data-testid={`button-retry-${video.sceneNumber}`}\n                >\n                  <RefreshCw className={`w-4 h-4 mr-2 ${retryingScenes.has(video.sceneNumber) ? 'animate-spin' : ''}`} />\n                  {retryingScenes.has(video.sceneNumber) ? 'Regenerating...' : 'Try Again'}\n                </Button>\n              </div>\n            ) : (\n              <div className=\"aspect-video bg-muted flex items-center justify-center\">\n                <div className=\"text-center text-muted-foreground\">\n                  <Play className=\"w-12 h-12 mx-auto mb-2 opacity-50\" />\n                  <p className=\"text-sm\">Video not available</p>\n                </div>\n              </div>\n            )}\n          </Card>\n        ))}\n      </div>\n    </div>\n  );\n}\n","size_bytes":12506},"client/src/components/ui/textarea.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Textarea = React.forwardRef<\n  HTMLTextAreaElement,\n  React.ComponentProps<\"textarea\">\n>(({ className, ...props }, ref) => {\n  return (\n    <textarea\n      className={cn(\n        \"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  )\n})\nTextarea.displayName = \"Textarea\"\n\nexport { Textarea }\n","size_bytes":689},"client/src/components/CharacterInput.tsx":{"content":"import { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport { Card } from \"@/components/ui/card\";\nimport { X, User } from \"lucide-react\";\nimport type { Character } from \"@shared/schema\";\n\ninterface CharacterInputProps {\n  character: Character;\n  onUpdate: (character: Character) => void;\n  onRemove: () => void;\n  canRemove: boolean;\n}\n\nexport default function CharacterInput({ \n  character, \n  onUpdate, \n  onRemove,\n  canRemove \n}: CharacterInputProps) {\n  return (\n    <Card className=\"p-6 relative bg-[#1e2838] dark:bg-[#181e2a] border-white/10\">\n      {canRemove && (\n        <Button\n          type=\"button\"\n          size=\"icon\"\n          variant=\"ghost\"\n          className=\"absolute top-4 right-4 text-gray-300 hover:text-white hover:bg-white/10\"\n          onClick={onRemove}\n          data-testid={`button-remove-character-${character.id}`}\n        >\n          <X className=\"w-4 h-4\" />\n        </Button>\n      )}\n      \n      <div className=\"flex items-center gap-2 mb-4\">\n        <User className=\"w-5 h-5 text-primary\" />\n        <h3 className=\"text-lg font-semibold text-white\">Character Details</h3>\n      </div>\n      \n      <div className=\"space-y-4\">\n        <div>\n          <Label htmlFor={`character-name-${character.id}`} className=\"text-gray-200\">\n            Character Name <span className=\"text-destructive\">*</span>\n          </Label>\n          <Input\n            id={`character-name-${character.id}`}\n            placeholder=\"e.g., Max the Motivator\"\n            value={character.name}\n            onChange={(e) => onUpdate({ ...character, name: e.target.value })}\n            className=\"h-12 mt-1\"\n            data-testid={`input-character-name-${character.id}`}\n          />\n        </div>\n        \n        <div>\n          <Label htmlFor={`character-description-${character.id}`} className=\"text-gray-200\">\n            Character Description <span className=\"text-destructive\">*</span>\n          </Label>\n          <Textarea\n            id={`character-description-${character.id}`}\n            placeholder=\"e.g., A majestic golden-maned lion with incredible energy and enthusiasm. He's the main motivator at the gym.\"\n            value={character.description}\n            onChange={(e) => onUpdate({ ...character, description: e.target.value })}\n            className=\"min-h-[120px] mt-1\"\n            data-testid={`input-character-description-${character.id}`}\n          />\n        </div>\n      </div>\n    </Card>\n  );\n}\n","size_bytes":2589},"server/routes.ts":{"content":"import type { Express, Request, Response, NextFunction } from \"express\";\nimport { createServer, type Server } from \"http\";\nimport { storage } from \"./storage\";\nimport { db } from \"./db\";\nimport { \n  storyInputSchema, \n  loginSchema, \n  insertUserSchema, \n  updateUserPlanSchema, \n  updateUserApiTokenSchema, \n  insertApiTokenSchema,\n  bulkReplaceTokensSchema,\n  updateTokenSettingsSchema,\n  videoHistory,\n  type Scene \n} from \"@shared/schema\";\nimport { generateScenes } from \"./gemini\";\nimport { generateScript } from \"./openai-script\";\nimport { generateVideoForScene, checkVideoStatus, waitForVideoCompletion, waitForVideoCompletionWithUpdates } from \"./veo3\";\nimport { uploadVideoToCloudinary } from \"./cloudinary\";\nimport { mergeVideosWithFalAI } from \"./falai\";\nimport { z } from \"zod\";\nimport { desc } from \"drizzle-orm\";\nimport path from \"path\";\nimport { existsSync } from \"fs\";\nimport { rm } from \"fs/promises\";\n\n// Cache to store Cloudinary URL promises by sceneId to avoid re-uploading\n// Using promises allows concurrent requests to await the same upload\nconst cloudinaryUploadCache = new Map<string, Promise<string>>();\n\n// Authentication middleware\nconst requireAuth = async (req: Request, res: Response, next: NextFunction) => {\n  if (!req.session.userId) {\n    return res.status(401).json({ error: \"Authentication required\" });\n  }\n  next();\n};\n\nconst requireAdmin = async (req: Request, res: Response, next: NextFunction) => {\n  if (!req.session.userId) {\n    return res.status(401).json({ error: \"Authentication required\" });\n  }\n\n  const user = await storage.getUser(req.session.userId);\n  if (!user || !user.isAdmin) {\n    return res.status(403).json({ error: \"Admin access required\" });\n  }\n  next();\n};\n\nexport async function registerRoutes(app: Express): Promise<Server> {\n  // Loader.io verification endpoint\n  app.get(\"/loaderio-34c6b917514b779ecc940b8a20a020fd.txt\", (_req, res) => {\n    res.type('text/plain');\n    res.send('loaderio-34c6b917514b779ecc940b8a20a020fd');\n  });\n\n  app.get(\"/loaderio-34c6b917514b779ecc940b8a20a020fd.html\", (_req, res) => {\n    res.type('text/html');\n    res.send('loaderio-34c6b917514b779ecc940b8a20a020fd');\n  });\n\n  app.get(\"/loaderio-34c6b917514b779ecc940b8a20a020fd/\", (_req, res) => {\n    res.type('text/plain');\n    res.send('loaderio-34c6b917514b779ecc940b8a20a020fd');\n  });\n\n  // Login endpoint\n  app.post(\"/api/login\", async (req, res) => {\n    try {\n      const validationResult = loginSchema.safeParse(req.body);\n      \n      if (!validationResult.success) {\n        return res.status(400).json({ \n          error: \"Invalid input\", \n          details: validationResult.error.errors \n        });\n      }\n\n      const { username, password } = validationResult.data;\n\n      const user = await storage.getUserByUsername(username);\n      \n      if (!user) {\n        return res.status(401).json({ error: \"Invalid username or password\" });\n      }\n\n      const isPasswordValid = await storage.verifyPassword(user, password);\n      if (!isPasswordValid) {\n        return res.status(401).json({ error: \"Invalid username or password\" });\n      }\n\n      req.session.userId = user.id;\n      \n      res.json({ \n        success: true,\n        user: { \n          id: user.id, \n          username: user.username, \n          isAdmin: user.isAdmin \n        } \n      });\n    } catch (error) {\n      console.error(\"Error in /api/login:\", error);\n      res.status(500).json({ error: \"Login failed\" });\n    }\n  });\n\n  // Logout endpoint\n  app.post(\"/api/logout\", (req, res) => {\n    req.session.destroy((err) => {\n      if (err) {\n        return res.status(500).json({ error: \"Logout failed\" });\n      }\n      res.json({ success: true });\n    });\n  });\n\n  // Check session endpoint\n  app.get(\"/api/session\", async (req, res) => {\n    if (!req.session.userId) {\n      return res.json({ authenticated: false });\n    }\n\n    const user = await storage.getUser(req.session.userId);\n    \n    if (!user) {\n      req.session.userId = undefined;\n      return res.json({ authenticated: false });\n    }\n\n    res.json({ \n      authenticated: true,\n      user: { \n        id: user.id, \n        username: user.username, \n        isAdmin: user.isAdmin \n      } \n    });\n  });\n\n  // Get all users endpoint (admin only)\n  app.get(\"/api/users\", requireAdmin, async (req, res) => {\n    try {\n      const users = await storage.getAllUsers();\n      \n      // Don't send password hashes to frontend\n      const sanitizedUsers = users.map(user => ({\n        id: user.id,\n        username: user.username,\n        isAdmin: user.isAdmin,\n        planType: user.planType,\n        planStatus: user.planStatus,\n        planExpiry: user.planExpiry,\n        apiToken: user.apiToken,\n      }));\n      \n      res.json({ users: sanitizedUsers });\n    } catch (error) {\n      console.error(\"Error in GET /api/users:\", error);\n      res.status(500).json({ error: \"Failed to fetch users\" });\n    }\n  });\n\n  // Create user endpoint (admin only)\n  app.post(\"/api/users\", requireAdmin, async (req, res) => {\n    try {\n      const validationResult = insertUserSchema.safeParse(req.body);\n      \n      if (!validationResult.success) {\n        return res.status(400).json({ \n          error: \"Invalid input\", \n          details: validationResult.error.errors \n        });\n      }\n\n      const { username, password, isAdmin } = validationResult.data;\n\n      const existingUser = await storage.getUserByUsername(username);\n      if (existingUser) {\n        return res.status(409).json({ error: \"Username already exists\" });\n      }\n\n      const newUser = await storage.createUser({ username, password, isAdmin });\n      \n      res.json({ \n        success: true,\n        user: { \n          id: newUser.id, \n          username: newUser.username, \n          isAdmin: newUser.isAdmin \n        } \n      });\n    } catch (error) {\n      console.error(\"Error in /api/users:\", error);\n      res.status(500).json({ error: \"Failed to create user\" });\n    }\n  });\n\n  // Update user plan endpoint (admin only)\n  app.patch(\"/api/users/:id/plan\", requireAdmin, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const validationResult = updateUserPlanSchema.safeParse(req.body);\n      \n      if (!validationResult.success) {\n        return res.status(400).json({ \n          error: \"Invalid input\", \n          details: validationResult.error.errors \n        });\n      }\n\n      const updatedUser = await storage.updateUserPlan(id, validationResult.data);\n      \n      if (!updatedUser) {\n        return res.status(404).json({ error: \"User not found\" });\n      }\n\n      res.json({ \n        success: true,\n        user: {\n          id: updatedUser.id,\n          username: updatedUser.username,\n          isAdmin: updatedUser.isAdmin,\n          planType: updatedUser.planType,\n          planStatus: updatedUser.planStatus,\n          planExpiry: updatedUser.planExpiry,\n          apiToken: updatedUser.apiToken,\n        }\n      });\n    } catch (error) {\n      console.error(\"Error in PATCH /api/users/:id/plan:\", error);\n      res.status(500).json({ error: \"Failed to update user plan\" });\n    }\n  });\n\n  // Update user API token endpoint (admin only)\n  app.patch(\"/api/users/:id/token\", requireAdmin, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const validationResult = updateUserApiTokenSchema.safeParse(req.body);\n      \n      if (!validationResult.success) {\n        return res.status(400).json({ \n          error: \"Invalid input\", \n          details: validationResult.error.errors \n        });\n      }\n\n      const updatedUser = await storage.updateUserApiToken(id, validationResult.data);\n      \n      if (!updatedUser) {\n        return res.status(404).json({ error: \"User not found\" });\n      }\n\n      res.json({ \n        success: true,\n        user: {\n          id: updatedUser.id,\n          username: updatedUser.username,\n          isAdmin: updatedUser.isAdmin,\n          planType: updatedUser.planType,\n          planStatus: updatedUser.planStatus,\n          planExpiry: updatedUser.planExpiry,\n          apiToken: updatedUser.apiToken,\n        }\n      });\n    } catch (error) {\n      console.error(\"Error in PATCH /api/users/:id/token:\", error);\n      res.status(500).json({ error: \"Failed to update user API token\" });\n    }\n  });\n\n  // API Token Management Endpoints (admin only)\n  app.get(\"/api/tokens\", requireAdmin, async (req, res) => {\n    try {\n      const tokens = await storage.getAllApiTokens();\n      res.json({ tokens });\n    } catch (error) {\n      console.error(\"Error in GET /api/tokens:\", error);\n      res.status(500).json({ error: \"Failed to fetch API tokens\" });\n    }\n  });\n\n  app.post(\"/api/tokens\", requireAdmin, async (req, res) => {\n    try {\n      const validationResult = insertApiTokenSchema.safeParse(req.body);\n      \n      if (!validationResult.success) {\n        return res.status(400).json({ \n          error: \"Invalid input\", \n          details: validationResult.error.errors \n        });\n      }\n\n      const newToken = await storage.addApiToken(validationResult.data);\n      res.json({ success: true, token: newToken });\n    } catch (error) {\n      console.error(\"Error in POST /api/tokens:\", error);\n      res.status(500).json({ error: \"Failed to add API token\" });\n    }\n  });\n\n  app.delete(\"/api/tokens/:id\", requireAdmin, async (req, res) => {\n    try {\n      const { id } = req.params;\n      await storage.deleteApiToken(id);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error in DELETE /api/tokens/:id:\", error);\n      res.status(500).json({ error: \"Failed to delete API token\" });\n    }\n  });\n\n  app.patch(\"/api/tokens/:id/toggle\", requireAdmin, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const { isActive } = req.body;\n      \n      const updatedToken = await storage.toggleApiTokenStatus(id, isActive);\n      \n      if (!updatedToken) {\n        return res.status(404).json({ error: \"Token not found\" });\n      }\n\n      res.json({ success: true, token: updatedToken });\n    } catch (error) {\n      console.error(\"Error in PATCH /api/tokens/:id/toggle:\", error);\n      res.status(500).json({ error: \"Failed to update token status\" });\n    }\n  });\n\n  // Token Rotation Settings Endpoints (admin only)\n  app.get(\"/api/token-settings\", requireAdmin, async (req, res) => {\n    try {\n      const settings = await storage.getTokenSettings();\n      res.json({ settings });\n    } catch (error) {\n      console.error(\"Error in GET /api/token-settings:\", error);\n      res.status(500).json({ error: \"Failed to fetch token settings\" });\n    }\n  });\n\n  app.put(\"/api/token-settings\", requireAdmin, async (req, res) => {\n    try {\n      const validationResult = updateTokenSettingsSchema.safeParse(req.body);\n      \n      if (!validationResult.success) {\n        return res.status(400).json({ \n          error: \"Invalid input\", \n          details: validationResult.error.errors \n        });\n      }\n\n      const updatedSettings = await storage.updateTokenSettings(validationResult.data);\n      res.json({ success: true, settings: updatedSettings });\n    } catch (error) {\n      console.error(\"Error in PUT /api/token-settings:\", error);\n      res.status(500).json({ error: \"Failed to update token settings\" });\n    }\n  });\n\n  // Bulk replace all tokens (admin only)\n  app.post(\"/api/tokens/bulk-replace\", requireAdmin, async (req, res) => {\n    try {\n      console.log('[Bulk Replace] Request body:', req.body);\n      const validationResult = bulkReplaceTokensSchema.safeParse(req.body);\n      \n      if (!validationResult.success) {\n        console.error('[Bulk Replace] Validation failed:', validationResult.error.errors);\n        return res.status(400).json({ \n          error: \"Invalid input\", \n          details: validationResult.error.errors \n        });\n      }\n\n      // Parse tokens from textarea (one per line)\n      const tokensText = validationResult.data.tokens.trim();\n      const tokenLines = tokensText.split('\\n')\n        .map(line => line.trim())\n        .filter(line => line.length > 0)\n        .map(line => {\n          // Remove \"Bearer \" prefix if present\n          return line.replace(/^Bearer\\s+/i, '');\n        });\n\n      console.log('[Bulk Replace] Parsed token lines:', tokenLines.length);\n\n      if (tokenLines.length === 0) {\n        console.error('[Bulk Replace] No valid tokens found');\n        return res.status(400).json({ \n          error: \"No valid tokens found\",\n          details: [\"Please enter at least one token\"] \n        });\n      }\n\n      console.log('[Bulk Replace] Calling storage.replaceAllTokens...');\n      const newTokens = await storage.replaceAllTokens(tokenLines);\n      console.log('[Bulk Replace] Successfully replaced tokens:', newTokens.length);\n      res.json({ success: true, tokens: newTokens, count: newTokens.length });\n    } catch (error) {\n      console.error(\"[Bulk Replace] Error details:\", error);\n      console.error(\"[Bulk Replace] Error stack:\", error instanceof Error ? error.stack : 'No stack trace');\n      res.status(500).json({ \n        error: \"Failed to replace tokens\",\n        message: error instanceof Error ? error.message : \"Unknown error\"\n      });\n    }\n  });\n\n  // Video history endpoints\n  app.get(\"/api/admin/video-history\", requireAuth, requireAdmin, async (req, res) => {\n    try {\n      const videos = await db.select().from(videoHistory).orderBy(desc(videoHistory.createdAt));\n      res.json({ videos });\n    } catch (error) {\n      console.error(\"Error fetching all video history:\", error);\n      res.status(500).json({ \n        error: \"Failed to fetch video history\",\n        message: error instanceof Error ? error.message : \"Unknown error\"\n      });\n    }\n  });\n\n  app.get(\"/api/video-history\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.session.userId;\n      if (!userId) {\n        return res.status(401).json({ error: \"Not authenticated\" });\n      }\n\n      const videos = await storage.getUserVideoHistory(userId);\n      \n      // Group videos by project\n      const grouped: Record<string, { project?: any; videos: any[] }> = {};\n      \n      for (const video of videos) {\n        const key = video.projectId || 'standalone';\n        \n        if (!grouped[key]) {\n          grouped[key] = {\n            videos: []\n          };\n          \n          // Fetch project details if this is a project video\n          if (video.projectId) {\n            const project = await storage.getProject(video.projectId, userId);\n            if (project) {\n              grouped[key].project = {\n                id: project.id,\n                title: project.title,\n                scenes: JSON.parse(project.scenes),\n                characters: JSON.parse(project.characters),\n                mergedVideoUrl: project.mergedVideoUrl,\n              };\n            }\n          }\n        }\n        \n        grouped[key].videos.push(video);\n      }\n      \n      res.json({ videos, grouped });\n    } catch (error) {\n      console.error(\"Error fetching video history:\", error);\n      res.status(500).json({ \n        error: \"Failed to fetch video history\",\n        message: error instanceof Error ? error.message : \"Unknown error\"\n      });\n    }\n  });\n\n  app.post(\"/api/video-history\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.session.userId;\n      if (!userId) {\n        return res.status(401).json({ error: \"Not authenticated\" });\n      }\n\n      const schema = z.object({\n        prompt: z.string().min(10, \"Prompt must be at least 10 characters\"),\n        aspectRatio: z.enum([\"landscape\", \"portrait\"]),\n        videoUrl: z.string().optional(),\n        status: z.enum([\"pending\", \"completed\", \"failed\", \"queued\"]),\n        title: z.string().optional(),\n        tokenUsed: z.string().optional(),\n      });\n\n      const validationResult = schema.safeParse(req.body);\n      \n      if (!validationResult.success) {\n        return res.status(400).json({ \n          error: \"Invalid input\", \n          details: validationResult.error.errors \n        });\n      }\n\n      const video = await storage.addVideoHistory({\n        userId,\n        ...validationResult.data\n      });\n\n      res.json({ video });\n    } catch (error) {\n      console.error(\"Error saving video history:\", error);\n      res.status(500).json({ \n        error: \"Failed to save video history\",\n        message: error instanceof Error ? error.message : \"Unknown error\"\n      });\n    }\n  });\n\n  // Bulk generate endpoint - processes videos in background queue\n  app.post(\"/api/bulk-generate\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.session.userId;\n      if (!userId) {\n        return res.status(401).json({ error: \"Not authenticated\" });\n      }\n\n      const schema = z.object({\n        prompts: z.array(z.string().min(10, \"Each prompt must be at least 10 characters\")).min(1).max(200),\n        aspectRatio: z.enum([\"landscape\", \"portrait\"]),\n      });\n\n      const validationResult = schema.safeParse(req.body);\n      \n      if (!validationResult.success) {\n        return res.status(400).json({ \n          error: \"Invalid input\", \n          details: validationResult.error.errors \n        });\n      }\n\n      const { prompts, aspectRatio } = validationResult.data;\n      const { addToQueue } = await import('./bulkQueue');\n      \n      console.log(`[Bulk Generate] Starting bulk generation for ${prompts.length} videos`);\n\n      // Create all video history entries immediately\n      const videoIds: string[] = [];\n      const queuedVideos = [];\n      \n      for (let i = 0; i < prompts.length; i++) {\n        const prompt = prompts[i];\n        const video = await storage.addVideoHistory({\n          userId,\n          prompt,\n          aspectRatio,\n          status: \"pending\",\n          title: `Bulk VEO ${aspectRatio} video ${i + 1}`,\n        });\n        \n        videoIds.push(video.id);\n        queuedVideos.push({\n          videoId: video.id,\n          prompt,\n          aspectRatio,\n          sceneNumber: i + 1,\n          userId,\n        });\n      }\n\n      // Add all videos to the background queue\n      addToQueue(queuedVideos);\n\n      console.log(`[Bulk Generate] Created ${videoIds.length} videos and added to queue`);\n\n      res.json({ \n        success: true,\n        videoIds,\n        message: `Started generating ${prompts.length} videos. You can leave this page and check progress in Video History.`\n      });\n    } catch (error) {\n      console.error(\"Error starting bulk generation:\", error);\n      res.status(500).json({ \n        error: \"Failed to start bulk generation\",\n        message: error instanceof Error ? error.message : \"Unknown error\"\n      });\n    }\n  });\n\n  app.patch(\"/api/video-history/:id\", requireAuth, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const userId = req.session.userId;\n      \n      if (!userId) {\n        return res.status(401).json({ error: \"Not authenticated\" });\n      }\n\n      const schema = z.object({\n        status: z.enum([\"pending\", \"completed\", \"failed\", \"queued\"]),\n        videoUrl: z.string().optional(),\n      });\n\n      const validationResult = schema.safeParse(req.body);\n      \n      if (!validationResult.success) {\n        return res.status(400).json({ \n          error: \"Invalid input\", \n          details: validationResult.error.errors \n        });\n      }\n\n      const { status, videoUrl } = validationResult.data;\n\n      const updated = await storage.updateVideoHistoryStatus(id, userId, status, videoUrl);\n\n      if (!updated) {\n        return res.status(404).json({ error: \"Video history entry not found or access denied\" });\n      }\n\n      res.json({ video: updated });\n    } catch (error) {\n      console.error(\"Error updating video history:\", error);\n      res.status(500).json({ \n        error: \"Failed to update video history\",\n        message: error instanceof Error ? error.message : \"Unknown error\"\n      });\n    }\n  });\n\n  // Scene generation endpoint\n  app.post(\"/api/generate-scenes\", requireAuth, async (req, res) => {\n    try {\n      // Validate request body\n      const validationResult = storyInputSchema.safeParse(req.body);\n      \n      if (!validationResult.success) {\n        return res.status(400).json({ \n          error: \"Invalid input\", \n          details: validationResult.error.errors \n        });\n      }\n\n      const storyInput = validationResult.data;\n      const userId = req.session.userId!;\n\n      // Generate scenes using Gemini AI\n      const scenes = await generateScenes(storyInput);\n\n      // Auto-save as project if title is provided or generate default title\n      const projectTitle = storyInput.title || `Cartoon Story - ${new Date().toLocaleDateString()}`;\n      \n      const project = await storage.createProject({\n        userId,\n        title: projectTitle,\n        script: storyInput.script,\n        characters: JSON.stringify(storyInput.characters),\n        scenes: JSON.stringify(scenes),\n      });\n\n      res.json({ scenes, projectId: project.id });\n    } catch (error) {\n      console.error(\"Error in /api/generate-scenes:\", error);\n      res.status(500).json({ \n        error: \"Failed to generate scenes\",\n        message: error instanceof Error ? error.message : \"Unknown error\"\n      });\n    }\n  });\n\n  // Script creator endpoint\n  app.post(\"/api/generate-script\", async (req, res) => {\n    try {\n      const schema = z.object({\n        storyAbout: z.string().min(5, \"Story description must be at least 5 characters\"),\n        numberOfPrompts: z.number().min(1).max(100),\n        finalStep: z.string().min(5, \"Final step must be at least 5 characters\")\n      });\n\n      const validationResult = schema.safeParse(req.body);\n      \n      if (!validationResult.success) {\n        return res.status(400).json({ \n          error: \"Invalid input\", \n          details: validationResult.error.errors \n        });\n      }\n\n      const { storyAbout, numberOfPrompts, finalStep } = validationResult.data;\n\n      // Generate script using OpenAI GPT-5\n      const script = await generateScript(storyAbout, numberOfPrompts, finalStep);\n\n      res.json({ script });\n    } catch (error) {\n      console.error(\"Error in /api/generate-script:\", error);\n      res.status(500).json({ \n        error: \"Failed to generate script\",\n        message: error instanceof Error ? error.message : \"Unknown error\"\n      });\n    }\n  });\n\n  // Generate VEO video directly from prompt\n  app.post(\"/api/generate-veo-video\", async (req, res) => {\n    let rotationToken: Awaited<ReturnType<typeof storage.getNextRotationToken>> | undefined;\n    \n    try {\n      const schema = z.object({\n        prompt: z.string().min(10, \"Prompt must be at least 10 characters\"),\n        aspectRatio: z.enum([\"landscape\", \"portrait\"]).default(\"landscape\")\n      });\n\n      const validationResult = schema.safeParse(req.body);\n      \n      if (!validationResult.success) {\n        return res.status(400).json({ \n          error: \"Invalid input\", \n          details: validationResult.error.errors \n        });\n      }\n\n      const { prompt, aspectRatio } = validationResult.data;\n      \n      // Get API key from token rotation system or fallback to environment variable\n      let apiKey: string | undefined;\n      rotationToken = await storage.getNextRotationToken();\n      \n      if (rotationToken) {\n        apiKey = rotationToken.token;\n        console.log(`[Token Rotation] Using token: ${rotationToken.label} (ID: ${rotationToken.id})`);\n        await storage.updateTokenUsage(rotationToken.id);\n      } else {\n        apiKey = process.env.VEO3_API_KEY;\n        console.log('[Token Rotation] No active tokens found, using environment variable VEO3_API_KEY');\n      }\n\n      if (!apiKey) {\n        return res.status(500).json({ \n          error: \"No API key configured. Please add tokens in the admin panel or set VEO3_API_KEY environment variable.\" \n        });\n      }\n\n      const veoProjectId = process.env.VEO3_PROJECT_ID || \"06ad4933-483d-4ef6-b1d9-7a8bc21219cb\";\n      const sceneId = `veo-${Date.now()}`;\n      const seed = Math.floor(Math.random() * 100000);\n\n      // Build the payload based on aspect ratio\n      const payload = {\n        clientContext: {\n          projectId: veoProjectId,\n          tool: \"PINHOLE\",\n          userPaygateTier: \"PAYGATE_TIER_TWO\"\n        },\n        requests: [{\n          aspectRatio: aspectRatio === \"portrait\" ? \"VIDEO_ASPECT_RATIO_PORTRAIT\" : \"VIDEO_ASPECT_RATIO_LANDSCAPE\",\n          seed: seed,\n          textInput: {\n            prompt: prompt\n          },\n          videoModelKey: aspectRatio === \"portrait\" ? \"veo_3_0_t2v_fast_portrait_ultra\" : \"veo_3_1_t2v_fast_ultra\",\n          metadata: {\n            sceneId: sceneId\n          }\n        }]\n      };\n\n      console.log(`[VEO Direct] Generating ${aspectRatio} video with prompt:`, prompt);\n\n      const response = await fetch('https://aisandbox-pa.googleapis.com/v1/video:batchAsyncGenerateVideoText', {\n        method: 'POST',\n        headers: {\n          'Authorization': `Bearer ${apiKey}`,\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify(payload),\n      });\n\n      const data = await response.json();\n\n      if (!response.ok) {\n        throw new Error(data.error?.message || 'Failed to start video generation');\n      }\n\n      const operationName = data.operations?.[0]?.operation?.name;\n\n      if (!operationName) {\n        throw new Error('No operation name returned from VEO API');\n      }\n\n      res.json({\n        operationName,\n        sceneId,\n        status: \"PENDING\",\n        tokenId: rotationToken?.id || null\n      });\n    } catch (error) {\n      console.error(\"Error in /api/generate-veo-video:\", error);\n      \n      // Record token error if we used a rotation token\n      if (rotationToken) {\n        storage.recordTokenError(rotationToken.id);\n      }\n      \n      res.status(500).json({ \n        error: \"Failed to start video generation\",\n        message: error instanceof Error ? error.message : \"Unknown error\"\n      });\n    }\n  });\n\n  // Start video generation for a scene\n  app.post(\"/api/generate-video\", async (req, res) => {\n    let rotationToken: Awaited<ReturnType<typeof storage.getNextRotationToken>> | undefined;\n    \n    try {\n      const schema = z.object({\n        scene: z.object({\n          scene: z.number(),\n          title: z.string(),\n          description: z.string()\n        }),\n        projectId: z.string().optional()\n      });\n\n      const validationResult = schema.safeParse(req.body);\n      \n      if (!validationResult.success) {\n        return res.status(400).json({ \n          error: \"Invalid input\", \n          details: validationResult.error.errors \n        });\n      }\n\n      const { scene, projectId } = validationResult.data;\n      \n      // Get API key from token rotation system or fallback to environment variable\n      let apiKey: string | undefined;\n      rotationToken = await storage.getNextRotationToken();\n      \n      if (rotationToken) {\n        apiKey = rotationToken.token;\n        console.log(`[Token Rotation] Using token: ${rotationToken.label} (ID: ${rotationToken.id})`);\n        await storage.updateTokenUsage(rotationToken.id);\n      } else {\n        apiKey = process.env.VEO3_API_KEY;\n        console.log('[Token Rotation] No active tokens found, using environment variable VEO3_API_KEY');\n      }\n\n      if (!apiKey) {\n        return res.status(500).json({ \n          error: \"No API key configured. Please add tokens in the admin panel or set VEO3_API_KEY environment variable.\" \n        });\n      }\n\n      // Use provided projectId or default\n      const veoProjectId = projectId || process.env.VEO3_PROJECT_ID || \"06ad4933-483d-4ef6-b1d9-7a8bc21219cb\";\n\n      const result = await generateVideoForScene(scene, veoProjectId, apiKey);\n\n      res.json({\n        operationName: result.operationName,\n        sceneId: result.sceneId,\n        sceneNumber: scene.scene,\n        status: \"PENDING\",\n        tokenId: rotationToken?.id || null\n      });\n    } catch (error) {\n      console.error(\"Error in /api/generate-video:\", error);\n      \n      // Record token error if we used a rotation token\n      if (rotationToken) {\n        storage.recordTokenError(rotationToken.id);\n      }\n      \n      res.status(500).json({ \n        error: \"Failed to start video generation\",\n        message: error instanceof Error ? error.message : \"Unknown error\"\n      });\n    }\n  });\n\n  // Regenerate a failed video from history\n  app.post(\"/api/regenerate-video\", requireAuth, async (req, res) => {\n    let rotationToken: Awaited<ReturnType<typeof storage.getNextRotationToken>> | undefined;\n    \n    try {\n      const userId = req.session.userId;\n      if (!userId) {\n        return res.status(401).json({ error: \"Not authenticated\" });\n      }\n\n      const schema = z.object({\n        videoId: z.string(),\n        prompt: z.string().min(10, \"Prompt must be at least 10 characters\"),\n        aspectRatio: z.enum([\"landscape\", \"portrait\"]).default(\"landscape\"),\n        projectId: z.string().optional(),\n        sceneNumber: z.number().optional(),\n      });\n\n      const validationResult = schema.safeParse(req.body);\n      \n      if (!validationResult.success) {\n        return res.status(400).json({ \n          error: \"Invalid input\", \n          details: validationResult.error.errors \n        });\n      }\n\n      const { videoId, prompt, aspectRatio, projectId, sceneNumber } = validationResult.data;\n      \n      // First, verify the video exists and belongs to the user, then update status to pending\n      const updatedVideo = await storage.updateVideoHistoryStatus(videoId, userId, 'pending');\n      \n      if (!updatedVideo) {\n        return res.status(404).json({ \n          error: \"Video not found or you don't have permission to regenerate it\" \n        });\n      }\n\n      // Get API key using round-robin rotation based on scene number\n      let apiKey: string | undefined;\n      \n      if (sceneNumber !== undefined && sceneNumber > 0) {\n        // Use round-robin token selection based on scene number (0-indexed)\n        rotationToken = await storage.getTokenByIndex(sceneNumber - 1);\n        \n        if (rotationToken) {\n          apiKey = rotationToken.token;\n          console.log(`[Token Rotation] Using token ${rotationToken.label} for video ${sceneNumber} (round-robin)`);\n          await storage.updateTokenUsage(rotationToken.id);\n        }\n      } else {\n        // For non-bulk generations, use the regular rotation\n        rotationToken = await storage.getNextRotationToken();\n        \n        if (rotationToken) {\n          apiKey = rotationToken.token;\n          console.log(`[Token Rotation] Using token: ${rotationToken.label} (ID: ${rotationToken.id})`);\n          await storage.updateTokenUsage(rotationToken.id);\n        }\n      }\n      \n      // Fallback to environment variable if no token available\n      if (!apiKey) {\n        apiKey = process.env.VEO3_API_KEY;\n        console.log('[Token Rotation] No active tokens found, using environment variable VEO3_API_KEY');\n      }\n\n      if (!apiKey) {\n        return res.status(500).json({ \n          error: \"No API key configured. Please add tokens in the admin panel or set VEO3_API_KEY environment variable.\" \n        });\n      }\n\n      const veoProjectId = process.env.VEO3_PROJECT_ID || \"06ad4933-483d-4ef6-b1d9-7a8bc21219cb\";\n      const sceneId = `regenerate-${videoId}-${Date.now()}`;\n      const seed = Math.floor(Math.random() * 100000);\n\n      // Build the payload\n      const payload = {\n        clientContext: {\n          projectId: veoProjectId,\n          tool: \"PINHOLE\",\n          userPaygateTier: \"PAYGATE_TIER_TWO\"\n        },\n        requests: [{\n          aspectRatio: aspectRatio === \"portrait\" ? \"VIDEO_ASPECT_RATIO_PORTRAIT\" : \"VIDEO_ASPECT_RATIO_LANDSCAPE\",\n          seed: seed,\n          textInput: {\n            prompt: prompt\n          },\n          videoModelKey: aspectRatio === \"portrait\" ? \"veo_3_0_t2v_fast_portrait_ultra\" : \"veo_3_1_t2v_fast_ultra\",\n          metadata: {\n            sceneId: sceneId\n          }\n        }]\n      };\n\n      console.log(`[VEO Regenerate] Regenerating video ${videoId} (scene ${sceneNumber || 'N/A'}) with prompt:`, prompt);\n\n      const response = await fetch('https://aisandbox-pa.googleapis.com/v1/video:batchAsyncGenerateVideoText', {\n        method: 'POST',\n        headers: {\n          'Authorization': `Bearer ${apiKey}`,\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify(payload),\n      });\n\n      const data = await response.json();\n\n      if (!response.ok) {\n        console.error('[VEO Regenerate] Error response:', data);\n        await storage.updateVideoHistoryStatus(videoId, userId, 'failed');\n        \n        // Record token error if we used a rotation token\n        if (rotationToken) {\n          storage.recordTokenError(rotationToken.id);\n        }\n        \n        return res.status(500).json({ \n          error: \"VEO API error\",\n          details: data \n        });\n      }\n\n      if (!data.operations || data.operations.length === 0) {\n        await storage.updateVideoHistoryStatus(videoId, userId, 'failed');\n        \n        // Record token error if we used a rotation token\n        if (rotationToken) {\n          storage.recordTokenError(rotationToken.id);\n        }\n        \n        return res.status(500).json({ error: \"No operations returned from VEO API\" });\n      }\n\n      const operation = data.operations[0];\n      const operationName = operation.operation.name;\n\n      console.log(`[VEO Regenerate] Started regeneration - Operation: ${operationName}, Scene ID: ${sceneId}`);\n\n      // Update history with token ID if available\n      if (rotationToken) {\n        try {\n          await storage.updateVideoHistoryFields(videoId, { tokenUsed: rotationToken.id });\n        } catch (err) {\n          console.error('Failed to update video history with token ID:', err);\n        }\n      }\n\n      // Poll for completion in the background (don't block response)\n      (async () => {\n        try {\n          let completed = false;\n          let attempts = 0;\n          const maxAttempts = 120; // 4 minutes max (120 * 2 seconds = 240 seconds)\n          const retryAttempt = 60; // 2 minutes (60 * 2 seconds = 120 seconds)\n          let currentOperationName = operationName;\n          let currentSceneId = sceneId;\n          let currentApiKey = apiKey!;\n          let currentRotationToken = rotationToken;\n          let hasRetriedWithNewToken = false;\n\n          while (!completed && attempts < maxAttempts) {\n            await new Promise(resolve => setTimeout(resolve, 2000));\n            attempts++;\n\n            // After 2 minutes, try with next API token if not completed\n            if (attempts === retryAttempt && !completed && !hasRetriedWithNewToken) {\n              console.log(`[VEO Regenerate] Video ${videoId} not completed after 2 minutes, trying with next API token...`);\n              \n              // Record error for current token\n              if (currentRotationToken) {\n                storage.recordTokenError(currentRotationToken.id);\n              }\n\n              try {\n                // Get next rotation token\n                const nextToken = await storage.getNextRotationToken();\n                \n                if (nextToken && nextToken.id !== currentRotationToken?.id) {\n                  console.log(`[Token Rotation] Switching to next token: ${nextToken.label} (ID: ${nextToken.id})`);\n                  currentApiKey = nextToken.token;\n                  currentRotationToken = nextToken;\n                  await storage.updateTokenUsage(nextToken.id);\n                  \n                  // Start new generation with the new token\n                  const newPayload = {\n                    clientContext: {\n                      projectId: process.env.VEO3_PROJECT_ID || \"06ad4933-483d-4ef6-b1d9-7a8bc21219cb\",\n                      tool: \"PINHOLE\",\n                      userPaygateTier: \"PAYGATE_TIER_TWO\"\n                    },\n                    requests: [{\n                      aspectRatio: aspectRatio === \"portrait\" ? \"VIDEO_ASPECT_RATIO_PORTRAIT\" : \"VIDEO_ASPECT_RATIO_LANDSCAPE\",\n                      seed: Math.floor(Math.random() * 100000),\n                      textInput: {\n                        prompt: prompt\n                      },\n                      videoModelKey: aspectRatio === \"portrait\" ? \"veo_3_0_t2v_fast_portrait_ultra\" : \"veo_3_1_t2v_fast_ultra\",\n                      metadata: {\n                        sceneId: `retry-${videoId}-${Date.now()}`\n                      }\n                    }]\n                  };\n\n                  const retryResponse = await fetch('https://aisandbox-pa.googleapis.com/v1/video:batchAsyncGenerateVideoText', {\n                    method: 'POST',\n                    headers: {\n                      'Authorization': `Bearer ${currentApiKey}`,\n                      'Content-Type': 'application/json',\n                    },\n                    body: JSON.stringify(newPayload),\n                  });\n\n                  const retryData = await retryResponse.json();\n\n                  if (retryResponse.ok && retryData.operations && retryData.operations.length > 0) {\n                    currentOperationName = retryData.operations[0].operation.name;\n                    currentSceneId = `retry-${videoId}-${Date.now()}`;\n                    hasRetriedWithNewToken = true;\n                    \n                    // Update history with new token ID\n                    await storage.updateVideoHistoryFields(videoId, { tokenUsed: nextToken.id });\n                    console.log(`[VEO Regenerate] Retrying video ${videoId} with new token - Operation: ${currentOperationName}`);\n                  } else {\n                    console.error(`[VEO Regenerate] Failed to retry with new token:`, retryData);\n                  }\n                } else {\n                  console.log(`[VEO Regenerate] No other tokens available for retry`);\n                }\n              } catch (retryError) {\n                console.error(`[VEO Regenerate] Error retrying with new token:`, retryError);\n              }\n            }\n\n            try {\n              const statusResult = await checkVideoStatus(currentOperationName, currentSceneId, currentApiKey);\n\n              if (statusResult.status === 'COMPLETED' || \n                  statusResult.status === 'MEDIA_GENERATION_STATUS_COMPLETE' || \n                  statusResult.status === 'MEDIA_GENERATION_STATUS_SUCCESSFUL') {\n                completed = true;\n                \n                if (statusResult.videoUrl) {\n                  // Upload to Cloudinary before saving URL\n                  try {\n                    console.log(`[VEO Regenerate] Uploading video ${videoId} to Cloudinary...`);\n                    const cloudinaryUrl = await uploadVideoToCloudinary(statusResult.videoUrl);\n                    console.log(`[VEO Regenerate] Video ${videoId} uploaded to Cloudinary: ${cloudinaryUrl}`);\n                    \n                    // Update history with Cloudinary URL\n                    await storage.updateVideoHistoryFields(videoId, {\n                      videoUrl: cloudinaryUrl,\n                      status: 'completed',\n                    });\n                    console.log(`[VEO Regenerate] Video ${videoId} completed successfully${hasRetriedWithNewToken ? ' (after token retry)' : ''}`);\n                  } catch (uploadError) {\n                    console.error(`[VEO Regenerate] Failed to upload video ${videoId} to Cloudinary:`, uploadError);\n                    // Fall back to original URL if Cloudinary upload fails\n                    await storage.updateVideoHistoryFields(videoId, {\n                      videoUrl: statusResult.videoUrl,\n                      status: 'completed',\n                    });\n                    console.log(`[VEO Regenerate] Video ${videoId} saved with original URL (Cloudinary upload failed)`);\n                  }\n                }\n              } else if (statusResult.status === 'FAILED' || \n                         statusResult.status === 'MEDIA_GENERATION_STATUS_FAILED') {\n                completed = true;\n                await storage.updateVideoHistoryFields(videoId, { status: 'failed' });\n                console.error(`[VEO Regenerate] Video ${videoId} failed`);\n                \n                // Record token error\n                if (currentRotationToken) {\n                  storage.recordTokenError(currentRotationToken.id);\n                }\n              }\n            } catch (pollError) {\n              console.error(`[VEO Regenerate] Error polling status for ${videoId}:`, pollError);\n            }\n          }\n\n          // Timeout - mark as failed\n          if (!completed) {\n            console.error(`[VEO Regenerate] Video ${videoId} timed out after 4 minutes`);\n            await storage.updateVideoHistoryFields(videoId, { status: 'failed' });\n            \n            // Record token error for timeout\n            if (currentRotationToken) {\n              storage.recordTokenError(currentRotationToken.id);\n            }\n          }\n        } catch (bgError) {\n          console.error(`[VEO Regenerate] Background polling error for ${videoId}:`, bgError);\n        }\n      })();\n\n      res.json({\n        success: true,\n        operationName,\n        sceneId,\n        videoId,\n        message: \"Video regeneration started and will complete in background\",\n        tokenId: rotationToken?.id || null,\n        tokenLabel: rotationToken?.label || null\n      });\n    } catch (error) {\n      console.error(\"Error in /api/regenerate-video:\", error);\n      \n      // Record token error if we used a rotation token\n      if (rotationToken) {\n        storage.recordTokenError(rotationToken.id);\n      }\n      \n      res.status(500).json({ \n        error: \"Failed to regenerate video\",\n        message: error instanceof Error ? error.message : \"Unknown error\"\n      });\n    }\n  });\n\n  // Check video generation status\n  app.post(\"/api/check-video-status\", async (req, res) => {\n    let rotationToken: Awaited<ReturnType<typeof storage.getNextRotationToken>> | undefined;\n    \n    try {\n      const schema = z.object({\n        operationName: z.string(),\n        sceneId: z.string()\n      });\n\n      const validationResult = schema.safeParse(req.body);\n      \n      if (!validationResult.success) {\n        return res.status(400).json({ \n          error: \"Invalid input\", \n          details: validationResult.error.errors \n        });\n      }\n\n      const { operationName, sceneId } = validationResult.data;\n      \n      // Get API key from token rotation system or fallback to environment variable\n      let apiKey: string | undefined;\n      rotationToken = await storage.getNextRotationToken();\n      \n      if (rotationToken) {\n        apiKey = rotationToken.token;\n        console.log(`[Token Rotation] Using token: ${rotationToken.label} (ID: ${rotationToken.id})`);\n        await storage.updateTokenUsage(rotationToken.id);\n      } else {\n        apiKey = process.env.VEO3_API_KEY;\n        console.log('[Token Rotation] No active tokens found, using environment variable VEO3_API_KEY');\n      }\n\n      if (!apiKey) {\n        return res.status(500).json({ \n          error: \"No API key configured. Please add tokens in the admin panel or set VEO3_API_KEY environment variable.\" \n        });\n      }\n\n      const status = await checkVideoStatus(operationName, sceneId, apiKey);\n\n      // Record token error if video generation failed\n      if (status.status === 'FAILED' || status.status === 'MEDIA_GENERATION_STATUS_FAILED') {\n        if (rotationToken) {\n          storage.recordTokenError(rotationToken.id);\n        }\n      }\n\n      // If video is completed, handle Cloudinary upload with caching\n      if (status.videoUrl && (status.status === 'COMPLETED' || status.status === 'MEDIA_GENERATION_STATUS_COMPLETE' || status.status === 'MEDIA_GENERATION_STATUS_SUCCESSFUL')) {\n        // Check if upload is already in progress or completed\n        let uploadPromise = cloudinaryUploadCache.get(sceneId);\n        \n        if (!uploadPromise) {\n          // No upload in progress, start new upload\n          console.log(`[Video Status] Starting Cloudinary upload for ${sceneId}...`);\n          uploadPromise = uploadVideoToCloudinary(status.videoUrl);\n          \n          // Cache the promise immediately to prevent concurrent uploads\n          cloudinaryUploadCache.set(sceneId, uploadPromise);\n          \n          // Handle upload completion/failure\n          uploadPromise\n            .then(() => console.log(`[Video Status] Upload completed for ${sceneId}`))\n            .catch((error) => {\n              console.error(`[Video Status] Upload failed for ${sceneId}:`, error);\n              // Remove failed upload from cache so it can be retried\n              cloudinaryUploadCache.delete(sceneId);\n            });\n        } else {\n          console.log(`[Video Status] Using cached/in-progress upload for ${sceneId}`);\n        }\n        \n        // Await the upload (will be instant if already resolved)\n        try {\n          status.videoUrl = await uploadPromise;\n        } catch (uploadError) {\n          console.error(`[Video Status] Failed to get Cloudinary URL:`, uploadError);\n          // Continue with original VEO URL if Cloudinary upload fails\n        }\n      }\n\n      res.json(status);\n    } catch (error) {\n      console.error(\"Error in /api/check-video-status:\", error);\n      \n      // Record token error if we used a rotation token\n      if (rotationToken) {\n        storage.recordTokenError(rotationToken.id);\n      }\n      \n      res.status(500).json({ \n        error: \"Failed to check video status\",\n        message: error instanceof Error ? error.message : \"Unknown error\"\n      });\n    }\n  });\n\n  // Generate all videos sequentially\n  app.post(\"/api/generate-all-videos\", async (req, res) => {\n    try {\n      const schema = z.object({\n        scenes: z.array(z.object({\n          scene: z.number(),\n          title: z.string(),\n          description: z.string()\n        })),\n        characters: z.array(z.object({\n          name: z.string(),\n          description: z.string()\n        })).optional(),\n        projectId: z.string().optional()\n      });\n\n      const validationResult = schema.safeParse(req.body);\n      \n      if (!validationResult.success) {\n        return res.status(400).json({ \n          error: \"Invalid input\", \n          details: validationResult.error.errors \n        });\n      }\n\n      const { scenes, characters, projectId } = validationResult.data;\n      \n      const veoProjectId = projectId || process.env.VEO3_PROJECT_ID || \"06ad4933-483d-4ef6-b1d9-7a8bc21219cb\";\n\n      // Set headers for SSE (Server-Sent Events) to stream progress\n      res.setHeader('Content-Type', 'text/event-stream');\n      res.setHeader('Cache-Control', 'no-cache');\n      res.setHeader('Connection', 'keep-alive');\n      res.setHeader('X-Accel-Buffering', 'no'); // Disable nginx buffering\n      res.flushHeaders(); // Immediately send headers to establish SSE connection\n\n      // Helper function to send SSE messages with immediate flush\n      const sendSSE = (data: any) => {\n        const message = `data: ${JSON.stringify(data)}\\n\\n`;\n        res.write(message);\n        console.log('[SSE] Sent:', data.type, 'for scene', data.sceneNumber, '-', data.message || data.status);\n      };\n\n      const videos = [];\n      const operations: Array<{ operationName: string; sceneId: string; scene: any; apiKey: string; rotationToken?: Awaited<ReturnType<typeof storage.getNextRotationToken>> }> = [];\n\n      // STEP 1: Start all video generation requests - each scene gets its own token\n      for (let i = 0; i < scenes.length; i++) {\n        const scene = scenes[i];\n        let sceneRotationToken: Awaited<ReturnType<typeof storage.getNextRotationToken>> | undefined;\n        \n        try {\n          // Get a DIFFERENT API key for EACH scene from token rotation system\n          let sceneApiKey: string | undefined;\n          sceneRotationToken = await storage.getNextRotationToken();\n          \n          if (sceneRotationToken) {\n            sceneApiKey = sceneRotationToken.token;\n            console.log(`[Token Rotation] Scene ${scene.scene}: Using token ${sceneRotationToken.label} (ID: ${sceneRotationToken.id})`);\n            await storage.updateTokenUsage(sceneRotationToken.id);\n          } else {\n            sceneApiKey = process.env.VEO3_API_KEY;\n            console.log(`[Token Rotation] Scene ${scene.scene}: No active tokens found, using environment variable VEO3_API_KEY`);\n          }\n\n          if (!sceneApiKey) {\n            throw new Error(\"No API key configured. Please add tokens in the admin panel or set VEO3_API_KEY environment variable.\");\n          }\n\n          // Send starting update\n          sendSSE({ \n            type: 'progress', \n            current: i + 1, \n            total: scenes.length,\n            sceneNumber: scene.scene,\n            status: 'starting',\n            message: `Submitting request to VEO API${sceneRotationToken ? ` using token: ${sceneRotationToken.label}` : ''}...`,\n            timestamp: new Date().toISOString()\n          });\n\n          // Start video generation with character context using this scene's token\n          const { operationName, sceneId } = await generateVideoForScene(scene, veoProjectId, sceneApiKey, characters);\n          \n          operations.push({ operationName, sceneId, scene, apiKey: sceneApiKey, rotationToken: sceneRotationToken });\n\n          // Send request sent update\n          sendSSE({ \n            type: 'progress', \n            current: i + 1, \n            total: scenes.length,\n            sceneNumber: scene.scene,\n            status: 'pending',\n            message: 'Request submitted, queued for processing...',\n            timestamp: new Date().toISOString()\n          });\n\n          // CRITICAL: 5-second delay between each VEO 3 API request to avoid rate limiting\n          // This applies to ALL environments (development, production, etc.)\n          // Do NOT reduce this delay - VEO 3 API will reject requests if sent too quickly\n          if (i < scenes.length - 1) {\n            await new Promise(resolve => setTimeout(resolve, 5000));\n          }\n\n        } catch (error) {\n          console.error(`Error starting video generation for scene ${scene.scene}:`, error);\n          \n          // Record token error if we used a rotation token for this scene\n          if (sceneRotationToken) {\n            storage.recordTokenError(sceneRotationToken.id);\n          }\n          \n          videos.push({\n            sceneNumber: scene.scene,\n            sceneTitle: scene.title,\n            error: error instanceof Error ? error.message : \"Unknown error\",\n            status: 'failed'\n          });\n\n          sendSSE({ \n            type: 'error', \n            sceneNumber: scene.scene,\n            error: error instanceof Error ? error.message : \"Unknown error\",\n            timestamp: new Date().toISOString()\n          });\n        }\n      }\n\n      // STEP 2: Now poll for completion of all started operations using each scene's token\n      for (const op of operations) {\n        try {\n          sendSSE({ \n            type: 'progress', \n            sceneNumber: op.scene.scene,\n            status: 'generating',\n            message: 'VEO is generating your video...',\n            timestamp: new Date().toISOString()\n          });\n\n          // Wait for completion with periodic status updates using this scene's specific token\n          const result = await waitForVideoCompletionWithUpdates(\n            op.operationName, \n            op.sceneId, \n            op.apiKey, // Use the token that was used to start this specific scene\n            (status: string) => {\n              // Send periodic status updates during polling\n              sendSSE({ \n                type: 'progress', \n                sceneNumber: op.scene.scene,\n                status: 'generating',\n                message: status,\n                timestamp: new Date().toISOString()\n              });\n            }\n          );\n\n          // Send uploading status\n          sendSSE({ \n            type: 'progress', \n            sceneNumber: op.scene.scene,\n            status: 'generating',\n            message: 'Uploading to Cloudinary...',\n            timestamp: new Date().toISOString()\n          });\n\n          // Upload video to Cloudinary for easy download\n          console.log(`[Video Gen] Uploading scene ${op.scene.scene} to Cloudinary...`);\n          let finalVideoUrl = result.videoUrl;\n          try {\n            finalVideoUrl = await uploadVideoToCloudinary(result.videoUrl);\n            console.log(`[Video Gen] Scene ${op.scene.scene} uploaded to Cloudinary successfully`);\n          } catch (uploadError) {\n            console.error(`[Video Gen] Failed to upload scene ${op.scene.scene} to Cloudinary:`, uploadError);\n            // Continue with original VEO URL if Cloudinary upload fails\n          }\n\n          videos.push({\n            sceneNumber: op.scene.scene,\n            sceneTitle: op.scene.title,\n            videoUrl: finalVideoUrl,\n            status: 'completed'\n          });\n\n          // Send completed update\n          sendSSE({ \n            type: 'video_complete', \n            sceneNumber: op.scene.scene,\n            videoUrl: finalVideoUrl,\n            timestamp: new Date().toISOString()\n          });\n\n        } catch (error) {\n          console.error(`Error waiting for video completion for scene ${op.scene.scene}:`, error);\n          \n          // Record token error if we used a rotation token for this scene\n          if (op.rotationToken) {\n            storage.recordTokenError(op.rotationToken.id);\n          }\n          \n          videos.push({\n            sceneNumber: op.scene.scene,\n            sceneTitle: op.scene.title,\n            error: error instanceof Error ? error.message : \"Unknown error\",\n            status: 'failed'\n          });\n\n          sendSSE({ \n            type: 'error', \n            sceneNumber: op.scene.scene,\n            error: error instanceof Error ? error.message : \"Unknown error\",\n            timestamp: new Date().toISOString()\n          });\n        }\n      }\n\n      // Send final result\n      sendSSE({ \n        type: 'complete', \n        videos \n      });\n\n      res.end();\n\n    } catch (error) {\n      console.error(\"Error in /api/generate-all-videos:\", error);\n      res.status(500).json({ \n        error: \"Failed to generate videos\",\n        message: error instanceof Error ? error.message : \"Unknown error\"\n      });\n    }\n  });\n\n  // Merge all videos into one\n  app.post(\"/api/merge-videos\", requireAuth, async (req, res) => {\n    try {\n      const schema = z.object({\n        videos: z.array(z.object({\n          sceneNumber: z.number(),\n          videoUrl: z.string()\n        })),\n        projectId: z.string().optional()\n      });\n\n      const validationResult = schema.safeParse(req.body);\n      \n      if (!validationResult.success) {\n        return res.status(400).json({ \n          error: \"Invalid input\", \n          details: validationResult.error.errors \n        });\n      }\n\n      const { videos, projectId } = validationResult.data;\n      const userId = req.session.userId!;\n\n      if (videos.length === 0) {\n        return res.status(400).json({ \n          error: \"No videos to merge\" \n        });\n      }\n\n      console.log(`[Merge Videos] Starting merge of ${videos.length} videos using fal.ai`);\n\n      // Sort videos by scene number before merging to ensure correct sequence\n      const sortedVideos = [...videos].sort((a, b) => a.sceneNumber - b.sceneNumber);\n      const videoUrls = sortedVideos.map(v => v.videoUrl);\n\n      // Merge videos using fal.ai API\n      const mergedVideoUrl = await mergeVideosWithFalAI(videoUrls);\n      console.log(`[Merge Videos] Videos merged successfully with fal.ai`);\n      console.log(`[Merge Videos] Merged video URL: ${mergedVideoUrl}`);\n\n      // Save merged video URL to project if projectId provided\n      if (projectId) {\n        console.log(`[Merge Videos] Saving merged video URL to project: ${projectId}`);\n        await storage.updateProject(projectId, userId, { mergedVideoUrl: mergedVideoUrl });\n        console.log(`[Merge Videos] Project updated successfully`);\n      }\n\n      res.json({ \n        success: true,\n        mergedVideoUrl: mergedVideoUrl\n      });\n    } catch (error) {\n      console.error(\"Error in /api/merge-videos:\", error);\n      res.status(500).json({ \n        error: \"Failed to merge videos\",\n        message: error instanceof Error ? error.message : \"Unknown error\"\n      });\n    }\n  });\n\n  // Merge selected videos from history using FFmpeg\n  app.post(\"/api/merge-selected-videos\", requireAuth, async (req, res) => {\n    try {\n      const schema = z.object({\n        videoIds: z.array(z.string()).min(2).max(19)\n      });\n\n      const validationResult = schema.safeParse(req.body);\n      \n      if (!validationResult.success) {\n        return res.status(400).json({ \n          error: \"Invalid input\", \n          details: validationResult.error.errors \n        });\n      }\n\n      const { videoIds } = validationResult.data;\n      const userId = req.session.userId!;\n\n      console.log(`[Merge Selected] Starting FFmpeg merge of ${videoIds.length} selected videos for user ${userId}`);\n\n      // Security: Verify all videos belong to the authenticated user\n      const userVideos = await storage.getUserVideoHistory(userId);\n      const videoUrls: string[] = [];\n\n      for (const videoId of videoIds) {\n        const video = userVideos.find(v => v.id === videoId);\n        \n        if (!video) {\n          return res.status(403).json({ \n            error: \"Forbidden\",\n            message: `Video ${videoId} not found or does not belong to you`\n          });\n        }\n\n        if (video.status !== 'completed' || !video.videoUrl) {\n          return res.status(400).json({ \n            error: \"Invalid video\",\n            message: `Video ${videoId} is not completed or has no URL`\n          });\n        }\n\n        // Additional security: Verify URL is from trusted sources (Cloudinary or Google Cloud Storage)\n        const isCloudinary = video.videoUrl.startsWith('https://res.cloudinary.com/');\n        const isGoogleStorage = video.videoUrl.startsWith('https://storage.googleapis.com/');\n        if (!isCloudinary && !isGoogleStorage) {\n          return res.status(400).json({ \n            error: \"Invalid video URL\",\n            message: `Video ${videoId} has an invalid URL`\n          });\n        }\n\n        // If video is from Google Cloud Storage, migrate it to Cloudinary first\n        let finalVideoUrl = video.videoUrl;\n        if (isGoogleStorage) {\n          console.log(`[Merge Selected] Migrating video ${videoId} from Google Cloud Storage to Cloudinary...`);\n          try {\n            const { uploadVideoToCloudinary } = await import('./cloudinary');\n            const cloudinaryUrl = await uploadVideoToCloudinary(video.videoUrl);\n            \n            // Update video history with new Cloudinary URL\n            await storage.updateVideoHistoryFields(videoId, {\n              videoUrl: cloudinaryUrl,\n            });\n            \n            finalVideoUrl = cloudinaryUrl;\n            console.log(`[Merge Selected] Migration successful for video ${videoId}`);\n          } catch (uploadError) {\n            console.error(`[Merge Selected] Failed to migrate video ${videoId}:`, uploadError);\n            throw new Error(`Failed to migrate video to Cloudinary: ${uploadError instanceof Error ? uploadError.message : 'Unknown error'}`);\n          }\n        }\n\n        videoUrls.push(finalVideoUrl);\n      }\n\n      console.log(`[Merge Selected] All videos verified and migrated to Cloudinary, proceeding with merge`);\n\n      // Create a video history entry for this merge operation\n      const mergeHistoryEntry = await storage.addVideoHistory({\n        userId,\n        prompt: `Merged video from ${videoIds.length} selected videos`,\n        aspectRatio: \"16:9\",\n        status: \"pending\",\n        metadata: JSON.stringify({ mergedVideoIds: videoIds }),\n        title: `Merged Video (${videoIds.length} clips)`,\n      });\n\n      try {\n        // Import the FFmpeg merger function\n        const { mergeVideosWithFFmpeg } = await import('./videoMergerFFmpeg');\n        \n        // Merge videos using local FFmpeg\n        const mergedVideoUrl = await mergeVideosWithFFmpeg(videoUrls);\n        console.log(`[Merge Selected] Videos merged successfully with FFmpeg`);\n        console.log(`[Merge Selected] Merged video URL: ${mergedVideoUrl}`);\n\n        // Update the video history entry with success\n        await storage.updateVideoHistoryFields(mergeHistoryEntry.id, {\n          status: 'completed',\n          videoUrl: mergedVideoUrl,\n        });\n\n        res.json({ \n          success: true,\n          mergedVideoUrl: mergedVideoUrl,\n          historyId: mergeHistoryEntry.id\n        });\n      } catch (mergeError) {\n        console.error(\"[Merge Selected] Merge failed:\", mergeError);\n        \n        // Update the video history entry with failure\n        await storage.updateVideoHistoryFields(mergeHistoryEntry.id, {\n          status: 'failed',\n        });\n\n        throw mergeError;\n      }\n    } catch (error) {\n      console.error(\"Error in /api/merge-selected-videos:\", error);\n      res.status(500).json({ \n        error: \"Failed to merge selected videos\",\n        message: error instanceof Error ? error.message : \"Unknown error\"\n      });\n    }\n  });\n\n  // Retry a failed merge operation\n  app.post(\"/api/retry-merge/:id\", requireAuth, async (req, res) => {\n    try {\n      const videoId = req.params.id;\n      const userId = req.session.userId!;\n\n      console.log(`[Retry Merge] Starting retry for merge video ${videoId} by user ${userId}`);\n\n      // Get the video history entry\n      const userVideos = await storage.getUserVideoHistory(userId);\n      const mergeVideo = userVideos.find(v => v.id === videoId);\n\n      if (!mergeVideo) {\n        return res.status(404).json({ \n          error: \"Video not found\",\n          message: \"Merge video not found or does not belong to you\"\n        });\n      }\n\n      // Parse metadata to get original video IDs\n      if (!mergeVideo.metadata) {\n        return res.status(400).json({ \n          error: \"Invalid merge video\",\n          message: \"This video does not have merge metadata\"\n        });\n      }\n\n      const metadata = JSON.parse(mergeVideo.metadata);\n      const videoIds = metadata.mergedVideoIds as string[];\n\n      if (!videoIds || !Array.isArray(videoIds) || videoIds.length < 2) {\n        return res.status(400).json({ \n          error: \"Invalid metadata\",\n          message: \"Merge metadata is invalid or missing video IDs\"\n        });\n      }\n\n      console.log(`[Retry Merge] Retrying merge of ${videoIds.length} videos`);\n\n      // Verify all videos still exist and are completed\n      const videoUrls: string[] = [];\n      for (const id of videoIds) {\n        const video = userVideos.find(v => v.id === id);\n        \n        if (!video || video.status !== 'completed' || !video.videoUrl) {\n          return res.status(400).json({ \n            error: \"Invalid source videos\",\n            message: `One or more source videos are no longer available or completed`\n          });\n        }\n\n        // Verify URL is from trusted sources (Cloudinary or Google Cloud Storage)\n        const isCloudinary = video.videoUrl.startsWith('https://res.cloudinary.com/');\n        const isGoogleStorage = video.videoUrl.startsWith('https://storage.googleapis.com/');\n        if (!isCloudinary && !isGoogleStorage) {\n          return res.status(400).json({ \n            error: \"Invalid video URL\",\n            message: `Video ${id} has an invalid URL`\n          });\n        }\n\n        // If video is from Google Cloud Storage, migrate it to Cloudinary first\n        let finalVideoUrl = video.videoUrl;\n        if (isGoogleStorage) {\n          console.log(`[Retry Merge] Migrating video ${id} from Google Cloud Storage to Cloudinary...`);\n          try {\n            const { uploadVideoToCloudinary } = await import('./cloudinary');\n            const cloudinaryUrl = await uploadVideoToCloudinary(video.videoUrl);\n            \n            // Update video history with new Cloudinary URL\n            await storage.updateVideoHistoryFields(id, {\n              videoUrl: cloudinaryUrl,\n            });\n            \n            finalVideoUrl = cloudinaryUrl;\n            console.log(`[Retry Merge] Migration successful for video ${id}`);\n          } catch (uploadError) {\n            console.error(`[Retry Merge] Failed to migrate video ${id}:`, uploadError);\n            throw new Error(`Failed to migrate video to Cloudinary: ${uploadError instanceof Error ? uploadError.message : 'Unknown error'}`);\n          }\n        }\n\n        videoUrls.push(finalVideoUrl);\n      }\n\n      // Update status to pending\n      await storage.updateVideoHistoryFields(videoId, {\n        status: 'pending',\n        videoUrl: null,\n      });\n\n      // Send immediate response\n      res.json({ \n        success: true,\n        message: \"Merge retry started\",\n        videoId: videoId\n      });\n\n      // Perform merge in background\n      (async () => {\n        try {\n          const { mergeVideosWithFFmpeg } = await import('./videoMergerFFmpeg');\n          const mergedVideoUrl = await mergeVideosWithFFmpeg(videoUrls);\n          \n          console.log(`[Retry Merge] Retry successful for video ${videoId}`);\n          \n          await storage.updateVideoHistoryFields(videoId, {\n            status: 'completed',\n            videoUrl: mergedVideoUrl,\n          });\n        } catch (mergeError) {\n          console.error(`[Retry Merge] Retry failed for video ${videoId}:`, mergeError);\n          \n          await storage.updateVideoHistoryFields(videoId, {\n            status: 'failed',\n          });\n        }\n      })();\n\n    } catch (error) {\n      console.error(\"Error in /api/retry-merge:\", error);\n      res.status(500).json({ \n        error: \"Failed to retry merge\",\n        message: error instanceof Error ? error.message : \"Unknown error\"\n      });\n    }\n  });\n\n  // Merge videos with FFmpeg and store temporarily (24 hours)\n  app.post(\"/api/merge-videos-temporary\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.session.userId!;\n      const { videoIds, expiryHours = 24 } = req.body;\n\n      if (!Array.isArray(videoIds) || videoIds.length < 2) {\n        return res.status(400).json({ \n          error: \"Invalid input\",\n          message: \"Please provide at least 2 video IDs to merge\"\n        });\n      }\n\n      if (videoIds.length > 19) {\n        return res.status(400).json({ \n          error: \"Too many videos\",\n          message: \"Cannot merge more than 19 videos at once\"\n        });\n      }\n\n      console.log(`[Merge Temporary] Starting temporary merge of ${videoIds.length} videos for user ${userId}`);\n\n      // Get all user videos\n      const userVideos = await storage.getUserVideoHistory(userId);\n\n      // Verify all videos exist and are completed\n      const videoUrls: string[] = [];\n      for (const id of videoIds) {\n        const video = userVideos.find(v => v.id === id);\n        \n        if (!video || video.status !== 'completed' || !video.videoUrl) {\n          return res.status(400).json({ \n            error: \"Invalid video selection\",\n            message: `Video ${id} is not available or not completed`\n          });\n        }\n\n        // Verify URL is from trusted sources (Cloudinary or Google Cloud Storage)\n        const isCloudinary = video.videoUrl.startsWith('https://res.cloudinary.com/');\n        const isGoogleStorage = video.videoUrl.startsWith('https://storage.googleapis.com/');\n        if (!isCloudinary && !isGoogleStorage) {\n          return res.status(400).json({ \n            error: \"Invalid video URL\",\n            message: `Video ${id} has an invalid URL`\n          });\n        }\n\n        // If video is from Google Cloud Storage, migrate it to Cloudinary first\n        let finalVideoUrl = video.videoUrl;\n        if (isGoogleStorage) {\n          console.log(`[Merge Temporary] Migrating video ${id} from Google Cloud Storage to Cloudinary...`);\n          try {\n            const { uploadVideoToCloudinary } = await import('./cloudinary');\n            const cloudinaryUrl = await uploadVideoToCloudinary(video.videoUrl);\n            \n            // Update video history with new Cloudinary URL\n            await storage.updateVideoHistoryFields(id, {\n              videoUrl: cloudinaryUrl,\n            });\n            \n            finalVideoUrl = cloudinaryUrl;\n            console.log(`[Merge Temporary] Migration successful for video ${id}`);\n          } catch (uploadError) {\n            console.error(`[Merge Temporary] Failed to migrate video ${id}:`, uploadError);\n            throw new Error(`Failed to migrate video to Cloudinary: ${uploadError instanceof Error ? uploadError.message : 'Unknown error'}`);\n          }\n        }\n\n        videoUrls.push(finalVideoUrl);\n      }\n\n      console.log(`[Merge Temporary] All videos verified and migrated to Cloudinary, starting FFmpeg merge`);\n\n      // Merge videos using FFmpeg with temporary storage\n      const { mergeVideosWithFFmpegTemporary } = await import('./videoMergerFFmpeg');\n      const { videoPath, expiresAt } = await mergeVideosWithFFmpegTemporary(videoUrls, expiryHours);\n\n      console.log(`[Merge Temporary] Merge complete!`);\n      console.log(`[Merge Temporary] Video path: ${videoPath}`);\n      console.log(`[Merge Temporary] Expires at: ${expiresAt}`);\n\n      res.json({ \n        success: true,\n        videoPath,\n        expiresAt,\n        previewUrl: videoPath,\n        message: `Video will be available for ${expiryHours} hours`\n      });\n\n    } catch (error) {\n      console.error(\"Error in /api/merge-videos-temporary:\", error);\n      res.status(500).json({ \n        error: \"Failed to merge videos temporarily\",\n        message: error instanceof Error ? error.message : \"Unknown error\"\n      });\n    }\n  });\n\n  // Get temporary video expiry information\n  app.get(\"/api/temp-video-info\", requireAuth, async (req, res) => {\n    try {\n      const { videoPath } = req.query;\n\n      if (!videoPath || typeof videoPath !== 'string') {\n        return res.status(400).json({ \n          error: \"Invalid input\",\n          message: \"videoPath is required\"\n        });\n      }\n\n      const { ObjectStorageService } = await import('./objectStorage');\n      const objectStorageService = new ObjectStorageService();\n      \n      const info = await objectStorageService.getVideoExpiryInfo(videoPath);\n\n      res.json({ \n        success: true,\n        ...info\n      });\n\n    } catch (error) {\n      console.error(\"Error in /api/temp-video-info:\", error);\n      res.status(500).json({ \n        error: \"Failed to get video info\",\n        message: error instanceof Error ? error.message : \"Unknown error\"\n      });\n    }\n  });\n\n  // Cleanup expired temporary videos (admin only)\n  app.post(\"/api/cleanup-expired-videos\", requireAdmin, async (req, res) => {\n    try {\n      console.log(`[Cleanup] Starting cleanup of expired videos`);\n\n      const { ObjectStorageService } = await import('./objectStorage');\n      const objectStorageService = new ObjectStorageService();\n      \n      const deletedCount = await objectStorageService.cleanupExpiredVideos();\n\n      console.log(`[Cleanup] Cleanup complete, deleted ${deletedCount} videos`);\n\n      res.json({ \n        success: true,\n        deletedCount,\n        message: `Deleted ${deletedCount} expired videos`\n      });\n\n    } catch (error) {\n      console.error(\"Error in /api/cleanup-expired-videos:\", error);\n      res.status(500).json({ \n        error: \"Failed to cleanup expired videos\",\n        message: error instanceof Error ? error.message : \"Unknown error\"\n      });\n    }\n  });\n\n\n  // Project endpoints\n  app.get(\"/api/projects\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.session.userId;\n      if (!userId) {\n        return res.status(401).json({ error: \"Not authenticated\" });\n      }\n\n      const projects = await storage.getUserProjects(userId);\n      res.json({ projects });\n    } catch (error) {\n      console.error(\"Error fetching projects:\", error);\n      res.status(500).json({ \n        error: \"Failed to fetch projects\",\n        message: error instanceof Error ? error.message : \"Unknown error\"\n      });\n    }\n  });\n\n  app.get(\"/api/projects/:id\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.session.userId;\n      if (!userId) {\n        return res.status(401).json({ error: \"Not authenticated\" });\n      }\n\n      const { id } = req.params;\n      const project = await storage.getProject(id, userId);\n\n      if (!project) {\n        return res.status(404).json({ error: \"Project not found\" });\n      }\n\n      res.json({ project });\n    } catch (error) {\n      console.error(\"Error fetching project:\", error);\n      res.status(500).json({ \n        error: \"Failed to fetch project\",\n        message: error instanceof Error ? error.message : \"Unknown error\"\n      });\n    }\n  });\n\n  app.post(\"/api/projects\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.session.userId;\n      if (!userId) {\n        return res.status(401).json({ error: \"Not authenticated\" });\n      }\n\n      const schema = z.object({\n        title: z.string().min(1, \"Title is required\"),\n        script: z.string().min(50, \"Script must be at least 50 characters\"),\n        characters: z.string(), // JSON string\n        scenes: z.string(), // JSON string\n        mergedVideoUrl: z.string().optional(),\n      });\n\n      const validationResult = schema.safeParse(req.body);\n      \n      if (!validationResult.success) {\n        return res.status(400).json({ \n          error: \"Invalid input\", \n          details: validationResult.error.errors \n        });\n      }\n\n      const project = await storage.createProject({\n        userId,\n        ...validationResult.data\n      });\n\n      res.json({ project });\n    } catch (error) {\n      console.error(\"Error creating project:\", error);\n      res.status(500).json({ \n        error: \"Failed to create project\",\n        message: error instanceof Error ? error.message : \"Unknown error\"\n      });\n    }\n  });\n\n  app.patch(\"/api/projects/:id\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.session.userId;\n      if (!userId) {\n        return res.status(401).json({ error: \"Not authenticated\" });\n      }\n\n      const { id } = req.params;\n\n      const schema = z.object({\n        title: z.string().min(1).optional(),\n        mergedVideoUrl: z.string().optional(),\n        scenes: z.string().optional(),\n      });\n\n      const validationResult = schema.safeParse(req.body);\n      \n      if (!validationResult.success) {\n        return res.status(400).json({ \n          error: \"Invalid input\", \n          details: validationResult.error.errors \n        });\n      }\n\n      const updated = await storage.updateProject(id, userId, validationResult.data);\n\n      if (!updated) {\n        return res.status(404).json({ error: \"Project not found or access denied\" });\n      }\n\n      res.json({ project: updated });\n    } catch (error) {\n      console.error(\"Error updating project:\", error);\n      res.status(500).json({ \n        error: \"Failed to update project\",\n        message: error instanceof Error ? error.message : \"Unknown error\"\n      });\n    }\n  });\n\n  app.delete(\"/api/projects/:id\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.session.userId;\n      if (!userId) {\n        return res.status(401).json({ error: \"Not authenticated\" });\n      }\n\n      const { id } = req.params;\n      const deleted = await storage.deleteProject(id, userId);\n\n      if (!deleted) {\n        return res.status(404).json({ error: \"Project not found or access denied\" });\n      }\n\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting project:\", error);\n      res.status(500).json({ \n        error: \"Failed to delete project\",\n        message: error instanceof Error ? error.message : \"Unknown error\"\n      });\n    }\n  });\n\n  // Update scene videos for a project\n  app.patch(\"/api/projects/:id/scene-videos\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.session.userId;\n      if (!userId) {\n        return res.status(401).json({ error: \"Not authenticated\" });\n      }\n\n      const { id } = req.params;\n      const schema = z.object({\n        sceneVideos: z.array(z.object({\n          sceneNumber: z.number(),\n          videoUrl: z.string().optional(),\n          status: z.enum(['pending', 'completed', 'failed'])\n        }))\n      });\n\n      const validationResult = schema.safeParse(req.body);\n      if (!validationResult.success) {\n        return res.status(400).json({ \n          error: \"Invalid input\", \n          details: validationResult.error.errors \n        });\n      }\n\n      const { sceneVideos } = validationResult.data;\n      \n      const updated = await storage.updateProject(id, userId, {\n        sceneVideos: JSON.stringify(sceneVideos)\n      });\n\n      if (!updated) {\n        return res.status(404).json({ error: \"Project not found or access denied\" });\n      }\n\n      res.json({ success: true, project: updated });\n    } catch (error) {\n      console.error(\"Error updating scene videos:\", error);\n      res.status(500).json({ \n        error: \"Failed to update scene videos\",\n        message: error instanceof Error ? error.message : \"Unknown error\"\n      });\n    }\n  });\n\n  // Google Drive OAuth setup helpers (Admin only)\n  app.get(\"/api/google-drive/auth-url\", requireAdmin, async (req, res) => {\n    try {\n      const { generateAuthUrl } = await import('./googleDriveOAuth');\n      const authUrl = await generateAuthUrl();\n      res.json({ authUrl });\n    } catch (error) {\n      console.error(\"Error generating auth URL:\", error);\n      res.status(500).json({ \n        error: \"Failed to generate auth URL\",\n        message: error instanceof Error ? error.message : \"Unknown error\"\n      });\n    }\n  });\n\n  app.post(\"/api/google-drive/exchange-token\", requireAdmin, async (req, res) => {\n    try {\n      const { code } = req.body;\n      if (!code) {\n        return res.status(400).json({ error: \"Authorization code required\" });\n      }\n\n      const { exchangeCodeForToken } = await import('./googleDriveOAuth');\n      const refreshToken = await exchangeCodeForToken(code);\n      \n      res.json({ \n        refreshToken,\n        message: \"Add this token to your secrets as GOOGLE_DRIVE_REFRESH_TOKEN\"\n      });\n    } catch (error) {\n      console.error(\"Error exchanging token:\", error);\n      res.status(500).json({ \n        error: \"Failed to exchange token\",\n        message: error instanceof Error ? error.message : \"Unknown error\"\n      });\n    }\n  });\n\n  const httpServer = createServer(app);\n\n  return httpServer;\n}\n","size_bytes":78877},"client/src/components/ui/hover-card.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as HoverCardPrimitive from \"@radix-ui/react-hover-card\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst HoverCard = HoverCardPrimitive.Root\n\nconst HoverCardTrigger = HoverCardPrimitive.Trigger\n\nconst HoverCardContent = React.forwardRef<\n  React.ElementRef<typeof HoverCardPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <HoverCardPrimitive.Content\n    ref={ref}\n    align={align}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-hover-card-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nHoverCardContent.displayName = HoverCardPrimitive.Content.displayName\n\nexport { HoverCard, HoverCardTrigger, HoverCardContent }\n","size_bytes":1251},"client/src/components/ui/tabs.tsx":{"content":"import * as React from \"react\"\nimport * as TabsPrimitive from \"@radix-ui/react-tabs\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Tabs = TabsPrimitive.Root\n\nconst TabsList = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.List\n    ref={ref}\n    className={cn(\n      \"inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsList.displayName = TabsPrimitive.List.displayName\n\nconst TabsTrigger = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsTrigger.displayName = TabsPrimitive.Trigger.displayName\n\nconst TabsContent = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsContent.displayName = TabsPrimitive.Content.displayName\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent }\n","size_bytes":1883},"server/googleDriveOAuth.ts":{"content":"import { google } from 'googleapis';\nimport fs from 'fs';\n\ninterface GoogleDriveConfig {\n  clientId: string;\n  clientSecret: string;\n  refreshToken: string;\n}\n\nfunction getOAuth2Client(config: GoogleDriveConfig, redirectUri?: string) {\n  const oauth2Client = new google.auth.OAuth2(\n    config.clientId,\n    config.clientSecret,\n    redirectUri || 'http://localhost:8080'\n  );\n\n  oauth2Client.setCredentials({\n    refresh_token: config.refreshToken,\n  });\n\n  return oauth2Client;\n}\n\nexport async function uploadVideoToGoogleDriveOAuth(\n  filePath: string,\n  fileName: string\n): Promise<{ id: string; webViewLink: string; webContentLink: string }> {\n  try {\n    const clientId = process.env.GOOGLE_DRIVE_CLIENT_ID;\n    const clientSecret = process.env.GOOGLE_DRIVE_CLIENT_SECRET;\n    const refreshToken = process.env.GOOGLE_DRIVE_REFRESH_TOKEN;\n\n    if (!clientId || !clientSecret || !refreshToken) {\n      throw new Error(\n        'Missing Google Drive OAuth credentials. Please set GOOGLE_DRIVE_CLIENT_ID, GOOGLE_DRIVE_CLIENT_SECRET, and GOOGLE_DRIVE_REFRESH_TOKEN environment variables.'\n      );\n    }\n\n    const auth = getOAuth2Client({ clientId, clientSecret, refreshToken });\n    const drive = google.drive({ version: 'v3', auth });\n\n    console.log(`[Google Drive OAuth] Uploading file: ${fileName}`);\n\n    const fileMetadata = {\n      name: fileName,\n    };\n\n    const media = {\n      mimeType: 'video/mp4',\n      body: fs.createReadStream(filePath),\n    };\n\n    const response = await drive.files.create({\n      requestBody: fileMetadata,\n      media: media,\n      fields: 'id, webViewLink, webContentLink',\n    });\n\n    if (!response.data.id) {\n      throw new Error('Upload succeeded but no file ID returned');\n    }\n\n    console.log(`[Google Drive OAuth] File uploaded successfully. ID: ${response.data.id}`);\n\n    // Make the file publicly accessible\n    await drive.permissions.create({\n      fileId: response.data.id,\n      requestBody: {\n        role: 'reader',\n        type: 'anyone',\n      },\n    });\n\n    console.log(`[Google Drive OAuth] File permissions set to public`);\n\n    return {\n      id: response.data.id,\n      webViewLink: response.data.webViewLink || '',\n      webContentLink: response.data.webContentLink || '',\n    };\n  } catch (error) {\n    console.error('[Google Drive OAuth] Upload error:', error);\n    throw error;\n  }\n}\n\nexport function getDirectDownloadLinkOAuth(fileId: string): string {\n  // Use direct view link for HTML5 video players\n  // This works for public files and allows streaming playback\n  return `https://drive.google.com/uc?export=view&id=${fileId}`;\n}\n\nexport function getEmbedLink(fileId: string): string {\n  // For iframe embedding if needed\n  return `https://drive.google.com/file/d/${fileId}/preview`;\n}\n\nexport async function generateAuthUrl(): Promise<string> {\n  const clientId = process.env.GOOGLE_DRIVE_CLIENT_ID;\n  const clientSecret = process.env.GOOGLE_DRIVE_CLIENT_SECRET;\n\n  if (!clientId || !clientSecret) {\n    throw new Error('Missing GOOGLE_DRIVE_CLIENT_ID or GOOGLE_DRIVE_CLIENT_SECRET');\n  }\n\n  const oauth2Client = new google.auth.OAuth2(\n    clientId,\n    clientSecret,\n    'http://localhost:8080'\n  );\n\n  const authUrl = oauth2Client.generateAuthUrl({\n    access_type: 'offline',\n    scope: ['https://www.googleapis.com/auth/drive.file'],\n    prompt: 'consent',\n  });\n\n  return authUrl;\n}\n\nexport async function exchangeCodeForToken(code: string): Promise<string> {\n  const clientId = process.env.GOOGLE_DRIVE_CLIENT_ID;\n  const clientSecret = process.env.GOOGLE_DRIVE_CLIENT_SECRET;\n\n  if (!clientId || !clientSecret) {\n    throw new Error('Missing GOOGLE_DRIVE_CLIENT_ID or GOOGLE_DRIVE_CLIENT_SECRET');\n  }\n\n  const oauth2Client = new google.auth.OAuth2(\n    clientId,\n    clientSecret,\n    'http://localhost:8080'\n  );\n\n  const { tokens } = await oauth2Client.getToken(code);\n\n  if (!tokens.refresh_token) {\n    throw new Error('No refresh token received. Make sure to use prompt=consent in the auth URL.');\n  }\n\n  return tokens.refresh_token;\n}\n","size_bytes":4029},"client/src/main.tsx":{"content":"import { createRoot } from \"react-dom/client\";\nimport App from \"./App\";\nimport \"./index.css\";\n\ncreateRoot(document.getElementById(\"root\")!).render(<App />);\n","size_bytes":157},"client/src/App.tsx":{"content":"import { Switch, Route } from \"wouter\";\nimport { queryClient } from \"./lib/queryClient\";\nimport { QueryClientProvider } from \"@tanstack/react-query\";\nimport { Toaster } from \"@/components/ui/toaster\";\nimport { TooltipProvider } from \"@/components/ui/tooltip\";\nimport Home from \"@/pages/Home\";\nimport Login from \"@/pages/Login\";\nimport Admin from \"@/pages/Admin\";\nimport VeoGenerator from \"@/pages/VeoGenerator\";\nimport BulkGenerator from \"@/pages/BulkGenerator\";\nimport ScriptCreator from \"@/pages/ScriptCreator\";\nimport History from \"@/pages/History\";\nimport Projects from \"@/pages/Projects\";\nimport ProjectDetail from \"@/pages/ProjectDetail\";\nimport NotFound from \"@/pages/not-found\";\n\nfunction Router() {\n  return (\n    <Switch>\n      <Route path=\"/\" component={Home} />\n      <Route path=\"/login\" component={Login} />\n      <Route path=\"/admin\" component={Admin} />\n      <Route path=\"/veo-generator\" component={VeoGenerator} />\n      <Route path=\"/bulk-generator\" component={BulkGenerator} />\n      <Route path=\"/script-creator\" component={ScriptCreator} />\n      <Route path=\"/history\" component={History} />\n      <Route path=\"/projects\" component={Projects} />\n      <Route path=\"/projects/:id\" component={ProjectDetail} />\n      <Route component={NotFound} />\n    </Switch>\n  );\n}\n\nfunction App() {\n  return (\n    <QueryClientProvider client={queryClient}>\n      <TooltipProvider>\n        <Toaster />\n        <Router />\n      </TooltipProvider>\n    </QueryClientProvider>\n  );\n}\n\nexport default App;\n","size_bytes":1509},"client/src/components/ui/chart.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as RechartsPrimitive from \"recharts\"\n\nimport { cn } from \"@/lib/utils\"\n\n// Format: { THEME_NAME: CSS_SELECTOR }\nconst THEMES = { light: \"\", dark: \".dark\" } as const\n\nexport type ChartConfig = {\n  [k in string]: {\n    label?: React.ReactNode\n    icon?: React.ComponentType\n  } & (\n    | { color?: string; theme?: never }\n    | { color?: never; theme: Record<keyof typeof THEMES, string> }\n  )\n}\n\ntype ChartContextProps = {\n  config: ChartConfig\n}\n\nconst ChartContext = React.createContext<ChartContextProps | null>(null)\n\nfunction useChart() {\n  const context = React.useContext(ChartContext)\n\n  if (!context) {\n    throw new Error(\"useChart must be used within a <ChartContainer />\")\n  }\n\n  return context\n}\n\nconst ChartContainer = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    config: ChartConfig\n    children: React.ComponentProps<\n      typeof RechartsPrimitive.ResponsiveContainer\n    >[\"children\"]\n  }\n>(({ id, className, children, config, ...props }, ref) => {\n  const uniqueId = React.useId()\n  const chartId = `chart-${id || uniqueId.replace(/:/g, \"\")}`\n\n  return (\n    <ChartContext.Provider value={{ config }}>\n      <div\n        data-chart={chartId}\n        ref={ref}\n        className={cn(\n          \"flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none\",\n          className\n        )}\n        {...props}\n      >\n        <ChartStyle id={chartId} config={config} />\n        <RechartsPrimitive.ResponsiveContainer>\n          {children}\n        </RechartsPrimitive.ResponsiveContainer>\n      </div>\n    </ChartContext.Provider>\n  )\n})\nChartContainer.displayName = \"Chart\"\n\nconst ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {\n  const colorConfig = Object.entries(config).filter(\n    ([, config]) => config.theme || config.color\n  )\n\n  if (!colorConfig.length) {\n    return null\n  }\n\n  return (\n    <style\n      dangerouslySetInnerHTML={{\n        __html: Object.entries(THEMES)\n          .map(\n            ([theme, prefix]) => `\n${prefix} [data-chart=${id}] {\n${colorConfig\n  .map(([key, itemConfig]) => {\n    const color =\n      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||\n      itemConfig.color\n    return color ? `  --color-${key}: ${color};` : null\n  })\n  .join(\"\\n\")}\n}\n`\n          )\n          .join(\"\\n\"),\n      }}\n    />\n  )\n}\n\nconst ChartTooltip = RechartsPrimitive.Tooltip\n\nconst ChartTooltipContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &\n    React.ComponentProps<\"div\"> & {\n      hideLabel?: boolean\n      hideIndicator?: boolean\n      indicator?: \"line\" | \"dot\" | \"dashed\"\n      nameKey?: string\n      labelKey?: string\n    }\n>(\n  (\n    {\n      active,\n      payload,\n      className,\n      indicator = \"dot\",\n      hideLabel = false,\n      hideIndicator = false,\n      label,\n      labelFormatter,\n      labelClassName,\n      formatter,\n      color,\n      nameKey,\n      labelKey,\n    },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    const tooltipLabel = React.useMemo(() => {\n      if (hideLabel || !payload?.length) {\n        return null\n      }\n\n      const [item] = payload\n      const key = `${labelKey || item?.dataKey || item?.name || \"value\"}`\n      const itemConfig = getPayloadConfigFromPayload(config, item, key)\n      const value =\n        !labelKey && typeof label === \"string\"\n          ? config[label as keyof typeof config]?.label || label\n          : itemConfig?.label\n\n      if (labelFormatter) {\n        return (\n          <div className={cn(\"font-medium\", labelClassName)}>\n            {labelFormatter(value, payload)}\n          </div>\n        )\n      }\n\n      if (!value) {\n        return null\n      }\n\n      return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>\n    }, [\n      label,\n      labelFormatter,\n      payload,\n      hideLabel,\n      labelClassName,\n      config,\n      labelKey,\n    ])\n\n    if (!active || !payload?.length) {\n      return null\n    }\n\n    const nestLabel = payload.length === 1 && indicator !== \"dot\"\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl\",\n          className\n        )}\n      >\n        {!nestLabel ? tooltipLabel : null}\n        <div className=\"grid gap-1.5\">\n          {payload.map((item, index) => {\n            const key = `${nameKey || item.name || item.dataKey || \"value\"}`\n            const itemConfig = getPayloadConfigFromPayload(config, item, key)\n            const indicatorColor = color || item.payload.fill || item.color\n\n            return (\n              <div\n                key={item.dataKey}\n                className={cn(\n                  \"flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground\",\n                  indicator === \"dot\" && \"items-center\"\n                )}\n              >\n                {formatter && item?.value !== undefined && item.name ? (\n                  formatter(item.value, item.name, item, index, item.payload)\n                ) : (\n                  <>\n                    {itemConfig?.icon ? (\n                      <itemConfig.icon />\n                    ) : (\n                      !hideIndicator && (\n                        <div\n                          className={cn(\n                            \"shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]\",\n                            {\n                              \"h-2.5 w-2.5\": indicator === \"dot\",\n                              \"w-1\": indicator === \"line\",\n                              \"w-0 border-[1.5px] border-dashed bg-transparent\":\n                                indicator === \"dashed\",\n                              \"my-0.5\": nestLabel && indicator === \"dashed\",\n                            }\n                          )}\n                          style={\n                            {\n                              \"--color-bg\": indicatorColor,\n                              \"--color-border\": indicatorColor,\n                            } as React.CSSProperties\n                          }\n                        />\n                      )\n                    )}\n                    <div\n                      className={cn(\n                        \"flex flex-1 justify-between leading-none\",\n                        nestLabel ? \"items-end\" : \"items-center\"\n                      )}\n                    >\n                      <div className=\"grid gap-1.5\">\n                        {nestLabel ? tooltipLabel : null}\n                        <span className=\"text-muted-foreground\">\n                          {itemConfig?.label || item.name}\n                        </span>\n                      </div>\n                      {item.value && (\n                        <span className=\"font-mono font-medium tabular-nums text-foreground\">\n                          {item.value.toLocaleString()}\n                        </span>\n                      )}\n                    </div>\n                  </>\n                )}\n              </div>\n            )\n          })}\n        </div>\n      </div>\n    )\n  }\n)\nChartTooltipContent.displayName = \"ChartTooltip\"\n\nconst ChartLegend = RechartsPrimitive.Legend\n\nconst ChartLegendContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> &\n    Pick<RechartsPrimitive.LegendProps, \"payload\" | \"verticalAlign\"> & {\n      hideIcon?: boolean\n      nameKey?: string\n    }\n>(\n  (\n    { className, hideIcon = false, payload, verticalAlign = \"bottom\", nameKey },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    if (!payload?.length) {\n      return null\n    }\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"flex items-center justify-center gap-4\",\n          verticalAlign === \"top\" ? \"pb-3\" : \"pt-3\",\n          className\n        )}\n      >\n        {payload.map((item) => {\n          const key = `${nameKey || item.dataKey || \"value\"}`\n          const itemConfig = getPayloadConfigFromPayload(config, item, key)\n\n          return (\n            <div\n              key={item.value}\n              className={cn(\n                \"flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground\"\n              )}\n            >\n              {itemConfig?.icon && !hideIcon ? (\n                <itemConfig.icon />\n              ) : (\n                <div\n                  className=\"h-2 w-2 shrink-0 rounded-[2px]\"\n                  style={{\n                    backgroundColor: item.color,\n                  }}\n                />\n              )}\n              {itemConfig?.label}\n            </div>\n          )\n        })}\n      </div>\n    )\n  }\n)\nChartLegendContent.displayName = \"ChartLegend\"\n\n// Helper to extract item config from a payload.\nfunction getPayloadConfigFromPayload(\n  config: ChartConfig,\n  payload: unknown,\n  key: string\n) {\n  if (typeof payload !== \"object\" || payload === null) {\n    return undefined\n  }\n\n  const payloadPayload =\n    \"payload\" in payload &&\n    typeof payload.payload === \"object\" &&\n    payload.payload !== null\n      ? payload.payload\n      : undefined\n\n  let configLabelKey: string = key\n\n  if (\n    key in payload &&\n    typeof payload[key as keyof typeof payload] === \"string\"\n  ) {\n    configLabelKey = payload[key as keyof typeof payload] as string\n  } else if (\n    payloadPayload &&\n    key in payloadPayload &&\n    typeof payloadPayload[key as keyof typeof payloadPayload] === \"string\"\n  ) {\n    configLabelKey = payloadPayload[\n      key as keyof typeof payloadPayload\n    ] as string\n  }\n\n  return configLabelKey in config\n    ? config[configLabelKey]\n    : config[key as keyof typeof config]\n}\n\nexport {\n  ChartContainer,\n  ChartTooltip,\n  ChartTooltipContent,\n  ChartLegend,\n  ChartLegendContent,\n  ChartStyle,\n}\n","size_bytes":10481},"client/src/components/ui/slider.tsx":{"content":"import * as React from \"react\"\nimport * as SliderPrimitive from \"@radix-ui/react-slider\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Slider = React.forwardRef<\n  React.ElementRef<typeof SliderPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <SliderPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex w-full touch-none select-none items-center\",\n      className\n    )}\n    {...props}\n  >\n    <SliderPrimitive.Track className=\"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary\">\n      <SliderPrimitive.Range className=\"absolute h-full bg-primary\" />\n    </SliderPrimitive.Track>\n    <SliderPrimitive.Thumb className=\"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50\" />\n  </SliderPrimitive.Root>\n))\nSlider.displayName = SliderPrimitive.Root.displayName\n\nexport { Slider }\n","size_bytes":1077},"client/src/components/ui/input-otp.tsx":{"content":"import * as React from \"react\"\nimport { OTPInput, OTPInputContext } from \"input-otp\"\nimport { Dot } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst InputOTP = React.forwardRef<\n  React.ElementRef<typeof OTPInput>,\n  React.ComponentPropsWithoutRef<typeof OTPInput>\n>(({ className, containerClassName, ...props }, ref) => (\n  <OTPInput\n    ref={ref}\n    containerClassName={cn(\n      \"flex items-center gap-2 has-[:disabled]:opacity-50\",\n      containerClassName\n    )}\n    className={cn(\"disabled:cursor-not-allowed\", className)}\n    {...props}\n  />\n))\nInputOTP.displayName = \"InputOTP\"\n\nconst InputOTPGroup = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"flex items-center\", className)} {...props} />\n))\nInputOTPGroup.displayName = \"InputOTPGroup\"\n\nconst InputOTPSlot = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\"> & { index: number }\n>(({ index, className, ...props }, ref) => {\n  const inputOTPContext = React.useContext(OTPInputContext)\n  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]\n\n  return (\n    <div\n      ref={ref}\n      className={cn(\n        \"relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md\",\n        isActive && \"z-10 ring-2 ring-ring ring-offset-background\",\n        className\n      )}\n      {...props}\n    >\n      {char}\n      {hasFakeCaret && (\n        <div className=\"pointer-events-none absolute inset-0 flex items-center justify-center\">\n          <div className=\"h-4 w-px animate-caret-blink bg-foreground duration-1000\" />\n        </div>\n      )}\n    </div>\n  )\n})\nInputOTPSlot.displayName = \"InputOTPSlot\"\n\nconst InputOTPSeparator = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ ...props }, ref) => (\n  <div ref={ref} role=\"separator\" {...props}>\n    <Dot />\n  </div>\n))\nInputOTPSeparator.displayName = \"InputOTPSeparator\"\n\nexport { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }\n","size_bytes":2154},"server/vite.ts":{"content":"import express, { type Express } from \"express\";\nimport fs from \"fs\";\nimport path from \"path\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\nimport { type Server } from \"http\";\nimport viteConfig from \"../vite.config\";\nimport { nanoid } from \"nanoid\";\n\nconst viteLogger = createLogger();\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\nexport async function setupVite(app: Express, server: Server) {\n  const serverOptions = {\n    middlewareMode: true,\n    hmr: { server },\n    allowedHosts: true as const,\n  };\n\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        viteLogger.error(msg, options);\n        process.exit(1);\n      },\n    },\n    server: serverOptions,\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n  app.use(\"*\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientTemplate = path.resolve(\n        import.meta.dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      template = template.replace(\n        `src=\"/src/main.tsx\"`,\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\n      );\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n\nexport function serveStatic(app: Express) {\n  const distPath = path.resolve(import.meta.dirname, \"public\");\n\n  if (!fs.existsSync(distPath)) {\n    throw new Error(\n      `Could not find the build directory: ${distPath}, make sure to build the client first`,\n    );\n  }\n\n  app.use(express.static(distPath));\n\n  // fall through to index.html if the file doesn't exist\n  app.use(\"*\", (_req, res) => {\n    res.sendFile(path.resolve(distPath, \"index.html\"));\n  });\n}\n","size_bytes":2263},"client/src/components/ui/dropdown-menu.tsx":{"content":"import * as React from \"react\"\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto\" />\n  </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n      {...props}\n    />\n  )\n}\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\"\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n}\n","size_bytes":7609},"client/src/components/examples/ProcessingState.tsx":{"content":"import ProcessingState from \"../ProcessingState\";\n\nexport default function ProcessingStateExample() {\n  return (\n    <ProcessingState status=\"Generating amazing scenes for your story...\" />\n  );\n}\n","size_bytes":197},"client/src/components/ui/checkbox.tsx":{"content":"import * as React from \"react\"\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\"\nimport { Check } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Checkbox = React.forwardRef<\n  React.ElementRef<typeof CheckboxPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <CheckboxPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground\",\n      className\n    )}\n    {...props}\n  >\n    <CheckboxPrimitive.Indicator\n      className={cn(\"flex items-center justify-center text-current\")}\n    >\n      <Check className=\"h-4 w-4\" />\n    </CheckboxPrimitive.Indicator>\n  </CheckboxPrimitive.Root>\n))\nCheckbox.displayName = CheckboxPrimitive.Root.displayName\n\nexport { Checkbox }\n","size_bytes":1056},"shared/schema.ts":{"content":"import { sql } from \"drizzle-orm\";\nimport { pgTable, text, varchar, boolean } from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\nexport const users = pgTable(\"users\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  username: text(\"username\").notNull().unique(),\n  password: text(\"password\").notNull(),\n  isAdmin: boolean(\"is_admin\").notNull().default(false),\n  planType: text(\"plan_type\").notNull().default(\"free\"),\n  planStatus: text(\"plan_status\").notNull().default(\"active\"),\n  planExpiry: text(\"plan_expiry\").default(sql`null`),\n  apiToken: text(\"api_token\").default(sql`null`),\n});\n\nexport const insertUserSchema = createInsertSchema(users).pick({\n  username: true,\n  password: true,\n  isAdmin: true,\n});\n\nexport const updateUserPlanSchema = z.object({\n  planType: z.enum([\"free\", \"basic\", \"premium\"]),\n  planStatus: z.enum([\"active\", \"expired\", \"cancelled\"]),\n  planExpiry: z.string().optional(),\n});\n\nexport const updateUserApiTokenSchema = z.object({\n  apiToken: z.string(),\n});\n\nexport type InsertUser = z.infer<typeof insertUserSchema>;\nexport type User = typeof users.$inferSelect;\nexport type UpdateUserPlan = z.infer<typeof updateUserPlanSchema>;\nexport type UpdateUserApiToken = z.infer<typeof updateUserApiTokenSchema>;\n\nexport const loginSchema = z.object({\n  username: z.string().min(1, \"Username is required\"),\n  password: z.string().min(1, \"Password is required\"),\n});\n\nexport type LoginInput = z.infer<typeof loginSchema>;\n\n// API Token Pool for automatic rotation\nexport const apiTokens = pgTable(\"api_tokens\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  token: text(\"token\").notNull().unique(),\n  label: text(\"label\").notNull(),\n  isActive: boolean(\"is_active\").notNull().default(true),\n  lastUsedAt: text(\"last_used_at\"),\n  requestCount: text(\"request_count\").notNull().default(\"0\"),\n  createdAt: text(\"created_at\").notNull().default(sql`now()::text`),\n});\n\n// Token rotation settings\nexport const tokenSettings = pgTable(\"token_settings\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  rotationEnabled: boolean(\"rotation_enabled\").notNull().default(false),\n  rotationIntervalMinutes: text(\"rotation_interval_minutes\").notNull().default(\"60\"),\n  maxRequestsPerToken: text(\"max_requests_per_token\").notNull().default(\"1000\"),\n  videosPerBatch: text(\"videos_per_batch\").notNull().default(\"10\"),\n  batchDelaySeconds: text(\"batch_delay_seconds\").notNull().default(\"20\"),\n});\n\nexport const insertApiTokenSchema = createInsertSchema(apiTokens).pick({\n  token: true,\n  label: true,\n});\n\nexport const bulkReplaceTokensSchema = z.object({\n  tokens: z.string().min(1, \"Please enter at least one token\"),\n});\n\nexport const updateTokenSettingsSchema = z.object({\n  rotationEnabled: z.boolean(),\n  rotationIntervalMinutes: z.string(),\n  maxRequestsPerToken: z.string(),\n  videosPerBatch: z.string(),\n  batchDelaySeconds: z.string(),\n});\n\nexport type ApiToken = typeof apiTokens.$inferSelect;\nexport type InsertApiToken = z.infer<typeof insertApiTokenSchema>;\nexport type BulkReplaceTokens = z.infer<typeof bulkReplaceTokensSchema>;\nexport type TokenSettings = typeof tokenSettings.$inferSelect;\nexport type UpdateTokenSettings = z.infer<typeof updateTokenSettingsSchema>;\n\n// Character schema for the story\nexport const characterSchema = z.object({\n  id: z.string(),\n  name: z.string().min(1, \"Character name is required\"),\n  description: z.string().min(1, \"Character description is required\"),\n});\n\nexport type Character = z.infer<typeof characterSchema>;\n\n// Story input schema\nexport const storyInputSchema = z.object({\n  script: z.string().min(50, \"Script must be at least 50 characters\"),\n  characters: z.array(characterSchema).min(1, \"At least one character is required\"),\n  title: z.string().min(1, \"Project title is required\").optional(),\n});\n\nexport type StoryInput = z.infer<typeof storyInputSchema>;\n\n// Scene schema for generated output\nexport const sceneSchema = z.object({\n  scene: z.number(),\n  title: z.string(),\n  description: z.string(),\n});\n\nexport type Scene = z.infer<typeof sceneSchema>;\n\n// Projects schema for storing cartoon story generations\nexport const projects = pgTable(\"projects\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  title: text(\"title\").notNull(),\n  script: text(\"script\").notNull(),\n  characters: text(\"characters\").notNull(), // JSON string of Character[]\n  scenes: text(\"scenes\").notNull(), // JSON string of Scene[]\n  sceneVideos: text(\"scene_videos\"), // JSON string of { sceneNumber: number, videoUrl: string, status: 'pending' | 'completed' | 'failed' }[]\n  mergedVideoUrl: text(\"merged_video_url\"),\n  createdAt: text(\"created_at\").notNull().default(sql`now()::text`),\n  updatedAt: text(\"updated_at\").notNull().default(sql`now()::text`),\n});\n\nexport const insertProjectSchema = createInsertSchema(projects).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type Project = typeof projects.$inferSelect;\nexport type InsertProject = z.infer<typeof insertProjectSchema>;\n\n// Video history schema for storing generated videos\nexport const videoHistory = pgTable(\"video_history\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  projectId: varchar(\"project_id\").references(() => projects.id),\n  prompt: text(\"prompt\").notNull(),\n  aspectRatio: text(\"aspect_ratio\").notNull(),\n  videoUrl: text(\"video_url\"),\n  status: text(\"status\").notNull().default(\"pending\"),\n  createdAt: text(\"created_at\").notNull().default(sql`now()::text`),\n  title: text(\"title\"),\n  tokenUsed: varchar(\"token_used\").references(() => apiTokens.id),\n  metadata: text(\"metadata\"), // JSON string for merge info: { mergedVideoIds: string[] }\n  errorMessage: text(\"error_message\"), // Store error details for failed videos\n});\n\nexport const insertVideoHistorySchema = createInsertSchema(videoHistory).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type VideoHistory = typeof videoHistory.$inferSelect;\nexport type InsertVideoHistory = z.infer<typeof insertVideoHistorySchema>;\n","size_bytes":6224},"client/src/components/ui/avatar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Avatar = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Root\n    ref={ref}\n    className={cn(`\n      after:content-[''] after:block after:absolute after:inset-0 after:rounded-full after:pointer-events-none after:border after:border-black/10 dark:after:border-white/10\n      relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full`,\n      className\n    )}\n    {...props}\n  />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Image>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Image\n    ref={ref}\n    className={cn(\"aspect-square h-full w-full\", className)}\n    {...props}\n  />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Fallback>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Fallback\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full items-center justify-center rounded-full bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","size_bytes":1592},"client/src/components/ScriptForm.tsx":{"content":"import { useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Plus, FileText } from \"lucide-react\";\nimport CharacterInput from \"./CharacterInput\";\nimport type { Character, StoryInput } from \"@shared/schema\";\n\ninterface ScriptFormProps {\n  onSubmit: (data: StoryInput) => void;\n}\n\nexport default function ScriptForm({ onSubmit }: ScriptFormProps) {\n  const [title, setTitle] = useState(\"\");\n  const [script, setScript] = useState(\"\");\n  const [characters, setCharacters] = useState<Character[]>([\n    { id: \"1\", name: \"\", description: \"\" }\n  ]);\n\n  const handleAddCharacter = () => {\n    setCharacters([\n      ...characters,\n      { id: Date.now().toString(), name: \"\", description: \"\" }\n    ]);\n  };\n\n  const handleRemoveCharacter = (id: string) => {\n    setCharacters(characters.filter(c => c.id !== id));\n  };\n\n  const handleUpdateCharacter = (updated: Character) => {\n    setCharacters(characters.map(c => c.id === updated.id ? updated : c));\n  };\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    onSubmit({ script, characters, title: title || undefined });\n  };\n\n  const isValid = script.length >= 50 && characters.every(c => c.name && c.description);\n\n  return (\n    <form onSubmit={handleSubmit} className=\"max-w-3xl mx-auto px-3 sm:px-4 py-4 sm:py-8\">\n      <div className=\"space-y-6 sm:space-y-8\">\n        <div>\n          <div className=\"flex items-center gap-2 mb-3 sm:mb-4\">\n            <FileText className=\"w-5 h-5 sm:w-6 sm:h-6 text-primary\" />\n            <h2 className=\"text-2xl sm:text-3xl font-bold text-white\">Project Details</h2>\n          </div>\n          \n          <div className=\"mb-6\">\n            <Label htmlFor=\"title\" className=\"text-sm sm:text-base text-gray-200\">\n              Project Title <span className=\"text-gray-400 text-xs\">(Optional)</span>\n            </Label>\n            <Input\n              id=\"title\"\n              placeholder=\"e.g., The Iron Den Adventure\"\n              value={title}\n              onChange={(e) => setTitle(e.target.value)}\n              className=\"mt-2 text-sm sm:text-base\"\n              data-testid=\"input-title\"\n            />\n            <p className=\"text-xs sm:text-sm text-gray-400 mt-2\">\n              If left empty, a default title will be generated\n            </p>\n          </div>\n\n          <div className=\"mb-3 sm:mb-4\">\n            <h3 className=\"text-xl sm:text-2xl font-semibold text-white\">Story Script</h3>\n          </div>\n          <p className=\"text-sm sm:text-base text-gray-300 mb-4\">\n            Enter your complete story script. The AI will break it down into detailed scenes.\n          </p>\n          \n          <div>\n            <Label htmlFor=\"script\" className=\"text-sm sm:text-base text-gray-200\">\n              Script <span className=\"text-destructive\">*</span>\n            </Label>\n            <Textarea\n              id=\"script\"\n              placeholder=\"Once upon a time in the vibrant city of Fitropolis, there was a legendary gym called 'The Iron Den'...\"\n              value={script}\n              onChange={(e) => setScript(e.target.value)}\n              className=\"min-h-[250px] sm:min-h-[300px] mt-2 text-sm sm:text-base\"\n              data-testid=\"input-script\"\n            />\n            <p className=\"text-xs sm:text-sm text-gray-400 mt-2\">\n              {script.length} characters (minimum 50 required)\n            </p>\n          </div>\n        </div>\n\n        <div>\n          <div className=\"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 sm:gap-0 mb-4\">\n            <h2 className=\"text-xl sm:text-2xl font-bold text-white\">Characters</h2>\n            <Button\n              type=\"button\"\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={handleAddCharacter}\n              data-testid=\"button-add-character\"\n              className=\"w-full sm:w-auto\"\n            >\n              <Plus className=\"w-4 h-4 mr-2\" />\n              Add Character\n            </Button>\n          </div>\n          \n          <div className=\"space-y-3 sm:space-y-4\">\n            {characters.map((character) => (\n              <CharacterInput\n                key={character.id}\n                character={character}\n                onUpdate={handleUpdateCharacter}\n                onRemove={() => handleRemoveCharacter(character.id)}\n                canRemove={characters.length > 1}\n              />\n            ))}\n          </div>\n        </div>\n\n        <div className=\"flex justify-center sm:justify-end pt-4\">\n          <Button\n            type=\"submit\"\n            size=\"lg\"\n            disabled={!isValid}\n            className=\"h-12 sm:h-14 px-8 sm:px-12 rounded-full w-full sm:w-auto text-sm sm:text-base\"\n            data-testid=\"button-generate-scenes\"\n          >\n            Generate Scenes\n          </Button>\n        </div>\n      </div>\n    </form>\n  );\n}\n","size_bytes":5018},"client/src/components/examples/ScenesDisplay.tsx":{"content":"import ScenesDisplay from \"../ScenesDisplay\";\n\nexport default function ScenesDisplayExample() {\n  //todo: remove mock functionality\n  const mockScenes = [\n    {\n      scene: 1,\n      title: \"Fitropolis Cityscape\",\n      description: `visuals: A wide, vibrant shot of Fitropolis city, filled with towering, colorful buildings and flying vehicles.\ndialogue_action: N/A (establishing shot)\nmusic: Upbeat, optimistic orchestral music with a driving rhythm.\nsound_effects: Distant city hum, occasional whoosh of flying vehicles.\ntransition: Fade in from black.`\n    },\n    {\n      scene: 2,\n      title: \"The Iron Den Exterior\",\n      description: `visuals: Camera smoothly zooms in from the cityscape to focus on \"The Iron Den,\" a large, modern gym building.\ndialogue_action: N/A (establishing shot)\nmusic: Music softens slightly, becoming more warm and inviting.\nsound_effects: Muffled gym sounds from within.\ntransition: Zoom to focal point.`\n    }\n  ];\n\n  return (\n    <ScenesDisplay \n      scenes={mockScenes}\n      onStartNew={() => console.log(\"Start new project\")}\n    />\n  );\n}\n","size_bytes":1082},"server/falai.ts":{"content":"// fal.ai FFmpeg API integration for video merging\n// Uses fal-ai/ffmpeg-api/merge-videos model\n\ninterface FalMergeRequest {\n  video_urls: string[];\n}\n\ninterface FalMergeResponse {\n  video: {\n    url: string;\n    content_type: string;\n    file_name: string;\n    file_size: number;\n  };\n  timings?: any;\n}\n\nexport async function mergeVideosWithFalAI(videoUrls: string[]): Promise<string> {\n  const apiKey = process.env.FAL_API_KEY;\n  \n  if (!apiKey) {\n    throw new Error('FAL_API_KEY environment variable is not set');\n  }\n\n  if (videoUrls.length === 0) {\n    throw new Error('No video URLs provided for merging');\n  }\n\n  console.log(`[fal.ai] Starting merge of ${videoUrls.length} videos`);\n  console.log(`[fal.ai] Video URLs:`, videoUrls);\n\n  const requestBody: FalMergeRequest = {\n    video_urls: videoUrls\n  };\n\n  try {\n    // Call fal.ai merge-videos API\n    const response = await fetch('https://fal.run/fal-ai/ffmpeg-api/merge-videos', {\n      method: 'POST',\n      headers: {\n        'Authorization': `Key ${apiKey}`,\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify(requestBody),\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      console.error(`[fal.ai] Error response:`, errorText);\n      throw new Error(`fal.ai API error: ${response.status} - ${errorText}`);\n    }\n\n    const data: FalMergeResponse = await response.json();\n    console.log(`[fal.ai] Merge response:`, JSON.stringify(data, null, 2));\n\n    if (!data.video || !data.video.url) {\n      throw new Error('No video URL in fal.ai response');\n    }\n\n    const mergedVideoUrl = data.video.url;\n    console.log(`[fal.ai] Video merged successfully!`);\n    console.log(`[fal.ai] Merged video URL: ${mergedVideoUrl}`);\n    console.log(`[fal.ai] File size: ${data.video.file_size} bytes`);\n\n    return mergedVideoUrl;\n  } catch (error) {\n    console.error(`[fal.ai] Error merging videos:`, error);\n    throw new Error(`Failed to merge videos with fal.ai: ${error instanceof Error ? error.message : 'Unknown error'}`);\n  }\n}\n","size_bytes":2055},"client/src/components/ui/pagination.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { ButtonProps, buttonVariants } from \"@/components/ui/button\"\n\nconst Pagination = ({ className, ...props }: React.ComponentProps<\"nav\">) => (\n  <nav\n    role=\"navigation\"\n    aria-label=\"pagination\"\n    className={cn(\"mx-auto flex w-full justify-center\", className)}\n    {...props}\n  />\n)\nPagination.displayName = \"Pagination\"\n\nconst PaginationContent = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    className={cn(\"flex flex-row items-center gap-1\", className)}\n    {...props}\n  />\n))\nPaginationContent.displayName = \"PaginationContent\"\n\nconst PaginationItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li ref={ref} className={cn(\"\", className)} {...props} />\n))\nPaginationItem.displayName = \"PaginationItem\"\n\ntype PaginationLinkProps = {\n  isActive?: boolean\n} & Pick<ButtonProps, \"size\"> &\n  React.ComponentProps<\"a\">\n\nconst PaginationLink = ({\n  className,\n  isActive,\n  size = \"icon\",\n  ...props\n}: PaginationLinkProps) => (\n  <a\n    aria-current={isActive ? \"page\" : undefined}\n    className={cn(\n      buttonVariants({\n        variant: isActive ? \"outline\" : \"ghost\",\n        size,\n      }),\n      className\n    )}\n    {...props}\n  />\n)\nPaginationLink.displayName = \"PaginationLink\"\n\nconst PaginationPrevious = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to previous page\"\n    size=\"default\"\n    className={cn(\"gap-1 pl-2.5\", className)}\n    {...props}\n  >\n    <ChevronLeft className=\"h-4 w-4\" />\n    <span>Previous</span>\n  </PaginationLink>\n)\nPaginationPrevious.displayName = \"PaginationPrevious\"\n\nconst PaginationNext = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to next page\"\n    size=\"default\"\n    className={cn(\"gap-1 pr-2.5\", className)}\n    {...props}\n  >\n    <span>Next</span>\n    <ChevronRight className=\"h-4 w-4\" />\n  </PaginationLink>\n)\nPaginationNext.displayName = \"PaginationNext\"\n\nconst PaginationEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    aria-hidden\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More pages</span>\n  </span>\n)\nPaginationEllipsis.displayName = \"PaginationEllipsis\"\n\nexport {\n  Pagination,\n  PaginationContent,\n  PaginationEllipsis,\n  PaginationItem,\n  PaginationLink,\n  PaginationNext,\n  PaginationPrevious,\n}\n","size_bytes":2751},"client/src/components/examples/Hero.tsx":{"content":"import Hero from \"../Hero\";\n\nexport default function HeroExample() {\n  return (\n    <Hero onGetStarted={() => console.log(\"Get started clicked\")} />\n  );\n}\n","size_bytes":156},"server/objectStorage.ts":{"content":"// Replit Object Storage integration for video hosting\nimport { Storage, File } from \"@google-cloud/storage\";\nimport { Response } from \"express\";\nimport { randomUUID } from \"crypto\";\nimport { createReadStream } from \"fs\";\n\nconst REPLIT_SIDECAR_ENDPOINT = \"http://127.0.0.1:1106\";\n\nexport const objectStorageClient = new Storage({\n  credentials: {\n    audience: \"replit\",\n    subject_token_type: \"access_token\",\n    token_url: `${REPLIT_SIDECAR_ENDPOINT}/token`,\n    type: \"external_account\",\n    credential_source: {\n      url: `${REPLIT_SIDECAR_ENDPOINT}/credential`,\n      format: {\n        type: \"json\",\n        subject_token_field_name: \"access_token\",\n      },\n    },\n    universe_domain: \"googleapis.com\",\n  },\n  projectId: \"\",\n});\n\nexport class ObjectNotFoundError extends Error {\n  constructor() {\n    super(\"Object not found\");\n    this.name = \"ObjectNotFoundError\";\n    Object.setPrototypeOf(this, ObjectNotFoundError.prototype);\n  }\n}\n\nexport class ObjectStorageService {\n  getPrivateObjectDir(): string {\n    const dir = process.env.PRIVATE_OBJECT_DIR || \"\";\n    if (!dir) {\n      throw new Error(\n        \"PRIVATE_OBJECT_DIR not set. Create a bucket in 'Object Storage' \" +\n          \"pane and set PRIVATE_OBJECT_DIR env var.\"\n      );\n    }\n    return dir;\n  }\n\n  async downloadObject(file: File, res: Response, cacheTtlSec: number = 3600) {\n    try {\n      const [metadata] = await file.getMetadata();\n      res.set({\n        \"Content-Type\": metadata.contentType || \"application/octet-stream\",\n        \"Content-Length\": metadata.size,\n        \"Cache-Control\": `public, max-age=${cacheTtlSec}`,\n        \"Accept-Ranges\": \"bytes\",\n      });\n\n      const stream = file.createReadStream();\n      stream.on(\"error\", (err) => {\n        console.error(\"Stream error:\", err);\n        if (!res.headersSent) {\n          res.status(500).json({ error: \"Error streaming file\" });\n        }\n      });\n\n      stream.pipe(res);\n    } catch (error) {\n      console.error(\"Error downloading file:\", error);\n      if (!res.headersSent) {\n        res.status(500).json({ error: \"Error downloading file\" });\n      }\n    }\n  }\n\n  async getObjectEntityFile(objectPath: string): Promise<File> {\n    if (!objectPath.startsWith(\"/videos/\")) {\n      throw new ObjectNotFoundError();\n    }\n\n    const parts = objectPath.slice(1).split(\"/\");\n    if (parts.length < 2) {\n      throw new ObjectNotFoundError();\n    }\n\n    const entityId = parts.slice(1).join(\"/\");\n    let entityDir = this.getPrivateObjectDir();\n    if (!entityDir.endsWith(\"/\")) {\n      entityDir = `${entityDir}/`;\n    }\n    const objectEntityPath = `${entityDir}${entityId}`;\n    const { bucketName, objectName } = parseObjectPath(objectEntityPath);\n    const bucket = objectStorageClient.bucket(bucketName);\n    const objectFile = bucket.file(objectName);\n    const [exists] = await objectFile.exists();\n    if (!exists) {\n      throw new ObjectNotFoundError();\n    }\n    return objectFile;\n  }\n\n  async uploadMergedVideo(localFilePath: string): Promise<string> {\n    const privateObjectDir = this.getPrivateObjectDir();\n    const videoId = randomUUID();\n    const fullPath = `${privateObjectDir}/merged/${videoId}.mp4`;\n\n    console.log(`[Object Storage] Uploading to: ${fullPath}`);\n\n    const { bucketName, objectName } = parseObjectPath(fullPath);\n    const bucket = objectStorageClient.bucket(bucketName);\n    const file = bucket.file(objectName);\n\n    // Use pipeline to stream file to object storage\n    await new Promise<void>((resolve, reject) => {\n      const readStream = createReadStream(localFilePath);\n      const writeStream = file.createWriteStream({\n        metadata: {\n          contentType: \"video/mp4\",\n        },\n        public: true,\n      });\n\n      readStream\n        .pipe(writeStream)\n        .on('error', reject)\n        .on('finish', resolve);\n    });\n\n    console.log(`[Object Storage] Upload complete`);\n    return `/videos/merged/${videoId}.mp4`;\n  }\n\n  async uploadTemporaryVideo(localFilePath: string, expiryHours: number = 24): Promise<string> {\n    const privateObjectDir = this.getPrivateObjectDir();\n    const videoId = randomUUID();\n    const fullPath = `${privateObjectDir}/temp/${videoId}.mp4`;\n\n    const expiryDate = new Date();\n    expiryDate.setHours(expiryDate.getHours() + expiryHours);\n\n    console.log(`[Object Storage] Uploading temporary video to: ${fullPath}`);\n    console.log(`[Object Storage] Video will expire at: ${expiryDate.toISOString()}`);\n\n    const { bucketName, objectName } = parseObjectPath(fullPath);\n    const bucket = objectStorageClient.bucket(bucketName);\n    const file = bucket.file(objectName);\n\n    // Use pipeline to stream file to object storage\n    await new Promise<void>((resolve, reject) => {\n      const readStream = createReadStream(localFilePath);\n      const writeStream = file.createWriteStream({\n        metadata: {\n          contentType: \"video/mp4\",\n          metadata: {\n            expiresAt: expiryDate.toISOString(),\n            isTemporary: \"true\",\n          },\n        },\n        public: true,\n      });\n\n      readStream\n        .pipe(writeStream)\n        .on('error', reject)\n        .on('finish', resolve);\n    });\n\n    console.log(`[Object Storage] Temporary video upload complete`);\n    return `/videos/temp/${videoId}.mp4`;\n  }\n\n  async cleanupExpiredVideos(): Promise<number> {\n    const privateObjectDir = this.getPrivateObjectDir();\n    const tempPath = `${privateObjectDir}/temp/`;\n    \n    console.log(`[Object Storage] Starting cleanup of expired videos in: ${tempPath}`);\n\n    const { bucketName, objectName } = parseObjectPath(tempPath);\n    const bucket = objectStorageClient.bucket(bucketName);\n\n    try {\n      const [files] = await bucket.getFiles({ prefix: objectName });\n      let deletedCount = 0;\n      const now = new Date();\n\n      for (const file of files) {\n        try {\n          const [metadata] = await file.getMetadata();\n          const expiresAt = metadata.metadata?.expiresAt;\n\n          if (expiresAt && typeof expiresAt === 'string' && new Date(expiresAt) < now) {\n            await file.delete();\n            deletedCount++;\n            console.log(`[Object Storage] Deleted expired video: ${file.name}`);\n          }\n        } catch (error) {\n          console.error(`[Object Storage] Error processing file ${file.name}:`, error);\n        }\n      }\n\n      console.log(`[Object Storage] Cleanup complete. Deleted ${deletedCount} expired videos`);\n      return deletedCount;\n    } catch (error) {\n      console.error(`[Object Storage] Error during cleanup:`, error);\n      return 0;\n    }\n  }\n\n  async getVideoExpiryInfo(videoPath: string): Promise<{ expiresAt: string | null; isExpired: boolean }> {\n    try {\n      const file = await this.getObjectEntityFile(videoPath);\n      const [metadata] = await file.getMetadata();\n      const expiresAtRaw = metadata.metadata?.expiresAt;\n      const expiresAt = typeof expiresAtRaw === 'string' ? expiresAtRaw : null;\n      const isExpired = expiresAt ? new Date(expiresAt) < new Date() : false;\n\n      return { expiresAt, isExpired };\n    } catch (error) {\n      return { expiresAt: null, isExpired: false };\n    }\n  }\n}\n\nfunction parseObjectPath(path: string): {\n  bucketName: string;\n  objectName: string;\n} {\n  if (!path.startsWith(\"/\")) {\n    path = `/${path}`;\n  }\n  const pathParts = path.split(\"/\");\n  if (pathParts.length < 3) {\n    throw new Error(\"Invalid path: must contain at least a bucket name\");\n  }\n\n  const bucketName = pathParts[1];\n  const objectName = pathParts.slice(2).join(\"/\");\n\n  return {\n    bucketName,\n    objectName,\n  };\n}\n","size_bytes":7579},"client/src/pages/Login.tsx":{"content":"import { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { useLocation } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Film } from \"lucide-react\";\n\nconst loginSchema = z.object({\n  username: z.string().min(1, \"Username is required\"),\n  password: z.string().min(1, \"Password is required\"),\n});\n\ntype LoginFormData = z.infer<typeof loginSchema>;\n\nexport default function Login() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n\n  const form = useForm<LoginFormData>({\n    resolver: zodResolver(loginSchema),\n    defaultValues: {\n      username: \"\",\n      password: \"\",\n    },\n  });\n\n  const loginMutation = useMutation({\n    mutationFn: async (data: LoginFormData) => {\n      const response = await apiRequest(\"POST\", \"/api/login\", data);\n      const result = await response.json();\n      return result as { success: boolean; user: { id: string; username: string; isAdmin: boolean } };\n    },\n    onSuccess: async (data) => {\n      // Invalidate session cache to force refetch with new session data\n      await queryClient.invalidateQueries({ queryKey: [\"/api/session\"] });\n      \n      toast({\n        title: \"Login successful\",\n        description: `Welcome back, ${data.user.username}!`,\n      });\n      \n      // Small delay to allow session query to update\n      setTimeout(() => {\n        if (data.user.isAdmin) {\n          setLocation(\"/admin\");\n        } else {\n          setLocation(\"/\");\n        }\n      }, 100);\n    },\n    onError: (error: any) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Login failed\",\n        description: error.message || \"Invalid username or password\",\n      });\n    },\n  });\n\n  const onSubmit = (data: LoginFormData) => {\n    loginMutation.mutate(data);\n  };\n\n  return (\n    <div className=\"min-h-screen flex items-center justify-center bg-gradient-to-br from-[#1a2332] via-[#1e2838] to-[#242d3f] dark:from-[#141a25] dark:via-[#181e2a] dark:to-[#1c2230] p-4 md:p-8\">\n      <Card className=\"w-full max-w-md shadow-2xl bg-[#1e2838] dark:bg-[#181e2a] border border-white/10 animate-scale-in backdrop-blur-sm\">\n        <CardHeader className=\"space-y-3 text-center pb-6\">\n          <div className=\"flex justify-center mb-2\">\n            <div className=\"p-4 rounded-2xl bg-purple-600/30 border border-purple-500/50 shadow-lg transform transition-transform hover:scale-105 duration-300\">\n              <Film className=\"w-10 h-10 text-purple-400\" />\n            </div>\n          </div>\n          <CardTitle className=\"text-3xl md:text-4xl font-bold text-white\">Welcome Back</CardTitle>\n          <CardDescription className=\"text-base text-gray-300\">\n            Sign in to create amazing AI-powered videos\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <Form {...form}>\n            <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n              <FormField\n                control={form.control}\n                name=\"username\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"text-white\">Username</FormLabel>\n                    <FormControl>\n                      <Input\n                        {...field}\n                        placeholder=\"Enter your username\"\n                        data-testid=\"input-username\"\n                        className=\"bg-[#242d3f]/50 border-white/10 text-white placeholder:text-gray-400\"\n                        disabled={loginMutation.isPending}\n                      />\n                    </FormControl>\n                    <FormMessage className=\"text-red-300\" />\n                  </FormItem>\n                )}\n              />\n              \n              <FormField\n                control={form.control}\n                name=\"password\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"text-white\">Password</FormLabel>\n                    <FormControl>\n                      <Input\n                        {...field}\n                        type=\"password\"\n                        placeholder=\"Enter your password\"\n                        data-testid=\"input-password\"\n                        className=\"bg-[#242d3f]/50 border-white/10 text-white placeholder:text-gray-400\"\n                        disabled={loginMutation.isPending}\n                      />\n                    </FormControl>\n                    <FormMessage className=\"text-red-300\" />\n                  </FormItem>\n                )}\n              />\n\n              <Button\n                type=\"submit\"\n                className=\"w-full bg-purple-600 hover:bg-purple-700 text-white border-0\"\n                disabled={loginMutation.isPending}\n                data-testid=\"button-login\"\n              >\n                {loginMutation.isPending ? \"Signing in...\" : \"Sign In\"}\n              </Button>\n            </form>\n          </Form>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":5478},"client/src/components/ui/carousel.tsx":{"content":"import * as React from \"react\"\nimport useEmblaCarousel, {\n  type UseEmblaCarouselType,\n} from \"embla-carousel-react\"\nimport { ArrowLeft, ArrowRight } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\n\ntype CarouselApi = UseEmblaCarouselType[1]\ntype UseCarouselParameters = Parameters<typeof useEmblaCarousel>\ntype CarouselOptions = UseCarouselParameters[0]\ntype CarouselPlugin = UseCarouselParameters[1]\n\ntype CarouselProps = {\n  opts?: CarouselOptions\n  plugins?: CarouselPlugin\n  orientation?: \"horizontal\" | \"vertical\"\n  setApi?: (api: CarouselApi) => void\n}\n\ntype CarouselContextProps = {\n  carouselRef: ReturnType<typeof useEmblaCarousel>[0]\n  api: ReturnType<typeof useEmblaCarousel>[1]\n  scrollPrev: () => void\n  scrollNext: () => void\n  canScrollPrev: boolean\n  canScrollNext: boolean\n} & CarouselProps\n\nconst CarouselContext = React.createContext<CarouselContextProps | null>(null)\n\nfunction useCarousel() {\n  const context = React.useContext(CarouselContext)\n\n  if (!context) {\n    throw new Error(\"useCarousel must be used within a <Carousel />\")\n  }\n\n  return context\n}\n\nconst Carousel = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & CarouselProps\n>(\n  (\n    {\n      orientation = \"horizontal\",\n      opts,\n      setApi,\n      plugins,\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const [carouselRef, api] = useEmblaCarousel(\n      {\n        ...opts,\n        axis: orientation === \"horizontal\" ? \"x\" : \"y\",\n      },\n      plugins\n    )\n    const [canScrollPrev, setCanScrollPrev] = React.useState(false)\n    const [canScrollNext, setCanScrollNext] = React.useState(false)\n\n    const onSelect = React.useCallback((api: CarouselApi) => {\n      if (!api) {\n        return\n      }\n\n      setCanScrollPrev(api.canScrollPrev())\n      setCanScrollNext(api.canScrollNext())\n    }, [])\n\n    const scrollPrev = React.useCallback(() => {\n      api?.scrollPrev()\n    }, [api])\n\n    const scrollNext = React.useCallback(() => {\n      api?.scrollNext()\n    }, [api])\n\n    const handleKeyDown = React.useCallback(\n      (event: React.KeyboardEvent<HTMLDivElement>) => {\n        if (event.key === \"ArrowLeft\") {\n          event.preventDefault()\n          scrollPrev()\n        } else if (event.key === \"ArrowRight\") {\n          event.preventDefault()\n          scrollNext()\n        }\n      },\n      [scrollPrev, scrollNext]\n    )\n\n    React.useEffect(() => {\n      if (!api || !setApi) {\n        return\n      }\n\n      setApi(api)\n    }, [api, setApi])\n\n    React.useEffect(() => {\n      if (!api) {\n        return\n      }\n\n      onSelect(api)\n      api.on(\"reInit\", onSelect)\n      api.on(\"select\", onSelect)\n\n      return () => {\n        api?.off(\"select\", onSelect)\n      }\n    }, [api, onSelect])\n\n    return (\n      <CarouselContext.Provider\n        value={{\n          carouselRef,\n          api: api,\n          opts,\n          orientation:\n            orientation || (opts?.axis === \"y\" ? \"vertical\" : \"horizontal\"),\n          scrollPrev,\n          scrollNext,\n          canScrollPrev,\n          canScrollNext,\n        }}\n      >\n        <div\n          ref={ref}\n          onKeyDownCapture={handleKeyDown}\n          className={cn(\"relative\", className)}\n          role=\"region\"\n          aria-roledescription=\"carousel\"\n          {...props}\n        >\n          {children}\n        </div>\n      </CarouselContext.Provider>\n    )\n  }\n)\nCarousel.displayName = \"Carousel\"\n\nconst CarouselContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { carouselRef, orientation } = useCarousel()\n\n  return (\n    <div ref={carouselRef} className=\"overflow-hidden\">\n      <div\n        ref={ref}\n        className={cn(\n          \"flex\",\n          orientation === \"horizontal\" ? \"-ml-4\" : \"-mt-4 flex-col\",\n          className\n        )}\n        {...props}\n      />\n    </div>\n  )\n})\nCarouselContent.displayName = \"CarouselContent\"\n\nconst CarouselItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { orientation } = useCarousel()\n\n  return (\n    <div\n      ref={ref}\n      role=\"group\"\n      aria-roledescription=\"slide\"\n      className={cn(\n        \"min-w-0 shrink-0 grow-0 basis-full\",\n        orientation === \"horizontal\" ? \"pl-4\" : \"pt-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nCarouselItem.displayName = \"CarouselItem\"\n\nconst CarouselPrevious = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollPrev, canScrollPrev } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute  h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-left-12 top-1/2 -translate-y-1/2\"\n          : \"-top-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollPrev}\n      onClick={scrollPrev}\n      {...props}\n    >\n      <ArrowLeft className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Previous slide</span>\n    </Button>\n  )\n})\nCarouselPrevious.displayName = \"CarouselPrevious\"\n\nconst CarouselNext = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollNext, canScrollNext } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-right-12 top-1/2 -translate-y-1/2\"\n          : \"-bottom-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollNext}\n      onClick={scrollNext}\n      {...props}\n    >\n      <ArrowRight className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Next slide</span>\n    </Button>\n  )\n})\nCarouselNext.displayName = \"CarouselNext\"\n\nexport {\n  type CarouselApi,\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselPrevious,\n  CarouselNext,\n}\n","size_bytes":6210},"client/src/lib/utils.ts":{"content":"import { clsx, type ClassValue } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n","size_bytes":166},"client/src/components/ui/toggle.tsx":{"content":"import * as React from \"react\"\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst toggleVariants = cva(\n  \"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 gap-2\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline:\n          \"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground\",\n      },\n      size: {\n        default: \"h-10 px-3 min-w-10\",\n        sm: \"h-9 px-2.5 min-w-9\",\n        lg: \"h-11 px-5 min-w-11\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst Toggle = React.forwardRef<\n  React.ElementRef<typeof TogglePrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, ...props }, ref) => (\n  <TogglePrimitive.Root\n    ref={ref}\n    className={cn(toggleVariants({ variant, size, className }))}\n    {...props}\n  />\n))\n\nToggle.displayName = TogglePrimitive.Root.displayName\n\nexport { Toggle, toggleVariants }\n","size_bytes":1527},"client/src/hooks/use-mobile.tsx":{"content":"import * as React from \"react\"\n\nconst MOBILE_BREAKPOINT = 768\n\nexport function useIsMobile() {\n  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)\n    const onChange = () => {\n      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    }\n    mql.addEventListener(\"change\", onChange)\n    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    return () => mql.removeEventListener(\"change\", onChange)\n  }, [])\n\n  return !!isMobile\n}\n","size_bytes":565},"client/src/components/ui/separator.tsx":{"content":"import * as React from \"react\"\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Separator = React.forwardRef<\n  React.ElementRef<typeof SeparatorPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>\n>(\n  (\n    { className, orientation = \"horizontal\", decorative = true, ...props },\n    ref\n  ) => (\n    <SeparatorPrimitive.Root\n      ref={ref}\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"shrink-0 bg-border\",\n        orientation === \"horizontal\" ? \"h-[1px] w-full\" : \"h-full w-[1px]\",\n        className\n      )}\n      {...props}\n    />\n  )\n)\nSeparator.displayName = SeparatorPrimitive.Root.displayName\n\nexport { Separator }\n","size_bytes":756},"client/src/components/ui/aspect-ratio.tsx":{"content":"import * as AspectRatioPrimitive from \"@radix-ui/react-aspect-ratio\"\n\nconst AspectRatio = AspectRatioPrimitive.Root\n\nexport { AspectRatio }\n","size_bytes":140},"client/src/components/ProcessingState.tsx":{"content":"import { Loader2, Sparkles } from \"lucide-react\";\n\ninterface ProcessingStateProps {\n  status?: string;\n}\n\nexport default function ProcessingState({ status = \"Analyzing your script...\" }: ProcessingStateProps) {\n  return (\n    <div className=\"flex flex-col items-center justify-center min-h-[500px] px-4\">\n      <div className=\"text-center space-y-6 max-w-md\">\n        <div className=\"relative\">\n          <div className=\"absolute inset-0 flex items-center justify-center\">\n            <Sparkles className=\"w-12 h-12 text-primary/20 animate-pulse\" />\n          </div>\n          <Loader2 className=\"w-16 h-16 text-primary animate-spin mx-auto\" />\n        </div>\n        \n        <div>\n          <h2 className=\"text-2xl font-bold mb-2\">Creating Your Scenes</h2>\n          <p className=\"text-muted-foreground\" data-testid=\"text-processing-status\">\n            {status}\n          </p>\n        </div>\n        \n        <div className=\"bg-muted rounded-lg p-4 space-y-2\">\n          <div className=\"flex items-center gap-3\">\n            <div className=\"w-2 h-2 bg-primary rounded-full animate-pulse\" />\n            <p className=\"text-sm\">Analyzing script structure...</p>\n          </div>\n          <div className=\"flex items-center gap-3\">\n            <div className=\"w-2 h-2 bg-primary rounded-full animate-pulse delay-150\" />\n            <p className=\"text-sm\">Processing character details...</p>\n          </div>\n          <div className=\"flex items-center gap-3\">\n            <div className=\"w-2 h-2 bg-primary rounded-full animate-pulse delay-300\" />\n            <p className=\"text-sm\">Generating scene descriptions...</p>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","size_bytes":1683},"client/src/components/ui/calendar.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight } from \"lucide-react\"\nimport { DayPicker } from \"react-day-picker\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nexport type CalendarProps = React.ComponentProps<typeof DayPicker>\n\nfunction Calendar({\n  className,\n  classNames,\n  showOutsideDays = true,\n  ...props\n}: CalendarProps) {\n  return (\n    <DayPicker\n      showOutsideDays={showOutsideDays}\n      className={cn(\"p-3\", className)}\n      classNames={{\n        months: \"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0\",\n        month: \"space-y-4\",\n        caption: \"flex justify-center pt-1 relative items-center\",\n        caption_label: \"text-sm font-medium\",\n        nav: \"space-x-1 flex items-center\",\n        nav_button: cn(\n          buttonVariants({ variant: \"outline\" }),\n          \"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100\"\n        ),\n        nav_button_previous: \"absolute left-1\",\n        nav_button_next: \"absolute right-1\",\n        table: \"w-full border-collapse space-y-1\",\n        head_row: \"flex\",\n        head_cell:\n          \"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]\",\n        row: \"flex w-full mt-2\",\n        cell: \"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20\",\n        day: cn(\n          buttonVariants({ variant: \"ghost\" }),\n          \"h-9 w-9 p-0 font-normal aria-selected:opacity-100\"\n        ),\n        day_range_end: \"day-range-end\",\n        day_selected:\n          \"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground\",\n        day_today: \"bg-accent text-accent-foreground\",\n        day_outside:\n          \"day-outside text-muted-foreground aria-selected:bg-accent/50 aria-selected:text-muted-foreground\",\n        day_disabled: \"text-muted-foreground opacity-50\",\n        day_range_middle:\n          \"aria-selected:bg-accent aria-selected:text-accent-foreground\",\n        day_hidden: \"invisible\",\n        ...classNames,\n      }}\n      components={{\n        IconLeft: ({ className, ...props }) => (\n          <ChevronLeft className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n        IconRight: ({ className, ...props }) => (\n          <ChevronRight className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n      }}\n      {...props}\n    />\n  )\n}\nCalendar.displayName = \"Calendar\"\n\nexport { Calendar }\n","size_bytes":2695},"client/src/pages/BulkGenerator.tsx":{"content":"import { useState, useEffect, useRef } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport { RadioGroup, RadioGroupItem } from \"@/components/ui/radio-group\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Link, useLocation } from \"wouter\";\nimport { Home, Loader2, CheckCircle, XCircle, Clock, AlertCircle, Layers } from \"lucide-react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Progress } from \"@/components/ui/progress\";\n\ntype AspectRatio = \"landscape\" | \"portrait\";\n\ninterface VideoGenerationStatus {\n  prompt: string;\n  status: \"pending\" | \"processing\" | \"completed\" | \"failed\";\n  videoUrl?: string;\n  error?: string;\n  tokenLabel?: string | null;\n}\n\nconst STORAGE_KEY = 'bulkGeneratorResults';\nconst STORAGE_META_KEY = 'bulkGeneratorMeta';\n\ninterface BulkGenerationMeta {\n  historyEntryIds: (string | null)[];\n  isGenerating: boolean;\n  timestamp: number;\n}\n\nexport default function BulkGenerator() {\n  const [prompts, setPrompts] = useState(\"\");\n  const [aspectRatio, setAspectRatio] = useState<AspectRatio>(\"landscape\");\n  const [isGenerating, setIsGenerating] = useState(false);\n  const [generationProgress, setGenerationProgress] = useState<VideoGenerationStatus[]>([]);\n  const { toast } = useToast();\n  const [, setLocation] = useLocation();\n  const pollingIntervalRef = useRef<NodeJS.Timeout | null>(null);\n  const historyEntryIdsRef = useRef<(string | null)[]>([]);\n\n  const { data: session, isLoading: sessionLoading } = useQuery<{\n    authenticated: boolean;\n    user?: { id: string; username: string; isAdmin: boolean };\n  }>({\n    queryKey: [\"/api/session\"],\n  });\n\n  // Load previous results from localStorage on mount and check for updates\n  useEffect(() => {\n    const loadAndSync = async () => {\n      try {\n        const saved = localStorage.getItem(STORAGE_KEY);\n        const savedMeta = localStorage.getItem(STORAGE_META_KEY);\n        \n        if (saved && savedMeta) {\n          const parsed = JSON.parse(saved);\n          const meta: BulkGenerationMeta = JSON.parse(savedMeta);\n          \n          if (Array.isArray(parsed) && parsed.length > 0) {\n            setGenerationProgress(parsed);\n            historyEntryIdsRef.current = meta.historyEntryIds;\n            \n            // Check if there are any in-progress videos\n            const hasInProgress = parsed.some(v => \n              v.status === 'pending' || v.status === 'processing'\n            );\n            \n            if (hasInProgress && meta.historyEntryIds.length > 0) {\n              // Sync with server immediately to update status\n              try {\n                const historyResponse = await fetch('/api/video-history', {\n                  credentials: 'include',\n                });\n                \n                if (historyResponse.ok) {\n                  const historyData = await historyResponse.json();\n                  \n                  // Update progress with latest status from server\n                  setGenerationProgress(prev => \n                    prev.map((item, idx) => {\n                      const entryId = meta.historyEntryIds[idx];\n                      if (!entryId) return item;\n                      \n                      const videoInHistory = historyData.videos.find((v: any) => v.id === entryId);\n                      if (videoInHistory) {\n                        if (videoInHistory.status === 'completed') {\n                          return { ...item, status: \"completed\", videoUrl: videoInHistory.videoUrl };\n                        } else if (videoInHistory.status === 'failed') {\n                          return { ...item, status: \"failed\", error: \"Generation failed\" };\n                        }\n                      }\n                      return item;\n                    })\n                  );\n                }\n              } catch (syncError) {\n                console.error('Failed to sync with server:', syncError);\n              }\n            }\n          }\n        }\n      } catch (error) {\n        console.error('Failed to load saved results:', error);\n      }\n    };\n    \n    loadAndSync();\n  }, []);\n\n  // Save results to localStorage whenever they change\n  useEffect(() => {\n    if (generationProgress.length > 0) {\n      try {\n        localStorage.setItem(STORAGE_KEY, JSON.stringify(generationProgress));\n        \n        // Also save metadata\n        const meta: BulkGenerationMeta = {\n          historyEntryIds: historyEntryIdsRef.current,\n          isGenerating,\n          timestamp: Date.now(),\n        };\n        localStorage.setItem(STORAGE_META_KEY, JSON.stringify(meta));\n      } catch (error) {\n        console.error('Failed to save results:', error);\n      }\n    }\n  }, [generationProgress, isGenerating]);\n\n  // Cleanup polling interval on unmount\n  useEffect(() => {\n    return () => {\n      if (pollingIntervalRef.current) {\n        clearInterval(pollingIntervalRef.current);\n        pollingIntervalRef.current = null;\n      }\n    };\n  }, []);\n\n  // Redirect to login if not authenticated\n  useEffect(() => {\n    if (!sessionLoading && session && !session.authenticated) {\n      toast({\n        title: \"Authentication required\",\n        description: \"Please log in to generate videos.\",\n        variant: \"destructive\",\n      });\n      setLocation(\"/login\");\n    }\n  }, [session, sessionLoading, setLocation, toast]);\n\n  const handleGenerate = async () => {\n    // Clear any existing polling interval before starting new generation\n    if (pollingIntervalRef.current) {\n      clearInterval(pollingIntervalRef.current);\n      pollingIntervalRef.current = null;\n    }\n\n    // Parse prompts (one per line)\n    const promptLines = prompts\n      .split('\\n')\n      .map(line => line.trim())\n      .filter(line => line.length > 0);\n\n    // Validate\n    if (promptLines.length === 0) {\n      toast({\n        title: \"No prompts found\",\n        description: \"Please enter at least one prompt\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (promptLines.length > 200) {\n      toast({\n        title: \"Too many prompts\",\n        description: \"Maximum 200 prompts allowed. Please remove some prompts.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    // Initialize progress tracking (this also clears previous results)\n    const initialProgress: VideoGenerationStatus[] = promptLines.map(prompt => ({\n      prompt,\n      status: \"pending\",\n    }));\n    setGenerationProgress(initialProgress);\n    setIsGenerating(true);\n\n    // Call the bulk generate endpoint\n    try {\n      const response = await fetch('/api/bulk-generate', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        credentials: 'include',\n        body: JSON.stringify({\n          prompts: promptLines,\n          aspectRatio,\n        }),\n      });\n\n      if (!response.ok) {\n        const error = await response.json();\n        toast({\n          title: \"Failed to start generation\",\n          description: error.message || \"Please try again\",\n          variant: \"destructive\",\n        });\n        setIsGenerating(false);\n        return;\n      }\n\n      const result = await response.json();\n      const videoIds = result.videoIds;\n      historyEntryIdsRef.current = videoIds;\n\n      toast({\n        title: \"Generation started!\",\n        description: `${promptLines.length} videos are now generating in the background. You can leave this page and check progress in Video History.`,\n      });\n\n      console.log(`[Bulk Generate] Started ${videoIds.length} videos. Processing in background.`);\n\n    } catch (error: any) {\n      console.error('Error starting bulk generation:', error);\n      toast({\n        title: \"Failed to start generation\",\n        description: error.message || \"Please try again\",\n        variant: \"destructive\",\n      });\n      setIsGenerating(false);\n      return;\n    }\n\n    // Start polling for status updates (runs in background)\n    const historyEntryIds = historyEntryIdsRef.current;\n    let pollingAttempts = 0;\n    const maxPollingAttempts = 600; // Poll for up to 20 minutes (600 * 2 sec)\n    \n    pollingIntervalRef.current = setInterval(async () => {\n      pollingAttempts++;\n      \n      try {\n        // Fetch latest history to check status\n        const historyResponse = await fetch('/api/video-history', {\n          credentials: 'include',\n        });\n        \n        if (historyResponse.ok) {\n          const historyData = await historyResponse.json();\n          \n          // Update progress for each video\n          for (let i = 0; i < historyEntryIds.length; i++) {\n            const entryId = historyEntryIds[i];\n            if (!entryId) continue;\n            \n            const videoInHistory = historyData.videos.find((v: any) => v.id === entryId);\n            if (videoInHistory) {\n              setGenerationProgress(prev => \n                prev.map((item, idx) => {\n                  if (idx !== i) return item;\n                  \n                  if (videoInHistory.status === 'completed') {\n                    return { ...item, status: \"completed\", videoUrl: videoInHistory.videoUrl };\n                  } else if (videoInHistory.status === 'failed') {\n                    return { ...item, status: \"failed\", error: \"Generation failed\" };\n                  } else if (videoInHistory.status === 'pending') {\n                    return { ...item, status: \"processing\" };\n                  }\n                  return item;\n                })\n              );\n            }\n          }\n          \n          // Check if all are done\n          const allDone = historyEntryIds.length > 0 && historyEntryIds.every(entryId => {\n            if (!entryId) return true;\n            const video = historyData.videos.find((v: any) => v.id === entryId);\n            return video && (video.status === 'completed' || video.status === 'failed');\n          });\n          \n          if (allDone || pollingAttempts >= maxPollingAttempts) {\n            if (pollingIntervalRef.current) {\n              clearInterval(pollingIntervalRef.current);\n              pollingIntervalRef.current = null;\n            }\n            setIsGenerating(false);\n          }\n        }\n      } catch (error) {\n        console.error('Error polling history:', error);\n      }\n    }, 2000);\n  };\n\n  const promptCount = prompts.split('\\n').filter(line => line.trim().length > 0).length;\n  const completedCount = generationProgress.filter(v => v.status === \"completed\").length;\n  const failedCount = generationProgress.filter(v => v.status === \"failed\").length;\n  const progressPercentage = generationProgress.length > 0 \n    ? ((completedCount + failedCount) / generationProgress.length) * 100 \n    : 0;\n\n  if (sessionLoading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center bg-gradient-to-br from-purple-50 via-white to-blue-50 dark:from-gray-900 dark:via-gray-800 dark:to-gray-900\">\n        <Loader2 className=\"w-8 h-8 animate-spin text-purple-600 dark:text-purple-400\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-[#1a2332] via-[#1e2838] to-[#242d3f] dark:from-[#141a25] dark:via-[#181e2a] dark:to-[#1c2230] p-4 md:p-6\">\n      <div className=\"max-w-7xl mx-auto py-6 md:py-10\">\n        <div className=\"flex flex-col md:flex-row md:justify-between md:items-center gap-4 mb-8 animate-slide-up\">\n          <div>\n            <h1 className=\"text-3xl md:text-4xl font-bold text-white mb-2\">\n              Bulk Video Generator\n            </h1>\n            <p className=\"text-gray-300 text-base md:text-lg\">\n              Generate up to 200 videos at once with smart API token rotation\n            </p>\n          </div>\n          <Link href=\"/\">\n            <Button variant=\"outline\" className=\"hover-lift self-start md:self-auto border-white/20 text-white hover:bg-white/10\" data-testid=\"button-home\">\n              <Home className=\"w-4 h-4 mr-2\" />\n              Home\n            </Button>\n          </Link>\n        </div>\n\n        <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n          {/* Input Section */}\n          <Card className=\"shadow-2xl hover-lift transition-all duration-300 animate-fade-in border border-white/10 bg-[#1e2838] dark:bg-[#181e2a]\">\n            <CardHeader className=\"border-b border-white/10 pb-4\">\n              <CardTitle className=\"text-white flex items-center gap-2\">\n                <Layers className=\"w-5 h-5 text-purple-400\" />\n                Video Prompts\n              </CardTitle>\n              <CardDescription className=\"text-gray-300\">\n                Enter up to 200 prompts (one per line)\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-6 pt-6\">\n              <div>\n                <div className=\"flex items-center justify-between mb-3\">\n                  <Label htmlFor=\"prompts\" className=\"text-white font-semibold\">\n                    Prompts ({promptCount}/200)\n                  </Label>\n                  {promptCount > 0 && promptCount <= 200 && (\n                    <span className=\"text-xs bg-green-600/30 border border-green-500/50 text-green-300 px-2 py-1 rounded-full\">\n                      ✓ Ready\n                    </span>\n                  )}\n                </div>\n                <Textarea\n                  id=\"prompts\"\n                  value={prompts}\n                  onChange={(e) => setPrompts(e.target.value)}\n                  placeholder=\"A dog running on the beach&#10;A sunset over mountains&#10;A city street at night&#10;...\"\n                  className=\"min-h-[280px] md:min-h-[320px] transition-smooth focus:ring-2 focus:ring-purple-500 bg-[#242d3f]/50 border-white/10 text-white placeholder:text-gray-400 text-sm md:text-base\"\n                  disabled={isGenerating}\n                  data-testid=\"input-bulk-prompts\"\n                />\n                {promptCount > 200 && (\n                  <p className=\"text-sm text-red-300 mt-2 flex items-center gap-2 animate-slide-up\">\n                    <AlertCircle className=\"w-4 h-4\" />\n                    Maximum 200 prompts allowed\n                  </p>\n                )}\n              </div>\n\n              <div>\n                <Label className=\"text-white mb-4 block font-semibold\">Aspect Ratio</Label>\n                <RadioGroup\n                  value={aspectRatio}\n                  onValueChange={(value) => setAspectRatio(value as AspectRatio)}\n                  disabled={isGenerating}\n                  className=\"grid grid-cols-2 gap-3\"\n                >\n                  <div className=\"flex items-center space-x-2 border-2 border-white/10 rounded-xl p-3 md:p-4 hover:border-purple-500 transition-all hover-lift cursor-pointer bg-white/5\">\n                    <RadioGroupItem value=\"landscape\" id=\"landscape\" data-testid=\"radio-landscape\" />\n                    <Label htmlFor=\"landscape\" className=\"cursor-pointer text-white text-sm md:text-base font-medium\">\n                      Landscape (16:9)\n                    </Label>\n                  </div>\n                  <div className=\"flex items-center space-x-2 border-2 border-white/10 rounded-xl p-3 md:p-4 hover:border-purple-500 transition-all hover-lift cursor-pointer bg-white/5\">\n                    <RadioGroupItem value=\"portrait\" id=\"portrait\" data-testid=\"radio-portrait\" />\n                    <Label htmlFor=\"portrait\" className=\"cursor-pointer text-white text-sm md:text-base font-medium\">\n                      Portrait (9:16)\n                    </Label>\n                  </div>\n                </RadioGroup>\n              </div>\n\n              <Button\n                onClick={handleGenerate}\n                disabled={isGenerating || promptCount === 0 || promptCount > 200}\n                className=\"w-full h-12 md:h-14 bg-purple-600 hover:bg-purple-700 shadow-lg hover-lift text-base md:text-lg font-semibold border-0\"\n                data-testid=\"button-generate-bulk\"\n              >\n                {isGenerating ? (\n                  <>\n                    <Loader2 className=\"w-5 h-5 mr-2 animate-spin\" />\n                    Processing...\n                  </>\n                ) : (\n                  <>\n                    <Layers className=\"w-5 h-5 mr-2\" />\n                    Generate {promptCount} Video{promptCount !== 1 ? 's' : ''}\n                  </>\n                )}\n              </Button>\n              \n              {isGenerating && (\n                <div className=\"mt-4 p-4 bg-purple-600/10 border border-purple-500/30 rounded-xl\">\n                  <p className=\"text-sm text-gray-300 text-center\">\n                    Videos are being generated in the background. Check the <Link href=\"/history\" className=\"text-purple-400 hover:text-purple-300 underline\">Video History</Link> page to track progress.\n                  </p>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n    </div>\n  );\n}\n","size_bytes":17105},"README.md":{"content":"\"# cartoon\" \n","size_bytes":13},"client/src/lib/queryClient.ts":{"content":"import { QueryClient, QueryFunction } from \"@tanstack/react-query\";\n\nasync function throwIfResNotOk(res: Response) {\n  if (!res.ok) {\n    const text = (await res.text()) || res.statusText;\n    throw new Error(`${res.status}: ${text}`);\n  }\n}\n\nexport async function apiRequest(\n  method: string,\n  url: string,\n  data?: unknown | undefined,\n): Promise<Response> {\n  const res = await fetch(url, {\n    method,\n    headers: data ? { \"Content-Type\": \"application/json\" } : {},\n    body: data ? JSON.stringify(data) : undefined,\n    credentials: \"include\",\n  });\n\n  await throwIfResNotOk(res);\n  return res;\n}\n\ntype UnauthorizedBehavior = \"returnNull\" | \"throw\";\nexport const getQueryFn: <T>(options: {\n  on401: UnauthorizedBehavior;\n}) => QueryFunction<T> =\n  ({ on401: unauthorizedBehavior }) =>\n  async ({ queryKey }) => {\n    const res = await fetch(queryKey.join(\"/\") as string, {\n      credentials: \"include\",\n    });\n\n    if (unauthorizedBehavior === \"returnNull\" && res.status === 401) {\n      return null;\n    }\n\n    await throwIfResNotOk(res);\n    return await res.json();\n  };\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: getQueryFn({ on401: \"throw\" }),\n      refetchInterval: false,\n      refetchOnWindowFocus: false,\n      staleTime: Infinity,\n      retry: false,\n    },\n    mutations: {\n      retry: false,\n    },\n  },\n});\n","size_bytes":1383},"client/src/pages/not-found.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { AlertCircle } from \"lucide-react\";\n\nexport default function NotFound() {\n  return (\n    <div className=\"min-h-screen w-full flex items-center justify-center bg-gradient-to-br from-[#1a2332] via-[#1e2838] to-[#242d3f]\">\n      <Card className=\"w-full max-w-md mx-4 bg-[#1e2838] dark:bg-[#181e2a] border border-white/10\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex mb-4 gap-2\">\n            <AlertCircle className=\"h-8 w-8 text-red-400\" />\n            <h1 className=\"text-2xl font-bold text-white\">404 Page Not Found</h1>\n          </div>\n\n          <p className=\"mt-4 text-sm text-gray-300\">\n            Did you forget to add the page to the router?\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":811},"client/src/pages/VeoGenerator.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport { RadioGroup, RadioGroupItem } from \"@/components/ui/radio-group\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Link, useLocation } from \"wouter\";\nimport { Home, Loader2, Download, PlayCircle } from \"lucide-react\";\nimport { useQuery } from \"@tanstack/react-query\";\n\ntype AspectRatio = \"landscape\" | \"portrait\";\n\nexport default function VeoGenerator() {\n  const [prompt, setPrompt] = useState(\"\");\n  const [aspectRatio, setAspectRatio] = useState<AspectRatio>(\"landscape\");\n  const [isGenerating, setIsGenerating] = useState(false);\n  const [videoUrl, setVideoUrl] = useState<string | null>(null);\n  const [error, setError] = useState<string | null>(null);\n  const { toast } = useToast();\n  const [, setLocation] = useLocation();\n\n  const { data: session, isLoading: sessionLoading } = useQuery<{\n    authenticated: boolean;\n    user?: { id: string; username: string; isAdmin: boolean };\n  }>({\n    queryKey: [\"/api/session\"],\n  });\n\n  // Redirect to login if not authenticated\n  useEffect(() => {\n    if (!sessionLoading && session && !session.authenticated) {\n      toast({\n        title: \"Authentication required\",\n        description: \"Please log in to generate videos.\",\n        variant: \"destructive\",\n      });\n      setLocation(\"/login\");\n    }\n  }, [session, sessionLoading, setLocation, toast]);\n\n  const handleGenerate = async () => {\n    if (!prompt.trim()) {\n      toast({\n        title: \"Prompt required\",\n        description: \"Please enter a video prompt\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setIsGenerating(true);\n    setVideoUrl(null);\n    setError(null);\n\n    let historyEntryId: string | null = null;\n\n    try {\n      // Save to history as pending first\n      try {\n        const historyResponse = await fetch('/api/video-history', {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n          },\n          credentials: 'include',\n          body: JSON.stringify({\n            userId: '', // Will be set by backend\n            prompt,\n            aspectRatio,\n            status: 'pending',\n            title: `VEO ${aspectRatio} video`,\n          }),\n        });\n        \n        if (historyResponse.ok) {\n          const historyData = await historyResponse.json();\n          historyEntryId = historyData.video.id;\n        }\n      } catch (historyError) {\n        console.error('Failed to save pending video to history:', historyError);\n        // Continue with generation even if history save fails\n      }\n\n      // Start video generation\n      const response = await fetch('/api/generate-veo-video', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        credentials: 'include',\n        body: JSON.stringify({ prompt, aspectRatio }),\n      });\n\n      const result = await response.json();\n\n      if (!response.ok) {\n        throw new Error(result.error || 'Failed to start video generation');\n      }\n\n      const { operationName, sceneId, tokenId } = result;\n\n      // Update history with token ID if available\n      if (historyEntryId && tokenId) {\n        try {\n          await fetch(`/api/video-history/${historyEntryId}`, {\n            method: 'PATCH',\n            headers: {\n              'Content-Type': 'application/json',\n            },\n            credentials: 'include',\n            body: JSON.stringify({\n              tokenUsed: tokenId,\n            }),\n          });\n        } catch (historyError) {\n          console.error('Failed to update history with token ID:', historyError);\n        }\n      }\n\n      // Poll for video status\n      let completed = false;\n      let attempts = 0;\n      const maxAttempts = 120; // 4 minutes max (2 second intervals)\n\n      while (!completed && attempts < maxAttempts) {\n        await new Promise(resolve => setTimeout(resolve, 2000));\n        attempts++;\n\n        const statusResponse = await fetch('/api/check-video-status', {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n          },\n          credentials: 'include',\n          body: JSON.stringify({ operationName, sceneId }),\n        });\n\n        const statusData = await statusResponse.json();\n\n        if (statusData.status === 'COMPLETED' || \n            statusData.status === 'MEDIA_GENERATION_STATUS_COMPLETE' || \n            statusData.status === 'MEDIA_GENERATION_STATUS_SUCCESSFUL') {\n          setVideoUrl(statusData.videoUrl);\n          completed = true;\n          \n          // Update history with completed status and video URL\n          if (historyEntryId) {\n            try {\n              await fetch(`/api/video-history/${historyEntryId}`, {\n                method: 'PATCH',\n                headers: {\n                  'Content-Type': 'application/json',\n                },\n                credentials: 'include',\n                body: JSON.stringify({\n                  status: 'completed',\n                  videoUrl: statusData.videoUrl,\n                }),\n              });\n            } catch (historyError) {\n              console.error('Failed to update history:', historyError);\n            }\n          }\n          \n          toast({\n            title: \"Video generated!\",\n            description: \"Your video is ready to watch and download.\",\n          });\n        } else if (statusData.status === 'FAILED' || \n                   statusData.status === 'MEDIA_GENERATION_STATUS_FAILED') {\n          throw new Error(statusData.error || 'Video generation failed');\n        }\n      }\n\n      if (!completed) {\n        throw new Error('Video generation timed out');\n      }\n    } catch (err) {\n      console.error(\"Error generating video:\", err);\n      const errorMessage = err instanceof Error ? err.message : 'Failed to generate video';\n      setError(errorMessage);\n      \n      // Update history with failed status\n      if (historyEntryId) {\n        try {\n          await fetch(`/api/video-history/${historyEntryId}`, {\n            method: 'PATCH',\n            headers: {\n              'Content-Type': 'application/json',\n            },\n            credentials: 'include',\n            body: JSON.stringify({\n              status: 'failed',\n            }),\n          });\n        } catch (historyError) {\n          console.error('Failed to update history:', historyError);\n        }\n      }\n      \n      toast({\n        title: \"Generation failed\",\n        description: errorMessage,\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsGenerating(false);\n    }\n  };\n\n  const handleDownload = () => {\n    if (videoUrl) {\n      window.open(videoUrl, '_blank');\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-[#1a2332] via-[#1e2838] to-[#242d3f] dark:from-[#141a25] dark:via-[#181e2a] dark:to-[#1c2230]\">\n      <header className=\"border-b border-white/10 bg-[#1c2534]/80 dark:bg-[#161c28]/80 backdrop-blur-md sticky top-0 z-50 shadow-xl\">\n        <div className=\"max-w-7xl mx-auto px-4 md:px-6 py-3 md:py-4 flex justify-between items-center\">\n          <h1 className=\"text-base sm:text-lg md:text-xl font-bold text-white\">VEO 3.1 Video Generator</h1>\n          <Link href=\"/\">\n            <Button variant=\"outline\" size=\"sm\" className=\"hover-lift border-white/20 text-white hover:bg-white/10\" data-testid=\"link-home\">\n              <Home className=\"w-4 h-4 sm:mr-2\" />\n              <span className=\"hidden sm:inline\">Home</span>\n            </Button>\n          </Link>\n        </div>\n      </header>\n\n      <div className=\"max-w-4xl mx-auto px-4 md:px-6 py-6 md:py-10\">\n        <Card className=\"shadow-2xl hover-lift transition-all duration-300 animate-fade-in border border-white/10 bg-[#1e2838] dark:bg-[#181e2a]\">\n          <CardHeader className=\"p-6 md:p-8 border-b border-white/10\">\n            <CardTitle className=\"flex items-center gap-3 text-2xl md:text-3xl text-white\">\n              <div className=\"p-2 rounded-xl bg-purple-600/30 border border-purple-500/50\">\n                <PlayCircle className=\"w-6 h-6 text-purple-400\" />\n              </div>\n              Generate AI Video\n            </CardTitle>\n            <CardDescription className=\"text-base mt-2 text-gray-300\">\n              Create stunning videos using Google's VEO 3.1 model. Choose your aspect ratio and describe what you want to see.\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-6 p-6 md:p-8\">\n            <div className=\"space-y-3\">\n              <Label htmlFor=\"prompt\" className=\"text-base font-semibold text-white\">Video Prompt</Label>\n              <Textarea\n                id=\"prompt\"\n                placeholder=\"Describe your vision in detail... (e.g., A serene sunset over a calm ocean with gentle waves, seagulls flying in the distance)\"\n                value={prompt}\n                onChange={(e) => setPrompt(e.target.value)}\n                rows={6}\n                disabled={isGenerating}\n                data-testid=\"textarea-prompt\"\n                className=\"resize-none text-base transition-smooth focus:ring-2 focus:ring-purple-500 bg-[#242d3f]/50 border-white/10 text-white placeholder:text-gray-400\"\n              />\n              <p className=\"text-sm text-gray-400 flex items-center gap-2\">\n                <span className=\"inline-block w-2 h-2 bg-purple-500 rounded-full animate-pulse\"></span>\n                Be specific and descriptive for best results\n              </p>\n            </div>\n\n            <div className=\"space-y-4\">\n              <Label className=\"text-base font-semibold text-white\">Aspect Ratio</Label>\n              <RadioGroup\n                value={aspectRatio}\n                onValueChange={(value) => setAspectRatio(value as AspectRatio)}\n                disabled={isGenerating}\n                className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\"\n              >\n                <div className=\"flex items-center space-x-3 border-2 border-white/10 rounded-xl p-4 hover:border-purple-500 transition-all hover-lift cursor-pointer bg-white/5\">\n                  <RadioGroupItem value=\"landscape\" id=\"landscape\" data-testid=\"radio-landscape\" />\n                  <Label htmlFor=\"landscape\" className=\"font-normal cursor-pointer flex-1 text-white\">\n                    <span className=\"font-semibold block mb-1\">Landscape (16:9)</span>\n                    <span className=\"text-xs text-gray-400\">YouTube, presentations</span>\n                  </Label>\n                </div>\n                <div className=\"flex items-center space-x-3 border-2 border-white/10 rounded-xl p-4 hover:border-purple-500 transition-all hover-lift cursor-pointer bg-white/5\">\n                  <RadioGroupItem value=\"portrait\" id=\"portrait\" data-testid=\"radio-portrait\" />\n                  <Label htmlFor=\"portrait\" className=\"font-normal cursor-pointer flex-1 text-white\">\n                    <span className=\"font-semibold block mb-1\">Portrait (9:16)</span>\n                    <span className=\"text-xs text-gray-400\">TikTok, Reels, Stories</span>\n                  </Label>\n                </div>\n              </RadioGroup>\n            </div>\n\n            {error && (\n              <div className=\"p-4 bg-red-900/30 border-2 border-red-500/50 rounded-xl animate-slide-up\">\n                <p className=\"text-red-200 text-sm\">{error}</p>\n              </div>\n            )}\n\n            {videoUrl && (\n              <div className=\"space-y-4 animate-scale-in\">\n                <div className=\"aspect-video bg-black rounded-2xl overflow-hidden shadow-2xl ring-4 ring-purple-500/30\">\n                  <video\n                    src={videoUrl}\n                    controls\n                    autoPlay\n                    loop\n                    className=\"w-full h-full\"\n                    data-testid=\"video-result\"\n                  />\n                </div>\n                <Button\n                  onClick={handleDownload}\n                  className=\"w-full h-12 text-base font-semibold bg-purple-600 hover:bg-purple-700 border-0\"\n                  data-testid=\"button-download\"\n                >\n                  <Download className=\"w-5 h-5 mr-2\" />\n                  Download Video\n                </Button>\n              </div>\n            )}\n\n            <Button\n              onClick={handleGenerate}\n              disabled={isGenerating || !prompt.trim()}\n              className=\"w-full h-14 text-lg font-semibold bg-purple-600 hover:bg-purple-700 shadow-lg hover-lift border-0\"\n              size=\"lg\"\n              data-testid=\"button-generate\"\n            >\n              {isGenerating ? (\n                <>\n                  <Loader2 className=\"w-5 h-5 mr-2 animate-spin\" />\n                  Generating Video...\n                </>\n              ) : (\n                <>\n                  <PlayCircle className=\"w-5 h-5 mr-2\" />\n                  Generate Video\n                </>\n              )}\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","size_bytes":13263},"client/src/components/ui/drawer.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Drawer as DrawerPrimitive } from \"vaul\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Drawer = ({\n  shouldScaleBackground = true,\n  ...props\n}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (\n  <DrawerPrimitive.Root\n    shouldScaleBackground={shouldScaleBackground}\n    {...props}\n  />\n)\nDrawer.displayName = \"Drawer\"\n\nconst DrawerTrigger = DrawerPrimitive.Trigger\n\nconst DrawerPortal = DrawerPrimitive.Portal\n\nconst DrawerClose = DrawerPrimitive.Close\n\nconst DrawerOverlay = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Overlay\n    ref={ref}\n    className={cn(\"fixed inset-0 z-50 bg-black/80\", className)}\n    {...props}\n  />\n))\nDrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName\n\nconst DrawerContent = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DrawerPortal>\n    <DrawerOverlay />\n    <DrawerPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background\",\n        className\n      )}\n      {...props}\n    >\n      <div className=\"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted\" />\n      {children}\n    </DrawerPrimitive.Content>\n  </DrawerPortal>\n))\nDrawerContent.displayName = \"DrawerContent\"\n\nconst DrawerHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"grid gap-1.5 p-4 text-center sm:text-left\", className)}\n    {...props}\n  />\n)\nDrawerHeader.displayName = \"DrawerHeader\"\n\nconst DrawerFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"mt-auto flex flex-col gap-2 p-4\", className)}\n    {...props}\n  />\n)\nDrawerFooter.displayName = \"DrawerFooter\"\n\nconst DrawerTitle = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDrawerTitle.displayName = DrawerPrimitive.Title.displayName\n\nconst DrawerDescription = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDrawerDescription.displayName = DrawerPrimitive.Description.displayName\n\nexport {\n  Drawer,\n  DrawerPortal,\n  DrawerOverlay,\n  DrawerTrigger,\n  DrawerClose,\n  DrawerContent,\n  DrawerHeader,\n  DrawerFooter,\n  DrawerTitle,\n  DrawerDescription,\n}\n","size_bytes":3021},"client/src/components/ui/toggle-group.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ToggleGroupPrimitive from \"@radix-ui/react-toggle-group\"\nimport { type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { toggleVariants } from \"@/components/ui/toggle\"\n\nconst ToggleGroupContext = React.createContext<\n  VariantProps<typeof toggleVariants>\n>({\n  size: \"default\",\n  variant: \"default\",\n})\n\nconst ToggleGroup = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, children, ...props }, ref) => (\n  <ToggleGroupPrimitive.Root\n    ref={ref}\n    className={cn(\"flex items-center justify-center gap-1\", className)}\n    {...props}\n  >\n    <ToggleGroupContext.Provider value={{ variant, size }}>\n      {children}\n    </ToggleGroupContext.Provider>\n  </ToggleGroupPrimitive.Root>\n))\n\nToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName\n\nconst ToggleGroupItem = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &\n    VariantProps<typeof toggleVariants>\n>(({ className, children, variant, size, ...props }, ref) => {\n  const context = React.useContext(ToggleGroupContext)\n\n  return (\n    <ToggleGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        toggleVariants({\n          variant: context.variant || variant,\n          size: context.size || size,\n        }),\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </ToggleGroupPrimitive.Item>\n  )\n})\n\nToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName\n\nexport { ToggleGroup, ToggleGroupItem }\n","size_bytes":1753},"client/src/components/ScenesDisplay.tsx":{"content":"import { Button } from \"@/components/ui/button\";\nimport { Download, RotateCcw, RefreshCw } from \"lucide-react\";\nimport SceneCard from \"./SceneCard\";\nimport type { Scene } from \"@shared/schema\";\n\ninterface ScenesDisplayProps {\n  scenes: Scene[];\n  onStartNew: () => void;\n  onRegenerate: () => void;\n  isRegenerating?: boolean;\n}\n\nexport default function ScenesDisplay({ scenes, onStartNew, onRegenerate, isRegenerating = false }: ScenesDisplayProps) {\n  const handleExport = () => {\n    const dataStr = JSON.stringify(scenes, null, 2);\n    const dataBlob = new Blob([dataStr], { type: 'application/json' });\n    const url = URL.createObjectURL(dataBlob);\n    const link = document.createElement('a');\n    link.href = url;\n    link.download = 'scenes.json';\n    link.click();\n    URL.revokeObjectURL(url);\n  };\n\n  return (\n    <div className=\"max-w-6xl mx-auto px-3 sm:px-4 py-4 sm:py-8\">\n      <div className=\"flex flex-col gap-4 mb-6 sm:mb-8\">\n        <div>\n          <h2 className=\"text-2xl sm:text-3xl font-bold mb-2\">Generated Scenes</h2>\n          <p className=\"text-sm sm:text-base text-muted-foreground\">\n            {scenes.length} scene{scenes.length !== 1 ? 's' : ''} created for your story\n          </p>\n        </div>\n        \n        <div className=\"flex flex-col sm:flex-row gap-2 sm:gap-3\">\n          <Button\n            variant=\"secondary\"\n            onClick={onStartNew}\n            disabled={isRegenerating}\n            data-testid=\"button-start-new\"\n            className=\"w-full sm:w-auto text-sm sm:text-base bg-slate-700 hover:bg-slate-600 text-white border-0\"\n          >\n            <RotateCcw className=\"w-4 h-4 mr-2\" />\n            Start New\n          </Button>\n          <Button\n            variant=\"secondary\"\n            onClick={onRegenerate}\n            disabled={isRegenerating}\n            data-testid=\"button-regenerate-scenes\"\n            className=\"w-full sm:w-auto text-sm sm:text-base bg-slate-700 hover:bg-slate-600 text-white border-0\"\n          >\n            <RefreshCw className={`w-4 h-4 mr-2 ${isRegenerating ? 'animate-spin' : ''}`} />\n            Regenerate Scenes\n          </Button>\n          <Button\n            onClick={handleExport}\n            disabled={isRegenerating}\n            data-testid=\"button-export\"\n            className=\"w-full sm:w-auto text-sm sm:text-base bg-purple-600 hover:bg-purple-700 text-white border-0\"\n          >\n            <Download className=\"w-4 h-4 mr-2\" />\n            Export JSON\n          </Button>\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6\">\n        {scenes.map((scene) => (\n          <SceneCard key={scene.scene} scene={scene} />\n        ))}\n      </div>\n    </div>\n  );\n}\n","size_bytes":2718},"TEMPORARY_VIDEO_STORAGE.md":{"content":"# Temporary Video Storage System\n\nThis document explains the new temporary video storage feature that allows you to merge videos and store them temporarily for preview without permanent storage in Cloudinary.\n\n## Overview\n\nThe system now supports two types of video merging:\n1. **Permanent Storage** (existing): Merges videos and uploads to Cloudinary permanently\n2. **Temporary Storage** (new): Merges videos and stores in Replit Object Storage with 24-hour expiry\n\n## Use Case\n\nTemporary storage is ideal for:\n- Quick video previews before committing to permanent storage\n- Testing video merges without consuming Cloudinary storage\n- Temporary sharing with automatic cleanup\n- Cost-effective preview generation\n\n## Architecture\n\n### Storage Flow\n```\nIndividual Videos (Cloudinary) → FFmpeg Merge → Temporary Storage (24h expiry)\n                                                ↓\n                                        Automatic Cleanup (Hourly)\n```\n\n### Components\n\n1. **ObjectStorageService** (`server/objectStorage.ts`)\n   - Manages temporary video uploads to Replit Object Storage\n   - Stores expiry metadata with each video\n   - Provides cleanup functionality for expired videos\n\n2. **FFmpeg Merger** (`server/videoMergerFFmpeg.ts`)\n   - `mergeVideosWithFFmpegTemporary()`: New function for temporary storage\n   - Downloads videos, merges them, uploads to temporary storage\n   - Returns video path and expiry timestamp\n\n3. **API Endpoints** (`server/routes.ts`)\n   - POST `/api/merge-videos-temporary`: Merge and store temporarily\n   - GET `/api/temp-video-info`: Get video expiry information\n   - POST `/api/cleanup-expired-videos`: Manual cleanup (admin only)\n\n4. **Cleanup Mechanism** (`server/index.ts`)\n   - Hourly cleanup: Runs every hour to delete expired videos\n   - Daily cleanup: Runs at midnight PKT along with video history cleanup\n   - Automatic and manual cleanup options available\n\n## API Usage\n\n### 1. Merge Videos Temporarily\n\n**Endpoint:** `POST /api/merge-videos-temporary`\n\n**Request Body:**\n```json\n{\n  \"videoIds\": [\"video-id-1\", \"video-id-2\", \"video-id-3\"],\n  \"expiryHours\": 24\n}\n```\n\n**Response:**\n```json\n{\n  \"success\": true,\n  \"videoPath\": \"object_storage://replit/temp-videos/merged-12345.mp4\",\n  \"expiresAt\": \"2025-11-02T12:00:00.000Z\",\n  \"previewUrl\": \"object_storage://replit/temp-videos/merged-12345.mp4\",\n  \"message\": \"Video will be available for 24 hours\"\n}\n```\n\n**Parameters:**\n- `videoIds`: Array of video IDs to merge (2-19 videos)\n- `expiryHours`: Optional, defaults to 24 hours\n\n**Requirements:**\n- User must be authenticated\n- All videos must exist and be completed\n- Videos must be from Cloudinary (verified)\n- Minimum 2 videos, maximum 19 videos\n\n### 2. Get Video Expiry Info\n\n**Endpoint:** `GET /api/temp-video-info?videoPath=<path>`\n\n**Response:**\n```json\n{\n  \"success\": true,\n  \"expiresAt\": \"2025-11-02T12:00:00.000Z\",\n  \"isExpired\": false\n}\n```\n\n### 3. Manual Cleanup (Admin Only)\n\n**Endpoint:** `POST /api/cleanup-expired-videos`\n\n**Response:**\n```json\n{\n  \"success\": true,\n  \"deletedCount\": 5,\n  \"message\": \"Deleted 5 expired videos\"\n}\n```\n\n## Automatic Cleanup\n\nThe system runs two cleanup mechanisms:\n\n### Hourly Cleanup\n- Runs every 60 minutes\n- Deletes expired temporary videos\n- Logs deletion count if any videos were removed\n\n### Daily Cleanup (Midnight PKT)\n- Runs at midnight Pakistan Time (UTC+5)\n- Clears all video history\n- Deletes expired temporary videos\n- Comprehensive system cleanup\n\n## Object Storage Structure\n\nTemporary videos are stored in Replit Object Storage:\n\n```\nBucket: replit\nPath: temp-videos/merged-{timestamp}-{uuid}.mp4\nMetadata: {\n  \"expiresAt\": \"2025-11-02T12:00:00.000Z\"\n}\n```\n\n## Video Preview\n\nOnce a video is merged temporarily, you can:\n1. Use the `videoPath` or `previewUrl` from the response\n2. Stream the video directly from Object Storage\n3. Check expiry status using the info endpoint\n4. Preview expires automatically after 24 hours (or custom duration)\n\n## Implementation Details\n\n### mergeVideosWithFFmpegTemporary Function\n\n```typescript\nexport async function mergeVideosWithFFmpegTemporary(\n  videoUrls: string[], \n  expiryHours: number = 24\n): Promise<{ videoPath: string; expiresAt: string }>\n```\n\n**Process:**\n1. Downloads videos from Cloudinary URLs\n2. Creates FFmpeg concat file\n3. Merges videos using `ffmpeg -f concat`\n4. Uploads to Replit Object Storage with expiry metadata\n5. Cleans up temporary files\n6. Returns video path and expiry timestamp\n\n### Error Handling\n\n- Failed downloads: Returns detailed error about which video failed\n- FFmpeg errors: Logs stderr output for debugging\n- Storage errors: Gracefully handles upload failures\n- Cleanup errors: Logs but doesn't throw to prevent blocking\n\n## Comparison: Permanent vs Temporary Storage\n\n| Feature | Permanent (Cloudinary) | Temporary (Object Storage) |\n|---------|----------------------|---------------------------|\n| Duration | Unlimited | 24 hours (configurable) |\n| API | `/api/merge-selected-videos` | `/api/merge-videos-temporary` |\n| Storage | Cloudinary CDN | Replit Object Storage |\n| Cleanup | Manual | Automatic (hourly) |\n| Cost | Uses Cloudinary quota | Uses Replit storage |\n| Use Case | Final videos | Preview & testing |\n\n## Frontend Integration\n\nTo use the temporary video feature in the frontend:\n\n```typescript\n// Merge videos temporarily\nconst response = await fetch('/api/merge-videos-temporary', {\n  method: 'POST',\n  headers: { 'Content-Type': 'application/json' },\n  body: JSON.stringify({\n    videoIds: selectedVideoIds,\n    expiryHours: 24\n  })\n});\n\nconst { videoPath, expiresAt, previewUrl } = await response.json();\n\n// Show video preview with expiry notice\n<video src={previewUrl} controls />\n<p>Expires at: {new Date(expiresAt).toLocaleString()}</p>\n\n// Check if video is still available\nconst infoResponse = await fetch(\n  `/api/temp-video-info?videoPath=${encodeURIComponent(videoPath)}`\n);\nconst { isExpired } = await infoResponse.json();\n```\n\n## Monitoring\n\nCheck server logs for cleanup activity:\n\n```\n[Hourly Cleanup] Deleted 3 expired temporary videos\n[Daily Cleanup] Running cleanup tasks at midnight PKT (11/2/2025)\n[Daily Cleanup] Deleted 5 expired temporary videos\n[Object Storage] Cleanup complete. Deleted 5 expired videos\n```\n\n## Security\n\n- All endpoints require authentication\n- Manual cleanup requires admin privileges\n- Videos are scoped to authenticated users\n- Automatic expiry prevents storage bloat\n\n## Troubleshooting\n\n### Video Not Found\n- Check if video has expired (24 hours default)\n- Verify the videoPath is correct\n- Check cleanup logs for deletion activity\n\n### Cleanup Not Running\n- Verify server is running continuously\n- Check server logs for cleanup initialization\n- Hourly cleanup: runs every 60 minutes\n- Daily cleanup: runs at midnight PKT\n\n### Storage Errors\n- Verify Object Storage integration is configured\n- Check REPLIT_DEPLOYMENT environment variable\n- Ensure proper bucket permissions\n\n## Future Enhancements\n\nPotential improvements:\n- Custom expiry times per video\n- Email notification before expiry\n- Extension of expiry time\n- Multiple quality options for previews\n- Bandwidth monitoring and limits\n","size_bytes":7150},"server/bulkQueue.ts":{"content":"import { storage } from \"./storage\";\nimport type { ApiToken } from \"@shared/schema\";\n\n// Queue to store videos pending generation\ninterface QueuedVideo {\n  videoId: string;\n  prompt: string;\n  aspectRatio: string;\n  sceneNumber: number;\n  userId: string;\n}\n\nconst bulkQueue: QueuedVideo[] = [];\nlet isProcessing = false;\nconst DELAY_BETWEEN_REQUESTS_MS = 20000; // 20 seconds\nconst MAX_RETRIES = 2; // Max retries per video\nconst RETRY_DELAY_MS = 10000; // 10 seconds between retries\n\n/**\n * Add videos to the bulk generation queue\n */\nexport function addToQueue(videos: QueuedVideo[]) {\n  bulkQueue.push(...videos);\n  console.log(`[Bulk Queue] Added ${videos.length} videos to queue. Total in queue: ${bulkQueue.length}`);\n  \n  // Start processing if not already running\n  if (!isProcessing) {\n    processQueue();\n  }\n}\n\n/**\n * Process a single video from the batch\n */\nasync function processSingleVideo(video: QueuedVideo): Promise<void> {\n  try {\n    console.log(`[Bulk Queue] Processing video ${video.sceneNumber} (ID: ${video.videoId})`);\n    \n    // Get API token using round-robin rotation (wraps around for any number of videos)\n    let apiKey: string | undefined;\n    let rotationToken: ApiToken | undefined;\n    \n    rotationToken = await storage.getNextRotationToken();\n    \n    if (rotationToken) {\n      apiKey = rotationToken.token;\n      console.log(`[Bulk Queue] Using token ${rotationToken.label} (ID: ${rotationToken.id}) for video ${video.sceneNumber}`);\n      await storage.updateTokenUsage(rotationToken.id);\n    }\n    \n    if (!apiKey) {\n      apiKey = process.env.VEO3_API_KEY;\n      console.log('[Bulk Queue] Fallback: Using environment variable VEO3_API_KEY');\n    }\n\n    if (!apiKey) {\n      const errorMessage = `No API key available for video generation (scene ${video.sceneNumber})`;\n      console.error(`[Bulk Queue] ❌ CRITICAL: ${errorMessage}`);\n      await storage.updateVideoHistoryStatus(video.videoId, video.userId, 'failed', undefined, errorMessage);\n      return;\n    }\n\n    // Send VEO generation request\n    const veoProjectId = process.env.VEO3_PROJECT_ID || \"06ad4933-483d-4ef6-b1d9-7a8bc21219cb\";\n    const sceneId = `bulk-${video.videoId}-${Date.now()}`;\n    const seed = Math.floor(Math.random() * 100000);\n\n    const payload = {\n      clientContext: {\n        projectId: veoProjectId,\n        tool: \"PINHOLE\",\n        userPaygateTier: \"PAYGATE_TIER_TWO\"\n      },\n      requests: [{\n        aspectRatio: video.aspectRatio === \"portrait\" ? \"VIDEO_ASPECT_RATIO_PORTRAIT\" : \"VIDEO_ASPECT_RATIO_LANDSCAPE\",\n        seed: seed,\n        textInput: {\n          prompt: video.prompt\n        },\n        videoModelKey: video.aspectRatio === \"portrait\" ? \"veo_3_0_t2v_fast_portrait_ultra\" : \"veo_3_1_t2v_fast_ultra\",\n        metadata: {\n          sceneId: sceneId\n        }\n      }]\n    };\n\n    // Add timeout to fetch request (90 seconds - VEO API can be slow to accept requests)\n    const controller = new AbortController();\n    const timeout = setTimeout(() => controller.abort(), 90000);\n    \n    let response;\n    let data;\n    \n    try {\n      response = await fetch('https://aisandbox-pa.googleapis.com/v1/video:batchAsyncGenerateVideoText', {\n        method: 'POST',\n        headers: {\n          'Authorization': `Bearer ${apiKey}`,\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify(payload),\n        signal: controller.signal,\n      });\n      \n      clearTimeout(timeout);\n      data = await response.json();\n    } catch (fetchError: any) {\n      clearTimeout(timeout);\n      if (fetchError.name === 'AbortError') {\n        const errorMessage = `Request timeout after 90 seconds - VEO API not responding`;\n        console.error('[Bulk Queue] Request timeout:', fetchError);\n        await storage.updateVideoHistoryStatus(video.videoId, video.userId, 'failed', undefined, errorMessage);\n      } else {\n        const errorMessage = `Network error: ${fetchError.message}`;\n        console.error('[Bulk Queue] Network error:', fetchError);\n        await storage.updateVideoHistoryStatus(video.videoId, video.userId, 'failed', undefined, errorMessage);\n      }\n      \n      if (rotationToken) {\n        storage.recordTokenError(rotationToken.id);\n      }\n      return;\n    }\n\n    if (!response.ok) {\n      const errorMessage = `VEO API error (${response.status}): ${JSON.stringify(data).substring(0, 200)}`;\n      console.error('[Bulk Queue] VEO API error:', data);\n      await storage.updateVideoHistoryStatus(video.videoId, video.userId, 'failed', undefined, errorMessage);\n      \n      if (rotationToken) {\n        storage.recordTokenError(rotationToken.id);\n      }\n      return;\n    }\n\n    if (!data.operations || data.operations.length === 0) {\n      const errorMessage = 'No operations returned from VEO API - possible API issue';\n      console.error('[Bulk Queue] No operations returned from VEO API');\n      await storage.updateVideoHistoryStatus(video.videoId, video.userId, 'failed', undefined, errorMessage);\n      \n      if (rotationToken) {\n        storage.recordTokenError(rotationToken.id);\n      }\n      return;\n    }\n\n    const operation = data.operations[0];\n    const operationName = operation.operation.name;\n\n    console.log(`[Bulk Queue] Started generation for video ${video.sceneNumber} - Operation: ${operationName}`);\n\n    // Update history with token ID if available\n    if (rotationToken) {\n      try {\n        await storage.updateVideoHistoryFields(video.videoId, { tokenUsed: rotationToken.id });\n      } catch (err) {\n        console.error('[Bulk Queue] Failed to update video history with token ID:', err);\n      }\n    }\n\n    // Start background polling for this video\n    startBackgroundPolling(video.videoId, video.userId, operationName, sceneId, apiKey, rotationToken);\n\n  } catch (error) {\n    const errorMessage = `Error processing video: ${error instanceof Error ? error.message : String(error)}`;\n    console.error(`[Bulk Queue] Error processing video ${video.sceneNumber}:`, error);\n    await storage.updateVideoHistoryStatus(video.videoId, video.userId, 'failed', undefined, errorMessage);\n  }\n}\n\n/**\n * Process the queue in the background with batch processing\n */\nasync function processQueue() {\n  if (isProcessing) {\n    console.log('[Bulk Queue] Already processing queue');\n    return;\n  }\n\n  isProcessing = true;\n  console.log('[Bulk Queue] Started processing queue');\n\n  // Fetch batch settings from database\n  let videosPerBatch = 10;\n  let batchDelaySeconds = 20;\n  \n  try {\n    const settings = await storage.getTokenSettings();\n    if (settings) {\n      videosPerBatch = parseInt(settings.videosPerBatch, 10) || 5;\n      batchDelaySeconds = parseInt(settings.batchDelaySeconds, 10) || 20;\n      console.log(`[Bulk Queue] Using batch settings: ${videosPerBatch} videos per batch, ${batchDelaySeconds}s delay`);\n    }\n  } catch (error) {\n    console.error('[Bulk Queue] Error fetching batch settings, using defaults:', error);\n  }\n\n  while (bulkQueue.length > 0) {\n    // Get N videos from queue for this batch\n    const batchSize = Math.min(videosPerBatch, bulkQueue.length);\n    const batch: QueuedVideo[] = [];\n    \n    for (let i = 0; i < batchSize; i++) {\n      const video = bulkQueue.shift();\n      if (video) {\n        batch.push(video);\n      }\n    }\n\n    if (batch.length === 0) {\n      continue;\n    }\n\n    console.log(`[Bulk Queue] Processing batch of ${batch.length} videos. Remaining in queue: ${bulkQueue.length}`);\n\n    // Process all videos in batch in parallel\n    await Promise.all(batch.map(video => processSingleVideo(video)));\n\n    console.log(`[Bulk Queue] Batch of ${batch.length} videos submitted`);\n\n    // Wait for batchDelaySeconds before processing next batch\n    if (bulkQueue.length > 0) {\n      console.log(`[Bulk Queue] Waiting ${batchDelaySeconds} seconds before next batch...`);\n      await new Promise(resolve => setTimeout(resolve, batchDelaySeconds * 1000));\n    }\n  }\n\n  isProcessing = false;\n  console.log('[Bulk Queue] Finished processing queue');\n}\n\n/**\n * Start background polling for a video\n */\nasync function startBackgroundPolling(\n  videoId: string, \n  userId: string, \n  operationName: string, \n  sceneId: string, \n  apiKey: string,\n  rotationToken: ApiToken | undefined\n) {\n  (async () => {\n    try {\n      let completed = false;\n      let attempts = 0;\n      const maxAttempts = 900; // 30 minutes max (900 attempts * 2 seconds = 1800 seconds)\n      const retryAttempt = 60; // 2 minutes\n      let currentOperationName = operationName;\n      let currentSceneId = sceneId;\n      let currentApiKey = apiKey;\n      let currentRotationToken = rotationToken;\n      let hasRetriedWithNewToken = false;\n\n      while (!completed && attempts < maxAttempts) {\n        await new Promise(resolve => setTimeout(resolve, 2000));\n        attempts++;\n\n        // After 2 minutes, try with next API token if not completed\n        if (attempts === retryAttempt && !completed && !hasRetriedWithNewToken) {\n          console.log(`[Bulk Queue Polling] Video ${videoId} not completed after 2 minutes, trying with next API token...`);\n          \n          if (currentRotationToken) {\n            storage.recordTokenError(currentRotationToken.id);\n          }\n\n          try {\n            const nextToken = await storage.getNextRotationToken();\n            \n            if (nextToken && nextToken.id !== currentRotationToken?.id) {\n              console.log(`[Bulk Queue Polling] Switching to next token: ${nextToken.label}`);\n              currentApiKey = nextToken.token;\n              currentRotationToken = nextToken;\n              await storage.updateTokenUsage(nextToken.id);\n              \n              // Start new generation with the new token\n              const veoProjectId = process.env.VEO3_PROJECT_ID || \"06ad4933-483d-4ef6-b1d9-7a8bc21219cb\";\n              const newSceneId = `retry-${videoId}-${Date.now()}`;\n              const seed = Math.floor(Math.random() * 100000);\n\n              const video = await storage.updateVideoHistoryStatus(videoId, userId, 'pending');\n              if (!video) continue;\n\n              const payload = {\n                clientContext: {\n                  projectId: veoProjectId,\n                  tool: \"PINHOLE\",\n                  userPaygateTier: \"PAYGATE_TIER_TWO\"\n                },\n                requests: [{\n                  aspectRatio: video.aspectRatio === \"portrait\" ? \"VIDEO_ASPECT_RATIO_PORTRAIT\" : \"VIDEO_ASPECT_RATIO_LANDSCAPE\",\n                  seed: seed,\n                  textInput: {\n                    prompt: video.prompt\n                  },\n                  videoModelKey: video.aspectRatio === \"portrait\" ? \"veo_3_0_t2v_fast_portrait_ultra\" : \"veo_3_1_t2v_fast_ultra\",\n                  metadata: {\n                    sceneId: newSceneId\n                  }\n                }]\n              };\n\n              // Add timeout for retry request too\n              const retryController = new AbortController();\n              const retryTimeout = setTimeout(() => retryController.abort(), 90000);\n              \n              const response = await fetch('https://aisandbox-pa.googleapis.com/v1/video:batchAsyncGenerateVideoText', {\n                method: 'POST',\n                headers: {\n                  'Authorization': `Bearer ${currentApiKey}`,\n                  'Content-Type': 'application/json',\n                },\n                body: JSON.stringify(payload),\n                signal: retryController.signal,\n              });\n              \n              clearTimeout(retryTimeout);\n\n              const data = await response.json();\n              \n              if (response.ok && data.operations && data.operations.length > 0) {\n                currentOperationName = data.operations[0].operation.name;\n                currentSceneId = newSceneId;\n                hasRetriedWithNewToken = true;\n                console.log(`[Bulk Queue Polling] Started new generation with token ${nextToken.label}`);\n                \n                await storage.updateVideoHistoryFields(videoId, { tokenUsed: nextToken.id });\n              }\n            }\n          } catch (retryError) {\n            console.error('[Bulk Queue Polling] Error retrying with new token:', retryError);\n          }\n        }\n\n        // Check video status using proper API endpoint\n        try {\n          const requestBody = {\n            operations: [{\n              operation: {\n                name: currentOperationName\n              },\n              sceneId: currentSceneId,\n              status: \"MEDIA_GENERATION_STATUS_PENDING\"\n            }]\n          };\n\n          // Add timeout to status check (30 seconds)\n          const statusController = new AbortController();\n          const statusTimeout = setTimeout(() => statusController.abort(), 30000);\n\n          const statusResponse = await fetch('https://aisandbox-pa.googleapis.com/v1/video:batchCheckAsyncVideoGenerationStatus', {\n            method: 'POST',\n            headers: {\n              'Authorization': `Bearer ${currentApiKey}`,\n              'Content-Type': 'application/json',\n            },\n            body: JSON.stringify(requestBody),\n            signal: statusController.signal,\n          });\n\n          clearTimeout(statusTimeout);\n\n          if (!statusResponse.ok) {\n            console.error(`[Bulk Queue Polling] Status check failed (${statusResponse.status}) - will retry on next poll`);\n            continue; // Try again on next poll\n          }\n\n          const statusData = await statusResponse.json();\n          console.log(`[Bulk Queue Polling] Status for ${videoId}:`, JSON.stringify(statusData, null, 2).substring(0, 500));\n\n          // Check operations array for status\n          if (statusData.operations && statusData.operations.length > 0) {\n            const operationData = statusData.operations[0];\n            const operation = operationData.operation;\n            const opStatus = operationData.status;\n            \n            console.log(`[Bulk Queue Polling] Video ${videoId} status: ${opStatus}`);\n            \n            // Extract video URL from nested metadata structure (matching veo3.ts)\n            let veoVideoUrl: string | undefined;\n            \n            if (operation?.metadata?.video?.fifeUrl) {\n              veoVideoUrl = operation.metadata.video.fifeUrl;\n            } else if (operation?.videoUrl) {\n              veoVideoUrl = operation.videoUrl;\n            } else if (operation?.fileUrl) {\n              veoVideoUrl = operation.fileUrl;\n            } else if (operation?.downloadUrl) {\n              veoVideoUrl = operation.downloadUrl;\n            }\n            \n            // Decode HTML entities (VEO returns &amp; instead of &)\n            if (veoVideoUrl) {\n              veoVideoUrl = veoVideoUrl\n                .replace(/&amp;/g, '&')\n                .replace(/&lt;/g, '<')\n                .replace(/&gt;/g, '>')\n                .replace(/&quot;/g, '\"')\n                .replace(/&#39;/g, \"'\");\n            }\n            \n            // Check if video is completed\n            if (opStatus === 'MEDIA_GENERATION_STATUS_COMPLETE' || opStatus === 'MEDIA_GENERATION_STATUS_SUCCESSFUL' || opStatus === 'COMPLETED') {\n              if (veoVideoUrl) {\n                console.log(`[Bulk Queue Polling] Video ${videoId} completed, uploading to Cloudinary...`);\n                \n                // Upload to Cloudinary\n                const { uploadVideoToCloudinary } = await import('./cloudinary');\n                const cloudinaryUrl = await uploadVideoToCloudinary(veoVideoUrl);\n                \n                await storage.updateVideoHistoryStatus(videoId, userId, 'completed', cloudinaryUrl);\n                console.log(`[Bulk Queue Polling] Video ${videoId} completed successfully`);\n                completed = true;\n              } else {\n                console.log(`[Bulk Queue Polling] Video ${videoId} shows complete but no URL found`);\n              }\n            } else if (operation?.error) {\n              const errorMessage = `VEO generation failed: ${operation.error.message || JSON.stringify(operation.error).substring(0, 200)}`;\n              console.error(`[Bulk Queue Polling] Video ${videoId} failed:`, operation.error);\n              await storage.updateVideoHistoryStatus(videoId, userId, 'failed', undefined, errorMessage);\n              \n              if (currentRotationToken) {\n                storage.recordTokenError(currentRotationToken.id);\n              }\n              completed = true;\n            }\n          }\n        } catch (pollError: any) {\n          // Log network errors with more detail\n          if (pollError.name === 'AbortError') {\n            console.error(`[Bulk Queue Polling] Status check timeout for video ${videoId} - will retry on next poll`);\n          } else if (pollError.code === 'ECONNRESET' || pollError.cause?.code === 'ECONNRESET') {\n            console.error(`[Bulk Queue Polling] Network connection reset for video ${videoId} - will retry on next poll`);\n          } else {\n            console.error(`[Bulk Queue Polling] Error polling video ${videoId}:`, pollError);\n          }\n          // Continue polling - will retry on next attempt\n        }\n      }\n\n      // If not completed after max attempts, mark as failed\n      if (!completed) {\n        const errorMessage = `Video generation timed out after ${maxAttempts * 2} seconds (${maxAttempts} attempts)`;\n        console.log(`[Bulk Queue Polling] Video ${videoId} timed out after ${maxAttempts} attempts`);\n        await storage.updateVideoHistoryStatus(videoId, userId, 'failed', undefined, errorMessage);\n      }\n    } catch (error) {\n      const errorMessage = `Fatal error during video generation: ${error instanceof Error ? error.message : String(error)}`;\n      console.error(`[Bulk Queue Polling] Fatal error polling video ${videoId}:`, error);\n      await storage.updateVideoHistoryStatus(videoId, userId, 'failed', undefined, errorMessage);\n    }\n  })();\n}\n\n/**\n * Get current queue status\n */\nexport function getQueueStatus() {\n  return {\n    queueLength: bulkQueue.length,\n    isProcessing\n  };\n}\n","size_bytes":18079},"client/src/pages/ScriptCreator.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Link, useLocation } from \"wouter\";\nimport { Home, Loader2, Copy, Wand2 } from \"lucide-react\";\nimport { useQuery } from \"@tanstack/react-query\";\n\nexport default function ScriptCreator() {\n  const [storyAbout, setStoryAbout] = useState(\"\");\n  const [numberOfPrompts, setNumberOfPrompts] = useState(10);\n  const [finalStep, setFinalStep] = useState(\"\");\n  const [isGenerating, setIsGenerating] = useState(false);\n  const [generatedScript, setGeneratedScript] = useState<string | null>(null);\n  const { toast } = useToast();\n  const [, setLocation] = useLocation();\n\n  const { data: session, isLoading: sessionLoading } = useQuery<{\n    authenticated: boolean;\n    user?: { id: string; username: string; isAdmin: boolean };\n  }>({\n    queryKey: [\"/api/session\"],\n  });\n\n  useEffect(() => {\n    if (!sessionLoading && session && !session.authenticated) {\n      toast({\n        title: \"Authentication required\",\n        description: \"Please log in to use the script creator.\",\n        variant: \"destructive\",\n      });\n      setLocation(\"/login\");\n    }\n  }, [session, sessionLoading, setLocation, toast]);\n\n  const handleGenerate = async () => {\n    if (!storyAbout.trim()) {\n      toast({\n        title: \"Story required\",\n        description: \"Please describe what your story is about\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (!finalStep.trim()) {\n      toast({\n        title: \"Final step required\",\n        description: \"Please describe what the final step should be\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setIsGenerating(true);\n    setGeneratedScript(null);\n\n    try {\n      const response = await fetch('/api/generate-script', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        credentials: 'include',\n        body: JSON.stringify({ storyAbout, numberOfPrompts, finalStep }),\n      });\n\n      const result = await response.json();\n\n      if (!response.ok) {\n        throw new Error(result.error || 'Failed to generate script');\n      }\n\n      setGeneratedScript(result.script);\n      \n      toast({\n        title: \"Script generated!\",\n        description: \"Your storyboard has been created successfully.\",\n      });\n    } catch (error) {\n      console.error('Error generating script:', error);\n      toast({\n        title: \"Generation failed\",\n        description: error instanceof Error ? error.message : \"An error occurred\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsGenerating(false);\n    }\n  };\n\n  const handleCopy = () => {\n    if (generatedScript) {\n      navigator.clipboard.writeText(generatedScript);\n      toast({\n        title: \"Copied!\",\n        description: \"Script copied to clipboard\",\n      });\n    }\n  };\n\n  if (sessionLoading) {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-br from-slate-950 via-blue-950 to-slate-950 flex items-center justify-center\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-purple-400\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-slate-950 via-blue-950 to-slate-950\">\n      <div className=\"absolute inset-0 bg-[radial-gradient(ellipse_at_top_right,_var(--tw-gradient-stops))] from-purple-900/20 via-transparent to-transparent\" />\n      \n      <div className=\"relative z-10 container mx-auto px-4 py-8 max-w-4xl\">\n        <div className=\"flex justify-between items-center mb-8\">\n          <Link href=\"/\">\n            <Button variant=\"outline\" size=\"sm\" className=\"border-slate-700 hover:bg-slate-800\" data-testid=\"button-home\">\n              <Home className=\"h-4 w-4 mr-2\" />\n              Home\n            </Button>\n          </Link>\n        </div>\n\n        <Card className=\"bg-slate-900/50 backdrop-blur-sm border-slate-800 shadow-2xl\">\n          <CardHeader className=\"space-y-4\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"p-3 bg-gradient-to-br from-purple-600 to-pink-600 rounded-lg\">\n                <Wand2 className=\"h-6 w-6 text-white\" />\n              </div>\n              <div>\n                <CardTitle className=\"text-3xl text-white\">Script Creator</CardTitle>\n                <CardDescription className=\"text-slate-400\">\n                  Generate detailed animated storyboards with AI\n                </CardDescription>\n              </div>\n            </div>\n          </CardHeader>\n\n          <CardContent className=\"space-y-6\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"storyAbout\" className=\"text-white\">\n                Story About\n              </Label>\n              <Input\n                id=\"storyAbout\"\n                placeholder=\"e.g., a brave knight on a quest to save a kingdom\"\n                value={storyAbout}\n                onChange={(e) => setStoryAbout(e.target.value)}\n                className=\"bg-slate-800/50 border-slate-700 text-white placeholder:text-slate-500\"\n                disabled={isGenerating}\n                data-testid=\"input-story-about\"\n              />\n              <p className=\"text-xs text-slate-500\">\n                Describe what your animated story is about\n              </p>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"numberOfPrompts\" className=\"text-white\">\n                Number of Steps\n              </Label>\n              <Input\n                id=\"numberOfPrompts\"\n                type=\"number\"\n                min={1}\n                max={100}\n                value={numberOfPrompts}\n                onChange={(e) => setNumberOfPrompts(parseInt(e.target.value) || 10)}\n                className=\"bg-slate-800/50 border-slate-700 text-white\"\n                disabled={isGenerating}\n                data-testid=\"input-number-of-prompts\"\n              />\n              <p className=\"text-xs text-slate-500\">\n                How many steps/scenes should the storyboard have? (1-100)\n              </p>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"finalStep\" className=\"text-white\">\n                Final Step Description\n              </Label>\n              <Input\n                id=\"finalStep\"\n                placeholder=\"e.g., end with the hero returning home victorious\"\n                value={finalStep}\n                onChange={(e) => setFinalStep(e.target.value)}\n                className=\"bg-slate-800/50 border-slate-700 text-white placeholder:text-slate-500\"\n                disabled={isGenerating}\n                data-testid=\"input-final-step\"\n              />\n              <p className=\"text-xs text-slate-500\">\n                Describe how the final step should conclude\n              </p>\n            </div>\n\n            <Button\n              onClick={handleGenerate}\n              disabled={isGenerating || !storyAbout.trim() || !finalStep.trim()}\n              className=\"w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-medium py-6 text-lg\"\n              data-testid=\"button-generate-script\"\n            >\n              {isGenerating ? (\n                <>\n                  <Loader2 className=\"mr-2 h-5 w-5 animate-spin\" />\n                  Generating Script...\n                </>\n              ) : (\n                <>\n                  <Wand2 className=\"mr-2 h-5 w-5\" />\n                  Generate Storyboard\n                </>\n              )}\n            </Button>\n\n            {generatedScript && (\n              <div className=\"mt-8 space-y-4\">\n                <div className=\"flex justify-between items-center\">\n                  <h3 className=\"text-xl font-semibold text-white\">Generated Storyboard</h3>\n                  <Button\n                    onClick={handleCopy}\n                    variant=\"outline\"\n                    size=\"sm\"\n                    className=\"border-slate-700 hover:bg-slate-800\"\n                    data-testid=\"button-copy-script\"\n                  >\n                    <Copy className=\"h-4 w-4 mr-2\" />\n                    Copy\n                  </Button>\n                </div>\n                \n                <Textarea\n                  value={generatedScript}\n                  readOnly\n                  className=\"min-h-[400px] bg-slate-800/50 border-slate-700 text-white font-mono text-sm\"\n                  data-testid=\"textarea-generated-script\"\n                />\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","size_bytes":8897},"server/openai-script.ts":{"content":"// Blueprint: javascript_openai_ai_integrations\nimport OpenAI from \"openai\";\n\n// This is using Replit's AI Integrations service, which provides OpenAI-compatible API access without requiring your own OpenAI API key.\nconst openai = new OpenAI({\n  baseURL: process.env.AI_INTEGRATIONS_OPENAI_BASE_URL,\n  apiKey: process.env.AI_INTEGRATIONS_OPENAI_API_KEY\n});\n\n/**\n * Generate script/storyboard using user's custom prompt template\n */\nexport async function generateScript(\n  storyAbout: string,\n  numberOfPrompts: number,\n  finalStep: string\n): Promise<string> {\n  try {\n    const prompt = `Output only paragraphs, with no need to label steps or prompts. Write a storyboard for an animated film about a ${storyAbout}, consisting of ${numberOfPrompts} steps. Each step should include an English prompt. The final step should ${finalStep}. Describe the animated character fully in English at the beginning, and repeat that full character description in each prompt (do not use pronouns or shorthand such as \"the same character\"). The purpose is to reinforce the character's identity in every scene.`;\n\n    const response = await openai.chat.completions.create({\n      model: \"gpt-5\", // the newest OpenAI model is \"gpt-5\" which was released August 7, 2025. do not change this unless explicitly requested by the user\n      messages: [\n        { \n          role: \"system\", \n          content: \"You are a creative screenwriter and storyboard artist. Generate detailed, vivid storyboards for animated films.\" \n        },\n        { \n          role: \"user\", \n          content: prompt \n        }\n      ],\n      max_completion_tokens: 8192,\n    });\n\n    const storyboard = response.choices[0]?.message?.content || \"\";\n\n    if (!storyboard) {\n      throw new Error(\"Empty response from OpenAI\");\n    }\n\n    return storyboard;\n  } catch (error) {\n    console.error(\"Script generation error:\", error);\n    throw new Error(`Failed to generate script: ${error instanceof Error ? error.message : String(error)}`);\n  }\n}\n","size_bytes":2002}},"version":2}